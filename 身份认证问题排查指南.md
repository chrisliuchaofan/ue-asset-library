# ğŸ” èº«ä»½è®¤è¯é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜ 1: åç«¯ç™»å½•å¤±è´¥ 401 Unauthorized

### åŸå› åˆ†æ

å‰ç«¯ç™»å½•æ—¶ä½¿ç”¨çš„ email å’Œåç«¯ `USER_WHITELIST` ä¸­çš„ email æ ¼å¼ä¸åŒ¹é…ã€‚

**å‰ç«¯é…ç½®ï¼š**
```env
ADMIN_USERS=admin:admin123
BACKEND_TEST_PASSWORD=password123
```

**å‰ç«¯ç™»å½•æµç¨‹ï¼š**
1. ç”¨æˆ·ä½¿ç”¨ `admin:admin123` ç™»å½•
2. NextAuth ç”Ÿæˆ sessionï¼Œemail ä¸º `admin@admin.local`
3. å‰ç«¯è°ƒç”¨åç«¯ç™»å½•æ—¶ï¼Œä½¿ç”¨ `admin@admin.local` + `admin123`ï¼ˆä» ADMIN_USERS åŒ¹é…ï¼‰

**åç«¯é…ç½®è¦æ±‚ï¼š**
```env
USER_WHITELIST=admin@admin.local:admin123
# æˆ–è€…
USER_WHITELIST=admin:admin123
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä¿®æ”¹åç«¯ USER_WHITELISTï¼ˆæ¨èï¼‰

åœ¨åç«¯ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
# ä½¿ç”¨å®Œæ•´çš„ email æ ¼å¼
USER_WHITELIST=admin@admin.local:admin123

# æˆ–è€…ä½¿ç”¨ç”¨æˆ·åæ ¼å¼ï¼ˆåç«¯å·²æ”¯æŒåŒ¹é…ï¼‰
USER_WHITELIST=admin:admin123
```

#### æ–¹æ¡ˆ 2: ä¿®æ”¹å‰ç«¯ ADMIN_USERS

åœ¨å‰ç«¯ `.env.local` æ–‡ä»¶ä¸­ä½¿ç”¨ email æ ¼å¼ï¼š

```env
ADMIN_USERS=admin@factory-buy.com:admin123
```

ç„¶ååç«¯é…ç½®ï¼š

```env
USER_WHITELIST=admin@factory-buy.com:admin123
```

### éªŒè¯æ­¥éª¤

1. **æ£€æŸ¥å‰ç«¯ session emailï¼š**
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°
   fetch('/api/auth/session').then(r => r.json()).then(console.log)
   ```

2. **æ£€æŸ¥åç«¯ USER_WHITELISTï¼š**
   ```bash
   # åœ¨æœåŠ¡å™¨ä¸Š
   grep USER_WHITELIST /opt/ue-assets-backend/backend-api/.env
   ```

3. **æµ‹è¯•åç«¯ç™»å½•ï¼š**
   ```bash
   curl -X POST https://api.factory-buy.com/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@admin.local","password":"admin123"}'
   ```

---

## é—®é¢˜ 2: åç«¯ /me æ¥å£ 404 Not Found

### åŸå› åˆ†æ

åç«¯ `/me` æ¥å£å¯èƒ½ï¼š
1. æ²¡æœ‰æ­£ç¡®æ³¨å†Œåˆ°è·¯ç”±
2. åç«¯æœåŠ¡æœªå¯åŠ¨
3. è·¯ç”±è·¯å¾„é…ç½®é”™è¯¯

### è§£å†³æ–¹æ¡ˆ

#### 1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
pm2 list
pm2 logs ue-assets-backend --lines 50
```

#### 2. æ£€æŸ¥è·¯ç”±æ³¨å†Œ

ç¡®ä¿ `backend-api/src/auth/auth.module.ts` ä¸­æ³¨å†Œäº† `MeController`ï¼š

```typescript
@Module({
  imports: [CreditsModule],
  controllers: [AuthController, MeController], // âœ… ç¡®ä¿åŒ…å« MeController
  providers: [AuthService],
  exports: [AuthService],
})
export class AuthModule {}
```

#### 3. é‡å¯åç«¯æœåŠ¡

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /opt/ue-assets-backend/backend-api
pm2 restart ue-assets-backend --update-env
```

#### 4. éªŒè¯è·¯ç”±

```bash
# å…ˆç™»å½•è·å– token
TOKEN=$(curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' \
  | jq -r '.token')

# æµ‹è¯• /me æ¥å£
curl https://api.factory-buy.com/me \
  -H "Authorization: Bearer $TOKEN"
```

---

## ğŸ”§ å¿«é€Ÿä¿®å¤è„šæœ¬

### ä¿®å¤åç«¯é…ç½®

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cat >> /opt/ue-assets-backend/backend-api/.env << 'EOF'

# èº«ä»½è®¤è¯é…ç½®ï¼ˆä¸å‰ç«¯åŒ¹é…ï¼‰
USER_WHITELIST=admin@admin.local:admin123
JWT_SECRET=ä½ çš„å¯†é’¥ï¼ˆä¸å‰ç«¯ NEXTAUTH_SECRET ç›¸åŒï¼‰
NEXTAUTH_SECRET=ä½ çš„å¯†é’¥ï¼ˆä¸å‰ç«¯ç›¸åŒï¼‰
MODEL_ENABLED=false
BILLING_ENABLED=false
INITIAL_CREDITS=100
EOF

# é‡å¯æœåŠ¡
pm2 restart ue-assets-backend --update-env
```

### ä¿®å¤å‰ç«¯é…ç½®

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cat >> .env.local << 'EOF'
# ç¡®ä¿å¯†ç ä¸åç«¯åŒ¹é…
ADMIN_USERS=admin:admin123
BACKEND_TEST_PASSWORD=admin123
NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
EOF
```

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

### å‰ç«¯é…ç½®

- [ ] `ADMIN_USERS` å·²é…ç½®
- [ ] `BACKEND_TEST_PASSWORD` å·²é…ç½®ï¼ˆæˆ– ADMIN_USERS ä¸­é…ç½®äº†å¯†ç ï¼‰
- [ ] `NEXT_PUBLIC_BACKEND_API_URL` å·²é…ç½®
- [ ] `NEXTAUTH_SECRET` å·²é…ç½®

### åç«¯é…ç½®

- [ ] `USER_WHITELIST` å·²é…ç½®ï¼ˆæ ¼å¼ï¼š`email:password` æˆ– `username:password`ï¼‰
- [ ] `JWT_SECRET` å·²é…ç½®ï¼ˆä¸å‰ç«¯ `NEXTAUTH_SECRET` ç›¸åŒï¼‰
- [ ] `NEXTAUTH_SECRET` å·²é…ç½®ï¼ˆä¸å‰ç«¯ç›¸åŒï¼‰
- [ ] `MODEL_ENABLED=false` å·²é…ç½®
- [ ] `BILLING_ENABLED=false` å·²é…ç½®
- [ ] `INITIAL_CREDITS` å·²é…ç½®

### å¯†ç åŒ¹é…æ£€æŸ¥

**å‰ç«¯ `ADMIN_USERS` å’Œåç«¯ `USER_WHITELIST` çš„å¯†ç å¿…é¡»åŒ¹é…ï¼š**

**ç¤ºä¾‹ 1ï¼ˆæ¨èï¼‰ï¼š**
```env
# å‰ç«¯
ADMIN_USERS=admin:admin123

# åç«¯
USER_WHITELIST=admin@admin.local:admin123
# æˆ–
USER_WHITELIST=admin:admin123
```

**ç¤ºä¾‹ 2ï¼š**
```env
# å‰ç«¯
ADMIN_USERS=admin@factory-buy.com:admin123

# åç«¯
USER_WHITELIST=admin@factory-buy.com:admin123
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å‰ç«¯ session

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼š
```javascript
fetch('/api/auth/session').then(r => r.json()).then(console.log)
```

### 2. æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
pm2 logs ue-assets-backend --lines 100
```

### 3. æµ‹è¯•åç«¯ç™»å½•

```bash
curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' \
  -v
```

### 4. æµ‹è¯• /me æ¥å£

```bash
# å…ˆè·å– token
TOKEN=$(curl -s -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' \
  | jq -r '.token')

# æµ‹è¯• /me
curl https://api.factory-buy.com/me \
  -H "Authorization: Bearer $TOKEN" \
  -v
```

---

## ğŸ“ å¸¸è§é”™è¯¯

### é”™è¯¯ 1: 401 Unauthorized

**åŸå› ï¼š** å¯†ç ä¸åŒ¹é…æˆ– email æ ¼å¼ä¸åŒ¹é…

**è§£å†³ï¼š** æ£€æŸ¥ `USER_WHITELIST` å’Œ `ADMIN_USERS` é…ç½®

### é”™è¯¯ 2: 404 Not Found

**åŸå› ï¼š** åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–è·¯ç”±æœªæ³¨å†Œ

**è§£å†³ï¼š** 
1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€ï¼š`pm2 list`
2. æ£€æŸ¥è·¯ç”±æ³¨å†Œï¼šç¡®ä¿ `MeController` åœ¨ `AuthModule` ä¸­
3. é‡å¯æœåŠ¡ï¼š`pm2 restart ue-assets-backend --update-env`

### é”™è¯¯ 3: CORS é”™è¯¯

**åŸå› ï¼š** å‰ç«¯åŸŸåä¸åœ¨åç«¯ CORS å…è®¸åˆ—è¡¨ä¸­

**è§£å†³ï¼š** æ£€æŸ¥åç«¯ `FRONTEND_URL` é…ç½®

---

## ğŸ¯ æ¨èé…ç½®

### å¼€å‘ç¯å¢ƒ

**å‰ç«¯ `.env.local`ï¼š**
```env
NEXTAUTH_SECRET=dev-secret-key-32-chars-minimum
NEXTAUTH_URL=http://localhost:3000
ADMIN_USERS=admin:admin123
BACKEND_TEST_PASSWORD=admin123
NEXT_PUBLIC_BACKEND_API_URL=http://localhost:3001
```

**åç«¯ `.env`ï¼š**
```env
JWT_SECRET=dev-secret-key-32-chars-minimum
NEXTAUTH_SECRET=dev-secret-key-32-chars-minimum
USER_WHITELIST=admin@admin.local:admin123
MODEL_ENABLED=false
BILLING_ENABLED=false
INITIAL_CREDITS=100
PORT=3001
FRONTEND_URL=http://localhost:3000
```

### ç”Ÿäº§ç¯å¢ƒ

**å‰ç«¯ï¼ˆVercelï¼‰ï¼š**
```env
NEXTAUTH_SECRET=production-secret-key-32-chars-minimum
NEXTAUTH_URL=https://your-domain.com
ADMIN_USERS=admin@factory-buy.com:secure-password
BACKEND_TEST_PASSWORD=secure-password
NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
```

**åç«¯ï¼ˆæœåŠ¡å™¨ï¼‰ï¼š**
```env
JWT_SECRET=production-secret-key-32-chars-minimum
NEXTAUTH_SECRET=production-secret-key-32-chars-minimum
USER_WHITELIST=admin@factory-buy.com:secure-password
MODEL_ENABLED=false
BILLING_ENABLED=false
INITIAL_CREDITS=1000
FRONTEND_URL=https://your-domain.com
```







