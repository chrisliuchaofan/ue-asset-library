# ä¿®å¤åç«¯ç™»å½•é—®é¢˜

## ğŸ” é—®é¢˜åˆ†æ

**é”™è¯¯ä¿¡æ¯ï¼š**
```
åç«¯ç™»å½•å¤±è´¥ (401 Unauthorized)
é‚®ç®±æˆ–å¯†ç é”™è¯¯
```

**é—®é¢˜åŸå› ï¼š**
1. å‰ç«¯ä½¿ç”¨ `BACKEND_TEST_EMAIL` (`test@factory-buy.com`) å’Œ `BACKEND_TEST_PASSWORD` ç™»å½•åç«¯
2. åç«¯ `/auth/login` æ¥å£ä¼šå°è¯•ä»æ•°æ®åº“éªŒè¯ç”¨æˆ·
3. æ•°æ®åº“ä¸­å¯èƒ½ï¼š
   - æ²¡æœ‰ `test@factory-buy.com` ç”¨æˆ·
   - æˆ–è€…å¯†ç ä¸åŒ¹é…ï¼ˆæ•°æ®åº“ä¸­çš„å¯†ç æ˜¯ bcrypt åŠ å¯†çš„ï¼Œè€Œ `BACKEND_TEST_PASSWORD` æ˜¯æ˜æ–‡ï¼‰

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®æ”¹åç«¯ç™»å½•é€»è¾‘ï¼ˆæ¨èï¼‰

**ä¿®æ”¹ `backend-api/src/auth/auth.service.ts`ï¼Œå…è®¸ä½¿ç”¨ `USER_WHITELIST` ä¸­çš„ç”¨æˆ·ç™»å½•ï¼ˆå³ä½¿ä¸åœ¨æ•°æ®åº“ä¸­ï¼‰ï¼š**

```typescript
async login(email: string, password: string, isAdmin: boolean = false) {
  // å…ˆæ£€æŸ¥ç™½åå•ï¼ˆæ— è®º isAdmin æ˜¯å¦ä¸º trueï¼‰
  const adminWhitelist = this.getAdminWhitelistUsers();
  const adminUser = adminWhitelist.find(
    (u) => {
      const whitelistEmail = u.email.trim();
      const emailUsername = email.split('@')[0];
      const whitelistUsername = whitelistEmail.includes('@') 
        ? whitelistEmail.split('@')[0] 
        : whitelistUsername;
      return (whitelistEmail === email || whitelistUsername === emailUsername) && u.password === password;
    }
  );

  if (adminUser) {
    // ç™½åå•ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œç¡®ä¿æ•°æ®åº“ä¸­æœ‰è¯¥ç”¨æˆ·ï¼ˆç”¨äºç§¯åˆ†ç³»ç»Ÿï¼‰
    const existingUser = await this.usersService.findByEmail(email);
    if (!existingUser) {
      // å¦‚æœæ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªï¼ˆå¯†ç æš‚æ—¶ä¸ºç©ºï¼Œå› ä¸ºç™½åå•ç”¨æˆ·ä¸éœ€è¦æ•°æ®åº“å¯†ç ï¼‰
      // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦è°ƒç”¨ UsersService çš„åˆ›å»ºæ–¹æ³•ï¼Œä½† UsersService æ²¡æœ‰å…¬å¼€çš„åˆ›å»ºæ–¹æ³•
      // å¯ä»¥è°ƒç”¨ CreditsService çš„åˆå§‹åŒ–é€»è¾‘ï¼Œæˆ–è€…ç›´æ¥åˆ›å»º
      // æš‚æ—¶è·³è¿‡ï¼Œå› ä¸º CreditsService ä¼šåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºç”¨æˆ·
    }
    
    const token = jwt.sign(
      { userId: email, email, isAdmin: true },
      this.jwtSecret,
      { expiresIn: '30d' }
    );
    return {
      success: true,
      userId: email,
      email,
      name: email.split('@')[0],
      token,
      isAdmin: true,
    };
  }

  // å°è¯•ä»æ•°æ®åº“éªŒè¯ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
  try {
    const result = await this.usersService.login(email, password);
    return {
      success: true,
      userId: result.user.id,
      email: result.user.email,
      name: result.user.name,
      token: result.token,
      isAdmin: false,
    };
  } catch (error) {
    // æ•°æ®åº“ç™»å½•å¤±è´¥ï¼Œè¿”å›é”™è¯¯
    throw new UnauthorizedException('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  }
}
```

### æ–¹æ¡ˆ 2ï¼šç¡®ä¿æ•°æ®åº“ä¸­æœ‰ç”¨æˆ·ï¼ˆç®€å•ä½†éœ€è¦æ‰‹åŠ¨æ“ä½œï¼‰

**åœ¨åç«¯æ•°æ®åº“ä¸­åˆ›å»ºç”¨æˆ·ï¼š**

1. **ä½¿ç”¨åç«¯æ³¨å†Œæ¥å£ï¼š**
   ```bash
   curl -X POST http://localhost:3001/users/register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@factory-buy.com",
       "password": "YOUR_BACKEND_TEST_PASSWORD",
       "name": "Test User"
     }'
   ```

2. **æˆ–è€…ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼š**
   - è¿æ¥åˆ° PostgreSQL æ•°æ®åº“
   - æ’å…¥ç”¨æˆ·è®°å½•ï¼ˆå¯†ç éœ€è¦ bcrypt åŠ å¯†ï¼‰

### æ–¹æ¡ˆ 3ï¼šä¿®æ”¹å‰ç«¯é…ç½®ï¼ˆæœ€ç®€å•ï¼‰

**ç¡®ä¿ `BACKEND_TEST_EMAIL` å’Œ `BACKEND_TEST_PASSWORD` ä¸åç«¯ `USER_WHITELIST` åŒ¹é…ï¼š**

1. **æ£€æŸ¥åç«¯ `.env` æ–‡ä»¶ï¼š**
   ```bash
   USER_WHITELIST=test@factory-buy.com:YOUR_PASSWORD
   ```

2. **ç¡®ä¿å‰ç«¯ `.env.local` æ–‡ä»¶ï¼š**
   ```bash
   BACKEND_TEST_EMAIL=test@factory-buy.com
   BACKEND_TEST_PASSWORD=YOUR_PASSWORD
   ```

3. **ç¡®ä¿å¯†ç å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬å¤§å°å†™ã€ç©ºæ ¼ç­‰ï¼‰**

---

## ğŸš€ æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ 1**ï¼Œå› ä¸ºï¼š
- ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·
- ç™½åå•ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•
- æ•°æ®åº“ç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ç™»å½•
- æ›´çµæ´»

---

## ğŸ“ å®æ–½æ­¥éª¤

1. **ä¿®æ”¹åç«¯ `auth.service.ts`**
2. **é‡å¯åç«¯æœåŠ¡**
3. **æµ‹è¯•ç™»å½•**

---

## âœ… éªŒè¯

**æµ‹è¯•ç™»å½•ï¼š**
```bash
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@factory-buy.com",
    "password": "YOUR_PASSWORD"
  }'
```

**é¢„æœŸç»“æœï¼š**
- è¿”å› 200ï¼ŒåŒ…å« `token`
- æˆ–è€…è¿”å› 401ï¼ˆå¦‚æœå¯†ç ä¸åŒ¹é…ï¼‰

