# 🔐 密钥配置指南

> 所有密钥都通过环境变量配置，不硬编码在代码中

## 📋 密钥配置位置

### 1. Vercel（前端）环境变量

在 Vercel Dashboard → 项目 → Settings → Environment Variables 配置

### 2. ECS 服务器（后端）环境变量

在 ECS 服务器的 `/opt/ue-assets-backend/backend-api/.env` 文件中配置

---

## 🔑 需要配置的密钥清单

### Vercel 环境变量（前端）

#### 认证相关

```env
# NextAuth 密钥（必须）
NEXTAUTH_SECRET=你的随机密钥（使用 openssl rand -base64 32 生成）
NEXTAUTH_URL=https://factory-buy.com
```

#### 后端 API 地址

```env
# 后端 API 地址（必须）
BACKEND_API_URL=https://api.factory-buy.com
```

#### 用户白名单（测试账号）

```env
# 格式：邮箱:密码,邮箱:密码
USER_WHITELIST=test@factory-buy.com:password123,admin@factory-buy.com:admin123
```

#### OSS 配置

```env
# OSS 服务端配置（用于上传和管理）
OSS_BUCKET=你的bucket名称
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=你的AccessKeyId
OSS_ACCESS_KEY_SECRET=你的AccessKeySecret

# OSS 客户端配置（用于前端）
NEXT_PUBLIC_OSS_BUCKET=你的bucket名称
NEXT_PUBLIC_OSS_REGION=oss-cn-hangzhou
NEXT_PUBLIC_CDN_BASE=https://你的CDN域名.com
```

#### AI 服务配置

```env
# 千问 API（图像分析）
AI_IMAGE_API_KEY=你的千问API密钥
AI_IMAGE_API_ENDPOINT=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
AI_IMAGE_API_MODEL=qwen-plus-latest
AI_VISION_MODEL=qwen-vl-plus-latest

# 即梦视频生成（火山引擎）
JIMENG_ACCESS_KEY=你的火山引擎AccessKey
JIMENG_SECRET_KEY=你的火山引擎SecretKey
JIMENG_REQ_KEY=jimeng_i2v_first_v30
JIMENG_REGION=cn-north-1
JIMENG_API_ENDPOINT=https://visual.volcengineapi.com

# 模型适配层（可选）
MODEL_PROVIDER=ollama  # 或 siliconflow
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama2
SILICONFLOW_API_KEY=你的SiliconFlow密钥
SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICONFLOW_MODEL=deepseek-ai/DeepSeek-V2.5
```

---

### ECS 服务器环境变量（后端）

在 ECS 服务器上创建 `/opt/ue-assets-backend/backend-api/.env` 文件：

```env
# 服务器配置
PORT=3001
NODE_ENV=production

# 前端地址（CORS 配置）
FRONTEND_URL=https://factory-buy.com

# JWT 密钥（必须与 Vercel 的 NEXTAUTH_SECRET 相同）
JWT_SECRET=你的密钥（与Vercel的NEXTAUTH_SECRET相同）
NEXTAUTH_SECRET=你的密钥（与Vercel相同）

# 用户白名单（与 Vercel 保持一致）
USER_WHITELIST=test@factory-buy.com:password123,admin@factory-buy.com:admin123

# 积分系统
INITIAL_CREDITS=100
```

---

## 🔒 密钥生成方法

### 生成 NEXTAUTH_SECRET / JWT_SECRET

```bash
# 方法 1：使用 OpenSSL
openssl rand -base64 32

# 方法 2：使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

**重要**：
- Vercel 和 ECS 的 `NEXTAUTH_SECRET` 和 `JWT_SECRET` 必须**完全相同**
- 使用强随机密钥，至少 32 字符
- 不要将密钥提交到 Git

---

## ✅ 配置检查清单

### Vercel 配置检查

- [ ] `NEXTAUTH_SECRET` 已配置
- [ ] `NEXTAUTH_URL` 已配置（你的域名）
- [ ] `BACKEND_API_URL` 已配置（后端域名）
- [ ] `USER_WHITELIST` 已配置（至少一个测试账号）
- [ ] OSS 相关变量已配置
- [ ] AI 相关变量已配置（如果使用 AI 功能）
- [ ] 即梦相关变量已配置（如果使用视频生成）

### ECS 配置检查

- [ ] `.env` 文件已创建
- [ ] `PORT` 已配置（3001）
- [ ] `FRONTEND_URL` 已配置（Vercel 域名）
- [ ] `JWT_SECRET` 已配置（与 Vercel 相同）
- [ ] `NEXTAUTH_SECRET` 已配置（与 Vercel 相同）
- [ ] `USER_WHITELIST` 已配置（与 Vercel 相同）
- [ ] `INITIAL_CREDITS` 已配置

---

## 🚨 安全建议

1. **不要硬编码密钥**：所有密钥都通过环境变量配置
2. **不要提交到 Git**：确保 `.env` 和 `.env.local` 在 `.gitignore` 中
3. **定期更换密钥**：建议每 3-6 个月更换一次
4. **使用 HTTPS**：生产环境必须使用 HTTPS
5. **限制访问**：后端 API 只允许前端域名访问（CORS）

---

## 📝 配置步骤

### 在 Vercel 配置

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择项目 → **Settings** → **Environment Variables**
3. 逐个添加上述环境变量
4. 点击 **Save**
5. 重新部署项目

### 在 ECS 配置

1. SSH 连接到服务器
2. 进入后端目录：`cd /opt/ue-assets-backend/backend-api`
3. 创建 `.env` 文件：`nano .env`
4. 粘贴上述环境变量内容
5. 保存文件（`Ctrl + X` → `Y` → `Enter`）
6. 重启服务：`pm2 restart ue-assets-backend`

---

## 🧪 测试配置

### 测试 Vercel 配置

在浏览器控制台：

```javascript
// 测试后端连接
fetch('/api/backend/health')
  .then(r => r.json())
  .then(console.log);
```

### 测试 ECS 配置

在服务器上：

```bash
# 测试健康检查
curl http://localhost:3001/health

# 查看环境变量（不显示敏感信息）
pm2 env ue-assets-backend | grep -v SECRET
```

---

## ❓ 常见问题

### Q: 密钥在哪里获取？

- **千问 API Key**：阿里云 DashScope 控制台
- **火山引擎密钥**：火山引擎控制台
- **OSS 密钥**：阿里云 OSS 控制台
- **SiliconFlow 密钥**：SiliconFlow 官网

### Q: 密钥泄露了怎么办？

1. 立即在服务商控制台**撤销旧密钥**
2. 生成新密钥
3. 更新 Vercel 和 ECS 的环境变量
4. 重新部署服务

### Q: 如何确认密钥配置正确？

1. 检查环境变量是否都已设置
2. 查看服务日志（Vercel 部署日志、PM2 日志）
3. 测试功能是否正常

---

**最后更新**：2025-12-14

