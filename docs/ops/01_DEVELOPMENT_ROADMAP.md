# 🗺️ 开发节奏规划 - 基于现实状态

**生成时间：** 2024-12-19  
**基于文档：** `00_PROJECT_REALITY.md`  
**规划原则：** 基于现实状态，不假设理想情况

---

## 📋 规划前提

### 当前系统状态

👉 **系统分类：** 【多用户未完成 / 部分可用】

**核心问题：**
1. 🔴 **前后端用户身份链路存在断裂风险**
2. 🔴 **前端 AI 调用未完全接入后端计费系统**
3. 🟡 **Dry Run 模式不一致**

**可用功能：**
- ✅ 前端认证系统（NextAuth.js）
- ✅ 后端用户系统（数据库 + 积分系统）
- ✅ 前端资产库功能
- ✅ 后端 Dry Run 模式（部分）

**不可用功能：**
- ❌ 前后端用户身份链路（不稳定）
- ❌ 前端 AI 调用后端计费（未完全接入）
- ❌ 统一的 Dry Run 模式

---

## 🎯 6 个里程碑（M1-M6）

### M1：修复前后端用户身份链路（地基）

**目标：** 确保前后端用户身份能够正确传递和识别

**必须完成的原因：**
- 这是所有后端功能的基础
- 如果用户身份链路断裂，用户无法使用后端功能（积分查询、AI 生成等）

**任务清单：**

1. **统一用户 ID 映射机制**
   - [ ] 确定单一可信来源（建议：使用 email 作为 userId）
   - [ ] 修改前端 `session.user.id` 生成逻辑，使用 email
   - [ ] 修改后端 `User` 实体，确保 `id` 字段与前端一致
   - [ ] 添加用户 ID 映射文档

2. **修复后端 token 获取逻辑**
   - [ ] 确保 `getBackendToken()` 能正确匹配用户
   - [ ] 添加 `BACKEND_TEST_EMAIL` 和 `BACKEND_TEST_PASSWORD` 环境变量支持
   - [ ] 改进错误提示（如果后端登录失败，明确告知用户）

3. **验证用户身份链路**
   - [ ] 编写测试脚本，验证前后端用户身份传递
   - [ ] 测试多用户场景（不同用户登录，验证身份正确）
   - [ ] 测试后端不可用场景（前端应该明确提示）

**验收标准：**
- ✅ 前端登录后，能成功获取后端 token
- ✅ 前端调用 `/api/me` 能正确返回用户信息
- ✅ 多用户登录时，每个用户能看到自己的积分
- ✅ 后端不可用时，前端明确提示错误

**依赖：** 无（这是地基，必须先完成）

**预计时间：** 2-3 天

---

### M2：修复前端 AI 调用未接入后端计费（地基）

**目标：** 确保所有 AI 调用都经过后端计费系统，并检查 Dry Run 模式

**必须完成的原因：**
- 防止"开发者以为没花钱，实际上在烧钱"的情况
- 确保所有 AI 调用都受 Dry Run 模式控制

**任务清单：**

1. **修复 AI 图像分析接入后端计费**
   - [ ] 修改 `/api/ai/analyze-image`，调用后端 `/credits/consume` 接口
   - [ ] 在调用 AI API 之前，先检查 Dry Run 模式（通过 `/api/me` 获取 `billingMode`）
   - [ ] 如果 `billingMode === 'DRY_RUN'`，不调用真实 AI API，返回 mock 结果
   - [ ] 如果 `billingMode === 'REAL'`，调用后端计费接口，然后调用 AI API

2. **修复 AI 文本生成接入后端计费**
   - [ ] 检查 `/api/ai/generate-text` 是否已接入后端
   - [ ] 如果未接入，修改为调用后端 `/ai/generate-text` 接口
   - [ ] 确保后端接口检查 Dry Run 模式

3. **统一 Dry Run 模式检查**
   - [ ] 创建统一的 Dry Run 检查函数（前端）
   - [ ] 所有 AI 调用都先检查 Dry Run 模式
   - [ ] 添加 Dry Run 模式 UI 提示（用户能看到当前模式）

**验收标准：**
- ✅ 所有 AI 调用都经过后端计费系统
- ✅ Dry Run 模式下，不调用真实 AI API
- ✅ Real 模式下，先扣费再调用 AI API
- ✅ 用户能看到当前模式（DRY_RUN/REAL）

**依赖：** M1（需要用户身份链路正常）

**预计时间：** 3-4 天

---

### M3：验证数据库和后端服务运行状态（地基）

**目标：** 确认数据库和后端服务真实可用

**必须完成的原因：**
- 如果数据库或后端服务不可用，M1 和 M2 的修复无法验证
- 需要确认生产环境的实际状态

**任务清单：**

1. **验证数据库连接**
   - [ ] 运行 `快速检查后端配置.sh` 脚本
   - [ ] 检查数据库连接配置（`DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USERNAME`, `DB_PASSWORD`）
   - [ ] 测试数据库连接（使用 `psql` 或 TypeORM 连接测试）
   - [ ] 检查数据库表结构（`User`, `CreditTransaction`, `LogEntry`, `Job`）

2. **验证后端服务运行**
   - [ ] 检查 PM2 进程状态（`pm2 list`）
   - [ ] 检查后端服务日志（`pm2 logs ue-assets-backend`）
   - [ ] 测试健康检查接口（`curl http://localhost:3001/health`）
   - [ ] 测试登录接口（`curl -X POST http://localhost:3001/auth/login`）

3. **验证环境变量配置**
   - [ ] 检查后端 `.env` 文件配置
   - [ ] 检查前端环境变量配置（Vercel 或 `.env.local`）
   - [ ] 验证 `USER_WHITELIST` 与 `ADMIN_USERS` 匹配

**验收标准：**
- ✅ 数据库连接正常
- ✅ 后端服务运行正常
- ✅ 健康检查接口返回正常
- ✅ 登录接口返回正常

**依赖：** 无（可以并行进行）

**预计时间：** 1-2 天

---

### M4：改进错误处理和可观测性（UI 增强）

**目标：** 用户能快速识别错误类型，知道错在哪

**必须完成的原因：**
- 提高用户体验
- 减少排查问题的时间

**任务清单：**

1. **统一错误信息格式**
   - [ ] 定义统一的错误码（`INSUFFICIENT_CREDITS`, `AUTH_FAILED`, `MODEL_ERROR` 等）
   - [ ] 前端错误处理统一使用错误码
   - [ ] 后端错误响应统一格式

2. **改进 UI 错误提示**
   - [ ] 登录错误：明确提示"用户名或密码错误"或"后端服务不可用"
   - [ ] 余额不足错误：显示当前余额和所需金额
   - [ ] 模型错误：显示具体错误原因（API Key 未配置、模型调用失败等）
   - [ ] 网络错误：显示"后端服务不可用，请稍后重试"

3. **添加错误日志收集**
   - [ ] 前端错误日志统一收集（可以发送到后端或日志服务）
   - [ ] 后端错误日志统一格式
   - [ ] 添加错误追踪 ID（方便排查问题）

**验收标准：**
- ✅ 用户能快速识别错误类型
- ✅ 错误信息明确，不会混淆
- ✅ 错误日志能帮助排查问题

**依赖：** M1, M2（需要用户身份链路和计费系统正常）

**预计时间：** 2-3 天

---

### M5：完善用户管理 UI（功能增强）

**目标：** 提供用户管理界面，支持多用户场景

**必须完成的原因：**
- 当前系统支持多用户，但 UI 层面未完全体现
- 需要用户管理界面来管理用户、查看积分、切换模式等

**任务清单：**

1. **用户信息显示增强**
   - [ ] 在 `/dream-factory` 页面显示用户信息（已部分实现）
   - [ ] 在 `/dashboard` 页面显示用户信息
   - [ ] 显示用户余额、模式（DRY_RUN/REAL）、最后登录时间等

2. **用户管理界面（管理员）**
   - [ ] 创建 `/admin/users` 页面
   - [ ] 显示用户列表（从后端获取）
   - [ ] 支持查看用户积分、交易记录
   - [ ] 支持手动充值积分（管理员功能）

3. **用户设置界面**
   - [ ] 创建 `/settings` 页面
   - [ ] 支持查看个人信息
   - [ ] 支持查看积分余额和交易记录
   - [ ] 支持查看当前模式（DRY_RUN/REAL）

**验收标准：**
- ✅ 用户能看到自己的信息（余额、模式等）
- ✅ 管理员能管理用户（查看、充值等）
- ✅ 用户能查看自己的交易记录

**依赖：** M1, M2, M3（需要用户身份链路、计费系统、数据库正常）

**预计时间：** 3-4 天

---

### M6：完善 Dry Run 模式 UI 和文档（功能增强）

**目标：** 用户和开发者能清楚了解 Dry Run 模式的状态和切换方式

**必须完成的原因：**
- 当前 Dry Run 模式不够直观
- 需要明确的 UI 提示和文档说明

**任务清单：**

1. **Dry Run 模式 UI 提示**
   - [ ] 在用户信息显示中突出显示当前模式（DRY_RUN/REAL）
   - [ ] 在 AI 调用按钮上显示模式提示（"Dry Run 模式：不会产生真实费用"）
   - [ ] 在 AI 调用结果中显示模式标记（"这是 Dry Run 模式的模拟结果"）

2. **Dry Run 模式切换（管理员）**
   - [ ] 在 `/admin/users` 页面支持切换用户模式（DRY_RUN/REAL）
   - [ ] 支持批量切换模式
   - [ ] 添加模式切换确认对话框（防止误操作）

3. **Dry Run 模式文档**
   - [ ] 更新 `DRY_RUN使用指南.md`
   - [ ] 添加 Dry Run 模式说明（用户文档）
   - [ ] 添加 Dry Run 模式切换指南（管理员文档）

**验收标准：**
- ✅ 用户能清楚看到当前模式
- ✅ 管理员能切换用户模式
- ✅ 有完整的 Dry Run 模式文档

**依赖：** M1, M2, M5（需要用户身份链路、计费系统、用户管理 UI）

**预计时间：** 2-3 天

---

## 📊 里程碑依赖关系图

```
M1 (用户身份链路)
  ↓
M2 (AI 调用计费)
  ↓
M4 (错误处理) ──┐
                │
M5 (用户管理 UI) ──┘
  ↓
M6 (Dry Run UI)

M3 (验证运行状态) ── 可并行进行
```

---

## 🎯 开发节奏建议

### 第一阶段：地基修复（必须优先完成）

**时间：** 1-2 周

**里程碑：** M1, M2, M3

**目标：** 确保系统基础功能正常，防止"花钱不可控"的问题

**关键任务：**
1. 修复前后端用户身份链路（M1）
2. 修复前端 AI 调用未接入后端计费（M2）
3. 验证数据库和后端服务运行状态（M3）

**验收标准：**
- ✅ 用户能正常登录并使用后端功能
- ✅ 所有 AI 调用都经过后端计费系统
- ✅ Dry Run 模式下不会产生真实费用

### 第二阶段：体验优化（可以并行进行）

**时间：** 1-2 周

**里程碑：** M4, M5

**目标：** 提高用户体验，完善功能

**关键任务：**
1. 改进错误处理和可观测性（M4）
2. 完善用户管理 UI（M5）

**验收标准：**
- ✅ 用户能快速识别错误类型
- ✅ 用户能看到自己的信息和交易记录
- ✅ 管理员能管理用户

### 第三阶段：功能增强（可以并行进行）

**时间：** 1 周

**里程碑：** M6

**目标：** 完善 Dry Run 模式 UI 和文档

**关键任务：**
1. 完善 Dry Run 模式 UI 和文档（M6）

**验收标准：**
- ✅ 用户能清楚看到当前模式
- ✅ 管理员能切换用户模式
- ✅ 有完整的 Dry Run 模式文档

---

## ⚠️ 关键风险提示

### 风险 1：前后端用户身份链路断裂

**影响：** 用户无法使用后端功能（积分查询、AI 生成等）

**缓解措施：**
- M1 必须优先完成
- 添加用户 ID 映射文档
- 添加自动化测试

### 风险 2：前端 AI 调用未接入后端计费

**影响：** 可能产生真实费用，但不会扣用户积分

**缓解措施：**
- M2 必须优先完成
- 所有 AI 调用都经过后端 Dry Run 检查
- 添加费用监控和告警

### 风险 3：数据库或后端服务不可用

**影响：** 所有后端功能不可用

**缓解措施：**
- M3 必须优先完成
- 添加健康检查监控
- 添加自动恢复机制

---

## 📝 开发注意事项

### 1. 不重复已完成工作

**已实现的功能：**
- ✅ 前端认证系统（NextAuth.js）
- ✅ 后端用户系统（数据库 + 积分系统）
- ✅ 后端 Dry Run 模式（部分）

**不要重复实现：**
- ❌ 不要重新实现认证系统
- ❌ 不要重新实现积分系统
- ❌ 不要重新实现 Dry Run 模式

**应该做的：**
- ✅ 修复现有功能的缺陷
- ✅ 完善现有功能的集成
- ✅ 添加缺失的功能

### 2. 不假设"用户系统已存在"

**当前状态：**
- ⚠️ 用户系统已实现，但前后端链路不稳定

**应该做的：**
- ✅ 先修复用户身份链路（M1）
- ✅ 再实现依赖用户身份的功能（M2, M4, M5, M6）

### 3. 优先解决"花钱不可控"的问题

**当前问题：**
- 🔴 前端 AI 调用未接入后端计费（M2）
- 🟡 Dry Run 模式不一致（M2, M6）

**应该做的：**
- ✅ M2 必须优先完成
- ✅ 所有 AI 调用都经过后端 Dry Run 检查
- ✅ 添加费用监控和告警

### 4. 哪些是必须先补的"地基"

**地基（必须优先完成）：**
1. **M1：** 前后端用户身份链路（所有后端功能的基础）
2. **M2：** 前端 AI 调用接入后端计费（防止"花钱不可控"）
3. **M3：** 验证数据库和后端服务运行状态（确保系统可用）

**非地基（可以后续完成）：**
- M4：错误处理和可观测性（体验优化）
- M5：用户管理 UI（功能增强）
- M6：Dry Run 模式 UI（功能增强）

### 5. 哪些功能必须有 UI 才能继续

**需要 UI 的功能：**
- **M5：** 用户管理 UI（需要 UI 才能管理用户）
- **M6：** Dry Run 模式 UI（需要 UI 才能切换模式）

**不需要 UI 的功能：**
- **M1：** 用户身份链路（后端修复，不需要 UI）
- **M2：** AI 调用计费（后端修复，不需要 UI）
- **M3：** 验证运行状态（脚本验证，不需要 UI）
- **M4：** 错误处理（可以先用控制台日志，后续添加 UI）

### 6. 哪些可以纯后端完成

**纯后端任务：**
- **M1：** 用户身份链路修复（后端逻辑修复）
- **M2：** AI 调用计费修复（后端逻辑修复）
- **M3：** 验证运行状态（脚本验证）

**需要前端的任务：**
- **M4：** 错误处理 UI（需要前端 UI）
- **M5：** 用户管理 UI（需要前端 UI）
- **M6：** Dry Run 模式 UI（需要前端 UI）

---

## 🎯 验收标准总结

### M1 验收标准
- ✅ 前端登录后，能成功获取后端 token
- ✅ 前端调用 `/api/me` 能正确返回用户信息
- ✅ 多用户登录时，每个用户能看到自己的积分
- ✅ 后端不可用时，前端明确提示错误

### M2 验收标准
- ✅ 所有 AI 调用都经过后端计费系统
- ✅ Dry Run 模式下，不调用真实 AI API
- ✅ Real 模式下，先扣费再调用 AI API
- ✅ 用户能看到当前模式（DRY_RUN/REAL）

### M3 验收标准
- ✅ 数据库连接正常
- ✅ 后端服务运行正常
- ✅ 健康检查接口返回正常
- ✅ 登录接口返回正常

### M4 验收标准
- ✅ 用户能快速识别错误类型
- ✅ 错误信息明确，不会混淆
- ✅ 错误日志能帮助排查问题

### M5 验收标准
- ✅ 用户能看到自己的信息（余额、模式等）
- ✅ 管理员能管理用户（查看、充值等）
- ✅ 用户能查看自己的交易记录

### M6 验收标准
- ✅ 用户能清楚看到当前模式
- ✅ 管理员能切换用户模式
- ✅ 有完整的 Dry Run 模式文档

---

## 📅 时间估算

### 第一阶段：地基修复（1-2 周）

- **M1：** 2-3 天
- **M2：** 3-4 天
- **M3：** 1-2 天
- **总计：** 6-9 天（约 1-2 周）

### 第二阶段：体验优化（1-2 周）

- **M4：** 2-3 天
- **M5：** 3-4 天
- **总计：** 5-7 天（约 1-2 周）

### 第三阶段：功能增强（1 周）

- **M6：** 2-3 天
- **总计：** 2-3 天（约 1 周）

### 总时间估算

**最短时间：** 13 天（约 2.5 周）  
**最长时间：** 19 天（约 4 周）  
**建议时间：** 16 天（约 3 周）

---

## 🔄 迭代建议

### 迭代 1：紧急修复（第 1 周）

**目标：** 修复"花钱不可控"的问题

**任务：**
- M1：修复用户身份链路
- M2：修复 AI 调用计费
- M3：验证运行状态

**验收：**
- ✅ 所有 AI 调用都经过后端 Dry Run 检查
- ✅ Dry Run 模式下不会产生真实费用

### 迭代 2：体验优化（第 2 周）

**目标：** 提高用户体验

**任务：**
- M4：改进错误处理
- M5：完善用户管理 UI

**验收：**
- ✅ 用户能快速识别错误类型
- ✅ 用户能看到自己的信息和交易记录

### 迭代 3：功能增强（第 3 周）

**目标：** 完善 Dry Run 模式

**任务：**
- M6：完善 Dry Run 模式 UI 和文档

**验收：**
- ✅ 用户能清楚看到当前模式
- ✅ 管理员能切换用户模式
- ✅ 有完整的 Dry Run 模式文档

---

**规划结束**

