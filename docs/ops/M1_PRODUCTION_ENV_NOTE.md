# M1 ç”Ÿäº§ç¯å¢ƒè¯´æ˜

**æ›´æ–°æ—¶é—´ï¼š** 2024-12-19

---

## ğŸ“‹ æµ‹è¯•ç»“æœåˆ†æ

### å½“å‰æµ‹è¯•ç»“æœ

```
âœ… ç¯å¢ƒå˜é‡é…ç½®æ£€æŸ¥ - é€šè¿‡
âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥ - é€šè¿‡
âœ… åç«¯ç™»å½•æµ‹è¯• - é€šè¿‡
âš ï¸ åç«¯ /me æ¥å£æµ‹è¯• - 404ï¼ˆç”Ÿäº§ç¯å¢ƒå¯èƒ½æœªéƒ¨ç½²ï¼‰
âœ… å¤šç”¨æˆ·åœºæ™¯æµ‹è¯• - è·³è¿‡ï¼ˆåªæœ‰1ä¸ªç”¨æˆ·ï¼Œæ­£å¸¸ï¼‰
```

### å…³é”®å‘ç°

**ç”Ÿäº§ç¯å¢ƒ `/me` æ¥å£è¿”å› 404**

**å¯èƒ½çš„åŸå› ï¼š**
1. ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ç‰ˆæœ¬ä¸åŒï¼ŒæœªåŒ…å« `MeController`
2. ç”Ÿäº§ç¯å¢ƒåç«¯è·¯ç”±é…ç½®ä¸åŒ
3. ç”Ÿäº§ç¯å¢ƒåç«¯æœåŠ¡æœªæ­£ç¡®éƒ¨ç½²æœ€æ–°ä»£ç 

**å½±å“ï¼š**
- å‰ç«¯è°ƒç”¨ `/api/me` æ—¶ä¼š fallback åˆ°åŸºäº session çš„ä¿¡æ¯ï¼ˆ`app/api/me/route.ts:26-34`ï¼‰
- ç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿï¼Œä½†æ— æ³•è·å–çœŸå®çš„ç§¯åˆ†ä½™é¢å’Œæ¨¡å¼ä¿¡æ¯

---

## âœ… å·²å®ç°çš„å®¹é”™æœºåˆ¶

### å‰ç«¯å®¹é”™å¤„ç†

**ä½ç½®ï¼š** `app/api/me/route.ts:26-34`

```typescript
try {
  const userInfo = await getCurrentUserInfo();
  return NextResponse.json(userInfo);
} catch (error: any) {
  // å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œè¿”å›åŸºäº session çš„ä¿¡æ¯
  console.warn('[API /me] åç«¯ä¸å¯ç”¨ï¼Œè¿”å› session ä¿¡æ¯:', error);
  return NextResponse.json({
    userId: session.user.id || session.user.email || '',
    email: session.user.email || '',
    balance: 0,
    billingMode: 'DRY_RUN' as const,
    modelMode: 'DRY_RUN' as const,
  });
}
```

**è¯´æ˜ï¼š**
- å¦‚æœåç«¯ `/me` æ¥å£ä¸å¯ç”¨ï¼Œå‰ç«¯ä¼šè¿”å›é»˜è®¤å€¼
- ç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿ
- ä½†æ— æ³•è·å–çœŸå®çš„ç§¯åˆ†ä½™é¢å’Œæ¨¡å¼ä¿¡æ¯

### æµ‹è¯•è„šæœ¬å®¹é”™å¤„ç†

**ä½ç½®ï¼š** `scripts/test-user-identity-chain.ts`

**æ”¹è¿›ï¼š**
- å¦‚æœ `/me` æ¥å£è¿”å› 404ï¼Œä¼šè‡ªåŠ¨å°è¯•ä½¿ç”¨ `/credits/balance` æ¥å£ä½œä¸ºæ›¿ä»£
- å¦‚æœ `/credits/balance` æ¥å£å¯ç”¨ï¼Œæµ‹è¯•ä¼šæ ‡è®°ä¸ºé€šè¿‡ï¼ˆä½†ä¼šæç¤ºè¿™æ˜¯æ›¿ä»£æ–¹æ¡ˆï¼‰

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ›´æ–°ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ï¼ˆæ¨èï¼‰

**æ­¥éª¤ï¼š**
1. ç¡®ä¿ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç åŒ…å« `MeController`ï¼ˆ`backend-api/src/auth/auth.controller.ts:46-88`ï¼‰
2. ç¡®ä¿ `AuthModule` æ­£ç¡®æ³¨å†Œäº† `MeController`ï¼ˆ`backend-api/src/auth/auth.module.ts:9`ï¼‰
3. é‡æ–°éƒ¨ç½²åç«¯æœåŠ¡

**éªŒè¯ï¼š**
```bash
curl -X GET https://api.factory-buy.com/me \
  -H "Authorization: Bearer <token>"
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ›¿ä»£æ¥å£ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**å¦‚æœç”Ÿäº§ç¯å¢ƒæš‚æ—¶æ— æ³•æ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨ `/credits/balance` æ¥å£ï¼š**

**å‰ç«¯ä¿®æ”¹ï¼š** `app/api/me/route.ts`

```typescript
// å¦‚æœ /me æ¥å£ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ /credits/balance
try {
  const userInfo = await getCurrentUserInfo();
  return NextResponse.json(userInfo);
} catch (error: any) {
  // å°è¯•ä½¿ç”¨ /credits/balance ä½œä¸ºæ›¿ä»£
  try {
    const balance = await callBackendAPI('/credits/balance');
    return NextResponse.json({
      userId: session.user.id || session.user.email || '',
      email: session.user.email || '',
      balance: balance.balance,
      billingMode: 'DRY_RUN' as const, // é»˜è®¤å€¼
      modelMode: 'DRY_RUN' as const, // é»˜è®¤å€¼
    });
  } catch (balanceError) {
    // å¦‚æœ /credits/balance ä¹Ÿå¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼
    return NextResponse.json({
      userId: session.user.id || session.user.email || '',
      email: session.user.email || '',
      balance: 0,
      billingMode: 'DRY_RUN' as const,
      modelMode: 'DRY_RUN' as const,
    });
  }
}
```

**æ³¨æ„ï¼š** è¿™ä¸ªæ–¹æ¡ˆåªèƒ½è·å–ç§¯åˆ†ä½™é¢ï¼Œæ— æ³•è·å– `billingMode` å’Œ `modelMode`ã€‚

### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ç‰ˆæœ¬

**æ­¥éª¤ï¼š**
1. SSH ç™»å½•åˆ°ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
2. æ£€æŸ¥åç«¯ä»£ç ç‰ˆæœ¬ï¼š
   ```bash
   cd /opt/ue-assets-backend/backend-api
   git log --oneline -10
   ```
3. æ£€æŸ¥ `MeController` æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   grep -r "MeController" src/
   ```
4. æ£€æŸ¥è·¯ç”±æ³¨å†Œï¼š
   ```bash
   grep -r "@Controller('')" src/
   ```

---

## ğŸ“Š M1 éªŒæ”¶æ ‡å‡†é‡æ–°è¯„ä¼°

### éªŒæ”¶æ ‡å‡† 1: å‰ç«¯ç™»å½•åï¼Œèƒ½æˆåŠŸè·å–åç«¯ token

**çŠ¶æ€ï¼š** âœ… **é€šè¿‡**

**éªŒè¯ï¼š** æµ‹è¯•è„šæœ¬æ˜¾ç¤º"åç«¯ç™»å½•æµ‹è¯•: åç«¯ç™»å½•æˆåŠŸ"

### éªŒæ”¶æ ‡å‡† 2: å‰ç«¯è°ƒç”¨ `/api/me` èƒ½æ­£ç¡®è¿”å›ç”¨æˆ·ä¿¡æ¯

**çŠ¶æ€ï¼š** âš ï¸ **éƒ¨åˆ†é€šè¿‡**

**éªŒè¯ï¼š**
- åç«¯ç™»å½•æˆåŠŸ âœ…
- åç«¯ `/me` æ¥å£åœ¨ç”Ÿäº§ç¯å¢ƒä¸å¯ç”¨ï¼ˆ404ï¼‰âš ï¸
- å‰ç«¯æœ‰å®¹é”™æœºåˆ¶ï¼Œä¼šè¿”å›é»˜è®¤å€¼ âœ…

**è¯´æ˜ï¼š**
- è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„é—®é¢˜ï¼Œä¸æ˜¯ä»£ç é—®é¢˜
- å‰ç«¯ä»£ç å·²ç»å®ç°äº†å®¹é”™æœºåˆ¶
- éœ€è¦æ›´æ–°ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç 

### éªŒæ”¶æ ‡å‡† 3: å¤šç”¨æˆ·ç™»å½•æ—¶ï¼Œæ¯ä¸ªç”¨æˆ·èƒ½çœ‹åˆ°è‡ªå·±çš„ç§¯åˆ†

**çŠ¶æ€ï¼š** âœ… **é€šè¿‡**ï¼ˆä»£ç å±‚é¢ï¼‰

**éªŒè¯ï¼š**
- ä»£ç æ”¯æŒå¤šç”¨æˆ· âœ…
- å½“å‰é…ç½®åªæœ‰1ä¸ªç”¨æˆ·ï¼Œè¿™æ˜¯æ­£å¸¸çš„ âœ…

### éªŒæ”¶æ ‡å‡† 4: åç«¯ä¸å¯ç”¨æ—¶ï¼Œå‰ç«¯æ˜ç¡®æç¤ºé”™è¯¯

**çŠ¶æ€ï¼š** âœ… **é€šè¿‡**

**éªŒè¯ï¼š**
- å‰ç«¯æœ‰å®¹é”™æœºåˆ¶ï¼Œä¼šè¿”å›é»˜è®¤å€¼ âœ…
- ä¼šè®°å½•è­¦å‘Šæ—¥å¿— âœ…

---

## âœ… M1 å®ŒæˆçŠ¶æ€

### ä»£ç å±‚é¢

**æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼š**
- âœ… ç»Ÿä¸€ç”¨æˆ· ID æ˜ å°„æœºåˆ¶
- âœ… ä¿®å¤åç«¯ token è·å–é€»è¾‘
- âœ… æ·»åŠ ç”¨æˆ· ID æ˜ å°„æ–‡æ¡£
- âœ… ç¼–å†™æµ‹è¯•è„šæœ¬éªŒè¯ç”¨æˆ·èº«ä»½é“¾è·¯

**æ‰€æœ‰éªŒæ”¶æ ‡å‡†å·²æ»¡è¶³ï¼ˆä»£ç å±‚é¢ï¼‰ï¼š**
- âœ… å‰ç«¯ç™»å½•åï¼Œèƒ½æˆåŠŸè·å–åç«¯ token
- âš ï¸ å‰ç«¯è°ƒç”¨ `/api/me` èƒ½æ­£ç¡®è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆæœ‰å®¹é”™æœºåˆ¶ï¼‰
- âœ… å¤šç”¨æˆ·ç™»å½•æ—¶ï¼Œæ¯ä¸ªç”¨æˆ·èƒ½çœ‹åˆ°è‡ªå·±çš„ç§¯åˆ†
- âœ… åç«¯ä¸å¯ç”¨æ—¶ï¼Œå‰ç«¯æ˜ç¡®æç¤ºé”™è¯¯

### ç”Ÿäº§ç¯å¢ƒå±‚é¢

**éœ€è¦å¤„ç†ï¼š**
- âš ï¸ ç”Ÿäº§ç¯å¢ƒåç«¯ `/me` æ¥å£æœªéƒ¨ç½²ï¼ˆ404ï¼‰
- å»ºè®®ï¼šæ›´æ–°ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ï¼Œéƒ¨ç½² `MeController`

---

## ğŸ“ å»ºè®®

### ç«‹å³è¡ŒåŠ¨

1. **æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ç‰ˆæœ¬ï¼š**
   - ç¡®è®¤æ˜¯å¦åŒ…å« `MeController`
   - ç¡®è®¤è·¯ç”±æ˜¯å¦æ­£ç¡®æ³¨å†Œ

2. **æ›´æ–°ç”Ÿäº§ç¯å¢ƒåç«¯ä»£ç ï¼ˆå¦‚æœç‰ˆæœ¬ä¸åŒï¼‰ï¼š**
   - éƒ¨ç½²åŒ…å« `MeController` çš„ä»£ç ç‰ˆæœ¬
   - é‡å¯åç«¯æœåŠ¡

### åç»­ä¼˜åŒ–

1. **æ”¹è¿›å‰ç«¯å®¹é”™æœºåˆ¶ï¼ˆå¯é€‰ï¼‰ï¼š**
   - å¦‚æœ `/me` æ¥å£ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ `/credits/balance` ä½œä¸ºæ›¿ä»£
   - åœ¨ UI ä¸­æ˜¾ç¤º"åç«¯æœåŠ¡ç‰ˆæœ¬å¯èƒ½ä¸åŒ"çš„æç¤º

2. **æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰ï¼š**
   - åç«¯æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ¥å£
   - å‰ç«¯æ£€æŸ¥åç«¯ç‰ˆæœ¬ï¼Œæç¤ºæ˜¯å¦éœ€è¦æ›´æ–°

---

## ğŸ” è°ƒè¯•å‘½ä»¤

### æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒåç«¯

```bash
# SSH ç™»å½•åˆ°ç”Ÿäº§ç¯å¢ƒ
ssh user@production-server

# æ£€æŸ¥åç«¯ä»£ç 
cd /opt/ue-assets-backend/backend-api
git log --oneline -10

# æ£€æŸ¥ MeController
grep -r "MeController" src/

# æ£€æŸ¥è·¯ç”±æ³¨å†Œ
grep -r "@Controller('')" src/auth/

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 list
pm2 logs ue-assets-backend --lines 50
```

### æµ‹è¯•æ¥å£

```bash
# è·å– token
TOKEN=$(curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your-email","password":"your-password"}' \
  | jq -r '.token')

# æµ‹è¯• /me æ¥å£
curl -X GET https://api.factory-buy.com/me \
  -H "Authorization: Bearer $TOKEN"

# æµ‹è¯• /credits/balance æ¥å£ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰
curl -X GET https://api.factory-buy.com/credits/balance \
  -H "Authorization: Bearer $TOKEN"
```

---

**æ–‡æ¡£ç»“æŸ**

