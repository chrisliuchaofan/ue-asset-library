# M5.1ï¼šæœåŠ¡å™¨ç«¯æ•°æ®å±‚è¿ç§»

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ç›®æ ‡ï¼š** å°† Dream Factory é¡¹ç›®æ•°æ®ä» localStorage è¿ç§»åˆ°æœåŠ¡å™¨ç«¯ï¼ˆPostgreSQLï¼‰

**ä¼˜å…ˆçº§ï¼š** é«˜ï¼ˆæ•°æ®å®‰å…¨å’Œè·¨è®¾å¤‡åŒæ­¥ï¼‰

**é¢„è®¡æ—¶é—´ï¼š** 3-4 å¤©

**ä¾èµ–ï¼š** M5 æµ‹è¯•å®Œæˆ

---

## ğŸ¯ å½“å‰é—®é¢˜

### æœ¬åœ°å­˜å‚¨çš„é—®é¢˜

**Dream Factory é¡¹ç›®æ•°æ®**ï¼ˆ`lib/dream-factory/project-storage.ts`ï¼‰
- âŒ åªå­˜å‚¨åœ¨æµè§ˆå™¨ localStorage ä¸­
- âŒ æ¢è®¾å¤‡å°±ä¸¢å¤±
- âŒ æ— æ³•è·¨è®¾å¤‡åŒæ­¥
- âŒ æ•°æ®ä¸å®‰å…¨ï¼ˆæµè§ˆå™¨æ¸…ç†ä¼šä¸¢å¤±ï¼‰
- âŒ æ— æ³•å¤‡ä»½å’Œæ¢å¤

---

## ğŸ“ å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šåç«¯æ•°æ®å±‚ï¼ˆæ•°æ®åº“å®ä½“å’Œ APIï¼‰

#### 1.1 åˆ›å»º Project å®ä½“

**æ–‡ä»¶ï¼š** `backend-api/src/database/entities/project.entity.ts`

**å­—æ®µï¼š**
- `id` (UUID, Primary Key)
- `userId` (String, Foreign Key -> users.id)
- `title` (String)
- `originalIdea` (Text)
- `selectedConcept` (JSONB, nullable)
- `storyboard` (JSONB)
- `mergedVideoUrl` (String, nullable)
- `createdAt` (Timestamp)
- `updatedAt` (Timestamp)
- `completedAt` (Timestamp, nullable)

**ç´¢å¼•ï¼š**
- `userId` + `createdAt` (ç”¨äºå¿«é€ŸæŸ¥è¯¢ç”¨æˆ·é¡¹ç›®åˆ—è¡¨)
- `userId` + `updatedAt` (ç”¨äºæ’åº)

#### 1.2 åˆ›å»º Projects Service

**æ–‡ä»¶ï¼š** `backend-api/src/projects/projects.service.ts`

**æ–¹æ³•ï¼š**
- `create(userId, projectData)` - åˆ›å»ºé¡¹ç›®
- `findAll(userId)` - è·å–ç”¨æˆ·æ‰€æœ‰é¡¹ç›®ï¼ˆæŒ‰æ›´æ–°æ—¶é—´å€’åºï¼‰
- `findOne(id, userId)` - è·å–å•ä¸ªé¡¹ç›®
- `update(id, userId, updates)` - æ›´æ–°é¡¹ç›®
- `delete(id, userId)` - åˆ é™¤é¡¹ç›®

#### 1.3 åˆ›å»º Projects Controller

**æ–‡ä»¶ï¼š** `backend-api/src/projects/projects.controller.ts`

**API ç«¯ç‚¹ï¼š**
- `POST /projects` - åˆ›å»ºé¡¹ç›®
- `GET /projects` - è·å–ç”¨æˆ·æ‰€æœ‰é¡¹ç›®
- `GET /projects/:id` - è·å–å•ä¸ªé¡¹ç›®
- `PATCH /projects/:id` - æ›´æ–°é¡¹ç›®
- `DELETE /projects/:id` - åˆ é™¤é¡¹ç›®

**è®¤è¯ï¼š** æ‰€æœ‰æ¥å£éƒ½éœ€è¦ `@UseGuards(AuthGuard)`

---

### é˜¶æ®µ 2ï¼šå‰ç«¯ API è·¯ç”±

#### 2.1 åˆ›å»ºå‰ç«¯ API è·¯ç”±

**æ–‡ä»¶ï¼š**
- `app/api/projects/route.ts` - åˆ›å»ºå’Œè·å–é¡¹ç›®åˆ—è¡¨
- `app/api/projects/[id]/route.ts` - è·å–ã€æ›´æ–°ã€åˆ é™¤å•ä¸ªé¡¹ç›®

**åŠŸèƒ½ï¼š**
- ä»£ç†åç«¯ API è°ƒç”¨
- å¤„ç†è®¤è¯ï¼ˆè‡ªåŠ¨æºå¸¦ tokenï¼‰
- é”™è¯¯å¤„ç†ï¼ˆä½¿ç”¨ `handleApiRouteError`ï¼‰

---

### é˜¶æ®µ 3ï¼šå‰ç«¯å­˜å‚¨å±‚æ”¹é€ 

#### 3.1 ä¿®æ”¹ project-storage.ts

**ç­–ç•¥ï¼š**
- ä¼˜å…ˆä½¿ç”¨åç«¯ API
- å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œå›é€€åˆ° localStorage
- æä¾›ç»Ÿä¸€çš„æ¥å£ï¼ˆä¸æ”¹å˜ç°æœ‰è°ƒç”¨æ–¹å¼ï¼‰

**æ–°æ¥å£ï¼ˆä¿æŒå¼‚æ­¥ï¼‰ï¼š**
```typescript
export async function saveProject(project: ProjectState, title?: string): Promise<string>
export async function getAllSavedProjects(): Promise<SavedProject[]>
export async function getProject(projectId: string): Promise<SavedProject | null>
export async function updateProject(projectId: string, updates: Partial<SavedProject>): Promise<void>
export async function deleteProject(projectId: string): Promise<void>
```

**å®ç°é€»è¾‘ï¼š**
1. å°è¯•è°ƒç”¨åç«¯ API
2. å¦‚æœæˆåŠŸï¼Œè¿”å›ç»“æœ
3. å¦‚æœå¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ã€åç«¯ä¸å¯ç”¨ï¼‰ï¼Œå›é€€åˆ° localStorage
4. è®°å½•æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥

#### 3.2 æ›´æ–° dream-factory/page.tsx

**ä¿®æ”¹ï¼š**
- æ‰€æœ‰ `saveProject`ã€`getAllSavedProjects`ã€`deleteProject` è°ƒç”¨æ”¹ä¸º `await`
- æ·»åŠ åŠ è½½çŠ¶æ€
- æ·»åŠ é”™è¯¯å¤„ç†

---

### é˜¶æ®µ 4ï¼šæ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

#### 4.1 è¿ç§»ç°æœ‰ localStorage æ•°æ®

**åŠŸèƒ½ï¼š**
- æ£€æµ‹ localStorage ä¸­æ˜¯å¦æœ‰é¡¹ç›®æ•°æ®
- å¦‚æœæœ‰ï¼Œå°è¯•ä¸Šä¼ åˆ°æœåŠ¡å™¨
- ä¸Šä¼ æˆåŠŸåï¼Œæ¸…é™¤ localStorage æ•°æ®

**è§¦å‘æ—¶æœºï¼š**
- ç”¨æˆ·ç™»å½•å
- é¦–æ¬¡è®¿é—® Dream Factory é¡µé¢æ—¶

**å®ç°ï¼š**
- åœ¨ `dream-factory/page.tsx` çš„ `useEffect` ä¸­æ£€æµ‹
- å¦‚æœæ£€æµ‹åˆ° localStorage æ•°æ®ï¼Œæ˜¾ç¤ºè¿ç§»æç¤º
- ç”¨æˆ·ç¡®è®¤åï¼Œæ‰¹é‡ä¸Šä¼ åˆ°æœåŠ¡å™¨

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¿ç§»

**åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼š** `backend-api/src/database/migrations/XXXXXX-create-projects-table.ts`

**SQLï¼š**
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL,
  title VARCHAR(255) NOT NULL,
  original_idea TEXT NOT NULL,
  selected_concept JSONB,
  storyboard JSONB NOT NULL,
  merged_video_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_projects_user_id_created_at ON projects(user_id, created_at DESC);
CREATE INDEX idx_projects_user_id_updated_at ON projects(user_id, updated_at DESC);
```

---

### API è®¾è®¡

#### POST /projects
**è¯·æ±‚ï¼š**
```json
{
  "title": "é¡¹ç›®æ ‡é¢˜",
  "originalIdea": "åŸå§‹åˆ›æ„",
  "selectedConcept": { ... },
  "storyboard": [ ... ]
}
```

**å“åº”ï¼š**
```json
{
  "id": "uuid",
  "title": "é¡¹ç›®æ ‡é¢˜",
  "originalIdea": "åŸå§‹åˆ›æ„",
  "selectedConcept": { ... },
  "storyboard": [ ... ],
  "createdAt": "2024-12-15T10:00:00Z",
  "updatedAt": "2024-12-15T10:00:00Z"
}
```

#### GET /projects
**å“åº”ï¼š**
```json
{
  "projects": [
    {
      "id": "uuid",
      "title": "é¡¹ç›®æ ‡é¢˜",
      "originalIdea": "åŸå§‹åˆ›æ„",
      "createdAt": "2024-12-15T10:00:00Z",
      "updatedAt": "2024-12-15T10:00:00Z"
    }
  ]
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - âœ… å¯ä»¥ä¿å­˜é¡¹ç›®åˆ°æœåŠ¡å™¨
   - âœ… å¯ä»¥è·å–é¡¹ç›®åˆ—è¡¨
   - âœ… å¯ä»¥æ›´æ–°é¡¹ç›®
   - âœ… å¯ä»¥åˆ é™¤é¡¹ç›®
   - âœ… åç«¯ä¸å¯ç”¨æ—¶ï¼Œå›é€€åˆ° localStorage

2. **æ•°æ®ä¸€è‡´æ€§**
   - âœ… é¡¹ç›®æ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
   - âœ… é¡¹ç›®ä¸ç”¨æˆ·æ­£ç¡®å…³è”
   - âœ… æ—¶é—´æˆ³æ­£ç¡®è®°å½•
   - âœ… æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆJSONBï¼‰

3. **ç”¨æˆ·ä½“éªŒ**
   - âœ… ä¿å­˜/åŠ è½½é€Ÿåº¦å¯æ¥å—
   - âœ… é”™è¯¯æç¤ºå‹å¥½
   - âœ… æ•°æ®è¿ç§»è¿‡ç¨‹é€æ˜
   - âœ… å‘åå…¼å®¹ï¼ˆlocalStorage æ•°æ®å¯ä»¥è¿ç§»ï¼‰

4. **å®‰å…¨æ€§**
   - âœ… ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„é¡¹ç›®
   - âœ… æ‰€æœ‰ API éƒ½éœ€è¦è®¤è¯
   - âœ… æ•°æ®éªŒè¯ï¼ˆé˜²æ­¢æ¶æ„æ•°æ®ï¼‰

---

## ğŸ“… å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šåç«¯å®ä½“å’Œ Serviceï¼ˆ1-2 å¤©ï¼‰

1. åˆ›å»º `Project` entity
2. åˆ›å»º `ProjectsService`
3. åˆ›å»ºæ•°æ®åº“è¿ç§»
4. æµ‹è¯• Service æ–¹æ³•

### æ­¥éª¤ 2ï¼šåç«¯ Controllerï¼ˆ0.5 å¤©ï¼‰

1. åˆ›å»º `ProjectsController`
2. å®ç°æ‰€æœ‰ API ç«¯ç‚¹
3. æ·»åŠ è®¤è¯å’Œæƒé™æ£€æŸ¥
4. æµ‹è¯• API ç«¯ç‚¹

### æ­¥éª¤ 3ï¼šå‰ç«¯ API è·¯ç”±ï¼ˆ0.5 å¤©ï¼‰

1. åˆ›å»º `/api/projects` è·¯ç”±
2. åˆ›å»º `/api/projects/[id]` è·¯ç”±
3. æ·»åŠ é”™è¯¯å¤„ç†
4. æµ‹è¯• API è·¯ç”±

### æ­¥éª¤ 4ï¼šå‰ç«¯å­˜å‚¨å±‚æ”¹é€ ï¼ˆ1 å¤©ï¼‰

1. ä¿®æ”¹ `project-storage.ts`ï¼Œæ·»åŠ åç«¯ API è°ƒç”¨
2. å®ç°å›é€€é€»è¾‘ï¼ˆlocalStorageï¼‰
3. æ›´æ–° `dream-factory/page.tsx`ï¼Œæ”¹ä¸ºå¼‚æ­¥è°ƒç”¨
4. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

### æ­¥éª¤ 5ï¼šæ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼Œ0.5 å¤©ï¼‰

1. å®ç° localStorage æ•°æ®æ£€æµ‹
2. å®ç°æ‰¹é‡ä¸Šä¼ åŠŸèƒ½
3. æ·»åŠ è¿ç§»æç¤º UI
4. æµ‹è¯•è¿ç§»åŠŸèƒ½

---

## ğŸš€ å¼€å§‹æ—¶é—´

**ç­‰å¾… M5 æµ‹è¯•å®Œæˆåå¼€å§‹**

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [M5 å®Œæˆæ€»ç»“](./M5_COMPLETION_SUMMARY.md)
- [æœåŠ¡å™¨ç«¯æ•°æ®å±‚è¿ç§»è®¡åˆ’](../../æœåŠ¡å™¨ç«¯æ•°æ®å±‚è¿ç§»è®¡åˆ’.md)

