# 📋 下一轮开发规划 - 最终输出

**生成时间：** 2024-12-19  
**基于文档：** `00_PROJECT_REALITY.md`、`01_DEVELOPMENT_ROADMAP.md`、`现状对齐报告.md`

---

## 第一部分：现状对齐报告

### ✅ 已完成的功能（代码层面已可用）

1. **认证与用户系统**
   - 前端认证系统（NextAuth.js）
   - 后端用户系统（PostgreSQL + 用户实体）
   - 积分系统（账本化设计）
   - 前后端身份链路（已修复）
   - 管理员权限检查

2. **资产库功能**
   - 资产列表、搜索、筛选
   - 素材列表、搜索、筛选
   - 文件上传（支持本地存储和 OSS 存储）

3. **AI 功能（梦工厂）**
   - AI 文本生成（已接入后端计费）
   - AI 图像生成（已接入后端计费）
   - AI 视频生成（已接入后端计费）
   - Dry Run 模式支持

4. **存储系统**
   - OSS 存储服务（后端 `StorageService` 已实现）
   - JobOutput 实体（数据库实体已定义）

5. **管理员功能**
   - 管理员充值接口
   - 路由保护

### ⚠️ 部分完成 / 结构存在但不可用的功能

1. **生成产物上传到 OSS**
   - 后端 `StorageService` 已实现
   - 前端生成路径可能未完全接入后端上传流程

2. **管理员入口与普通用户入口区分**
   - 路由保护已实现
   - UI 层面未明确区分

### ❌ 文档中提到、但代码中尚未实现的功能

1. **兑换码系统**
   - 完全未实现（数据库实体、后端接口、前端 UI 都没有）

### 📝 与 00_PROJECT_REALITY.md 不一致的地方

1. **前端 AI 调用已接入后端计费**（文档描述已过时）
2. **前后端用户身份链路已修复**（文档描述已过时）
3. **生成产物上传到 OSS 的状态**（部分完成，需要完善）

---

## 第二部分：下一轮开发 Roadmap（M 级拆分）

### M7：生成产物统一上传到 OSS

**目标：** 确保所有生成的图片/视频产物统一上传到 OSS，数据库存储 OSS URL 与元信息，本地磁盘不得作为长期存储

**核心任务：**
1. 确认后端上传流程（检查后端 AI 控制器是否已接入 `StorageService`）
2. 修复前端生成路径（确保所有生成路径都返回 OSS URL）
3. 验证上传流程（测试图片/视频生成后是否上传到 OSS）

**依赖：** M2（需要 AI 调用正常）

**预计时间：** 2-3 天

---

### M8：兑换码系统

**目标：** 引入积分体系，支持手动兑换码充值。兑换码由管理员手动生成与发放，适合小白操作，低风险，必须可追踪、可回收、可禁用

**核心任务：**
1. 数据库设计（创建 `RedeemCode` 实体）
2. 后端接口实现（生成、验证、使用、列表、禁用）
3. 前端接口实现（兑换、管理）
4. 前端 UI 实现（用户兑换界面、管理员管理界面）

**依赖：** M1, M2（需要用户身份链路和积分系统正常）

**预计时间：** 4-5 天

---

### M9：明确区分管理员入口与普通用户入口

**目标：** 明确区分管理员入口与普通用户入口。管理员：管理资产、兑换码、用户积分。普通用户：使用梦工厂、查看积分与历史。权限逻辑清晰，但实现尽量简单

**核心任务：**
1. 管理员入口 UI（用户管理、兑换码管理、积分管理）
2. 普通用户入口 UI（梦工厂、我的积分、兑换码兑换）
3. 权限检查优化（根据用户角色显示不同入口）
4. 用户体验优化（角色标识、视觉风格）

**依赖：** M7, M8（需要兑换码系统完成）

**预计时间：** 3-4 天

---

## 第三部分：每个 M 的验收标准（我怎么知道它完成了）

### M7 验收标准：生成产物统一上传到 OSS

#### 功能验收

1. **所有生成的图片都上传到 OSS**
   - [ ] 在梦工厂生成图片后，检查返回的 URL 是否是 OSS URL（包含 `oss-` 或 `aliyuncs.com`）
   - [ ] 检查数据库 `JobOutput` 表是否有对应记录
   - [ ] 验证图片 URL 可长期访问（不依赖临时 URL）

2. **所有生成的视频都上传到 OSS**
   - [ ] 在梦工厂生成视频后，检查返回的 URL 是否是 OSS URL
   - [ ] 检查数据库 `JobOutput` 表是否有对应记录
   - [ ] 验证视频 URL 可长期访问（不依赖临时 URL）

3. **数据库记录完整**
   - [ ] `JobOutput` 表记录 OSS URL（`ossUrl` 字段）
   - [ ] `JobOutput` 表记录 OSS 路径（`ossPath` 字段）
   - [ ] `JobOutput` 表记录文件大小（`size` 字段）
   - [ ] `JobOutput` 表记录元信息（`meta` 字段，如 width、height、duration）

#### 技术验收

1. **后端上传流程正常**
   - [ ] 后端 AI 控制器调用 `StorageService.uploadJobOutput()` 或 `uploadJobOutputFromSource()`
   - [ ] 后端上传成功后返回 OSS URL
   - [ ] 后端上传失败时返回明确错误信息

2. **前端生成路径正常**
   - [ ] `/api/ai/generate-image` 在 fallback 模式下也上传到 OSS
   - [ ] `/api/ai/generate-job` 在 fallback 模式下也上传到 OSS
   - [ ] 所有生成路径都返回 OSS URL，而不是 AI 服务商的临时 URL

#### 验收方法

1. **手动测试**
   - 在梦工厂生成一张图片，检查返回的 URL
   - 在梦工厂生成一个视频，检查返回的 URL
   - 检查数据库 `JobOutput` 表是否有对应记录

2. **自动化测试（可选）**
   - 编写测试脚本，模拟生成图片/视频，验证是否上传到 OSS
   - 验证数据库记录是否完整

---

### M8 验收标准：兑换码系统

#### 功能验收

1. **管理员能生成兑换码**
   - [ ] 管理员在 `/admin/redeem-codes` 页面能生成兑换码
   - [ ] 生成时能指定金额（如 100 积分）
   - [ ] 生成时能指定数量（如生成 10 个兑换码）
   - [ ] 生成时能指定过期时间（可选）
   - [ ] 生成的兑换码是唯一的（不重复）

2. **用户能使用兑换码充值积分**
   - [ ] 用户在 `/settings/redeem` 或 `/dream-factory` 页面能输入兑换码
   - [ ] 输入有效的兑换码后，用户积分增加
   - [ ] 兑换成功后，兑换码标记为已使用
   - [ ] 兑换成功后，记录使用者和使用时间

3. **兑换码验证正常**
   - [ ] 已使用的兑换码不能重复使用
   - [ ] 过期的兑换码不能使用
   - [ ] 禁用的兑换码不能使用
   - [ ] 不存在的兑换码不能使用

4. **管理员能管理兑换码**
   - [ ] 管理员能查看所有兑换码列表
   - [ ] 管理员能看到兑换码的使用情况（已使用/未使用）
   - [ ] 管理员能禁用兑换码
   - [ ] 禁用的兑换码不能使用

#### 技术验收

1. **数据库设计正确**
   - [ ] `RedeemCode` 表存在
   - [ ] 字段完整（code, amount, used, usedBy, usedAt, createdAt, expiresAt, disabled）
   - [ ] 索引正确（code, used, disabled）

2. **后端接口正常**
   - [ ] `POST /credits/admin/redeem-codes/generate` 能生成兑换码
   - [ ] `GET /credits/redeem-codes/:code` 能验证兑换码
   - [ ] `POST /credits/redeem-codes/:code/redeem` 能使用兑换码
   - [ ] `GET /credits/admin/redeem-codes` 能查询兑换码列表
   - [ ] `POST /credits/admin/redeem-codes/:code/disable` 能禁用兑换码

3. **前端接口正常**
   - [ ] `POST /api/credits/redeem` 能兑换兑换码
   - [ ] `GET /api/credits/admin/redeem-codes` 能查询兑换码列表
   - [ ] `POST /api/credits/admin/redeem-codes/generate` 能生成兑换码
   - [ ] `POST /api/credits/admin/redeem-codes/:code/disable` 能禁用兑换码

#### 验收方法

1. **手动测试**
   - 管理员生成一个兑换码（金额 100 积分）
   - 用户使用该兑换码充值，验证积分是否增加
   - 再次使用该兑换码，验证是否提示"已使用"
   - 管理员禁用该兑换码，验证是否不能使用
   - 管理员查看兑换码列表，验证使用情况

2. **边界测试**
   - 测试过期的兑换码（设置过期时间为过去时间）
   - 测试禁用的兑换码
   - 测试不存在的兑换码
   - 测试已使用的兑换码

---

### M9 验收标准：明确区分管理员入口与普通用户入口

#### 功能验收

1. **管理员能看到管理员专用入口**
   - [ ] 管理员登录后，在导航栏能看到"用户管理"入口
   - [ ] 管理员登录后，在导航栏能看到"兑换码管理"入口
   - [ ] 管理员登录后，在导航栏能看到"积分管理"入口
   - [ ] 管理员登录后，在导航栏能看到"资产管理"入口（现有 `/admin` 页面）

2. **普通用户能看到普通用户入口**
   - [ ] 普通用户登录后，在导航栏能看到"梦工厂"入口
   - [ ] 普通用户登录后，在导航栏能看到"我的积分"入口
   - [ ] 普通用户登录后，在导航栏能看到"兑换码兑换"入口
   - [ ] 普通用户登录后，在导航栏能看到"我的项目"入口

3. **权限检查正常**
   - [ ] 普通用户访问 `/admin/users` 时，显示权限不足提示
   - [ ] 普通用户访问 `/admin/redeem-codes` 时，显示权限不足提示
   - [ ] 管理员访问 `/admin/users` 时，能正常访问
   - [ ] 管理员访问 `/admin/redeem-codes` 时，能正常访问

4. **用户体验良好**
   - [ ] 导航栏根据用户角色显示不同入口（管理员看不到普通用户入口，普通用户看不到管理员入口）
   - [ ] 角色标识清晰（管理员/普通用户）
   - [ ] UI 清晰，用户能快速找到自己需要的功能

#### 技术验收

1. **权限检查逻辑正确**
   - [ ] 前端 `isAdmin()` 函数正确判断用户角色
   - [ ] 后端 `AdminGuard` 正确保护管理员接口
   - [ ] 路由保护正确（`middleware.ts` 保护 `/admin` 路由）

2. **UI 实现正确**
   - [ ] 导航栏根据用户角色动态显示入口
   - [ ] 权限不足时显示明确提示
   - [ ] 角色标识清晰（可选）

#### 验收方法

1. **手动测试**
   - 使用管理员账号登录，检查导航栏是否显示管理员入口
   - 使用普通用户账号登录，检查导航栏是否显示普通用户入口
   - 普通用户访问管理员页面，验证是否显示权限不足提示
   - 管理员访问管理员页面，验证是否能正常访问

2. **角色切换测试**
   - 使用不同角色的账号登录，验证导航栏显示是否正确
   - 验证权限检查是否正确

---

## 📊 验收标准总结

### M7 验收标准总结
- ✅ 所有生成的图片/视频都上传到 OSS
- ✅ 数据库 `JobOutput` 表记录 OSS URL 和元信息
- ✅ 前端返回的 URL 都是 OSS URL（不是 AI 服务商的临时 URL）
- ✅ 生成产物可长期访问（不依赖临时 URL）

### M8 验收标准总结
- ✅ 管理员能生成兑换码（指定金额、数量、过期时间）
- ✅ 用户能使用兑换码充值积分
- ✅ 兑换码使用后不能重复使用
- ✅ 过期的兑换码不能使用
- ✅ 禁用的兑换码不能使用
- ✅ 管理员能查看所有兑换码的使用情况
- ✅ 管理员能禁用兑换码
- ✅ 所有兑换码操作都有日志记录（可追踪）

### M9 验收标准总结
- ✅ 管理员能看到管理员专用入口（用户管理、兑换码管理、积分管理）
- ✅ 普通用户能看到普通用户入口（梦工厂、我的积分、兑换码兑换）
- ✅ 权限检查清晰，普通用户访问管理员页面时显示权限不足
- ✅ UI 清晰，用户能快速找到自己需要的功能

---

**文档结束**


