# 🗺️ 开发节奏规划 - M10-M12

**生成时间：** 2024-12-19  
**基于文档：** `00_PROJECT_REALITY.md`、`01_DEVELOPMENT_ROADMAP.md`、`现状自查报告.md`  
**规划原则：** 基于现实状态，不假设理想情况，不推翻现有系统

---

## 📋 规划前提

### 当前系统状态

👉 **系统分类：** 【多用户部分完成 / 核心功能可用】

**已完成里程碑：**
- ✅ M1-M6（历史冻结，不允许修改）
- ⚠️ M7-M9（进行中/待完成）

**核心问题：**
1. 🔴 **生成结果未明确区分"临时展示"和"已保存"**
2. 🔴 **OSS 上传失败时可能返回临时 URL**
3. 🟡 **管理员后台缺少前端页面**
4. 🟡 **积分补充与风控机制不完整**

**可用功能：**
- ✅ 前后端用户身份链路
- ✅ AI 调用后端计费
- ✅ 积分系统（账本化设计）
- ✅ OSS 存储服务（后端已实现）

**不可用功能：**
- ❌ 生成结果分层（临时/已保存）
- ❌ 管理员前端管理页面
- ❌ 积分补充与风控最小闭环

---

## 🎯 新增里程碑（M10-M12）

### M10：生成结果分层 + OSS 归档机制

**目标：**
- 生成结果分为「临时展示态」与「已保存态」
- 只有"保存项目"才触发 OSS 上传
- 前端保存前可立即查看结果（本地/缓存）
- 后端确保 OSS 失败不污染正式数据，支持重试

**必须完成的原因：**
- 符合"生成结果分层"的要求
- 避免未保存的生成产物占用 OSS 存储
- 确保只有用户明确保存的项目才归档到 OSS
- 提高用户体验（生成后立即查看，无需等待 OSS 上传）

**任务清单：**

1. **前端生成结果状态管理**
   - [ ] 定义生成结果状态：`'temporary' | 'saved'`
   - [ ] 生成后立即展示，标记为 `temporary`（前端状态）
   - [ ] 保存项目时，将生成结果标记为 `saved`，触发 OSS 上传
   - [ ] 前端缓存临时结果（localStorage 或内存），刷新后丢失

2. **后端 OSS 归档接口**
   - [ ] 创建归档接口：`POST /projects/:projectId/archive-outputs`
   - [ ] 接收临时结果 URL（AI 服务商临时 URL 或前端缓存）
   - [ ] 上传到 OSS，创建 `JobOutput` 记录
   - [ ] 返回 OSS URL，更新项目关联

3. **前端保存项目流程调整**
   - [ ] 修改 `saveProject()` 函数，保存项目时调用归档接口
   - [ ] 如果归档失败，项目仍可保存，但生成产物标记为"未归档"
   - [ ] 支持重试归档（管理员或用户手动触发）

4. **OSS 上传失败处理**
   - [ ] OSS 上传失败时，不污染正式数据（项目状态仍可保存）
   - [ ] 记录失败原因，支持重试
   - [ ] 前端显示"归档失败"提示，允许用户重试

5. **数据流说明文档**
   - [ ] 编写数据流说明（临时展示 → 保存项目 → OSS 归档）
   - [ ] 明确哪些数据存储在内存/缓存，哪些存储在数据库/OSS
   - [ ] 说明临时结果的生命周期（刷新后丢失）

**验收标准：**
- ✅ 生成后立即展示，标记为"临时"（前端状态）
- ✅ 保存项目时，生成产物上传到 OSS，标记为"已保存"
- ✅ OSS 上传失败时，项目仍可保存，但生成产物标记为"未归档"
- ✅ 支持重试归档（管理员或用户手动触发）
- ✅ 临时结果刷新后丢失，已保存结果可长期访问

**依赖：** M7（需要 OSS 上传功能正常）

**预计时间：** 3-4 天

**已知风险点：**
- 临时结果刷新后丢失，用户可能误以为已保存
- OSS 上传失败时，用户可能不知道需要重试
- 项目与生成产物的关联可能丢失（如果归档失败）

**接口调整点：**
- 新增：`POST /projects/:projectId/archive-outputs`（归档生成产物）
- 新增：`POST /projects/:projectId/retry-archive`（重试归档）
- 修改：`POST /projects`（保存项目时可选触发归档）

---

### M11：管理员后台（前端页面）

**目标：**
- 不再通过服务器终端或数据库盲操作系统
- 提供受 admin 权限保护的前端管理页面

**必须完成的原因：**
- 符合"管理能力必须前端可视化"的要求
- 降低操作门槛，不需要服务器终端或数据库知识
- 提高管理效率，可视化操作比命令行更直观

**任务清单：**

1. **用户列表页面**
   - [ ] 创建 `/admin/users` 页面
   - [ ] 显示用户列表（从后端 `GET /users` 获取）
   - [ ] 显示用户信息：email、积分余额、最后登录时间、模式（DRY_RUN/REAL）
   - [ ] 支持搜索和筛选（按 email、积分范围、模式）

2. **单用户积分查看**
   - [ ] 点击用户，显示用户详情
   - [ ] 显示积分余额（从后端 `GET /credits/balance` 获取）
   - [ ] 显示积分交易记录（从后端 `GET /credits/transactions` 获取）
   - [ ] 显示生成/消耗记录（从后端 `GET /jobs` 获取）

3. **手动加/扣积分（兑换码前置）**
   - [ ] 创建积分操作界面（加积分、扣积分）
   - [ ] 调用后端 `POST /credits/admin/recharge` 接口
   - [ ] 记录操作日志（操作者、目标用户、金额、原因）
   - [ ] 显示操作结果（成功/失败、新余额）

4. **用户生成/消耗记录查看**
   - [ ] 显示用户的所有生成任务（从后端 `GET /jobs?userId=xxx` 获取）
   - [ ] 显示任务状态、消耗积分、生成产物 URL
   - [ ] 支持筛选（按任务类型、状态、时间范围）

5. **权限保护**
   - [ ] 前端 `isAdmin()` 函数（检查 `session.user.email` 是否在 `ADMIN_USERS` 中）
   - [ ] 路由保护：`middleware.ts` 保护 `/admin/users`
   - [ ] 后端接口保护：`AdminGuard` 保护所有管理员接口
   - [ ] 权限不足时显示明确提示

**验收标准：**
- ✅ 管理员能查看用户列表
- ✅ 管理员能查看单用户积分和交易记录
- ✅ 管理员能手动加/扣积分（记录操作日志）
- ✅ 管理员能查看用户生成/消耗记录
- ✅ 普通用户访问管理员页面时显示权限不足
- ✅ 所有数据来自后端 API，前端不维护业务真相

**依赖：** M1（需要用户身份链路正常）

**预计时间：** 4-5 天

**UI 要求：**
- 不要求好看，但结构必须清晰
- 使用现有组件库（shadcn/ui）
- 响应式设计（移动端可用）

---

### M12：积分补充与风控最小闭环

**目标：**
- 支持前期内部使用，后期可接支付
- 明确积分来源和风控机制

**必须完成的原因：**
- 符合"积分补充与风控最小闭环"的要求
- 支持内部使用场景（初始赠送、管理员充值、兑换码）
- 为后期接入支付做准备（数据结构兼容）

**任务清单：**

1. **积分来源区分**
   - [ ] 在 `CreditTransaction` 实体中添加 `source` 字段（`'initial' | 'admin_recharge' | 'redeem_code' | 'payment'`）
   - [ ] 创建数据库迁移脚本
   - [ ] 更新 `CreditsService`，记录积分来源
   - [ ] 初始赠送：用户初始化时，记录 `source: 'initial'`
   - [ ] 管理员充值：调用 `recharge()` 时，记录 `source: 'admin_recharge'`
   - [ ] 兑换码：调用兑换码接口时，记录 `source: 'redeem_code'`
   - [ ] 支付：预留 `source: 'payment'`（暂不实现）

2. **积分日志表（不可删除、不可修改）**
   - [ ] 确认 `CreditTransaction` 实体已满足要求：
     - ✅ 不可删除：没有 `@DeleteDateColumn()`
     - ✅ 不可修改：没有 `@UpdateDateColumn()`，只有 `@CreateDateColumn()`
   - [ ] 添加 `source` 字段索引（用于统计）
   - [ ] 添加 `description` 字段（记录操作原因）

3. **防重复扣、误扣机制**
   - [ ] 确认幂等性约束已实现：
     - ✅ `@Unique(['userId', 'refId', 'action'])`（防止重复扣费）
   - [ ] 添加扣费前余额检查（防止误扣）
   - [ ] 添加扣费后余额验证（确保余额正确）
   - [ ] 添加每日消费限额检查（防止异常消费）

4. **明确哪些数据不可丢，哪些可裁剪**
   - [ ] **不可丢数据：**
     - `CreditTransaction` 表（积分交易记录，账本）
     - `User` 表（用户基本信息）
     - `Job` 表（生成任务记录，关联积分交易）
     - `JobOutput` 表（生成产物 OSS 引用）
   - [ ] **可裁剪数据：**
     - `LogEntry` 表（日志，可定期清理）
     - 临时生成结果（前端缓存，刷新后丢失）
   - [ ] 编写数据保留策略文档

5. **兑换码系统（M8 已完成，此处仅验证）**
   - [ ] 验证兑换码系统已实现（M8）
   - [ ] 验证兑换码使用记录积分来源为 `'redeem_code'`
   - [ ] 验证兑换码可追踪（兑换码表记录使用情况）

**验收标准：**
- ✅ 积分来源区分清晰（initial、admin_recharge、redeem_code、payment）
- ✅ 积分日志表不可删除、不可修改
- ✅ 防重复扣、误扣机制有效
- ✅ 明确哪些数据不可丢，哪些可裁剪
- ✅ 兑换码系统正常工作（M8）

**依赖：** M8（需要兑换码系统完成）

**预计时间：** 3-4 天

**数据保留策略：**
- **永久保留：** `CreditTransaction`、`User`、`Job`、`JobOutput`
- **定期清理：** `LogEntry`（保留 6 个月）
- **临时数据：** 前端缓存（刷新后丢失）

---

## 📊 里程碑依赖关系图

```
M7 (生成产物上传到 OSS)
  ↓
M10 (生成结果分层 + OSS 归档机制)
  ↓
M8 (兑换码系统)
  ↓
M12 (积分补充与风控最小闭环)
  ↓
M11 (管理员后台前端页面)
```

---

## 🎯 开发节奏建议

### 第一阶段：核心功能（1-2 周）

**时间：** 1-2 周

**里程碑：** M10

**目标：** 完成生成结果分层，确保只有保存的项目才归档到 OSS

**关键任务：**
1. 生成结果分层（临时/已保存）
2. OSS 归档机制（保存项目时触发）
3. OSS 上传失败处理（重试机制）

**验收标准：**
- ✅ 生成后立即展示，标记为"临时"
- ✅ 保存项目时，生成产物上传到 OSS
- ✅ OSS 上传失败时，支持重试

### 第二阶段：管理功能（1-2 周）

**时间：** 1-2 周

**里程碑：** M11, M12

**目标：** 完成管理员后台和积分风控机制

**关键任务：**
1. 管理员后台前端页面（用户列表、积分管理）
2. 积分来源区分（initial、admin_recharge、redeem_code）
3. 防重复扣、误扣机制完善

**验收标准：**
- ✅ 管理员能通过前端页面管理用户和积分
- ✅ 积分来源区分清晰
- ✅ 防重复扣、误扣机制有效

---

## 📅 时间估算

### 第一阶段：核心功能（1-2 周）

- **M10：** 3-4 天
- **总计：** 3-4 天（约 1 周）

### 第二阶段：管理功能（1-2 周）

- **M11：** 4-5 天
- **M12：** 3-4 天
- **总计：** 7-9 天（约 1.5-2 周）

### 总时间估算

**最短时间：** 10 天（约 2 周）  
**最长时间：** 13 天（约 2.5 周）  
**建议时间：** 11 天（约 2 周）

---

## ⚠️ 关键风险提示

### 风险 1：生成结果分层复杂

**影响：** 临时结果和已保存结果可能混淆

**缓解措施：**
- 明确状态标记（`'temporary' | 'saved'`）
- 保存项目时明确提示用户
- 临时结果刷新后丢失，需要用户明确保存

### 风险 2：OSS 上传失败

**影响：** 生成产物可能无法归档，用户可能不知道需要重试

**缓解措施：**
- OSS 上传失败时，项目仍可保存
- 显示"归档失败"提示，允许用户重试
- 管理员可以批量重试归档

### 风险 3：管理员后台权限泄露

**影响：** 普通用户可能访问管理员功能

**缓解措施：**
- 前端 `isAdmin()` 函数检查
- 后端 `AdminGuard` 保护
- 路由保护（`middleware.ts`）

---

## 📝 开发注意事项

### 1. 不推翻现有系统

**已实现的功能：**
- ✅ 积分系统（账本化设计）
- ✅ OSS 存储服务（后端已实现）
- ✅ 用户身份链路

**不要重复实现：**
- ❌ 不要重新实现积分系统
- ❌ 不要重新实现 OSS 上传
- ❌ 不要重新实现用户认证

**应该做的：**
- ✅ 在现有系统基础上扩展
- ✅ 修复现有功能的缺陷
- ✅ 添加缺失的功能

### 2. 数据库是唯一事实源

**原则：**
- 前端只负责展示，不维护业务真相
- 所有业务逻辑在后端
- 数据库是唯一事实源

**实现：**
- 前端调用后端 API 获取数据
- 前端不缓存业务数据（只缓存 UI 状态）
- 后端验证所有操作

### 3. OSS 只作为归档层

**原则：**
- OSS 只作为归档层，不作为即时展示层
- 临时结果可以存储在内存/缓存
- 只有保存的项目才归档到 OSS

**实现：**
- 生成后立即展示（前端状态）
- 保存项目时触发 OSS 归档
- OSS 上传失败时，项目仍可保存

### 4. 管理能力必须前端可视化

**原则：**
- 不再通过服务器终端或数据库盲操作系统
- 所有管理操作通过前端页面完成

**实现：**
- 管理员后台前端页面
- 所有数据来自后端 API
- 权限保护（前端+后端）

---

## 🎯 验收标准总结

### M10 验收标准
- ✅ 生成后立即展示，标记为"临时"（前端状态）
- ✅ 保存项目时，生成产物上传到 OSS，标记为"已保存"
- ✅ OSS 上传失败时，项目仍可保存，但生成产物标记为"未归档"
- ✅ 支持重试归档（管理员或用户手动触发）
- ✅ 临时结果刷新后丢失，已保存结果可长期访问

### M11 验收标准
- ✅ 管理员能查看用户列表
- ✅ 管理员能查看单用户积分和交易记录
- ✅ 管理员能手动加/扣积分（记录操作日志）
- ✅ 管理员能查看用户生成/消耗记录
- ✅ 普通用户访问管理员页面时显示权限不足
- ✅ 所有数据来自后端 API，前端不维护业务真相

### M12 验收标准
- ✅ 积分来源区分清晰（initial、admin_recharge、redeem_code、payment）
- ✅ 积分日志表不可删除、不可修改
- ✅ 防重复扣、误扣机制有效
- ✅ 明确哪些数据不可丢，哪些可裁剪
- ✅ 兑换码系统正常工作（M8）

---

**规划结束**







