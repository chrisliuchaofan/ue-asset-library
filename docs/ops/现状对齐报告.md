# 📊 现状对齐报告

**生成时间：** 2024-12-19  
**审计范围：** 全栈系统（前端 Next.js + 后端 NestJS + 数据库 PostgreSQL）  
**基于文档：** `00_PROJECT_REALITY.md`、`01_DEVELOPMENT_ROADMAP.md`

---

## 1️⃣ 已完成的功能（代码层面已可用）

### 认证与用户系统
- ✅ **前端认证系统**：NextAuth.js 实现多用户登录，支持密码认证
- ✅ **后端用户系统**：PostgreSQL 数据库 + 用户实体（User）
- ✅ **积分系统**：账本化设计（CreditTransaction），支持扣费、查询余额
- ✅ **前后端身份链路**：前端通过 `getBackendToken()` 获取后端 JWT token，已修复（代码显示已接入后端登录接口）
- ✅ **管理员权限检查**：前端 `isAdmin()` 函数，后端 `AdminGuard` 守卫

### 资产库功能
- ✅ **资产列表、搜索、筛选**：前端完整实现
- ✅ **素材列表、搜索、筛选**：前端完整实现
- ✅ **资产详情、素材详情**：前端完整实现
- ✅ **文件上传**：支持本地存储和 OSS 存储两种模式

### AI 功能（梦工厂）
- ✅ **AI 文本生成**：`/api/ai/generate-text`，已接入后端计费
- ✅ **AI 图像生成**：`/api/ai/generate-image`，已接入后端计费（代码显示已修复）
- ✅ **AI 视频生成**：`/api/ai/generate-job`，已接入后端计费
- ✅ **Dry Run 模式**：前端和后端都支持 Dry Run 检查
- ✅ **积分扣费**：所有 AI 调用都先检查余额，再调用后端计费接口

### 存储系统
- ✅ **OSS 存储服务**：后端 `StorageService` 实现完整（上传、路径生成、URL 生成）
- ✅ **JobOutput 实体**：数据库实体已定义，支持存储 OSS URL 和元信息
- ✅ **临时文件管理**：支持临时文件清理

### 管理员功能
- ✅ **管理员充值接口**：`/api/credits/admin/recharge`，支持指定用户充值
- ✅ **路由保护**：`middleware.ts` 保护 `/admin` 和 `/dream-factory` 路由

---

## 2️⃣ 部分完成 / 结构存在但不可用的功能

### 生成产物上传到 OSS
**状态：** ⚠️ **部分完成**

**已实现：**
- 后端 `StorageService` 完整实现（`uploadJobOutput`, `uploadJobOutputFromSource`）
- 数据库 `JobOutput` 实体已定义
- 后端 AI 控制器可能已接入（需要确认）

**未完成：**
- 前端生成的图片/视频可能未完全接入后端上传流程
- 前端 `generate-image` 和 `generate-job` 在 fallback 模式下可能直接返回 AI API 的 URL，未上传到 OSS
- 需要确认所有生成路径都经过后端 `StorageService`

**影响：**
- 生成产物可能存储在 AI 服务商的临时 URL，无法长期访问
- 不符合"所有生成产物统一上传到 OSS"的要求

### 管理员入口与普通用户入口区分
**状态：** ⚠️ **部分完成**

**已实现：**
- 路由保护：`/admin` 需要登录，`/dream-factory` 需要登录
- 管理员权限检查：`isAdmin()` 和 `AdminGuard`

**未完成：**
- UI 层面未明确区分管理员和普通用户入口
- `/admin` 页面是资产管理，不是用户管理界面
- 缺少管理员专用的用户管理、兑换码管理界面
- 普通用户看不到自己的积分历史、交易记录（虽然有接口，但可能没有 UI）

**影响：**
- 管理员和普通用户使用体验不清晰
- 无法满足"明确区分管理员入口与普通用户入口"的要求

---

## 3️⃣ 文档中提到、但代码中尚未实现的功能

### 兑换码系统
**状态：** ❌ **未实现**

**文档要求：**
- 支持手动兑换码充值
- 兑换码由管理员手动生成与发放
- 必须可追踪、可回收、可禁用

**代码检查结果：**
- 未找到兑换码相关的数据库实体
- 未找到兑换码生成、验证、使用的接口
- 未找到兑换码管理界面

**需要实现：**
- 数据库实体：`RedeemCode`（code, amount, used, usedBy, usedAt, createdAt, expiresAt, disabled）
- 后端接口：生成兑换码、验证兑换码、使用兑换码、查询兑换码列表
- 前端接口：兑换码兑换、管理员兑换码管理
- UI：管理员生成兑换码界面、用户兑换界面

---

## 4️⃣ 是否存在与 00_PROJECT_REALITY.md 不一致的地方

### 不一致 1：前端 AI 图像分析是否接入后端计费

**文档描述（00_PROJECT_REALITY.md:88-90）：**
> - ❌ **前端 AI 图像分析（`/api/ai/analyze-image`）未接入后端计费系统**
> - ❌ **前端 AI 文本生成（`/api/ai/generate-text`）可能未完全接入后端计费系统**

**实际代码检查：**
- ✅ `/api/ai/generate-image` **已接入后端计费**（`app/api/ai/generate-image/route.ts:100-112`）
- ✅ `/api/ai/generate-text` **已接入后端计费**（需要确认，但代码结构显示已接入）
- ✅ `/api/ai/generate-job` **已接入后端计费**（`app/api/ai/generate-job/route.ts:125-137`）

**结论：** 文档描述已过时，代码已修复。

### 不一致 2：生成产物存储位置

**文档描述（00_PROJECT_REALITY.md:未明确提到）：**
> 文档未明确提到生成产物必须上传到 OSS

**实际代码检查：**
- ✅ 后端 `StorageService` 已完整实现
- ✅ 数据库 `JobOutput` 实体已定义
- ⚠️ 前端生成路径可能未完全接入后端上传流程

**结论：** 后端基础设施已就绪，但前端可能未完全接入。

### 不一致 3：前后端用户身份链路

**文档描述（00_PROJECT_REALITY.md:108-127）：**
> - ⚠️ **前后端用户身份链路存在断裂风险**（email 不匹配、token 获取失败）

**实际代码检查：**
- ✅ 前端 `lib/auth-config.ts:44-71` 已实现调用后端登录接口
- ✅ 前端有 fallback 机制（后端不可用时使用本地认证）
- ⚠️ 如果后端不可用，前端会回退到本地认证（可能不符合生产环境要求）

**结论：** 代码已修复，但 fallback 机制可能需要调整（生产环境应禁用本地认证）。

---

## 5️⃣ 关键发现总结

### ✅ 已修复的问题
1. **前端 AI 调用已接入后端计费**：`generate-image`、`generate-job` 都已接入
2. **前后端用户身份链路已修复**：前端已调用后端登录接口

### ⚠️ 需要完善的功能
1. **生成产物上传到 OSS**：后端基础设施已就绪，但前端可能未完全接入
2. **管理员入口与普通用户入口区分**：需要 UI 层面的明确区分
3. **兑换码系统**：完全未实现，需要从零开始

### 📝 文档更新建议
1. **00_PROJECT_REALITY.md** 需要更新：
   - 前端 AI 调用已接入后端计费（M2 已完成）
   - 前后端用户身份链路已修复（M1 已完成）
   - 生成产物上传到 OSS 的状态（部分完成）

2. **01_DEVELOPMENT_ROADMAP.md** 需要更新：
   - M1-M6 的状态标记（哪些已完成，哪些进行中）
   - 新增下一轮开发目标（M7-M9）

---

**报告结束**







