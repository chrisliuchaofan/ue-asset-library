# M1 部署决策建议

**生成时间：** 2024-12-19  
**当前状态：** M1 已完成，所有测试通过

---

## 📊 当前状态

### ✅ M1 完成情况

- ✅ 统一用户 ID 映射机制
- ✅ 修复后端 token 获取逻辑
- ✅ 添加用户 ID 映射文档
- ✅ 编写测试脚本验证用户身份链路
- ✅ 所有测试通过

### ⚠️ 待处理问题

根据 `00_PROJECT_REALITY.md`，还有以下**高严重性**问题：

1. **🔴 前端 AI 调用未完全接入后端计费系统**
   - **问题：** AI 图像分析直接调用真实 AI API，不检查 Dry Run 模式，不调用后端计费系统
   - **影响：** 可能产生真实费用，但不会扣用户积分，用户不知道实际花费
   - **严重性：** 🔴 高

2. **🟡 Dry Run 模式不一致**
   - **问题：** 前端 AI 图像分析没有 Dry Run flag，依赖环境变量配置
   - **影响：** 开发者可能以为"没配置后端就不会花钱"，但实际上前端直接调用了 AI API
   - **严重性：** 🟡 中

---

## 🎯 建议：先完成 M2，再一起部署

### 理由 1：M2 是"防止花钱不可控"的关键问题

**风险：**
- 如果现在部署 M1，前端 AI 调用仍然可能产生真实费用
- 用户不知道实际花费，可能导致意外费用
- 这是**高严重性**问题，应该优先解决

### 理由 2：M1 和 M2 都是"地基"，应该一起完成

**规划文档说明：**
- M1：修复前后端用户身份链路（地基）✅ 已完成
- M2：修复前端 AI 调用未接入后端计费（地基）❌ 未完成
- 两者都是"地基"，应该都完成后再部署

### 理由 3：M2 依赖 M1，现在正是好时机

**依赖关系：**
- M2 需要 M1 的用户身份链路正常
- M1 已经完成，现在可以立即开始 M2
- 预计时间：3-4 天

---

## 📋 两种方案对比

### 方案 A：先部署 M1，再开发 M2

**优点：**
- ✅ 可以立即验证 M1 的修复效果
- ✅ 用户身份链路问题已解决

**缺点：**
- ❌ 前端 AI 调用仍然可能产生真实费用（高风险）
- ❌ 需要两次部署（M1 一次，M2 一次）
- ❌ 如果 M2 发现问题，可能需要回滚

**风险：** 🔴 高（可能产生意外费用）

### 方案 B：先完成 M2，再一起部署（推荐）

**优点：**
- ✅ 一次性解决两个地基问题
- ✅ 防止"花钱不可控"的风险
- ✅ 只需要一次部署
- ✅ 更完整的测试和验证

**缺点：**
- ⏱️ 需要额外 3-4 天开发时间

**风险：** 🟢 低（所有地基问题一起解决）

---

## ✅ 推荐方案：先完成 M2，再一起部署

### 理由总结

1. **M2 是高风险问题**：可能产生意外费用
2. **M1 和 M2 都是地基**：应该一起完成
3. **M2 依赖 M1**：现在正是好时机
4. **一次性部署更安全**：避免多次部署的风险

### 时间估算

- **M2 开发时间：** 3-4 天
- **测试和验证：** 1 天
- **总计：** 4-5 天

### 下一步行动

1. **立即开始 M2：**
   - 修复 AI 图像分析接入后端计费
   - 修复 AI 文本生成接入后端计费
   - 统一 Dry Run 模式检查

2. **完成 M2 后：**
   - 运行完整测试
   - 验证 Dry Run 模式
   - 一起部署 M1 + M2

---

## 🚨 如果必须现在部署 M1

### 风险控制措施

如果因为业务需要必须现在部署 M1，建议采取以下风险控制措施：

1. **禁用前端 AI 调用（临时）：**
   - 在环境变量中不配置 `AI_IMAGE_API_ENDPOINT` 和 `AI_IMAGE_API_KEY`
   - 这样前端会返回 mock 结果，不会产生费用

2. **监控费用：**
   - 如果必须启用 AI 调用，密切监控 AI API 的费用
   - 设置费用告警

3. **快速完成 M2：**
   - 部署 M1 后，立即开始 M2
   - 尽快完成 M2 并部署

---

## 📝 决策建议

### 推荐：先完成 M2，再一起部署

**原因：**
- M2 是高风险问题（可能产生意外费用）
- M1 和 M2 都是地基，应该一起完成
- 一次性部署更安全、更完整

**时间成本：** 额外 4-5 天

**风险：** 🟢 低

### 备选：现在部署 M1（如果业务紧急）

**前提：**
- 必须禁用前端 AI 调用（不配置 AI API 环境变量）
- 或密切监控费用
- 立即开始 M2 开发

**风险：** 🔴 高（如果启用 AI 调用）

---

## ✅ 最终建议

**建议：先完成 M2，再一起部署**

**理由：**
1. M2 是高风险问题，应该优先解决
2. M1 和 M2 都是地基，应该一起完成
3. 一次性部署更安全、更完整
4. 时间成本可接受（4-5 天）

**如果业务紧急，必须现在部署：**
- 必须禁用前端 AI 调用（不配置 AI API 环境变量）
- 或密切监控费用
- 立即开始 M2 开发

---

**文档结束**

