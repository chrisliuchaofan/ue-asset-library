# M5.1: ç”Ÿæˆäº§ç‰©å­˜å‚¨ç­–ç•¥å®ç°

## ğŸ“‹ å®ç°ç›®æ ‡

**ç¦æ­¢é•¿æœŸå­˜å‚¨åˆ° ECS æœ¬åœ°ç£ç›˜ï¼Œæ‰€æœ‰å›¾ç‰‡/è§†é¢‘å¿…é¡»ä¸Šä¼ åˆ° OSSï¼Œæ•°æ®åº“ä»…ä¿å­˜å¼•ç”¨ã€‚**

---

## âœ… å·²å®Œæˆ

### 1. åˆ›å»º JobOutput å®ä½“

**æ–‡ä»¶ï¼š** `backend-api/src/database/entities/job-output.entity.ts`

**å­—æ®µï¼š**
- `id`: UUID
- `jobId`: å…³è”çš„ Job ID
- `userId`: ç”¨æˆ· IDï¼ˆå†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
- `type`: 'image' | 'video'
- `ossUrl`: OSS å®Œæ•´ URLï¼ˆç”¨äºè®¿é—®ï¼‰
- `ossPath`: OSS è·¯å¾„ï¼ˆusers/{userId}/jobs/{jobId}/{type}-{timestamp}.{ext}ï¼‰
- `size`: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- `meta`: JSONBï¼ˆå®½åº¦ã€é«˜åº¦ã€æ—¶é•¿ã€æ ¼å¼ç­‰ï¼‰
- `createdAt`: åˆ›å»ºæ—¶é—´

---

### 2. åˆ›å»º StorageService

**æ–‡ä»¶ï¼š** `backend-api/src/storage/storage.service.ts`

**åŠŸèƒ½ï¼š**
- âœ… `saveTempFile()`: ä¿å­˜ä¸´æ—¶æ–‡ä»¶åˆ° `/tmp/dream-factory/{jobId}.{ext}`
- âœ… `uploadJobOutput()`: ä¸Šä¼ ç”Ÿæˆäº§ç‰©åˆ° OSS
  - ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
  - ä¸Šä¼ åˆ° OSSï¼ˆè·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/{type}-{timestamp}.{ext}`ï¼‰
  - å†™å…¥ job_outputs è¡¨
  - åˆ é™¤ä¸´æ—¶æ–‡ä»¶
- âœ… `uploadJobOutputFromSource()`: ä» URL æˆ– Buffer ä¸Šä¼ 
- âœ… `getJobOutputs()`: è·å– Job çš„æ‰€æœ‰è¾“å‡º
- âœ… `cleanupJobTempFiles()`: æ¸…ç† Job çš„ä¸´æ—¶æ–‡ä»¶
- âœ… `cleanupOldTempFiles()`: æ¸…ç† 24 å°æ—¶å‰çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆç”¨äº cronï¼‰

**OSS è·¯å¾„è§„èŒƒï¼š**
```
users/{userId}/jobs/{jobId}/{type}-{timestamp}.{ext}
```

**ç¤ºä¾‹ï¼š**
```
users/test@factory-buy.com/jobs/abc123/image-1703123456789.jpg
users/test@factory-buy.com/jobs/abc123/video-1703123456789.mp4
```

---

### 3. é›†æˆåˆ° JobsService

**ä¿®æ”¹ï¼š** `backend-api/src/jobs/jobs.service.ts`

- âœ… åœ¨ `complete()` æ–¹æ³•ä¸­æ·»åŠ ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- âœ… å¯¼å…¥ StorageModule

---

## ğŸš§ å¾…å®ç°

### 4. ä¿®æ”¹ç”Ÿæˆæµç¨‹

**éœ€è¦ä¿®æ”¹çš„æ¥å£ï¼š**
- `/ai/generate-image` (åç«¯)
- `/ai/generate-video` (åç«¯)

**æµç¨‹ï¼š**
1. è°ƒç”¨ AI æœåŠ¡ç”Ÿæˆå›¾ç‰‡/è§†é¢‘ï¼ˆè¿”å› URL æˆ– Bufferï¼‰
2. å¦‚æœè¿”å› URLï¼Œä¸‹è½½æ–‡ä»¶
3. è°ƒç”¨ `StorageService.uploadJobOutput()` ä¸Šä¼ åˆ° OSS
4. è¿”å› OSS URLï¼ˆè€Œä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼‰

---

### 5. ä¿®æ”¹ API å“åº”

**è¦æ±‚ï¼š**
- ä»»ä½• API å“åº”ä¸­ä¸å¾—è¿”å›æœ¬åœ°æ–‡ä»¶è·¯å¾„
- åªè¿”å› `ossUrl`

**éœ€è¦ä¿®æ”¹ï¼š**
- `job-schemas.ts`: ç¡®ä¿è¾“å‡º schema åªåŒ…å« URL
- æ‰€æœ‰è¿”å›å›¾ç‰‡/è§†é¢‘ URL çš„æ¥å£

---

### 6. ç¯å¢ƒå˜é‡é…ç½®

**æ–°å¢ç¯å¢ƒå˜é‡ï¼š**
```bash
# OSS é…ç½®
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY=your-access-key-id
OSS_SECRET=your-access-key-secret
OSS_BASE_URL=https://your-cdn-domain.com  # å¯é€‰ï¼ŒCDN URL
```

**æ³¨æ„ï¼š**
- `OSS_ACCESS_KEY` å’Œ `OSS_ACCESS_KEY_ID` éƒ½æ”¯æŒï¼ˆå…¼å®¹æ€§ï¼‰
- `OSS_SECRET` å’Œ `OSS_ACCESS_KEY_SECRET` éƒ½æ”¯æŒï¼ˆå…¼å®¹æ€§ï¼‰

---

### 7. æ¸…ç†æœºåˆ¶

**å·²å®ç°ï¼š**
- âœ… Job å®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆåœ¨ `JobsService.complete()` ä¸­ï¼‰
- âœ… `cleanupOldTempFiles()` æ–¹æ³•ï¼ˆç”¨äº cronï¼‰

**å¾…å®ç°ï¼š**
- â³ Cron ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰ï¼šæ¯å¤©æ¸…ç† 24 å°æ—¶å‰çš„ä¸´æ—¶æ–‡ä»¶

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²åˆ›å»º
- âœ… `backend-api/src/database/entities/job-output.entity.ts`
- âœ… `backend-api/src/storage/storage.service.ts`
- âœ… `backend-api/src/storage/storage.module.ts`

### å·²ä¿®æ”¹
- âœ… `backend-api/src/database/database.module.ts` (æ·»åŠ  JobOutput å®ä½“)
- âœ… `backend-api/src/app.module.ts` (å¯¼å…¥ StorageModule)
- âœ… `backend-api/src/jobs/jobs.service.ts` (æ·»åŠ æ¸…ç†é€»è¾‘)
- âœ… `backend-api/src/jobs/jobs.module.ts` (å¯¼å…¥ StorageModule)

### å¾…ä¿®æ”¹
- â³ `backend-api/src/ai/ai.controller.ts` (æ·»åŠ  generate-image å’Œ generate-video æ¥å£)
- â³ `backend-api/src/jobs/job-schemas.ts` (ç¡®ä¿è¾“å‡ºåªåŒ…å« OSS URL)
- â³ å‰ç«¯ API è·¯ç”±ï¼ˆç¡®ä¿åªè¿”å› OSS URLï¼‰

---

## ğŸ§ª éªŒè¯æ­¥éª¤

1. **ç”Ÿæˆä¸€æ¬¡å›¾ç‰‡/è§†é¢‘**
   - è°ƒç”¨ `/api/ai/generate-image` æˆ– `/api/ai/generate-video`
   - æ£€æŸ¥è¿”å›çš„ URL æ˜¯å¦ä¸º OSS URL

2. **æ£€æŸ¥ OSS**
   - ç™»å½• OSS æ§åˆ¶å°
   - æ£€æŸ¥è·¯å¾„ `users/{userId}/jobs/{jobId}/` ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶

3. **æ£€æŸ¥ ECS /tmp**
   - SSH åˆ°æœåŠ¡å™¨
   - æ£€æŸ¥ `/tmp/dream-factory/` ç›®å½•
   - ç¡®è®¤æ²¡æœ‰æ®‹ç•™æ–‡ä»¶ï¼ˆé™¤äº†æ­£åœ¨å¤„ç†çš„ï¼‰

4. **æ£€æŸ¥æ•°æ®åº“**
   - æŸ¥è¯¢ `job_outputs` è¡¨
   - ç¡®è®¤æœ‰è®°å½•ï¼Œä¸” `ossUrl` å’Œ `ossPath` æ­£ç¡®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**
   - Job å®Œæˆåç«‹å³æ¸…ç†
   - Cron ä»»åŠ¡ä½œä¸ºå…œåº•ï¼ˆå¯é€‰ï¼‰

2. **é”™è¯¯å¤„ç†**
   - ä¸Šä¼ å¤±è´¥æ—¶ï¼Œå°è¯•åˆ é™¤ä¸´æ—¶æ–‡ä»¶
   - æ¸…ç†å¤±è´¥ä¸é˜»å¡ä¸»æµç¨‹

3. **OSS é…ç½®**
   - ç¡®ä¿ OSS é…ç½®æ­£ç¡®
   - ç¡®ä¿æœ‰å†™å…¥æƒé™

4. **å‘åå…¼å®¹**
   - æ—§çš„ Job å¯èƒ½æ²¡æœ‰ job_outputs è®°å½•
   - éœ€è¦å¤„ç†è¿™ç§æƒ…å†µ







