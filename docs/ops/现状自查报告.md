# 📋 现状自查报告

**生成时间：** 2024-12-19  
**基于代码库：** 当前真实状态  
**自查范围：** 生成结果数据流、OSS使用、用户权限、积分系统

---

## 第一步：现状自查结果

### 1. 生成结果的数据流向

**状态：** 【部分完成】

**当前实现：**
- ✅ 生成后立即展示：前端生成后直接显示结果（`app/dream-factory/page.tsx`）
- ✅ 项目保存功能：有 `saveProject()` 函数，保存项目状态到服务器或 localStorage（`lib/dream-factory/project-storage.ts`）
- ⚠️ **问题：** 生成产物（图片/视频）与项目保存是分离的
  - 项目保存只保存状态（prompt、concept、storyboard），不保存生成产物本身
  - 生成产物通过后端 `JobOutput` 实体存储 OSS URL，但前端可能仍有部分路径未完全接入
- ❌ **缺失：** 没有明确区分"临时展示态"和"已保存态"的生成产物
  - 生成后立即展示，但没有标记为"临时"
  - 保存项目时，生成产物可能已经上传到 OSS，但没有与项目关联

**数据流现状：**
```
生成 → 立即展示（前端状态） → 后端上传OSS（部分路径） → JobOutput表记录
保存项目 → 只保存项目状态 → 生成产物URL可能丢失关联
```

**需要改进：**
- 生成后立即展示，但标记为"临时态"（前端状态，未保存）
- 保存项目时，确保生成产物已上传到 OSS，并建立项目与产物的关联
- 区分"临时展示"（前端状态）和"已保存"（数据库+OSS）

---

### 2. OSS 使用状态

**状态：** 【部分完成】

**当前实现：**
- ✅ 后端 `StorageService` 已实现（`backend-api/src/storage/storage.service.ts`）
- ✅ 后端 `JobOutput` 实体已定义（`backend-api/src/database/entities/job-output.entity.ts`）
- ✅ 后端 AI 控制器已接入 OSS 上传（`backend-api/src/ai/ai.controller.ts:145-236`）
- ✅ 前端上传接口支持 OSS（`app/api/upload/route.ts`）
- ⚠️ **问题：** 前端生成路径可能未完全接入后端上传流程
  - `app/api/ai/generate-image/route.ts:270-299` 有上传逻辑，但可能失败时返回原始 URL
  - `app/api/ai/generate-job/route.ts:292-294` 有上传逻辑，但可能失败时返回原始 URL
- ⚠️ **风险：** 如果后端上传失败，前端可能返回 AI 服务商的临时 URL

**OSS 使用现状：**
- ✅ 图片/视频上传接口：统一走 OSS（`/api/upload`）
- ✅ 后端生成路径：已接入 OSS（`/ai/generate-image`, `/ai/generate-video`）
- ⚠️ 前端生成路径：部分接入，失败时可能返回临时 URL

**需要改进：**
- 确保所有生成路径都返回 OSS URL（不允许返回临时 URL）
- OSS 上传失败时，应该重试或明确报错，而不是静默返回临时 URL
- 明确哪些数据必须走 OSS，哪些可以临时存储在内存/本地

---

### 3. 用户与权限模型

**状态：** 【部分完成】

**当前实现：**
- ✅ userId 贯穿前后端：
  - 前端：`session.user.id` 或 `session.user.email`（`lib/auth-config.ts`）
  - 后端：JWT token 解析 `userId`（`@CurrentUser()` 装饰器）
  - 数据库：`User.id` 字段（通常是 email）
- ✅ 管理员权限检查：
  - 前端：通过 `ADMIN_USERS` 环境变量判断（`lib/auth-config.ts:7-28`）
  - 后端：`AdminGuard` 守卫（`backend-api/src/credits/auth.guard.ts`）
- ⚠️ **问题：** 前端没有统一的 `isAdmin()` 函数
  - 权限检查分散在不同地方
  - 没有明确的管理员/普通用户角色区分

**用户权限现状：**
- ✅ 多用户支持：`ADMIN_USERS` 环境变量支持多个用户
- ✅ 路由保护：`middleware.ts` 保护 `/admin` 和 `/dream-factory`
- ⚠️ 角色区分：没有明确的角色字段，只能通过 `ADMIN_USERS` 判断

**需要改进：**
- 前端统一 `isAdmin()` 函数
- 明确管理员/普通用户的角色区分（可选：数据库角色字段）
- 管理员入口与普通用户入口明确区分（UI 层面）

---

### 4. 积分系统状态

**状态：** 【已完成】

**当前实现：**
- ✅ 积分字段：`User.credits`（`backend-api/src/database/entities/user.entity.ts:18`）
- ✅ 积分变更日志：`CreditTransaction` 实体（`backend-api/src/database/entities/credit-transaction.entity.ts`）
  - 不可删除：没有 `@DeleteDateColumn()`
  - 不可修改：没有 `@UpdateDateColumn()`，只有 `@CreateDateColumn()`
  - 幂等性约束：`@Unique(['userId', 'refId', 'action'])`
- ✅ 账本化设计：从 `CreditTransaction` 表 sum 计算余额（`backend-api/src/credits/credits.service.ts:60-88`）
- ✅ 防重复扣费：通过 `refId` 和 `action` 唯一约束（`backend-api/src/credits/credits.service.ts:240-254`）

**积分系统现状：**
- ✅ 积分字段：存在
- ✅ 积分日志：不可删除、不可修改
- ✅ 防重复扣费：幂等性约束
- ✅ 账本化设计：真实来源是 `CreditTransaction` 表

**无需改进：** 积分系统设计完善，符合要求

---

## 第二步：新增里程碑（M10-M12）

详见 `02_DEVELOPMENT_ROADMAP.md`

---

**报告结束**


