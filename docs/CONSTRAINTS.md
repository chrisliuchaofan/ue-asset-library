# 项目约束与限制

## 绝对不能随意修改的部分

### 🔴 核心数据模型

#### 1. `data/manifest.schema.ts` 和 `data/material.schema.ts`

**禁止操作**：
- ❌ 随意删除或重命名字段
- ❌ 修改必需字段为可选（除非提供默认值）
- ❌ 修改枚举类型的值（如资产类型、素材类型）
- ❌ 不兼容的类型变更（如 `string` 改为 `number`）
- ❌ **删除或修改 NAS 路径字段**（`guangzhouNas`、`shenzhenNas`）- 这是系统核心约束

**允许操作**：
- ✅ 添加新的可选字段（使用 `.optional()`）
- ✅ 扩展现有字段的功能（向后兼容）

**修改前置条件**：
1. 编写数据迁移脚本（如有必要）
2. 在测试环境验证所有现有数据仍能正常解析
3. 更新所有使用该 schema 的代码

---

### 🔴 存储抽象层

#### 2. `lib/storage.ts` 的核心接口

**禁止操作**：
- ❌ 修改 `listAssets()`, `getAsset()`, `createAsset()`, `updateAsset()`, `deleteAsset()` 的函数签名
- ❌ 修改 `getStorageMode()` 的返回值类型
- ❌ 破坏 OSS 模式的兼容性

**修改前置条件**：
1. 必须充分测试 OSS 模式
2. 验证缓存机制正常工作
3. 确保错误处理逻辑完整

---

### 🔴 认证系统

#### 3. `lib/auth-config.ts` 的认证逻辑

**禁止操作**：
- ❌ 随意修改 NextAuth 配置结构
- ❌ 删除或修改认证提供者（Credentials Provider）

**修改前置条件**：
1. 在测试环境完整测试登录流程
2. 验证所有受保护的路由和 API 仍能正常工作
3. 确保环境变量配置正确

---

## 环境与存储模式硬约束

### NAS 路径核心约束

#### NAS 是主取用来源

**硬性约束**：

1. **NAS 路径字段长期存在**：
   - `guangzhouNas`、`shenzhenNas` 是资产数据模型的核心字段
   - 这些字段不是可选信息，而是系统核心约束
   - 资产创建时，广州 NAS 和深圳 NAS 至少需要填写一个

2. **NAS 路径允许为空的情况**：
   - 部分素材可能不需要 NAS 路径（如 AI 生成的临时素材）
   - 更新操作时，如果不需要修改 NAS 路径，可以不提供
   - 但创建新资产时，NAS 路径是必需的（至少填写一个）

3. **NAS 路径的用途**：
   - 用户通过线上系统找到资产后，主要通过 NAS 路径获取实际文件
   - 线上系统负责展示 NAS 路径信息，提供定位能力
   - NAS 是资产的主要取用来源，不是历史债，而是系统设计约束

---

### 存储模式硬性规则

#### 线上环境强制使用 OSS（用于展示必需数据）

**硬性约束**：

1. **Vercel 等无状态平台**：必须使用 `oss` 模式
   - Local 模式依赖文件系统，无状态平台不支持持久化存储
   - 如果使用 local 模式，数据会在每次部署后丢失

2. **Local 模式适用范围**：
   - ✅ **仅用于**：本地开发环境（`npm run dev`）的早期调试
   - ❌ **不能用于**：Vercel、Netlify 等无状态平台
   - ❌ **不能用于**：任何线上环境

3. **环境变量一致性规则**：
   - `STORAGE_MODE` 和 `NEXT_PUBLIC_STORAGE_MODE` **必须保持一致**
   - **线上环境必须固定为 `oss`**

#### OSS 用途限制（核心约束）

**OSS 仅用于展示必需数据**：
- ✅ manifest.json、materials.json 等清单数据
- ✅ 预览图、缩略图、封面图
- ✅ 轻量展示资源

**OSS 不用于**：
- ❌ **全量资产文件存储**（资产安全、流量费、下载成本不可接受）
- ❌ **资产文件的分发和下载**（短期内不考虑）
- ❌ 禁止把"OSS=全量资产分发"写成短期目标

#### OSS 模式配置要求

**必须配置的环境变量**：
- `OSS_BUCKET` - OSS Bucket 名称
- `OSS_REGION` - OSS 地域（如 `oss-cn-hangzhou`）
- `OSS_ACCESS_KEY_ID` - OSS AccessKey ID
- `OSS_ACCESS_KEY_SECRET` - OSS AccessKey Secret
- `NEXT_PUBLIC_OSS_BUCKET` - 客户端可访问的 Bucket 名称
- `NEXT_PUBLIC_OSS_REGION` - 客户端可访问的 Region
- `NEXT_PUBLIC_CDN_BASE` - CDN 基础 URL（如果使用 CDN）

**OSS 模式切换前置条件**：
1. OSS 配置完整且测试通过
2. OSS Bucket 中存在 `manifest.json` 文件（如果已有数据）
3. 测试 OSS 读写权限正常

---

### 环境变量配置规则

#### 环境隔离原则

1. **开发环境**：
   - 可以使用 `local` 模式（仅用于早期调试）
   - 环境变量存储在 `.env.local`（不提交到 Git）

2. **生产环境**：
   - **强制使用 `oss` 模式**
   - 所有环境变量在 Vercel Dashboard 配置
   - 敏感信息（密钥、密码）绝不提交到 Git

---

## backend-legacy 冻结规则

### backend-legacy 状态（Frozen）

**明确规则**：

1. **状态**：Frozen（冻结）/ Deprecated（已弃用）
2. **不做运维**：不进行日常维护和监控
3. **不做健康检查**：不纳入健康检查范围
4. **不纳入路线图**：不在未来规划中
5. **未来评估**：如果体量/需求确实出现再评估

6. **前端调用规则**：
   - 前端代码中可能仍存在对 `lib/backend-client.ts` 的调用
   - 这些调用应为可选功能，不影响核心功能
   - 如果后端服务不可用，相关功能应降级（见降级策略）

---

## 脚本开发约束

### 脚本是必需工具

**重要性**：脚本是降低人为失误的必需手段，必须小而清晰

#### 脚本开发规则

**每个脚本必须包含**：

1. **输入**：明确脚本的输入参数或环境要求
2. **输出**：明确脚本的输出格式和结果
3. **失败提示**：脚本执行失败时，必须给出清晰的错误提示
4. **如何运行**：脚本必须包含运行说明（注释或 README）

**脚本范围要求**：

1. **范围要小**：每个脚本只做一件事，避免为了自动化而自动化
2. **只做必要校验**：
   - ✅ 环境变量校验
   - ✅ 存储配置校验
   - ✅ 基础健康检查（针对前端/OSS）
   - ❌ 不做复杂的集成测试
   - ❌ 不做后端服务健康检查（backend-legacy 已冻结）

**脚本示例要求**：

- `scripts/check-env.ts` - 环境变量校验脚本（必需）
  - 输入：读取环境变量
  - 输出：列出缺失或格式错误的变量
  - 失败提示：明确指出哪些变量有问题
  - 运行：`npm run check:env` 或 `tsx scripts/check-env.ts`

- `scripts/check-storage-config.ts` - 存储配置校验脚本（可选）
  - 输入：读取存储相关环境变量
  - 输出：验证存储模式配置是否正确
  - 失败提示：明确指出配置错误
  - 运行：`tsx scripts/check-storage-config.ts`

---

## 数据一致性规则

### Asset 和 Material 数据约束

**硬性规则**：

1. **唯一性约束**：
   - Asset：`name` + `type` 的组合必须唯一
   - Material：`name` + `type` 的组合必须唯一

2. **必需字段**：
   - Asset：`id`, `name`, `type`, `project`, `tags`, `thumbnail`, `src`
   - Material：`id`, `name`, `type`, `project`, `tag`, `quality`, `thumbnail`, `src`

3. **项目字段**：
   - 所有 Asset 和 Material 必须有 `project` 字段
   - 如果缺失，系统会自动设置为 `'项目A'`

4. **NAS 路径约束**（核心约束）：
   - Asset 创建时，`guangzhouNas` 和 `shenzhenNas` 至少需要填写一个
   - NAS 路径字段长期存在，是系统核心约束
   - 允许为空的情况：部分素材（如 AI 生成的临时素材）可能不需要 NAS 路径
   - 更新操作时，如果不需要修改 NAS 路径，可以不提供

---

### 权限和认证规则

#### 用户认证

**硬性规则**：

1. **环境变量要求**：
   - `NEXTAUTH_SECRET`：必须配置，至少 32 字符的随机字符串
   - `NEXTAUTH_URL`：必须配置，与部署域名一致
   - `ADMIN_USERS`：管理员账号配置（格式：`username:password,username:password`）

2. **会话安全**：
   - 生产环境必须使用 HTTPS
   - 会话 Cookie 使用 Secure 标志

3. **API 保护**：
   - 所有管理相关的 API 路由必须检查认证状态
   - 使用 `lib/auth.ts` 的 `isAuthenticated()` 或 `getCurrentUser()` 进行验证

---

## 变更范围约束

### 单次变更范围限制

**硬性规则**：

1. **单次变更只允许影响一个模块**
   - ❌ 禁止同时修改多个核心模块（如 storage + auth + schema）
   - ✅ 允许修改同一模块内的多个文件

2. **模块划分原则**：
   - **存储模块**：`lib/storage.ts`, `lib/materials-data.ts`, `lib/oss-client.ts`
   - **认证模块**：`lib/auth-config.ts`, `lib/auth.ts`, `app/api/auth/*`
   - **数据模型模块**：`data/manifest.schema.ts`, `data/material.schema.ts`
   - **API 模块**：`app/api/*`（按功能子模块划分）

3. **跨模块修改必须分步进行**：
   - 第一步：修改底层模块（如数据模型），保持接口兼容
   - 第二步：修改依赖层（如存储层、API 层）
   - 第三步：修改上层（如组件层）
   - 每一步独立提交和测试

---

### 禁止跨模块联动大改

**明确禁止的操作**：

1. ❌ **同时修改数据模型和存储层**
2. ❌ **同时修改认证系统和所有受保护的路由**
3. ❌ **一次性重构多个核心文件**

---

## 修改前必须满足的前置条件

### 通用前置条件

1. **环境准备**：
   - ✅ 本地开发环境可正常运行
   - ✅ 相关环境变量已配置

2. **代码审查**：
   - ✅ 理解相关代码的依赖关系
   - ✅ 阅读相关文档和注释

3. **测试准备**：
   - ✅ 确定测试验证点

---

### 数据模型修改前置条件

- [ ] 1. 分析现有数据，确认修改不会破坏数据完整性
- [ ] 2. 编写数据迁移脚本（如有必要）
- [ ] 3. 在测试环境验证所有现有数据仍能正常解析
- [ ] 4. 更新所有使用该 schema 的代码
- [ ] 5. 运行类型检查：`npm run build` 或 `tsc --noEmit`

**特别注意**：如果修改 NAS 路径字段，必须充分评估影响，因为这是系统核心约束。

---

### 存储层修改前置条件

- [ ] 1. 必须充分测试 OSS 模式
- [ ] 2. 验证缓存机制正常工作
- [ ] 3. 测试错误处理（文件不存在、网络错误等）

---

### 认证系统修改前置条件

- [ ] 1. 在测试环境验证登录流程
- [ ] 2. 测试所有受保护的路由和 API
- [ ] 3. 验证环境变量配置正确

---

## 明确禁止的操作

### 🚫 代码层面

#### 1. 一次性大范围重构

**禁止**：
- ❌ 同时重构多个核心模块（如 storage + auth + schema）
- ❌ 同时修改前端和后端的 API 接口

**推荐做法**：
- ✅ 渐进式重构，一次只改一个模块
- ✅ 分阶段发布，每个阶段充分测试

---

#### 2. 跨模块联动修改

**禁止**：
- ❌ 同时修改数据模型和存储层
- ❌ 同时修改认证系统和所有受保护的路由

**推荐做法**：
- ✅ 先修改底层（如数据模型），再修改上层（如 API）
- ✅ 保持接口兼容

---

#### 3. 直接修改生产数据

**禁止**：
- ❌ 直接编辑生产环境的 OSS 中的 `manifest.json` 或 `materials.json`
- ❌ 通过 OSS 控制台直接修改 `manifest.json`

**推荐做法**：
- ✅ 通过 API 或后台管理界面修改数据
- ✅ 修改后清除缓存（如需要）

---

#### 4. 忽略类型检查

**禁止**：
- ❌ 使用 `any` 类型逃避类型检查
- ❌ 不修复 TypeScript 编译错误就提交代码

**推荐做法**：
- ✅ 正确定义类型或接口
- ✅ 修复所有类型错误后再提交

---

#### 5. 硬编码配置值

**禁止**：
- ❌ 在代码中硬编码 API URL、密钥、路径等

**推荐做法**：
- ✅ 使用环境变量
- ✅ 敏感信息绝不提交到 Git

---

### 🚫 部署层面

#### 6. 跳过测试直接部署

**禁止**：
- ❌ 不运行 `npm run build` 检查构建错误
- ❌ 不检查类型错误（`tsc --noEmit`）

**推荐做法**：
- ✅ 本地测试后再部署
- ✅ 使用 CI/CD 自动运行构建

---

#### 7. 不备份就修改生产数据

**禁止**：
- ❌ 不备份 OSS 文件就修改存储逻辑

**推荐做法**：
- ✅ 修改前备份相关数据

---

## 降级策略

### backend-legacy 服务不可用时的降级策略

**核心原则**：backend-legacy 服务不可用时，应降级相关功能，而不是让全站崩溃。

#### 具体降级策略

1. **积分系统降级**
   - 如果后端不可用，显示"积分服务暂时不可用"提示
   - 禁用需要积分消费的功能（如即梦工厂 AI 视频生成）
   - 允许用户浏览资产和素材（不需要积分）

2. **日志记录降级**
   - 日志记录失败时，静默忽略（不影响用户操作）
   - 不中断用户操作流程

3. **AI 功能降级**
   - **资产库 AI 功能**：如果后端不可用，禁用相关辅助功能（不影响主链路）
   - **即梦工厂 AI 功能**：如果后端不可用，禁用所有 AI 功能，显示友好提示："AI 服务暂时不可用，请稍后重试"
   - 不影响资产和素材的浏览功能

#### 降级实现要求

1. **错误处理必须优雅**：
   - ❌ 不允许后端错误导致页面崩溃（500 错误）
   - ✅ 必须捕获错误，显示友好的提示

2. **降级功能必须可用**：
   - 即使后端不可用，用户仍应能够：
     - 浏览资产和素材列表
     - 查看资产和素材详情
     - 使用搜索和筛选功能
     - 获取 NAS 路径信息
     - 登录和登出（使用 NextAuth）

---

## 环境变量清单

### 前端环境变量（Vercel/Next.js）

| 变量名 | 用途 | 必需/可选 | 示例格式 | 备注 |
|--------|------|-----------|----------|------|
| `NEXTAUTH_SECRET` | NextAuth 会话加密密钥 | **必需** | `base64编码的32字节随机字符串` | 至少 32 字符 |
| `NEXTAUTH_URL` | NextAuth 回调 URL | **必需** | `https://your-domain.vercel.app` | 必须与部署域名一致 |
| `STORAGE_MODE` | 存储模式（服务端） | **必需** | `oss` | 线上必须为 `oss` |
| `NEXT_PUBLIC_STORAGE_MODE` | 存储模式（客户端） | **必需** | `oss` | 必须与 `STORAGE_MODE` 一致，线上必须为 `oss` |
| `OSS_BUCKET` | OSS Bucket 名称 | OSS 模式必需 | `your-bucket-name` | 仅服务端使用 |
| `OSS_REGION` | OSS 地域 | OSS 模式必需 | `oss-cn-hangzhou` | 仅服务端使用 |
| `OSS_ACCESS_KEY_ID` | OSS AccessKey ID | OSS 模式必需 | `LTAI5t...` | 敏感信息，仅服务端使用 |
| `OSS_ACCESS_KEY_SECRET` | OSS AccessKey Secret | OSS 模式必需 | `xxxxx...` | 敏感信息，仅服务端使用 |
| `OSS_ENDPOINT` | OSS Endpoint | 可选 | `https://oss-cn-hangzhou.aliyuncs.com` | 不填会自动根据 region 生成 |
| `NEXT_PUBLIC_OSS_BUCKET` | OSS Bucket（客户端） | OSS 模式必需 | `your-bucket-name` | 客户端可访问 |
| `NEXT_PUBLIC_OSS_REGION` | OSS Region（客户端） | OSS 模式必需 | `oss-cn-hangzhou` | 客户端可访问 |
| `NEXT_PUBLIC_CDN_BASE` | CDN 基础 URL | 可选 | `https://cdn.your-domain.com` | 如果使用 CDN |
| `ADMIN_USERS` | 管理员账号列表 | 可选 | `username1:password1,username2:password2` | 用于快速测试 |
| `AI_IMAGE_API_KEY` | AI 图片生成 API Key | AI 功能必需 | `sk-xxxxx...` | 敏感信息 |
| `AI_IMAGE_API_ENDPOINT` | AI 图片生成端点 | AI 功能必需 | `https://dashscope.aliyuncs.com/api/v1/...` | |
| `AI_IMAGE_API_MODEL` | AI 图片生成模型 | AI 功能必需 | `qwen-plus-latest` | |
| `JIMENG_REQ_KEY` | 即梦视频生成请求 Key | AI 功能必需 | `jimeng_i2v_first_v30` | |

---

## 总结

### 核心原则

1. **向后兼容优先**：尽可能保持向后兼容，避免破坏现有功能
2. **充分测试**：修改前在测试环境充分验证
3. **渐进式改进**：避免大范围重构，采用渐进式改进
4. **文档更新**：修改后及时更新相关文档

### 遇到不确定的情况

如果遇到上述规则未覆盖的情况，请：

1. 查阅相关文档和代码注释
2. 先在测试环境验证
3. 记录决策和风险

**记住**：对于内部使用的小规模工具，稳定性比完美更重要。

---

## 变更记录

### 2024-XX-XX（本次修订 - 二次纠偏）

1. **NAS 路径改为核心约束**：
   - 将 NAS 路径从"可选信息"改为"核心约束"
   - 明确 NAS 路径字段长期存在，是系统核心约束
   - 明确 NAS 是主取用来源，不是历史债
   - 明确 NAS 路径允许为空的情况（部分素材/AI 输出）

2. **OSS 规则明确用途**：
   - 明确 OSS 仅用于 manifest/materials/预览/缩略图/封面等展示必需数据
   - 禁止把"OSS=全量资产分发"写成短期目标
   - 明确不考虑"上传到 OSS 再下载"作为主流程

3. **backend-legacy 明确冻结**：
   - 明确标注为 Frozen/Deprecated
   - 不设任何必须运维/健康检查要求
   - 前端调用应为可选功能，不影响核心功能

4. **新增脚本开发约束**：
   - 明确脚本是必需的，用于降低人为失误
   - 每个脚本必须包含：输入/输出/失败提示/如何运行
   - 脚本范围要小：只做环境变量校验、存储配置校验、基础健康检查（针对前端/OSS）

5. **删除内容**：
   - 删除了后端 API 集成规则
   - 删除了数据库相关的约束（backend-legacy 已冻结）
