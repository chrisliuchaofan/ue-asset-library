# 项目上下文

## 项目目标

**恒星UE资产库** 是一个用于管理和展示 Unreal Engine 资产资源的 Web 应用系统。项目旨在解决以下核心问题：

### 核心解决的问题

1. **资产集中化管理**
   - 统一管理 UE 项目中的各类资产（角色、场景、动画、特效、材质、蓝图、UI、合成、音频等）
   - 提供结构化的资产分类、标签和元数据管理
   - 支持多项目（项目A、项目B、项目C）的资产隔离
   - **NAS 地址是主取用来源**：资产实际文件存储在 NAS（广州/深圳），线上系统只负责索引、检索、权限、预览等展示层功能

2. **高效的资产检索**
   - 提供实时搜索和筛选功能
   - 支持按类型、标签、风格、来源等多维度筛选
   - 关键词高亮显示，提升查找效率
   - 用户通过系统找到资产后，主要从 NAS 路径获取实际文件

3. **素材生命周期管理**
   - 独立的素材库（Materials）模块，管理视频素材（UE视频、AE视频、混剪、AI视频、图片）
   - 素材质量评级系统（爆款、优质、达标）
   - 素材质量标签（高品质、常规、迭代）

4. **AI 驱动的创作工具**
   - **资产库 AI 功能**（辅助能力）：
     - 在资产检索和管理流程中，AI 功能为可选辅助
     - 不影响资产检索与管理的主链路
     - 可有可无，不影响核心功能使用
   - **即梦工厂 AI 功能**（主价值模块）：
     - 集成"即梦工厂"（Dream Factory）AI 视频生成功能
     - 支持文本生成图片、图片生成视频等 AI 能力
     - 基于积分系统的 AI 功能使用计费
     - 在该页面 AI 体验与计费是主流程，需要稳定可用

5. **团队协作支持**
   - 用户认证和权限管理（NextAuth）
   - 后台管理界面，支持资产的增删改查
   - 支持多办公室的 NAS 路径管理（广州、深圳）
   - 线上展示层提供 NAS 路径定位信息，用户据此获取实际资产文件

## 非目标（明确不打算做什么）

1. **不是通用文件管理系统**
   - 专注于 UE 资产和视频素材，不支持任意文件类型
   - 不提供文件版本控制（Git-like）功能

2. **不是实时协作平台**
   - 不支持多用户同时编辑同一资产
   - 不提供实时通知或聊天功能

3. **不是代码仓库**
   - 不存储和管理源代码
   - 不提供代码编译、构建或部署功能

4. **不是完整的 CMS 系统**
   - 专注于资产展示和管理，不提供富文本编辑、内容发布流程等 CMS 核心功能

5. **不是资产交易平台**
   - 不提供资产购买、销售或版权管理功能

6. **不是全量资产分发平台**
   - 不考虑"上传到 OSS 再下载"作为主流程（资产安全、流量费、下载成本不可接受）
   - OSS 仅用于展示必需数据（预览、缩略图、清单数据等）

## 核心用户与使用场景

### 主要用户群体

1. **UE 项目团队**
   - **角色**：资产管理员、项目负责人
   - **使用场景**：
     - 上传和管理项目资产元数据
     - 为资产添加标签、描述、来源等元数据
     - 通过搜索和筛选快速找到所需资产
     - 查看资产详情和 NAS 路径，从 NAS 获取实际文件

2. **内容创作团队**
   - **角色**：视频制作人员、素材管理员
   - **使用场景**：
     - 管理视频素材库
     - 标记素材质量和评级
     - 筛选高质量素材用于项目

3. **AI 功能使用者**
   - **角色**：内容创作者、设计师
   - **使用场景**：
     - 使用"即梦工厂"生成 AI 视频（主流程）
     - 通过积分系统消费 AI 功能
     - 查看生成任务状态和历史

4. **系统管理员**
   - **角色**：技术负责人
   - **使用场景**：
     - 管理用户账号和权限
     - 配置系统环境（存储模式、CDN）
     - 处理积分充值和管理

### 典型使用流程

1. **资产查找与获取流程**
   ```
   访问资产列表页 → 输入搜索关键词 → 选择类型/标签筛选 → 查看资产卡片 → 点击查看详情 → 获取 NAS 路径 → 从 NAS 获取实际文件
   ```

2. **AI 视频生成流程（即梦工厂）**
   ```
   用户登录 → 进入即梦工厂 → 上传图片/输入提示词 → 选择生成参数 → 消费积分 → 等待生成完成 → 查看结果
   ```

## 当前项目所处阶段

### 阶段评估：**内部使用工具，小规模团队**

项目定位为**内部使用的小规模工具**，具备以下特征：

1. **功能完整性**
   - ✅ 资产和素材的完整 CRUD 操作
   - ✅ 用户认证和权限管理
   - ✅ AI 功能集成（即梦工厂）
   - ✅ 积分系统和计费逻辑
   - ✅ 后台管理界面
   - ✅ OSS 存储支持（用于展示必需数据）

2. **技术架构**
   - ✅ Next.js 16 App Router
   - ✅ TypeScript
   - ✅ 数据库集成（Supabase/PostgreSQL）
   - ✅ 云存储支持（阿里云 OSS，用于预览和清单数据）
   - ✅ 认证系统（NextAuth v5）

3. **部署状态**
   - ✅ 前端部署在 Vercel（自动化 CI/CD）
   - ⚠️ 环境变量配置需要手动管理
   - ⚠️ 存储模式需要正确配置（线上必须 OSS）

4. **工程化程度**
   - ⚠️ 代码质量：中等（存在遗留代码和技术债）
   - ⚠️ 文档完整性：中等
   - ❌ 测试覆盖：较低
   - ✅ 部署自动化：前端自动化

### 项目规模假设

- **用户规模**：< 50 人
- **使用场景**：内部团队协作工具
- **可用性承诺**：不承诺高可用，可接受短时间维护
- **工程化程度**：满足基本使用即可，不做过度工程化

### 下一步发展方向

优先解决**上线阻塞问题**：

1. **环境一致性**：确保开发/测试/生产环境配置一致（通过脚本自动化校验）
2. **存储模式正确配置**：线上强制 OSS（用于展示必需数据），避免配置错误
3. **基础错误处理**：确保系统不会因小错误崩溃
4. **NAS 路径展示能力**：确保 NAS 路径字段正确显示和定位

### 不适合的操作

⚠️ **不建议进行大规模重构或过度工程化**，原因：
- 系统正在使用中
- 用户规模小，不需要高可用架构
- 优先解决实际问题，而非追求完美架构

建议采用**渐进式改进**策略，优先解决阻塞问题。

## 当前状态与已知阻塞（Blockers）

### 部署与环境问题

1. **存储模式配置**
   - Local 模式仅用于本地开发调试
   - 线上环境（Vercel）必须使用 OSS 模式（用于 manifest/materials/预览等展示必需数据）
   - `STORAGE_MODE` 和 `NEXT_PUBLIC_STORAGE_MODE` 必须保持一致

2. **环境变量配置**
   - 开发、测试、生产环境的变量配置可能存在差异
   - 需要脚本自动化校验，降低人为失误
   - 需要人工确认各环境的实际配置状态

3. **依赖版本管理**
   - Node.js 版本未明确锁定（从代码可见使用 Node 20）
   - 需要确认各环境的 Node 版本一致性

### 数据一致性

4. **NAS 路径管理（系统约束）**
   - NAS 地址字段（`guangzhouNas`、`shenzhenNas`）长期存在，是系统核心约束
   - 资产创建时，广州 NAS 和深圳 NAS 至少需要填写一个
   - 需要确保 NAS 路径正确展示和定位（这不是历史债，而是系统设计约束）

5. **OSS 数据一致性**
   - OSS 用于存储 manifest.json、materials.json 等清单数据
   - OSS 用于存储预览图、缩略图、封面等展示必需资源
   - 需要确保 OSS 读写与 manifest 一致性

## 部署现实假设

### 存储架构说明

#### NAS 是主取用来源

**核心架构**：
- **NAS（广州/深圳）**：资产实际文件的存储位置，是用户获取资产的主要来源
- **线上系统（Vercel）**：展示层/元数据管理层，负责索引、检索、权限、预览、素材清单等
- **OSS**：仅用于轻量预览/缩略图/清单数据（manifest/materials）等"展示必需品"

**资产获取流程**：
1. 用户在线上系统搜索和筛选资产
2. 查看资产详情，获取 NAS 路径信息
3. 通过 NAS 路径直接访问 NAS 获取实际资产文件
4. 线上系统只提供预览图（存储在 OSS）

#### OSS 用途限制

**OSS 仅用于**：
- manifest.json、materials.json 等清单数据
- 预览图、缩略图、封面图
- 轻量展示资源

**OSS 不用于**：
- ❌ 全量资产文件存储（资产安全、流量费、下载成本不可接受）
- ❌ 资产文件的分发和下载（短期内不考虑）

#### 存储模式硬性规则

**线上环境强制使用 OSS**：

1. **Local 模式适用范围**：
   - ✅ **仅用于**：本地开发环境（`npm run dev`）的早期调试
   - ❌ **不能用于**：Vercel、Netlify 等无状态平台
   - ❌ **不能用于**：任何线上环境

2. **线上存储策略**：
   - **Vercel 部署**：必须使用 `oss` 模式
   - **OSS 配置要求**：
     - `OSS_BUCKET`、`OSS_REGION`、`OSS_ACCESS_KEY_ID`、`OSS_ACCESS_KEY_SECRET` 必须配置
     - OSS Bucket 中必须存在 `manifest.json` 文件（如果已有数据）
     - `NEXT_PUBLIC_CDN_BASE` 应指向 CDN 域名（如果使用 CDN）

3. **存储模式切换原则**：
   - **开发环境**：可以使用 `local` 模式，快速调试
   - **生产环境**：强制使用 `oss` 模式

---

## 变更记录

### 2024-XX-XX（本次修订 - 二次纠偏）

1. **新增 NAS 架构说明**：
   - 明确 NAS 是主取用来源，线上只是展示层/元数据管理层
   - 明确 OSS 仅用于展示必需数据（预览、缩略图、清单数据）
   - 明确不考虑"上传到 OSS 再下载"作为主流程

2. **AI 功能分层说明**：
   - 资产库 AI：辅助能力（可有可无，不影响主链路）
   - 即梦工厂 AI：主价值模块（AI 体验与计费是主流程）

3. **阻塞问题调整**：
   - NAS 路径管理从"历史债"调整为"系统约束"
   - 明确 NAS 路径展示能力是上线阻塞之一

4. **删除内容**：
   - 删除了后端服务相关的阻塞问题
