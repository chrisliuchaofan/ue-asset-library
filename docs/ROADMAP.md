# 项目演进路线图

## 概述

本文档描述接下来 **2-4 周**的推荐演进方向。所有任务聚焦于**解决当前上线阻塞 + 立刻收益**的事项。

**重要提示**：
- 本文档基于当前代码库的实际情况生成
- 所有任务必须回答：**是否直接影响部署成功**
- 不提前规划监控、测试、严格 TS 等非阻塞内容

**项目定位**：
- 内部使用工具
- 用户规模 < 50 人
- 不承诺高可用
- 不做过度工程化

**AI 模块分层定位**：
- **资产库 AI**：P2（可选辅助能力，不影响资产检索与管理主链路）
- **即梦工厂 AI**：P1（主价值模块，AI 体验与计费是主流程，需要稳定）

---

## 上线阻塞任务（Priority 0 - 必须完成）

### 任务 1：环境变量清单与校验脚本

**是否直接影响部署成功**：✅ 是（配置错误会导致部署失败）

**目标**：
- 建立完整的环境变量清单文档
- 创建环境变量校验脚本，确保所有必需变量已配置
- 降低人为失误，脚本是必需工具

**范围**：
- `scripts/check-env.ts` - 增强现有脚本或创建新的校验脚本
- `ENV_VARIABLES.md` - 更新环境变量文档

**验收标准**：
- ✅ 环境变量校验脚本可以检查所有必需变量
- ✅ 脚本输出清晰的错误提示（哪些变量缺失、格式错误等）
- ✅ 脚本包含：输入说明、输出格式、失败提示、运行方法
- ✅ 开发、测试、生产环境变量清单文档完整且一致

**风险**：
- 🟢 **低风险**：主要是文档和工具脚本

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：1-2 天

---

### 任务 2：OSS 读写与 manifest 一致性

**是否直接影响部署成功**：✅ 是（配置错误会导致数据丢失或功能失效）

**目标**：
- 明确线上环境必须使用 OSS 模式的规则（OSS 用于展示必需数据：manifest/materials/预览/缩略图）
- 创建存储模式配置检查脚本
- 确保 OSS 读写与 manifest 数据一致性

**范围**：
- `lib/storage.ts` - 增强存储模式推断逻辑（生产环境强制 OSS）
- `scripts/check-storage-config.ts` - 创建存储模式配置检查脚本（可选）
- OSS 读写逻辑验证

**验收标准**：
- ✅ 生产环境（`NODE_ENV=production` 或 `VERCEL=1`）强制使用 OSS 模式
- ✅ 如果生产环境配置为 local 模式，系统应给出明确错误提示
- ✅ OSS 读写 manifest.json、materials.json 正常
- ✅ 文档明确说明 OSS 仅用于展示必需数据（manifest/materials/预览/缩略图），不用于全量资产分发

**风险**：
- 🟡 **中等风险**：修改存储模式推断逻辑可能影响现有部署

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：2-3 天

---

### 任务 3：NAS 路径展示定位能力

**是否直接影响部署成功**：✅ 是（NAS 是主取用来源，路径展示是核心功能）

**目标**：
- 确保 NAS 路径字段（`guangzhouNas`、`shenzhenNas`）正确显示和定位
- 验证 NAS 路径在资产详情、列表等页面的展示
- 确保 NAS 路径为空时的空状态处理
- 验证权限控制（只有授权用户能看到 NAS 路径）

**范围**：
- `data/manifest.schema.ts` - 验证 NAS 路径字段定义
- `components/asset-detail-dialog.tsx` - 资产详情页 NAS 路径展示
- `components/admin/admin-dashboard.tsx` - 后台管理页 NAS 路径展示
- `app/assets/[id]/page.tsx` - 资产详情页 NAS 路径展示

**验收标准**：
- ✅ NAS 路径字段在资产详情页正确显示
- ✅ NAS 路径可以在列表页复制（如果支持）
- ✅ NAS 路径为空时显示合适的空状态
- ✅ NAS 路径权限控制正确（如需要）
- ✅ 广州 NAS 和深圳 NAS 至少填写一个的验证规则正常工作

**风险**：
- 🟡 **中等风险**：NAS 路径是系统核心约束，修改需谨慎

**AI 辅助**：✅ 适合 AI 辅助（UI 和展示逻辑）

**工作量**：2-3 天

---

### 任务 4：基础错误处理

**是否直接影响部署成功**：✅ 是（错误处理不当会导致页面崩溃）

**目标**：
- 确保关键错误不会导致页面崩溃
- 改进错误消息的用户友好性

**范围**：
- `lib/error-handler.ts` - 统一错误处理（如存在）
- `app/api/*` - API 路由的错误处理
- `components/error-boundary.tsx` - 错误边界组件

**验收标准**：
- ✅ 关键错误不会导致页面崩溃（500 错误）
- ✅ 用户看到友好的错误消息（避免技术错误信息）
- ✅ 错误被正确捕获和记录

**风险**：
- 🟡 **中等风险**：错误处理不当可能隐藏问题

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：2-3 天

---

### 任务 5：Node/依赖版本锁定

**是否直接影响部署成功**：✅ 是（版本不一致可能导致构建失败）

**目标**：
- 明确 Node.js 版本要求（从代码可见使用 Node 20）
- 创建 `.nvmrc` 文件指定 Node 版本

**范围**：
- `.nvmrc` - 创建 Node 版本文件
- `README.md` - 添加版本要求说明

**验收标准**：
- ✅ `.nvmrc` 文件指定 Node 版本（如 `20.x.x`）
- ✅ 文档说明 Node 版本要求
- ✅ CI/CD 和本地开发使用相同的 Node 版本

**风险**：
- 🟢 **低风险**：主要是配置和文档工作

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：1 天

---

## 核心功能稳定任务（Priority 1 - 重要）

### 任务 6：即梦工厂 AI 功能稳定（主价值模块）

**是否直接影响部署成功**：⚠️ 部分影响（AI 是主价值模块，需要稳定可用）

**目标**：
- 确保即梦工厂 AI 功能的稳定性和可用性
- 优化 AI 功能的错误处理和用户体验
- 确保积分系统和计费逻辑正常

**范围**：
- `app/dream-factory/page.tsx` - 即梦工厂主页面
- `components/dream-factory/` - 即梦工厂相关组件
- `app/api/ai/*` - AI 功能 API（即梦工厂相关）

**验收标准**：
- ✅ AI 视频生成功能正常工作
- ✅ 积分消费逻辑正确
- ✅ 错误处理友好（后端不可用时优雅降级）
- ✅ 用户体验流畅

**风险**：
- 🟡 **中等风险**：AI 功能依赖外部服务，可能有网络或服务可用性问题

**AI 辅助**：✅ 适合 AI 辅助（代码优化、错误处理）

**工作量**：3-4 天

---

## 立即收益任务（Priority 2 - 可选）

### 任务 7：资产库 AI 功能优化（辅助能力）

**是否直接影响部署成功**：❌ 否（AI 是辅助能力，不影响主链路）

**目标**：
- 优化资产库中的 AI 辅助功能（如果有）
- 确保 AI 功能失败时不影响资产检索与管理主链路

**范围**：
- 资产库页面中的 AI 相关功能（如有）
- `app/api/ai/*` - AI 功能 API（资产库相关）

**验收标准**：
- ✅ AI 功能正常工作（如果存在）
- ✅ AI 功能失败时不影响资产检索与管理主链路
- ✅ 错误处理优雅

**风险**：
- 🟢 **低风险**：AI 是辅助能力，不影响核心功能

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：2-3 天

---

### 任务 8：改进错误提示和空状态

**是否直接影响部署成功**：❌ 否（但可以提升用户体验）

**目标**：
- 统一错误提示的样式和文案
- 改进空状态的显示（无搜索结果、无资产、NAS 路径为空等）

**范围**：
- `components/empty-state.tsx`
- `components/error-boundary.tsx`
- `components/errors/error-display.tsx`

**验收标准**：
- ✅ 错误提示样式统一且友好
- ✅ 空状态显示清晰，有明确的引导信息
- ✅ NAS 路径为空时的空状态友好

**风险**：
- 🟢 **低风险**：主要是 UI 改进

**AI 辅助**：✅ 适合 AI 辅助

**工作量**：1-2 天

---

## 实施建议

### 第一周：上线阻塞任务（P0）

**目标**：确保系统可以稳定部署和运行

- 任务 1：环境变量清单与校验脚本（1-2 天）
- 任务 2：OSS 读写与 manifest 一致性（2-3 天）
- 任务 5：Node/依赖版本锁定（1 天）

### 第二周：核心功能与阻塞任务（P0 + P1）

**目标**：完成剩余阻塞任务，提升核心功能稳定性

- 任务 3：NAS 路径展示定位能力（2-3 天）
- 任务 4：基础错误处理（2-3 天）
- 任务 6：即梦工厂 AI 功能稳定（3-4 天）

### 第三周：可选优化（P2）

**目标**：提升用户体验和辅助功能

- 任务 7：资产库 AI 功能优化（2-3 天）
- 任务 8：改进错误提示和空状态（1-2 天）

---

## 不在此路线图中的事项

以下事项**不影响部署成功**，暂不规划：

- ❌ **backend-legacy 相关任务** - 已冻结，不做运维、不做健康检查、不纳入路线图
- ❌ 错误监控服务集成（Sentry 等）- 非阻塞，可在后续需要时添加
- ❌ 单元测试 - 非阻塞，对于小规模内部工具不是必须
- ❌ TypeScript 严格模式 - 非阻塞，当前类型检查已足够
- ❌ 性能优化（虚拟滚动等）- 非阻塞，当前性能可接受
- ❌ API 文档 - 非阻塞，内部使用工具，文档需求较低
- ❌ 批量操作功能 - 非阻塞，可以后续添加

---

## 未来可能项（暂不规划）

### backend-legacy 相关

如果体量/需求确实出现，再评估是否需要重新启用或扩展 backend-legacy 相关功能。

---

## 需要人工确认的问题清单

### 环境配置相关

1. **当前线上环境的实际配置**
   - [ ] Vercel 环境变量是否已完整配置？
   - [ ] 当前线上环境使用的存储模式（应该是 `oss`）？
   - [ ] OSS 配置是否完整且测试通过？

2. **Node.js 版本**
   - [ ] 当前开发环境使用的 Node.js 版本（从代码可见是 Node 20）？
   - [ ] CI/CD 环境使用的 Node.js 版本是否一致？

### NAS 路径相关

3. **NAS 路径展示现状**
   - [ ] 当前 NAS 路径在资产详情页是否正确显示？
   - [ ] NAS 路径为空时的空状态是否友好？
   - [ ] NAS 路径是否需要权限控制（只有授权用户能看到）？

### OSS 数据一致性

4. **OSS manifest 数据**
   - [ ] 当前 OSS 中的 manifest.json、materials.json 是否与预期一致？
   - [ ] OSS 读写权限是否正常？

### AI 功能相关

5. **即梦工厂 AI 功能**
   - [ ] 当前即梦工厂 AI 功能的稳定性如何？
   - [ ] 积分系统和计费逻辑是否正常？

6. **资产库 AI 功能**
   - [ ] 资产库中是否有 AI 辅助功能？
   - [ ] 如果有，这些功能的稳定性如何？

---

## 变更记录

### 2024-XX-XX（本次修订 - 二次纠偏）

1. **P0 任务聚焦调整**：
   - 明确 P0 任务聚焦：环境变量一致性（脚本优先）、OSS（作为展示必需）读写与 manifest 一致性、NAS 作为主取用来源的"展示定位能力"
   - 新增任务 3：NAS 路径展示定位能力（字段、展示、权限、空态）

2. **AI 模块分层标注**：
   - 资产库 AI：P2（可选辅助能力，不影响资产检索与管理主链路）
   - 即梦工厂 AI：P1（主价值模块，AI 体验与计费是主流程，需要稳定）

3. **backend-legacy 处理**：
   - backend-legacy 不进入 P0/P1，只在"未来可能项"里一行带过
   - 明确不做运维、不做健康检查、不纳入路线图

4. **任务完善**：
   - 每个任务都包含：目标、范围、验收标准、风险、AI/人工标注
   - 明确每个任务是否直接影响部署成功

5. **删除内容**：
   - 删除了所有非阻塞任务（监控、测试、性能优化等）
   - 删除了 backend-legacy 相关的任务

6. **脚本重要性强调**：
   - 明确脚本是必需工具，用于降低人为失误
   - 任务 1 强调脚本开发要求（输入/输出/失败提示/运行方法）
