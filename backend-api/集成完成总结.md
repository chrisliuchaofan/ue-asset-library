# âœ… å‰ç«¯ä¸åç«¯é›†æˆå®Œæˆæ€»ç»“

## ğŸ‰ å·²å®Œæˆçš„å·¥ä½œ

### 1. åç«¯æœåŠ¡éƒ¨ç½² âœ…
- âœ… PostgreSQL æ•°æ®åº“å·²å®‰è£…å¹¶é…ç½®
- âœ… æ•°æ®åº“è¡¨ç»“æ„å·²è‡ªåŠ¨åˆ›å»ºï¼ˆusers, credit_transactions, log_entriesï¼‰
- âœ… NestJS åç«¯æœåŠ¡å·²éƒ¨ç½²åˆ° ECS æœåŠ¡å™¨
- âœ… PM2 è¿›ç¨‹ç®¡ç†å·²é…ç½®
- âœ… Nginx åå‘ä»£ç†å·²é…ç½®
- âœ… SSL è¯ä¹¦å·²é…ç½®ï¼ˆHTTPSï¼‰

### 2. ç¯å¢ƒå˜é‡é…ç½® âœ…
- âœ… æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆDB_HOST, DB_PORT, DB_NAME, DB_USERNAME, DB_PASSWORDï¼‰
- âœ… ç”¨æˆ·ç™½åå•é…ç½®ï¼ˆUSER_WHITELISTï¼‰
- âœ… JWT å¯†é’¥é…ç½®ï¼ˆJWT_SECRETï¼‰
- âœ… å‰ç«¯ URL é…ç½®ï¼ˆFRONTEND_URLï¼‰

### 3. API æ¥å£æµ‹è¯• âœ…
- âœ… å¥åº·æ£€æŸ¥ï¼š`GET /health`
- âœ… ç”¨æˆ·ç™»å½•ï¼š`POST /auth/login`
- âœ… Token éªŒè¯ï¼š`POST /auth/verify`
- âœ… æŸ¥è¯¢ç§¯åˆ†ï¼š`GET /credits/balance`
- âœ… æ¶ˆè´¹ç§¯åˆ†ï¼š`POST /credits/consume`
- âœ… åˆ›å»ºæ—¥å¿—ï¼š`POST /logs/create`

### 4. æ•°æ®åº“é›†æˆ âœ…
- âœ… TypeORM å·²é…ç½®
- âœ… ç”¨æˆ·æ•°æ®æŒä¹…åŒ–
- âœ… ç§¯åˆ†äº¤æ˜“è®°å½•
- âœ… æ“ä½œæ—¥å¿—è®°å½•

### 5. è‡ªåŠ¨åŒ–éƒ¨ç½² âœ…
- âœ… GitHub Actions è‡ªåŠ¨éƒ¨ç½²é…ç½®
- âœ… ä»£ç æ›´æ–°è‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨

---

## ğŸ“Š å½“å‰ç³»ç»Ÿæ¶æ„

```
å‰ç«¯ (Vercel)
  â””â”€ https://www.factory-buy.com
      â”‚
      â””â”€ API è°ƒç”¨
          â”‚
          â””â”€ åç«¯ (ECS)
              â””â”€ https://api.factory-buy.com
                  â”‚
                  â”œâ”€ NestJS åº”ç”¨ (PM2)
                  â”‚   â”œâ”€ è®¤è¯æ¨¡å—
                  â”‚   â”œâ”€ ç§¯åˆ†æ¨¡å—
                  â”‚   â””â”€ æ—¥å¿—æ¨¡å—
                  â”‚
                  â””â”€ PostgreSQL æ•°æ®åº“
                      â”œâ”€ users
                      â”œâ”€ credit_transactions
                      â””â”€ log_entries
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### 1. å‰ç«¯ API å®¢æˆ·ç«¯å°è£…

åˆ›å»ºç»Ÿä¸€çš„å‰ç«¯ API å®¢æˆ·ç«¯ï¼Œå°è£…æ‰€æœ‰åç«¯ API è°ƒç”¨ï¼š

**æ–‡ä»¶ï¼š`lib/backend-api-client.ts`**

```typescript
const BACKEND_API_URL = process.env.NEXT_PUBLIC_BACKEND_API_URL || 'https://api.factory-buy.com';

export class BackendApiClient {
  private token: string | null = null;

  setToken(token: string) {
    this.token = token;
  }

  clearToken() {
    this.token = null;
  }

  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const headers: HeadersInit = {
      'Content-Type': 'application/json',
      ...options.headers,
    };

    if (this.token) {
      headers['Authorization'] = `Bearer ${this.token}`;
    }

    const response = await fetch(`${BACKEND_API_URL}${endpoint}`, {
      ...options,
      headers,
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ message: response.statusText }));
      throw new Error(error.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    return response.json();
  }

  // è®¤è¯ç›¸å…³
  async login(email: string, password: string) {
    const data = await this.request<{
      success: boolean;
      token: string;
      userId: string;
      email: string;
    }>('/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password }),
    });
    
    if (data.token) {
      this.setToken(data.token);
    }
    
    return data;
  }

  // ç§¯åˆ†ç›¸å…³
  async getBalance(userId: string) {
    return this.request<{ balance: number }>('/credits/balance', {
      headers: { 'X-User-Id': userId },
    });
  }

  async consumeCredits(userId: string, amount: number, action: string) {
    return this.request<{
      success: boolean;
      balance: number;
      transactionId: string;
    }>('/credits/consume', {
      method: 'POST',
      headers: { 'X-User-Id': userId },
      body: JSON.stringify({ amount, action }),
    });
  }

  // æ—¥å¿—ç›¸å…³
  async createLog(
    userId: string,
    action: string,
    details?: any,
    success: boolean = true
  ) {
    return this.request<{ logId: string }>('/logs/create', {
      method: 'POST',
      headers: { 'X-User-Id': userId },
      body: JSON.stringify({
        action,
        details,
        success,
        timestamp: new Date().toISOString(),
      }),
    });
  }
}

export const backendApi = new BackendApiClient();
```

### 2. å‰ç«¯ UI é›†æˆ

#### 2.1 ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶

**æ–‡ä»¶ï¼š`components/user-credits.tsx`**

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { backendApi } from '@/lib/backend-api-client';

export function UserCredits() {
  const { data: session } = useSession();
  const [balance, setBalance] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (session?.user?.email) {
      backendApi.getBalance(session.user.email)
        .then((data) => {
          setBalance(data.balance);
          setLoading(false);
        })
        .catch((error) => {
          console.error('è·å–ç§¯åˆ†å¤±è´¥:', error);
          setLoading(false);
        });
    }
  }, [session]);

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-gray-600">ç§¯åˆ†ä½™é¢ï¼š</span>
      <span className="font-bold text-blue-600">{balance ?? 0}</span>
    </div>
  );
}
```

#### 2.2 ç§¯åˆ†æ¶ˆè´¹è®°å½•ç»„ä»¶

**æ–‡ä»¶ï¼š`components/credit-history.tsx`**

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

interface Transaction {
  id: string;
  amount: number;
  action: string;
  timestamp: Date;
}

export function CreditHistory() {
  const { data: session } = useSession();
  const [transactions, setTransactions] = useState<Transaction[]>([]);

  // TODO: å®ç°è·å–äº¤æ˜“è®°å½•çš„ API
  // éœ€è¦åœ¨åç«¯æ·»åŠ  GET /credits/history æ¥å£

  return (
    <div>
      <h3>ç§¯åˆ†æ¶ˆè´¹è®°å½•</h3>
      {/* æ˜¾ç¤ºäº¤æ˜“è®°å½•åˆ—è¡¨ */}
    </div>
  );
}
```

### 3. åœ¨éœ€è¦çš„åœ°æ–¹é›†æˆ

#### 3.1 åœ¨ AI ç”ŸæˆåŠŸèƒ½ä¸­æ¶ˆè´¹ç§¯åˆ†

åœ¨ `app/api/ai/generate-text/route.ts` æˆ–ç›¸å…³æ–‡ä»¶ä¸­ï¼š

```typescript
import { backendApi } from '@/lib/backend-api-client';

// åœ¨ç”Ÿæˆå†…å®¹å‰æ¶ˆè´¹ç§¯åˆ†
const userId = session?.user?.email;
if (userId) {
  try {
    const result = await backendApi.consumeCredits(
      userId,
      10, // æ¶ˆè´¹ 10 ç§¯åˆ†
      'ai_text_generation'
    );
    
    // è®°å½•æ—¥å¿—
    await backendApi.createLog(
      userId,
      'ai_text_generation',
      { prompt, model: 'qwen' },
      true
    );
    
    // ç»§ç»­ç”Ÿæˆå†…å®¹...
  } catch (error) {
    // ç§¯åˆ†ä¸è¶³æˆ–å…¶ä»–é”™è¯¯
    return NextResponse.json(
      { error: 'ç§¯åˆ†ä¸è¶³æˆ–æ“ä½œå¤±è´¥' },
      { status: 402 }
    );
  }
}
```

#### 3.2 åœ¨ç®¡ç†é¡µé¢æ˜¾ç¤ºç§¯åˆ†

åœ¨ `app/admin/page.tsx` ä¸­ï¼š

```typescript
import { UserCredits } from '@/components/user-credits';

export default function AdminPage() {
  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <h1>ç®¡ç†åå°</h1>
        <UserCredits />
      </div>
      {/* å…¶ä»–å†…å®¹ */}
    </div>
  );
}
```

### 4. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Vercel ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```
NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
```

### 5. åç«¯åŠŸèƒ½æ‰©å±•

#### 5.1 æ·»åŠ ç§¯åˆ†å……å€¼æ¥å£

```typescript
// backend-api/src/credits/credits.controller.ts
@Post('recharge')
async recharge(
  @Headers('x-user-id') userId: string,
  @Body() body: { amount: number }
) {
  return this.creditsService.recharge(userId, body.amount);
}
```

#### 5.2 æ·»åŠ ç§¯åˆ†å†å²æŸ¥è¯¢æ¥å£

```typescript
// backend-api/src/credits/credits.controller.ts
@Get('history')
async getHistory(
  @Headers('x-user-id') userId: string,
  @Query('limit') limit: number = 50
) {
  return this.creditsService.getHistory(userId, limit);
}
```

#### 5.3 æ·»åŠ æ—¥å¿—æŸ¥è¯¢æ¥å£

```typescript
// backend-api/src/logs/logs.controller.ts
@Get('list')
async getLogs(
  @Headers('x-user-id') userId: string,
  @Query('limit') limit: number = 50
) {
  return this.logsService.getUserLogs(userId, limit);
}
```

---

## ğŸ“ å¾…åŠäº‹é¡¹æ¸…å•

- [ ] åˆ›å»ºå‰ç«¯ API å®¢æˆ·ç«¯å°è£…
- [ ] åœ¨ Vercel é…ç½® `NEXT_PUBLIC_BACKEND_API_URL`
- [ ] åˆ›å»ºç”¨æˆ·ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶
- [ ] åœ¨ç®¡ç†é¡µé¢é›†æˆç§¯åˆ†æ˜¾ç¤º
- [ ] åœ¨ AI ç”ŸæˆåŠŸèƒ½ä¸­é›†æˆç§¯åˆ†æ¶ˆè´¹
- [ ] æ·»åŠ ç§¯åˆ†æ¶ˆè´¹è®°å½•æŸ¥è¯¢åŠŸèƒ½
- [ ] æ·»åŠ æ“ä½œæ—¥å¿—æŸ¥è¯¢åŠŸèƒ½
- [ ] æ·»åŠ ç§¯åˆ†å……å€¼åŠŸèƒ½ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- [ ] æ·»åŠ åŠ è½½çŠ¶æ€å’ŒåŠ¨ç”»

---

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. âœ… åç«¯æœåŠ¡éƒ¨ç½²å’Œæµ‹è¯•ï¼ˆå·²å®Œæˆï¼‰
2. ğŸ”„ åˆ›å»ºå‰ç«¯ API å®¢æˆ·ç«¯å°è£…
3. ğŸ”„ åœ¨ AI ç”ŸæˆåŠŸèƒ½ä¸­é›†æˆç§¯åˆ†æ¶ˆè´¹

### ä¸­ä¼˜å…ˆçº§
4. åˆ›å»ºç”¨æˆ·ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶
5. åœ¨ç®¡ç†é¡µé¢æ˜¾ç¤ºç§¯åˆ†ä½™é¢
6. æ·»åŠ ç§¯åˆ†æ¶ˆè´¹è®°å½•æŸ¥è¯¢

### ä½ä¼˜å…ˆçº§
7. æ·»åŠ ç§¯åˆ†å……å€¼åŠŸèƒ½
8. å®Œå–„æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½
9. æ·»åŠ æ›´å¤šç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½

---

## ğŸ”§ æŠ€æœ¯æ ˆæ€»ç»“

- **å‰ç«¯**: Next.js 16, React 19, TypeScript
- **åç«¯**: NestJS, TypeORM, PostgreSQL
- **éƒ¨ç½²**: Vercel (å‰ç«¯), é˜¿é‡Œäº‘ ECS (åç«¯)
- **æ•°æ®åº“**: PostgreSQL
- **è¿›ç¨‹ç®¡ç†**: PM2
- **åå‘ä»£ç†**: Nginx
- **CI/CD**: GitHub Actions

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•å‰ç«¯åç«¯é›†æˆ.md](./æµ‹è¯•å‰ç«¯åç«¯é›†æˆ.md) - è¯¦ç»†çš„æµ‹è¯•æŒ‡å—
- [å¿«é€Ÿæµ‹è¯•æŒ‡å—.md](./å¿«é€Ÿæµ‹è¯•æŒ‡å—.md) - å¿«é€Ÿå¼€å§‹æµ‹è¯•
- [æ•°æ®åº“è®¾ç½®æŒ‡å—.md](../æ•°æ®åº“è®¾ç½®æŒ‡å—.md) - æ•°æ®åº“é…ç½®è¯´æ˜
- [éƒ¨ç½²è‡ªåŠ¨åŒ–è®¾ç½®æŒ‡å—.md](../éƒ¨ç½²è‡ªåŠ¨åŒ–è®¾ç½®æŒ‡å—.md) - è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®

---

**æ­å–œï¼å‰ç«¯ä¸åç«¯é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ğŸ‰**

ç°åœ¨å¯ä»¥å¼€å§‹å°†åç«¯ API é›†æˆåˆ°å‰ç«¯ä»£ç ä¸­äº†ã€‚

