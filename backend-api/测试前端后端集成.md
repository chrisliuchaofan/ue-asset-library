# ğŸ§ª å‰ç«¯ä¸åç«¯é›†æˆæµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

1. **ç¡®è®¤åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸**
   ```bash
   # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
   pm2 status
   curl http://localhost:3001/health
   ```

2. **ç¡®è®¤å‰ç«¯å¯ä»¥è®¿é—®åç«¯ API**
   - åç«¯ API åœ°å€ï¼š`https://api.factory-buy.com`
   - å‰ç«¯åœ°å€ï¼š`https://www.factory-buy.com`

3. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼ˆF12ï¼‰

---

## 1. åŸºç¡€è¿æ¥æµ‹è¯•

### 1.1 æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æµ‹è¯•å¥åº·æ£€æŸ¥
fetch('https://api.factory-buy.com/health')
  .then(r => r.json())
  .then(data => {
    console.log('âœ… åç«¯å¥åº·æ£€æŸ¥æˆåŠŸ:', data);
  })
  .catch(err => {
    console.error('âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥:', err);
  });
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "status": "ok",
  "timestamp": 1234567890
}
```

---

## 2. ç”¨æˆ·è®¤è¯æµ‹è¯•

### 2.1 æµ‹è¯•ç™»å½• API

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æµ‹è¯•ç™»å½•ï¼ˆéœ€è¦å…ˆåœ¨åç«¯é…ç½®ç”¨æˆ·ï¼‰
fetch('https://api.factory-buy.com/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    email: 'test@factory-buy.com',  // æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·é‚®ç®±
    password: 'password123'         // æ›¿æ¢ä¸ºå®é™…å¯†ç 
  })
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… ç™»å½•æˆåŠŸ:', data);
    // ä¿å­˜ token ä¾›åç»­æµ‹è¯•ä½¿ç”¨
    window.testToken = data.token;
  })
  .catch(err => {
    console.error('âŒ ç™»å½•å¤±è´¥:', err);
  });
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "email": "test@factory-buy.com"
  }
}
```

### 2.2 æµ‹è¯• Token éªŒè¯

```javascript
// ä½¿ç”¨ç™»å½•è·å¾—çš„ token
fetch('https://api.factory-buy.com/auth/verify', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    token: window.testToken  // ä½¿ç”¨ä¸Šé¢ä¿å­˜çš„ token
  })
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… Token éªŒè¯æˆåŠŸ:', data);
  })
  .catch(err => {
    console.error('âŒ Token éªŒè¯å¤±è´¥:', err);
  });
```

---

## 3. ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•

### 3.1 æŸ¥è¯¢ç§¯åˆ†ä½™é¢

```javascript
// éœ€è¦å…ˆç™»å½•è·å– token
const userId = 'test@factory-buy.com';  // æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·é‚®ç®±

fetch('https://api.factory-buy.com/credits/balance', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${window.testToken}`,  // ä½¿ç”¨ç™»å½•è·å¾—çš„ token
    'X-User-Id': userId
  }
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… ç§¯åˆ†ä½™é¢:', data);
  })
  .catch(err => {
    console.error('âŒ æŸ¥è¯¢ç§¯åˆ†å¤±è´¥:', err);
  });
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "balance": 100
}
```

### 3.2 æ¶ˆè´¹ç§¯åˆ†

```javascript
const userId = 'test@factory-buy.com';

fetch('https://api.factory-buy.com/credits/consume', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${window.testToken}`,
    'X-User-Id': userId
  },
  body: JSON.stringify({
    amount: 10,
    action: 'test_action'
  })
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… æ¶ˆè´¹ç§¯åˆ†æˆåŠŸ:', data);
  })
  .catch(err => {
    console.error('âŒ æ¶ˆè´¹ç§¯åˆ†å¤±è´¥:', err);
  });
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": true,
  "balance": 90,
  "transactionId": "txn-1234567890-abc123"
}
```

---

## 4. æ—¥å¿—ç³»ç»Ÿæµ‹è¯•

### 4.1 åˆ›å»ºæ—¥å¿—

```javascript
const userId = 'test@factory-buy.com';

fetch('https://api.factory-buy.com/logs/create', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${window.testToken}`,
    'X-User-Id': userId
  },
  body: JSON.stringify({
    action: 'test_action',
    details: {
      message: 'æµ‹è¯•æ—¥å¿—',
      timestamp: new Date().toISOString()
    },
    success: true,
    timestamp: new Date().toISOString()
  })
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… åˆ›å»ºæ—¥å¿—æˆåŠŸ:', data);
  })
  .catch(err => {
    console.error('âŒ åˆ›å»ºæ—¥å¿—å¤±è´¥:', err);
  });
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "logId": "uuid-12345678-1234-1234-1234-123456789abc"
}
```

---

## 5. é”™è¯¯å¤„ç†æµ‹è¯•

### 5.1 æµ‹è¯•æœªè®¤è¯è®¿é—®

```javascript
// ä¸æä¾› token
fetch('https://api.factory-buy.com/credits/balance', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'X-User-Id': 'test@factory-buy.com'
  }
})
  .then(r => r.json())
  .then(data => {
    console.log('å“åº”:', data);
  })
  .catch(err => {
    console.error('âŒ é¢„æœŸé”™è¯¯ï¼ˆæœªè®¤è¯ï¼‰:', err);
  });
```

**é¢„æœŸç»“æœï¼š** è¿”å› 401 æœªæˆæƒé”™è¯¯

### 5.2 æµ‹è¯•ç§¯åˆ†ä¸è¶³

```javascript
// å°è¯•æ¶ˆè´¹è¶…è¿‡ä½™é¢çš„ç§¯åˆ†
fetch('https://api.factory-buy.com/credits/consume', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${window.testToken}`,
    'X-User-Id': userId
  },
  body: JSON.stringify({
    amount: 999999,  // è¶…è¿‡ä½™é¢
    action: 'test_action'
  })
})
  .then(r => r.json())
  .then(data => {
    console.log('å“åº”:', data);
  })
  .catch(err => {
    console.error('âŒ é¢„æœŸé”™è¯¯ï¼ˆç§¯åˆ†ä¸è¶³ï¼‰:', err);
  });
```

**é¢„æœŸç»“æœï¼š** è¿”å› 402 æ”¯ä»˜è¦æ±‚é”™è¯¯ï¼ŒåŒ…å« `INSUFFICIENT_CREDITS` ä»£ç 

---

## 6. CORS æµ‹è¯•

### 6.1 ä»å‰ç«¯é¡µé¢æµ‹è¯•

åœ¨ `https://www.factory-buy.com` é¡µé¢çš„æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æµ‹è¯• CORS æ˜¯å¦é…ç½®æ­£ç¡®
fetch('https://api.factory-buy.com/health', {
  method: 'GET',
  credentials: 'include'  // åŒ…å« cookies
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… CORS é…ç½®æ­£ç¡®:', data);
  })
  .catch(err => {
    console.error('âŒ CORS é…ç½®é”™è¯¯:', err);
  });
```

**é¢„æœŸç»“æœï¼š** æˆåŠŸè¿”å›æ•°æ®ï¼Œæ²¡æœ‰ CORS é”™è¯¯

---

## 7. å®Œæ•´æµç¨‹æµ‹è¯•

### 7.1 å®Œæ•´ç”¨æˆ·æµç¨‹

```javascript
// 1. ç™»å½•
async function testFullFlow() {
  try {
    // ç™»å½•
    const loginRes = await fetch('https://api.factory-buy.com/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'test@factory-buy.com',
        password: 'password123'
      })
    });
    const loginData = await loginRes.json();
    const token = loginData.token;
    const userId = 'test@factory-buy.com';
    
    console.log('âœ… 1. ç™»å½•æˆåŠŸ');
    
    // 2. æŸ¥è¯¢ç§¯åˆ†
    const balanceRes = await fetch('https://api.factory-buy.com/credits/balance', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'X-User-Id': userId
      }
    });
    const balanceData = await balanceRes.json();
    console.log('âœ… 2. æŸ¥è¯¢ç§¯åˆ†æˆåŠŸ:', balanceData);
    
    // 3. æ¶ˆè´¹ç§¯åˆ†
    const consumeRes = await fetch('https://api.factory-buy.com/credits/consume', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'X-User-Id': userId
      },
      body: JSON.stringify({
        amount: 5,
        action: 'test_flow'
      })
    });
    const consumeData = await consumeRes.json();
    console.log('âœ… 3. æ¶ˆè´¹ç§¯åˆ†æˆåŠŸ:', consumeData);
    
    // 4. åˆ›å»ºæ—¥å¿—
    const logRes = await fetch('https://api.factory-buy.com/logs/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'X-User-Id': userId
      },
      body: JSON.stringify({
        action: 'test_flow',
        details: { test: true },
        success: true,
        timestamp: new Date().toISOString()
      })
    });
    const logData = await logRes.json();
    console.log('âœ… 4. åˆ›å»ºæ—¥å¿—æˆåŠŸ:', logData);
    
    console.log('ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼');
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
  }
}

// æ‰§è¡Œæµ‹è¯•
testFullFlow();
```

---

## 8. æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åç«¯å¥åº·æ£€æŸ¥æ­£å¸¸
- [ ] ç™»å½• API æ­£å¸¸å·¥ä½œ
- [ ] Token éªŒè¯æ­£å¸¸å·¥ä½œ
- [ ] æŸ¥è¯¢ç§¯åˆ†ä½™é¢æ­£å¸¸
- [ ] æ¶ˆè´¹ç§¯åˆ†æ­£å¸¸
- [ ] åˆ›å»ºæ—¥å¿—æ­£å¸¸
- [ ] æœªè®¤è¯è®¿é—®æ­£ç¡®è¿”å› 401
- [ ] ç§¯åˆ†ä¸è¶³æ­£ç¡®è¿”å› 402
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡

---

## 9. å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šCORS é”™è¯¯

**ç—‡çŠ¶ï¼š** æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º `CORS policy` é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åç«¯ `main.ts` ä¸­çš„ CORS é…ç½®
2. ç¡®è®¤ `FRONTEND_URL` ç¯å¢ƒå˜é‡åŒ…å«å‰ç«¯åŸŸå
3. é‡å¯åç«¯æœåŠ¡ï¼š`pm2 restart ue-assets-backend --update-env`

### é—®é¢˜ 2ï¼š401 æœªæˆæƒ

**ç—‡çŠ¶ï¼š** æ‰€æœ‰éœ€è¦è®¤è¯çš„ API éƒ½è¿”å› 401

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤æä¾›äº†æ­£ç¡®çš„ `Authorization` header
2. ç¡®è®¤ token æœªè¿‡æœŸ
3. æ£€æŸ¥åç«¯ `JWT_SECRET` ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 3ï¼š404 æœªæ‰¾åˆ°

**ç—‡çŠ¶ï¼š** API è¿”å› 404

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤ API è·¯å¾„æ­£ç¡®ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰
2. æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®ä»£ç†åˆ°åç«¯
3. ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ

### é—®é¢˜ 4ï¼šæ•°æ®åº“è¿æ¥é”™è¯¯

**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤ºæ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
2. ç¡®è®¤ PostgreSQL æœåŠ¡æ­£åœ¨è¿è¡Œ
3. æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™

---

## 10. ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ï¼š

1. **é›†æˆåˆ°å‰ç«¯ä»£ç **
   - åˆ›å»ºå‰ç«¯ API å®¢æˆ·ç«¯å°è£…
   - åœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨åç«¯ API
   - å¤„ç†é”™è¯¯å’ŒåŠ è½½çŠ¶æ€

2. **æ·»åŠ å‰ç«¯ UI**
   - æ˜¾ç¤ºç”¨æˆ·ç§¯åˆ†ä½™é¢
   - æ˜¾ç¤ºç§¯åˆ†æ¶ˆè´¹è®°å½•
   - æ˜¾ç¤ºæ“ä½œæ—¥å¿—

3. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - æ·»åŠ é”™è¯¯æç¤º
   - æ·»åŠ æˆåŠŸæç¤º

---

**æµ‹è¯•å®Œæˆåï¼Œè¯·è®°å½•æµ‹è¯•ç»“æœå’Œå‘ç°çš„é—®é¢˜ï¼**

