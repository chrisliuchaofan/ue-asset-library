# 🔍 快速诊断指南 - 500 错误排查

## 问题：前端调用 `/api/ai/generate-text` 返回 500 错误

### 快速检查清单

#### 1. 检查后端 API 配置（推荐方案）

**检查项：**
- [ ] 后端服务器 `.env` 文件中是否配置了 `MODEL_ENABLED=false` 和 `BILLING_ENABLED=false`
- [ ] 后端服务是否已重启（`pm2 restart ue-assets-backend --update-env`）
- [ ] 后端 API 是否可访问（`curl https://api.factory-buy.com/health`）

**前端配置：**
```env
# .env.local 或 Vercel 环境变量
NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
BACKEND_TEST_EMAIL=test@factory-buy.com
BACKEND_TEST_PASSWORD=password123
```

**验证：**
```bash
# 测试后端 API 是否可访问
curl https://api.factory-buy.com/health

# 测试后端登录
curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"password123"}'
```

---

#### 2. 检查前端 AI 服务配置（Fallback 方案）

**检查项：**
- [ ] 前端环境变量中是否配置了 `AI_IMAGE_API_KEY`
- [ ] API Key 是否有效

**配置：**
```env
# .env.local 或 Vercel 环境变量
AI_IMAGE_API_KEY=sk-xxxxx
AI_IMAGE_API_ENDPOINT=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

**验证：**
```bash
# 检查环境变量是否加载
echo $AI_IMAGE_API_KEY
```

---

### 常见错误及解决方案

#### 错误 1：`AI 服务未配置`

**症状：** 返回 503 错误，错误信息包含 "AI 服务未配置"

**原因：** 
- 后端 API 未配置（`NEXT_PUBLIC_BACKEND_API_URL` 未设置）
- 前端 AI 服务未配置（`AI_IMAGE_API_KEY` 未设置）

**解决：**
1. **推荐：** 配置后端 API（支持 dry run 模式）
   ```env
   NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
   BACKEND_TEST_EMAIL=test@factory-buy.com
   BACKEND_TEST_PASSWORD=password123
   ```

2. **备选：** 配置前端 AI 服务
   ```env
   AI_IMAGE_API_KEY=sk-xxxxx
   ```

---

#### 错误 2：`后端API调用失败`

**症状：** 控制台警告 "后端API调用失败，回退到前端服务"

**原因：**
- 后端 API 不可访问（网络问题）
- 后端 API 认证失败（token 获取失败）
- 后端 API 返回错误（500/401/403）

**解决：**
1. 检查后端 API 是否可访问
   ```bash
   curl https://api.factory-buy.com/health
   ```

2. 检查后端用户白名单配置
   ```env
   # 后端 .env
   USER_WHITELIST=test@factory-buy.com:password123
   ```

3. 检查后端服务状态
   ```bash
   pm2 status
   pm2 logs ue-assets-backend --lines 50
   ```

---

#### 错误 3：`千问API密钥未配置`

**症状：** 返回 500 错误，错误信息包含 "千问API密钥未配置"

**原因：** 前端 fallback 到本地 AI 服务，但 `AI_IMAGE_API_KEY` 未配置

**解决：**
1. **推荐：** 配置后端 API（支持 dry run 模式）
2. **备选：** 配置前端 AI 服务密钥

---

#### 错误 4：`千问API调用失败`

**症状：** 返回 500 错误，错误信息包含 "千问API调用失败"

**原因：** 
- API Key 无效
- API 端点不可访问
- API 返回错误（401/403/500）

**解决：**
1. 验证 API Key 是否有效
2. 检查 API 端点是否正确
3. 查看 API 返回的详细错误信息

---

### 调试步骤

#### 步骤 1：查看服务器日志

**前端日志（Next.js）：**
```bash
# 开发环境
npm run dev
# 查看控制台输出

# 生产环境（Vercel）
# 在 Vercel Dashboard 查看 Function Logs
```

**后端日志：**
```bash
# SSH 登录到后端服务器
pm2 logs ue-assets-backend --lines 100
```

#### 步骤 2：检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签页
3. 重新触发请求
4. 查看 `/api/ai/generate-text` 请求：
   - **Request Headers**：检查认证信息
   - **Request Payload**：检查请求体
   - **Response**：查看错误详情

#### 步骤 3：测试 API 端点

**测试后端 API：**
```bash
# 1. 登录获取 token
TOKEN=$(curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"password123"}' \
  | jq -r '.token')

# 2. 测试生成文本
curl -X POST https://api.factory-buy.com/ai/generate-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "prompt": "测试",
    "presetId": "qwen-turbo-standard"
  }' | jq .
```

**测试前端 API：**
```bash
# 本地开发环境
curl -X POST http://localhost:3000/api/ai/generate-text \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "测试",
    "provider": "qwen"
  }' | jq .
```

---

### 推荐配置（Dry Run 模式）

**后端配置（`/opt/ue-assets-backend/backend-api/.env`）：**
```env
# Dry Run 模式（0成本测试）
MODEL_ENABLED=false
BILLING_ENABLED=false

# 用户白名单
USER_WHITELIST=test@factory-buy.com:password123

# 其他配置...
```

**前端配置（`.env.local` 或 Vercel）：**
```env
# 后端 API 配置（推荐）
NEXT_PUBLIC_BACKEND_API_URL=https://api.factory-buy.com
BACKEND_TEST_EMAIL=test@factory-buy.com
BACKEND_TEST_PASSWORD=password123
```

**验证配置：**
```bash
# 1. 重启后端服务
pm2 restart ue-assets-backend --update-env

# 2. 测试后端 API
curl https://api.factory-buy.com/health

# 3. 测试前端 API
curl -X POST http://localhost:3000/api/ai/generate-text \
  -H "Content-Type: application/json" \
  -d '{"prompt":"测试","presetId":"qwen-turbo-standard"}'
```

---

### 快速修复脚本

如果遇到 500 错误，可以运行以下脚本快速诊断：

```bash
#!/bin/bash

echo "🔍 开始诊断..."

# 1. 检查后端 API
echo "1️⃣ 检查后端 API..."
if curl -s https://api.factory-buy.com/health > /dev/null; then
  echo "✅ 后端 API 可访问"
else
  echo "❌ 后端 API 不可访问"
fi

# 2. 检查后端登录
echo "2️⃣ 检查后端登录..."
TOKEN=$(curl -s -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"password123"}' \
  | jq -r '.token')

if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
  echo "✅ 后端登录成功"
else
  echo "❌ 后端登录失败"
fi

# 3. 检查前端环境变量
echo "3️⃣ 检查前端环境变量..."
if [ -n "$NEXT_PUBLIC_BACKEND_API_URL" ]; then
  echo "✅ NEXT_PUBLIC_BACKEND_API_URL 已配置: $NEXT_PUBLIC_BACKEND_API_URL"
else
  echo "❌ NEXT_PUBLIC_BACKEND_API_URL 未配置"
fi

if [ -n "$AI_IMAGE_API_KEY" ]; then
  echo "✅ AI_IMAGE_API_KEY 已配置"
else
  echo "❌ AI_IMAGE_API_KEY 未配置"
fi

echo "🎉 诊断完成！"
```

---

### 总结

**推荐方案：** 使用后端 API + Dry Run 模式
- ✅ 支持 0 成本测试
- ✅ 统一的错误处理
- ✅ 更好的安全性

**备选方案：** 使用前端 AI 服务
- ⚠️ 需要配置 API Key
- ⚠️ 可能产生费用
- ⚠️ 不支持 dry run 模式

**如果仍然遇到问题，请检查：**
1. 服务器日志（前端 + 后端）
2. 网络请求详情（浏览器开发者工具）
3. 环境变量配置（前端 + 后端）

