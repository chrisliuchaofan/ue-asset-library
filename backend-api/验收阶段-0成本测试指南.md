# ğŸ§ª éªŒæ”¶é˜¶æ®µ - 0 æˆæœ¬å›å½’æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### 1. é…ç½® Dry Run æ¨¡å¼

åœ¨æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Dry Run æ¨¡å¼é…ç½®
MODEL_ENABLED=false          # ç¦ç”¨çœŸå®æ¨¡å‹è°ƒç”¨
BILLING_ENABLED=false        # ç¦ç”¨çœŸå®æ‰£è´¹

# å…¶ä»–é…ç½®ä¿æŒä¸å˜
```

### 2. é‡å¯æœåŠ¡

```bash
pm2 restart ue-assets-backend --update-env
```

---

## âœ… æµ‹è¯•æ¸…å•

### æµ‹è¯• 1ï¼šå¹‚ç­‰æ‰£è´¹ï¼ˆæ•°æ®åº“çº§çº¦æŸï¼‰

**ç›®æ ‡ï¼š** ç¡®ä¿åŒä¸€ä¸ª jobId åªèƒ½äº§ç”Ÿä¸€æ¬¡æ‰£è´¹äº¤æ˜“

**æ­¥éª¤ï¼š**

```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"password123"}' \
  | jq -r '.token')

# 2. ç¬¬ä¸€æ¬¡æ¶ˆè´¹ï¼ˆå¸¦ refIdï¼‰
curl -X POST https://api.factory-buy.com/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "amount": 10,
    "action": "test_action",
    "refId": "job-12345"
  }'

# 3. ç¬¬äºŒæ¬¡æ¶ˆè´¹ï¼ˆç›¸åŒçš„ refId + actionï¼‰- åº”è¯¥è¿”å›å¹‚ç­‰ç»“æœ
curl -X POST https://api.factory-buy.com/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "amount": 10,
    "action": "test_action",
    "refId": "job-12345"
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… ç¬¬ä¸€æ¬¡ï¼šæ­£å¸¸æ‰£è´¹ï¼Œè¿”å› `isIdempotent: false`
- âœ… ç¬¬äºŒæ¬¡ï¼šè¿”å›å·²å­˜åœ¨çš„äº¤æ˜“ï¼Œ`isIdempotent: true`ï¼Œä½™é¢ä¸å˜

**éªŒè¯ï¼š**
```bash
# æŸ¥è¯¢äº¤æ˜“è®°å½•ï¼Œåº”è¯¥åªæœ‰ä¸€æ¡
curl https://api.factory-buy.com/credits/balance \
  -H "Authorization: Bearer $TOKEN"
```

---

### æµ‹è¯• 2ï¼šDry Run æ¨¡å¼ - æ¨¡å‹è°ƒç”¨

**ç›®æ ‡ï¼š** éªŒè¯ MODEL_ENABLED=false æ—¶ä¸è°ƒç”¨çœŸå®æ¨¡å‹

**æ­¥éª¤ï¼š**

```bash
# 1. è°ƒç”¨ AI ç”Ÿæˆï¼ˆDry Run æ¨¡å¼ï¼‰
curl -X POST https://api.factory-buy.com/ai/generate-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "prompt": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±",
    "presetId": "qwen-turbo-standard"
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… è¿”å› mock æ•°æ®ï¼ŒåŒ…å« `[Mock Response]` æ ‡è®°
- âœ… `raw.mock: true`
- âœ… ä¸äº§ç”Ÿä»»ä½•æ¨¡å‹ API è°ƒç”¨è´¹ç”¨

**éªŒè¯ï¼š**
- æ£€æŸ¥å“åº”ä¸­çš„ `raw.mock` å­—æ®µ
- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼Œä¸åº”è¯¥æœ‰çœŸå®çš„ API è°ƒç”¨

---

### æµ‹è¯• 3ï¼šDry Run æ¨¡å¼ - æ‰£è´¹

**ç›®æ ‡ï¼š** éªŒè¯ BILLING_ENABLED=false æ—¶ä¸å†™çœŸå®æ‰£è´¹

**æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥è¯¢å½“å‰ä½™é¢
BALANCE_BEFORE=$(curl https://api.factory-buy.com/credits/balance \
  -H "Authorization: Bearer $TOKEN" | jq -r '.balance')

# 2. æ¶ˆè´¹ç§¯åˆ†ï¼ˆDry Run æ¨¡å¼ï¼‰
curl -X POST https://api.factory-buy.com/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "amount": 10,
    "action": "test_dry_run"
  }'

# 3. å†æ¬¡æŸ¥è¯¢ä½™é¢
BALANCE_AFTER=$(curl https://api.factory-buy.com/credits/balance \
  -H "Authorization: Bearer $TOKEN" | jq -r '.balance')
```

**é¢„æœŸç»“æœï¼š**
- âœ… è¿”å› `isDryRun: true`
- âœ… è¿”å›æ¨¡æ‹Ÿçš„ `transactionId`ï¼ˆä»¥ `mock-txn-` å¼€å¤´ï¼‰
- âœ… ä½™é¢ä¸å˜ï¼ˆ`BALANCE_BEFORE === BALANCE_AFTER`ï¼‰
- âœ… æ•°æ®åº“ä¸­æ²¡æœ‰æ–°å¢äº¤æ˜“è®°å½•

**éªŒè¯ï¼š**
```bash
# æ£€æŸ¥æ•°æ®åº“ï¼ˆåº”è¯¥æ²¡æœ‰æ–°è®°å½•ï¼‰
# æˆ–è€…æ£€æŸ¥è¿”å›çš„ isDryRun å­—æ®µ
```

---

### æµ‹è¯• 4ï¼šå‚æ•°ç™½åå•éªŒè¯

**ç›®æ ‡ï¼š** éªŒè¯ç”Ÿäº§ç¯å¢ƒç¦æ­¢è‡ªç”±æŒ‡å®šå‚æ•°

**æ­¥éª¤ï¼š**

```bash
# 1. è·å–å¯ç”¨é¢„è®¾åˆ—è¡¨
curl https://api.factory-buy.com/ai/presets \
  -H "Authorization: Bearer $TOKEN"

# 2. ä½¿ç”¨æœ‰æ•ˆé¢„è®¾ï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -X POST https://api.factory-buy.com/ai/generate-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "prompt": "æµ‹è¯•",
    "presetId": "qwen-turbo-standard"
  }'

# 3. å°è¯•è‡ªç”±æŒ‡å®šå‚æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥å¤±è´¥ï¼‰
curl -X POST https://api.factory-buy.com/ai/generate-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "prompt": "æµ‹è¯•",
    "provider": "qwen",
    "model": "qwen-turbo",
    "maxTokens": 5000
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… ä½¿ç”¨é¢„è®¾ï¼šæˆåŠŸ
- âœ… è‡ªç”±æŒ‡å®šå‚æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼šè¿”å› 400 é”™è¯¯ï¼Œæç¤ºå¿…é¡»ä½¿ç”¨ presetId

**æ³¨æ„ï¼š** å¼€å‘ç¯å¢ƒï¼ˆNODE_ENV !== 'production'ï¼‰å…è®¸è‡ªç”±æŒ‡å®šå‚æ•°ï¼Œç”¨äºæµ‹è¯•ã€‚

---

### æµ‹è¯• 5ï¼šJob æµç¨‹å®Œæ•´æ€§ï¼ˆDry Runï¼‰

**ç›®æ ‡ï¼š** éªŒè¯ Dry Run æ¨¡å¼ä¸‹ Job æµç¨‹å®Œæ•´è·‘é€š

**æ­¥éª¤ï¼š**

```bash
# 1. åˆ›å»ºä»»åŠ¡
JOB_ID=$(curl -X POST https://api.factory-buy.com/jobs \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "type": "text_generation",
    "input": {
      "prompt": "æµ‹è¯•æç¤ºè¯",
      "presetId": "qwen-turbo-standard"
    }
  }' | jq -r '.id')

# 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆåº”è¯¥æ˜¯ queuedï¼‰
curl https://api.factory-buy.com/jobs/$JOB_ID \
  -H "Authorization: Bearer $TOKEN"

# 3. æ¨¡æ‹Ÿå¤„ç†ä»»åŠ¡ï¼ˆéœ€è¦åç«¯å®ç°å¤„ç†é€»è¾‘ï¼‰
# è¿™é‡Œå‡è®¾æœ‰å¤„ç†æ¥å£ï¼Œå®é™…å¯èƒ½éœ€è¦æ‰‹åŠ¨è§¦å‘æˆ–ç­‰å¾…é˜Ÿåˆ—å¤„ç†

# 4. å†æ¬¡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆåº”è¯¥æ˜¯ completedï¼‰
curl https://api.factory-buy.com/jobs/$JOB_ID \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸç»“æœï¼š**
- âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ
- âœ… çŠ¶æ€ä» `queued` â†’ `processing` â†’ `completed`
- âœ… è¾“å‡ºåŒ…å« mock æ•°æ®
- âœ… ä¸äº§ç”ŸçœŸå®è´¹ç”¨

---

### æµ‹è¯• 6ï¼šJob è¾“å…¥è¾“å‡ºç»“æ„éªŒè¯

**ç›®æ ‡ï¼š** éªŒè¯ Job è¾“å…¥è¾“å‡ºç¬¦åˆ schema

**æ­¥éª¤ï¼š**

```bash
# 1. åˆ›å»ºæœ‰æ•ˆä»»åŠ¡ï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -X POST https://api.factory-buy.com/jobs \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "type": "text_generation",
    "input": {
      "prompt": "æµ‹è¯•",
      "presetId": "qwen-turbo-standard"
    }
  }'

# 2. åˆ›å»ºæ— æ•ˆä»»åŠ¡ï¼ˆç¼ºå°‘å¿…éœ€å­—æ®µï¼Œåº”è¯¥å¤±è´¥ï¼‰
curl -X POST https://api.factory-buy.com/jobs \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "type": "text_generation",
    "input": {
      "presetId": "qwen-turbo-standard"
      // ç¼ºå°‘ prompt
    }
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… æœ‰æ•ˆè¾“å…¥ï¼šæˆåŠŸåˆ›å»ºä»»åŠ¡
- âœ… æ— æ•ˆè¾“å…¥ï¼šè¿”å› 400 é”™è¯¯ï¼Œæç¤ºéªŒè¯å¤±è´¥

---

### æµ‹è¯• 7ï¼šæ€§èƒ½ç´¢å¼•éªŒè¯

**ç›®æ ‡ï¼š** éªŒè¯æ¯æ—¥é¢åº¦è®¡ç®—ä½¿ç”¨ç´¢å¼•

**æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥è¯¢ä»Šæ—¥æ¶ˆè´¹ï¼ˆåº”è¯¥ä½¿ç”¨ç´¢å¼•ï¼Œä¸ä¼šå…¨è¡¨æ‰«æï¼‰
# è¿™ä¸ªæµ‹è¯•éœ€è¦æŸ¥çœ‹æ•°æ®åº“æ‰§è¡Œè®¡åˆ’ï¼Œæˆ–è€…é€šè¿‡æ€§èƒ½ç›‘æ§éªŒè¯

# 2. å¤šæ¬¡æ¶ˆè´¹ï¼ŒéªŒè¯æ€§èƒ½
for i in {1..10}; do
  curl -X POST https://api.factory-buy.com/credits/consume \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d "{
      \"amount\": 1,
      \"action\": \"perf_test_$i\"
    }"
done
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ¯æ¬¡æ¶ˆè´¹å“åº”æ—¶é—´ < 100ms
- âœ… æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼ˆå¯é€šè¿‡ EXPLAIN éªŒè¯ï¼‰

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

### æµ‹è¯•æ—¥æœŸï¼š___________

### æµ‹è¯•ç»“æœï¼š

- [ ] æµ‹è¯• 1ï¼šå¹‚ç­‰æ‰£è´¹ âœ… / âŒ
- [ ] æµ‹è¯• 2ï¼šDry Run æ¨¡å‹è°ƒç”¨ âœ… / âŒ
- [ ] æµ‹è¯• 3ï¼šDry Run æ‰£è´¹ âœ… / âŒ
- [ ] æµ‹è¯• 4ï¼šå‚æ•°ç™½åå• âœ… / âŒ
- [ ] æµ‹è¯• 5ï¼šJob æµç¨‹å®Œæ•´æ€§ âœ… / âŒ
- [ ] æµ‹è¯• 6ï¼šJob ç»“æ„éªŒè¯ âœ… / âŒ
- [ ] æµ‹è¯• 7ï¼šæ€§èƒ½ç´¢å¼• âœ… / âŒ

### å‘ç°çš„é—®é¢˜ï¼š

1. _________________________________
2. _________________________________
3. _________________________________

---

## ğŸ”§ å¿«é€Ÿæµ‹è¯•è„šæœ¬

```bash
#!/bin/bash

# 0 æˆæœ¬å›å½’æµ‹è¯•è„šæœ¬

BACKEND_URL="https://api.factory-buy.com"
EMAIL="test@factory-buy.com"
PASSWORD="password123"

echo "ğŸ§ª å¼€å§‹ 0 æˆæœ¬å›å½’æµ‹è¯•..."

# 1. ç™»å½•
echo "1ï¸âƒ£ ç™»å½•..."
TOKEN=$(curl -s -X POST $BACKEND_URL/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" \
  | jq -r '.token')

if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
  echo "âŒ ç™»å½•å¤±è´¥"
  exit 1
fi
echo "âœ… ç™»å½•æˆåŠŸ"

# 2. æµ‹è¯• Dry Run æ¨¡å‹è°ƒç”¨
echo "2ï¸âƒ£ æµ‹è¯• Dry Run æ¨¡å‹è°ƒç”¨..."
RESPONSE=$(curl -s -X POST $BACKEND_URL/ai/generate-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "prompt": "æµ‹è¯•",
    "presetId": "qwen-turbo-standard"
  }')

if echo "$RESPONSE" | jq -e '.raw.mock == true' > /dev/null; then
  echo "âœ… Dry Run æ¨¡å¼æ­£å¸¸"
else
  echo "âŒ Dry Run æ¨¡å¼å¼‚å¸¸"
  echo "$RESPONSE" | jq .
fi

# 3. æµ‹è¯• Dry Run æ‰£è´¹
echo "3ï¸âƒ£ æµ‹è¯• Dry Run æ‰£è´¹..."
BALANCE_BEFORE=$(curl -s $BACKEND_URL/credits/balance \
  -H "Authorization: Bearer $TOKEN" | jq -r '.balance')

CONSUME_RESPONSE=$(curl -s -X POST $BACKEND_URL/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "amount": 10,
    "action": "test_dry_run"
  }')

if echo "$CONSUME_RESPONSE" | jq -e '.isDryRun == true' > /dev/null; then
  echo "âœ… Dry Run æ‰£è´¹æ­£å¸¸"
else
  echo "âŒ Dry Run æ‰£è´¹å¼‚å¸¸"
  echo "$CONSUME_RESPONSE" | jq .
fi

BALANCE_AFTER=$(curl -s $BACKEND_URL/credits/balance \
  -H "Authorization: Bearer $TOKEN" | jq -r '.balance')

if [ "$BALANCE_BEFORE" == "$BALANCE_AFTER" ]; then
  echo "âœ… ä½™é¢æœªå˜åŒ–ï¼ˆDry Run æ­£å¸¸ï¼‰"
else
  echo "âŒ ä½™é¢å‘ç”Ÿå˜åŒ–ï¼ˆDry Run å¼‚å¸¸ï¼‰"
fi

# 4. æµ‹è¯•å¹‚ç­‰æ‰£è´¹
echo "4ï¸âƒ£ æµ‹è¯•å¹‚ç­‰æ‰£è´¹..."
REF_ID="test-idempotent-$(date +%s)"

FIRST=$(curl -s -X POST $BACKEND_URL/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d "{
    \"amount\": 5,
    \"action\": \"test_idempotent\",
    \"refId\": \"$REF_ID\"
  }")

SECOND=$(curl -s -X POST $BACKEND_URL/credits/consume \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d "{
    \"amount\": 5,
    \"action\": \"test_idempotent\",
    \"refId\": \"$REF_ID\"
  }")

if echo "$SECOND" | jq -e '.isIdempotent == true' > /dev/null; then
  echo "âœ… å¹‚ç­‰æ‰£è´¹æ­£å¸¸"
else
  echo "âŒ å¹‚ç­‰æ‰£è´¹å¼‚å¸¸"
  echo "$SECOND" | jq .
fi

echo "ğŸ‰ æµ‹è¯•å®Œæˆï¼"
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Dry Run æ¨¡å¼å¿…é¡»é…ç½®**
   - `MODEL_ENABLED=false` å’Œ `BILLING_ENABLED=false` å¿…é¡»åŒæ—¶è®¾ç½®
   - å¦åˆ™å¯èƒ½äº§ç”ŸçœŸå®è´¹ç”¨

2. **ç”Ÿäº§ç¯å¢ƒéªŒè¯**
   - åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•æ—¶ï¼Œç¡®ä¿ `NODE_ENV=production`
   - éªŒè¯å‚æ•°ç™½åå•æ˜¯å¦ç”Ÿæ•ˆ

3. **æ•°æ®åº“çº¦æŸ**
   - å”¯ä¸€çº¦æŸ `(userId, refId, action)` ä¼šåœ¨æ•°æ®åº“å±‚é˜²æ­¢é‡å¤æ‰£è´¹
   - å³ä½¿ä»£ç å±‚æ£€æŸ¥å¤±è´¥ï¼Œæ•°æ®åº“ä¹Ÿä¼šæ‹’ç»é‡å¤è®°å½•

---

**æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œç³»ç»Ÿå·²å…·å¤‡éªŒæ”¶æ¡ä»¶ï¼** âœ…

