# ğŸ”§ å…³é”®ä¼˜åŒ–æ–¹æ¡ˆ - 6 ä¸ªå¿…é¡»ä¿®å¤çš„é—®é¢˜

> åŸºäº GPT æ·±åº¦åˆ†æï¼Œè¿™äº›æ˜¯"ç°åœ¨ä¸è¡¥ã€ä»¥åå¿…è¿”å·¥"çš„å…³é”®ç‚¹

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### âœ… é—®é¢˜ 1ï¼šç§¯åˆ†ç³»ç»Ÿè´¦æœ¬åŒ–ï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤å†…å®¹ï¼š**
- âœ… `getBalance()` ç°åœ¨ä» `credit_transactions` è¡¨ SUM è®¡ç®—ä½™é¢
- âœ… `user.credits` ä»…ä½œä¸ºç¼“å­˜ï¼ŒçœŸå®ä½™é¢æ¥è‡ªè´¦æœ¬
- âœ… æ·»åŠ äº† `validateBalance()` æ–¹æ³•ç”¨äºå®¡è®¡

**æ•ˆæœï¼š**
- ä½™é¢å¯å®¡è®¡ã€å¯è¿½æº¯
- ä¸ä¼šå‡ºç°ä½™é¢å’Œäº¤æ˜“è®°å½•å¯¹ä¸ä¸Šçš„æƒ…å†µ

---

### âœ… é—®é¢˜ 2ï¼šJob è¡¨å’ŒçŠ¶æ€æœºï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤å†…å®¹ï¼š**
- âœ… åˆ›å»ºäº† `Job` å®ä½“ï¼Œæ”¯æŒå¼‚æ­¥ä»»åŠ¡ç®¡ç†
- âœ… å®ç°äº† `JobsService` å’Œ `JobsController`
- âœ… æ”¯æŒä»»åŠ¡çŠ¶æ€ï¼š`queued` â†’ `processing` â†’ `completed`/`failed`

**æ•ˆæœï¼š**
- å¯ä»¥ç®¡ç†é•¿æ—¶é—´ä»»åŠ¡ï¼ˆè§†é¢‘ç”Ÿæˆï¼‰
- å¯ä»¥é‡è¯•å¤±è´¥ä»»åŠ¡
- å¯ä»¥æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€å’Œå†å²

---

### âœ… é—®é¢˜ 3ï¼šä» JWT è§£æ userIdï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤å†…å®¹ï¼š**
- âœ… åˆ›å»ºäº† `@CurrentUser()` è£…é¥°å™¨
- âœ… ä¿®æ”¹äº† `CreditsController` å’Œ `LogsController` ä½¿ç”¨è£…é¥°å™¨
- âœ… ç§»é™¤äº†ä¸å®‰å…¨çš„ `X-User-Id` header ä¼ å‚

**æ•ˆæœï¼š**
- å‰ç«¯æ— æ³•ä¼ªé€  userId
- å®‰å…¨æ€§å¤§å¹…æå‡

---

### âœ… é—®é¢˜ 4ï¼šåŒºåˆ†ä¸šåŠ¡æ—¥å¿—å’Œç³»ç»Ÿæ—¥å¿—ï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤å†…å®¹ï¼š**
- âœ… åœ¨ `LogEntry` å®ä½“ä¸­æ·»åŠ äº† `logType` å­—æ®µï¼ˆ`business` | `system`ï¼‰
- âœ… æ·»åŠ äº† `level` å­—æ®µï¼ˆ`info` | `warn` | `error`ï¼‰
- âœ… æ›´æ–°äº† `LogsService.create()` æ–¹æ³•æ”¯æŒæ–°å­—æ®µ

**æ•ˆæœï¼š**
- å¯ä»¥åŒºåˆ†ç”¨æˆ·è¡Œä¸ºå’Œç³»ç»Ÿé”™è¯¯
- ä¾¿äºæ’æŸ¥é—®é¢˜å’Œå®¡è®¡

---

## ğŸ”„ å¾…ä¿®å¤çš„é—®é¢˜

### â³ é—®é¢˜ 5ï¼šåç«¯é›†æˆ ModelAdapter

**å½“å‰çŠ¶æ€ï¼š**
- ModelAdapter åœ¨å‰ç«¯å­˜åœ¨ï¼ˆ`lib/model/ModelAdapter.ts`ï¼‰
- ä½†åç«¯ API æ²¡æœ‰ä½¿ç”¨ï¼Œç›´æ¥è°ƒç”¨å„ç§ AI SDK

**éœ€è¦ä¿®å¤ï¼š**
1. åœ¨åç«¯åˆ›å»º `ModelAdapterService`
2. ç»Ÿä¸€æ‰€æœ‰ AI è°ƒç”¨å…¥å£
3. æ”¯æŒåˆ‡æ¢ä¸åŒçš„æ¨¡å‹æä¾›å•†

---

### â³ é—®é¢˜ 6ï¼šæˆæœ¬æŠ¤æ 

**å½“å‰çŠ¶æ€ï¼š**
- æ²¡æœ‰ rate limit
- æ²¡æœ‰å•æ¬¡ç”Ÿæˆæœ€å¤§æˆæœ¬é™åˆ¶
- æ²¡æœ‰æ¯æ—¥ä¸Šé™

**éœ€è¦ä¿®å¤ï¼š**
1. æ·»åŠ  rate limit ä¸­é—´ä»¶
2. æ·»åŠ å•æ¬¡æ¶ˆè´¹ä¸Šé™æ£€æŸ¥
3. æ·»åŠ æ¯æ—¥æ¶ˆè´¹ä¸Šé™æ£€æŸ¥

---

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨ Job ç®¡ç†ç”Ÿæˆä»»åŠ¡

```typescript
// åˆ›å»ºä»»åŠ¡
const job = await jobsService.create({
  userId: user.userId,
  type: 'text_generation',
  input: { prompt, model: 'qwen' },
  estimatedCost: 10,
});

try {
  // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
  await jobsService.updateStatus(job.id, 'processing');
  
  // æ¶ˆè´¹ç§¯åˆ†
  const creditResult = await creditsService.consume(
    user.userId,
    10,
    'text_generation'
  );
  
  // æ‰§è¡Œç”Ÿæˆ
  const result = await aiService.generateText(prompt);
  
  // å®Œæˆä»»åŠ¡
  await jobsService.complete(job.id, {
    output: result,
    creditCost: 10,
    transactionId: creditResult.transactionId,
  });
} catch (error) {
  // æ ‡è®°å¤±è´¥
  await jobsService.fail(job.id, error);
  // å›é€€ç§¯åˆ†...
}
```

### ä½¿ç”¨è´¦æœ¬åŒ–ä½™é¢

```typescript
// è·å–ä½™é¢ï¼ˆä» transaction sumï¼‰
const { balance } = await creditsService.getBalance(userId);

// éªŒè¯ä½™é¢ä¸€è‡´æ€§
const validation = await creditsService.validateBalance(userId);
if (!validation.valid) {
  console.warn('ä½™é¢ä¸ä¸€è‡´ï¼', validation);
}
```

### åˆ›å»ºä¸åŒç±»å‹çš„æ—¥å¿—

```typescript
// ä¸šåŠ¡æ—¥å¿—
await logsService.create(userId, {
  action: 'ai_text_generation',
  logType: 'business',
  details: { prompt, model },
  success: true,
  timestamp: new Date().toISOString(),
});

// ç³»ç»Ÿæ—¥å¿—
await logsService.create('system', {
  action: 'model_api_error',
  logType: 'system',
  level: 'error',
  details: { error: error.message, stack: error.stack },
  success: false,
  timestamp: new Date().toISOString(),
});
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ä¿®å¤é—®é¢˜ 5**ï¼šåç«¯é›†æˆ ModelAdapter
2. **ä¿®å¤é—®é¢˜ 6**ï¼šæ·»åŠ æˆæœ¬æŠ¤æ 
3. **æ›´æ–°å‰ç«¯ä»£ç **ï¼šç§»é™¤ `X-User-Id` headerï¼Œä½¿ç”¨æ–°çš„ API

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### æ•°æ®åº“è¿ç§»

ç”±äºä¿®æ”¹äº†å®ä½“ç»“æ„ï¼Œéœ€è¦ï¼š
1. åœ¨å¼€å‘ç¯å¢ƒï¼ŒTypeORM ä¼šè‡ªåŠ¨åŒæ­¥ï¼ˆ`synchronize: true`ï¼‰
2. åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦æ‰‹åŠ¨è¿è¡Œè¿ç§»æˆ–é‡æ–°åˆ›å»ºè¡¨

### å…¼å®¹æ€§

- æ—§çš„ API è°ƒç”¨ï¼ˆå¸¦ `X-User-Id` headerï¼‰å°†ä¸å†å·¥ä½œ
- å‰ç«¯éœ€è¦æ›´æ–°ä¸ºä½¿ç”¨ `Authorization: Bearer <token>` æ–¹å¼

### æµ‹è¯•

ä¿®å¤åéœ€è¦æµ‹è¯•ï¼š
1. ç™»å½•è·å– token
2. ä½¿ç”¨ token æŸ¥è¯¢ç§¯åˆ†ï¼ˆä¸å†ä¼  userIdï¼‰
3. åˆ›å»ºä»»åŠ¡å¹¶æŸ¥çœ‹çŠ¶æ€
4. éªŒè¯ä½™é¢è®¡ç®—æ˜¯å¦æ­£ç¡®







