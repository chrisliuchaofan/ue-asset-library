# 后端部署问题排查

**问题：** GitHub Actions 后端部署一直失败

---

## 🔍 可能的原因

### 1. 工作流触发条件问题

**当前配置：**
```yaml
on:
  push:
    branches:
      - main
    paths:
      - 'backend-api/**'
      - '.github/workflows/deploy-backend.yml'
```

**问题：** 如果最近的提交没有修改 `backend-api/**` 目录下的文件，工作流不会触发。

**检查方法：**
```bash
# 检查最近的提交是否修改了 backend-api 目录
git log --oneline -5 --name-only | grep backend-api
```

---

### 2. GitHub Secrets 未配置

**需要的 Secrets：**
- `ECS_HOST` - 服务器 IP 或域名
- `ECS_USERNAME` - SSH 用户名（通常是 `root`）
- `ECS_SSH_KEY` - SSH 私钥

**检查方法：**
1. 访问 GitHub 仓库 Settings → Secrets and variables → Actions
2. 确认以上三个 secrets 是否已配置

---

### 3. SSH 连接失败

**可能原因：**
- SSH 密钥格式错误
- 服务器 IP 或域名错误
- 服务器防火墙阻止 SSH 连接
- SSH 密钥未添加到服务器的 authorized_keys

---

### 4. 部署脚本执行失败

**可能原因：**
- 服务器上目录不存在：`/opt/ue-assets-backend/backend-api`
- PM2 进程不存在或名称错误
- npm 安装失败
- 构建失败

---

## 🛠️ 解决方案

### 方案 1：检查工作流是否触发

**问题：** 如果提交没有修改 `backend-api/**`，工作流不会触发。

**解决：** 修改工作流配置，移除路径过滤，或确保提交包含 backend-api 的更改。

---

### 方案 2：检查 GitHub Secrets

**步骤：**
1. 访问：`https://github.com/chrisliuchaofan/ue-asset-library/settings/secrets/actions`
2. 确认以下 secrets 已配置：
   - `ECS_HOST`
   - `ECS_USERNAME`
   - `ECS_SSH_KEY`

**如果未配置：**
- 获取服务器 IP：`curl ifconfig.me` 或查看服务器控制台
- 获取 SSH 用户名：通常是 `root`
- 生成 SSH 密钥对（如果还没有）：
  ```bash
  ssh-keygen -t rsa -b 4096 -C "github-actions"
  # 将公钥添加到服务器
  ssh-copy-id -i ~/.ssh/id_rsa.pub root@your-server-ip
  # 将私钥内容复制到 GitHub Secrets
  cat ~/.ssh/id_rsa
  ```

---

### 方案 3：改进工作流配置

**当前问题：**
- 路径过滤可能导致工作流不触发
- 部署脚本可能有问题

**建议改进：**
1. 移除路径过滤（或放宽条件）
2. 添加错误处理
3. 添加部署前检查
4. 改进日志输出

---

## 📋 快速检查清单

- [ ] 检查最近的提交是否包含 `backend-api/**` 的更改
- [ ] 检查 GitHub Secrets 是否已配置
- [ ] 检查 GitHub Actions 日志，查看具体错误信息
- [ ] 检查服务器 SSH 连接是否正常
- [ ] 检查服务器上目录是否存在
- [ ] 检查 PM2 进程是否存在

---

## 🔧 下一步

1. **查看 GitHub Actions 日志**
   - 访问：`https://github.com/chrisliuchaofan/ue-asset-library/actions`
   - 点击失败的部署，查看详细日志

2. **检查 Secrets 配置**
   - 确认所有必需的 secrets 已配置

3. **测试 SSH 连接**
   - 手动测试从本地连接到服务器

4. **改进工作流配置**
   - 根据错误日志修复问题

---

**需要我帮你检查具体哪个问题吗？**


