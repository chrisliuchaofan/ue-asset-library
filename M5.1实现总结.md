# M5.1 å®ç°æ€»ç»“

## âœ… å·²å®Œæˆ

### 1. æ•°æ®åº“å®ä½“
- âœ… åˆ›å»º `JobOutput` å®ä½“ï¼ˆ`backend-api/src/database/entities/job-output.entity.ts`ï¼‰
- âœ… æ³¨å†Œåˆ° `DatabaseModule`

### 2. å­˜å‚¨æœåŠ¡
- âœ… åˆ›å»º `StorageService`ï¼ˆ`backend-api/src/storage/storage.service.ts`ï¼‰
  - ä¿å­˜ä¸´æ—¶æ–‡ä»¶åˆ° `/tmp/dream-factory/{jobId}.{ext}`
  - ä¸Šä¼ åˆ° OSSï¼ˆè·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/{type}-{timestamp}.{ext}`ï¼‰
  - å†™å…¥ `job_outputs` è¡¨
  - åˆ é™¤ä¸´æ—¶æ–‡ä»¶
  - æ¸…ç†æœºåˆ¶

### 3. åç«¯æ¥å£
- âœ… æ·»åŠ  `/ai/generate-image` æ¥å£ï¼ˆæ¥æ”¶ URLï¼Œä¸Šä¼ åˆ° OSSï¼‰
- âœ… æ·»åŠ  `/ai/generate-video` æ¥å£ï¼ˆæ¥æ”¶ URLï¼Œä¸Šä¼ åˆ° OSSï¼‰
- âœ… é›†æˆ `StorageService` å’Œ `JobsService`

### 4. æ¸…ç†æœºåˆ¶
- âœ… Job å®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆåœ¨ `JobsService.complete()` ä¸­ï¼‰
- âœ… `cleanupOldTempFiles()` æ–¹æ³•ï¼ˆç”¨äº cronï¼‰

---

## â³ å¾…å®Œæˆ

### 5. ä¿®æ”¹å‰ç«¯ API è·¯ç”±

**éœ€è¦ä¿®æ”¹ï¼š**
- `app/api/ai/generate-image/route.ts`
- `app/api/ai/generate-job/route.ts`

**æµç¨‹ï¼š**
1. ç”Ÿæˆå›¾ç‰‡/è§†é¢‘ï¼ˆè¿”å› URLï¼‰
2. è°ƒç”¨åç«¯ `/ai/generate-image` æˆ– `/ai/generate-video`ï¼Œä¼ é€’ URL
3. åç«¯ä¸‹è½½å¹¶ä¸Šä¼ åˆ° OSS
4. è¿”å› OSS URL

---

### 6. ç¯å¢ƒå˜é‡é…ç½®

**éœ€è¦æ·»åŠ ï¼š**
```bash
# OSS é…ç½®
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY=your-access-key-id
OSS_SECRET=your-access-key-secret
OSS_BASE_URL=https://your-cdn-domain.com  # å¯é€‰ï¼ŒCDN URL
```

---

### 7. Cron ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

**å®ç°ï¼š**
- æ¯å¤©æ¸…ç† 24 å°æ—¶å‰çš„ä¸´æ—¶æ–‡ä»¶
- å¯ä»¥ä½¿ç”¨ `@nestjs/schedule` æˆ–ç³»ç»Ÿ cron

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²åˆ›å»º
- âœ… `backend-api/src/database/entities/job-output.entity.ts`
- âœ… `backend-api/src/storage/storage.service.ts`
- âœ… `backend-api/src/storage/storage.module.ts`

### å·²ä¿®æ”¹
- âœ… `backend-api/src/database/database.module.ts`
- âœ… `backend-api/src/app.module.ts`
- âœ… `backend-api/src/jobs/jobs.service.ts`
- âœ… `backend-api/src/jobs/jobs.module.ts`
- âœ… `backend-api/src/ai/ai.controller.ts`
- âœ… `backend-api/src/ai/ai.module.ts`

### å¾…ä¿®æ”¹
- â³ `app/api/ai/generate-image/route.ts`ï¼ˆç”Ÿæˆåè°ƒç”¨åç«¯ä¸Šä¼ ï¼‰
- â³ `app/api/ai/generate-job/route.ts`ï¼ˆç”Ÿæˆåè°ƒç”¨åç«¯ä¸Šä¼ ï¼‰

---

## ğŸ§ª éªŒè¯æ­¥éª¤

1. **ç”Ÿæˆä¸€æ¬¡å›¾ç‰‡**
   - è°ƒç”¨ `/api/ai/generate-image`
   - æ£€æŸ¥è¿”å›çš„ URL æ˜¯å¦ä¸º OSS URLï¼ˆä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼‰

2. **æ£€æŸ¥ OSS**
   - ç™»å½• OSS æ§åˆ¶å°
   - æ£€æŸ¥è·¯å¾„ `users/{userId}/jobs/{jobId}/` ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶

3. **æ£€æŸ¥ ECS /tmp**
   - SSH åˆ°æœåŠ¡å™¨
   - æ£€æŸ¥ `/tmp/dream-factory/` ç›®å½•
   - ç¡®è®¤æ²¡æœ‰æ®‹ç•™æ–‡ä»¶ï¼ˆé™¤äº†æ­£åœ¨å¤„ç†çš„ï¼‰

4. **æ£€æŸ¥æ•°æ®åº“**
   - æŸ¥è¯¢ `job_outputs` è¡¨
   - ç¡®è®¤æœ‰è®°å½•ï¼Œä¸” `ossUrl` å’Œ `ossPath` æ­£ç¡®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**
   - Job å®Œæˆåç«‹å³æ¸…ç†
   - Cron ä»»åŠ¡ä½œä¸ºå…œåº•ï¼ˆå¯é€‰ï¼‰

2. **é”™è¯¯å¤„ç†**
   - ä¸Šä¼ å¤±è´¥æ—¶ï¼Œå°è¯•åˆ é™¤ä¸´æ—¶æ–‡ä»¶
   - æ¸…ç†å¤±è´¥ä¸é˜»å¡ä¸»æµç¨‹

3. **OSS é…ç½®**
   - ç¡®ä¿ OSS é…ç½®æ­£ç¡®
   - ç¡®ä¿æœ‰å†™å…¥æƒé™

4. **å‘åå…¼å®¹**
   - æ—§çš„ Job å¯èƒ½æ²¡æœ‰ job_outputs è®°å½•
   - éœ€è¦å¤„ç†è¿™ç§æƒ…å†µ







