# ç™»å½•åŠŸèƒ½å¤±æ•ˆ - æ·±åº¦è¯Šæ–­æŠ¥å‘Šä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç»è¿‡å¯¹å…¨æ ˆä»£ç åº“çš„æ·±åº¦æ‰«æï¼Œè¯†åˆ«å‡ºå¯¼è‡´"ç”¨æˆ·ç™»å½•åŠŸèƒ½å¤±æ•ˆ"çš„**3ä¸ªæœ€å¯èƒ½çš„æ ¹æœ¬åŸå› **ï¼š

### ğŸ”´ æ ¹æœ¬åŸå›  #1ï¼šCORS è·¨åŸŸé…ç½®ä¸å®Œæ•´ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜æè¿°ï¼š**
- åç«¯ `backend-api/src/main.ts` ä¸­çš„ CORS é…ç½®ä»…å…è®¸ç‰¹å®šåŸŸå
- Vercel éƒ¨ç½²çš„åŸŸåå¯èƒ½ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­
- ç”Ÿäº§ç¯å¢ƒï¼ˆ`NODE_ENV=production`ï¼‰ä¼šä¸¥æ ¼æ£€æŸ¥ originï¼Œå¯¼è‡´è·¨åŸŸè¯·æ±‚è¢«æ‹’ç»

**è¯æ®ï¼š**
```78:86:backend-api/src/main.ts
      // ç”Ÿäº§ç¯å¢ƒï¼šæ£€æŸ¥ origin æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
      const isAllowed = allowedOrigins.some(allowed => origin.startsWith(allowed));
      if (isAllowed) {
        console.log('[CORS] âœ… å…è®¸æ¥æº:', origin);
        callback(null, true);
      } else {
        console.warn('[CORS] âŒ æ‹’ç»æ¥æº:', origin, 'ï¼ˆä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼‰');
        callback(new Error('Not allowed by CORS'));
      }
```

**å½“å‰å…è®¸çš„åŸŸåï¼š**
```43:50:backend-api/src/main.ts
  const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
  const allowedOrigins = [
    frontendUrl,
    'http://localhost:3000',  // âœ… æ˜¾å¼å…è®¸ localhost:3000
    'http://127.0.0.1:3000',  // âœ… æ˜¾å¼å…è®¸ 127.0.0.1:3000
    'https://www.factory-buy.com',
    'https://factory-buy.com',
  ].filter(Boolean); // ç§»é™¤ç©ºå€¼
```

**é£é™©ï¼š** å¦‚æœ Vercel åˆ†é…çš„åŸŸåæ˜¯ `https://your-app-xxx.vercel.app`ï¼Œä¸”æœªåœ¨ `FRONTEND_URL` ä¸­é…ç½®ï¼Œç™»å½•è¯·æ±‚ä¼šè¢« CORS æ‹’ç»ã€‚

---

### ğŸ”´ æ ¹æœ¬åŸå›  #2ï¼šMixed Contentï¼ˆHTTPS â†’ HTTPï¼‰

**é—®é¢˜æè¿°ï¼š**
- Vercel å¼ºåˆ¶ä½¿ç”¨ HTTPS
- å¦‚æœåç«¯ ECS æœåŠ¡å™¨ä½¿ç”¨ HTTPï¼ˆ`http://your-ecs-ip:3001`ï¼‰ï¼Œæµè§ˆå™¨ä¼šé˜»æ­¢ Mixed Content è¯·æ±‚
- ç™»å½•è¯·æ±‚ä¼šé™é»˜å¤±è´¥ï¼Œæµè§ˆå™¨æ§åˆ¶å°å¯èƒ½æ˜¾ç¤º "Mixed Content" é”™è¯¯

**è¯æ®ï¼š**
```78:78:lib/auth-config.ts
          const backendUrl = process.env.BACKEND_API_URL || process.env.NEXT_PUBLIC_BACKEND_API_URL || 'http://localhost:3001';
```

**é£é™©ï¼š** 
- å‰ç«¯ï¼ˆHTTPSï¼‰â†’ åç«¯ï¼ˆHTTPï¼‰çš„è¯·æ±‚ä¼šè¢«æµè§ˆå™¨æ‹¦æˆª
- é”™è¯¯ä¿¡æ¯å¯èƒ½ä¸æ˜æ˜¾ï¼Œå¯¼è‡´éš¾ä»¥æ’æŸ¥

---

### ğŸ”´ æ ¹æœ¬åŸå›  #3ï¼šç¯å¢ƒå˜é‡é…ç½®ç¼ºå¤±æˆ–ä¸ä¸€è‡´

**é—®é¢˜æè¿°ï¼š**
- `NEXT_PUBLIC_BACKEND_API_URL` å¯èƒ½æœªåœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­é…ç½®
- å‰ç«¯ä»£ç å›é€€åˆ°é»˜è®¤å€¼ `http://localhost:3001`ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒæ— æ³•è¿æ¥
- JWT_SECRET å’Œ NEXTAUTH_SECRET å¯èƒ½ä¸ä¸€è‡´ï¼Œå¯¼è‡´ token éªŒè¯å¤±è´¥

**è¯æ®ï¼š**
```9:12:lib/backend-api-client.ts
function getBackendApiUrl(): string {
  const url = process.env.NEXT_PUBLIC_BACKEND_API_URL || 
              process.env.BACKEND_API_URL || 
              'https://api.factory-buy.com';
```

```7:7:backend-api/src/auth/auth.service.ts
  private jwtSecret = process.env.JWT_SECRET || process.env.NEXTAUTH_SECRET || 'your-secret-key';
```

**é£é™©ï¼š**
- å‰ç«¯æ— æ³•æ‰¾åˆ°æ­£ç¡®çš„åç«¯åœ°å€
- Token ç­¾åéªŒè¯å¤±è´¥ï¼Œå¯¼è‡´è®¤è¯å¤±è´¥

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ #1ï¼šå®Œå–„ CORS é…ç½®ï¼ˆåç«¯ï¼‰

**æ–‡ä»¶ï¼š** `backend-api/src/main.ts`

**ä¿®å¤ä»£ç ï¼š**

```typescript
// CORS é…ç½®
// æ”¯æŒå¤šä¸ªå‰ç«¯åŸŸåï¼ˆå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒï¼‰
const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';

// âœ… æ–°å¢ï¼šä»ç¯å¢ƒå˜é‡è¯»å–å¤šä¸ªå…è®¸çš„åŸŸåï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
const additionalOrigins = (process.env.ALLOWED_ORIGINS || '').split(',').filter(Boolean);

const allowedOrigins = [
  frontendUrl,
  'http://localhost:3000',
  'http://127.0.0.1:3000',
  'https://www.factory-buy.com',
  'https://factory-buy.com',
  // âœ… æ–°å¢ï¼šæ·»åŠ æ‰€æœ‰ Vercel é¢„è§ˆå’Œç”Ÿäº§åŸŸå
  ...additionalOrigins,
  // âœ… æ–°å¢ï¼šå…è®¸æ‰€æœ‰ *.vercel.app åŸŸåï¼ˆVercel è‡ªåŠ¨åˆ†é…çš„åŸŸåï¼‰
  ...(process.env.NODE_ENV === 'production' ? ['https://*.vercel.app'] : []),
].filter(Boolean);

// å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼ˆæ–¹ä¾¿æœ¬åœ°è°ƒè¯•ï¼‰
const isDevelopment = process.env.NODE_ENV !== 'production';

console.log('[CORS] é…ç½®è¯¦æƒ…:', {
  isDevelopment,
  allowedOrigins,
  frontendUrl,
  additionalOrigins,
  allowedHeaders: ['Content-Type', 'Authorization', 'X-User-Id'],
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
});

app.enableCors({
  origin: (origin, callback) => {
    // å¼€å‘ç¯å¢ƒï¼šå…è®¸æ‰€æœ‰æ¥æº
    if (isDevelopment) {
      console.log('[CORS] å¼€å‘æ¨¡å¼ï¼šå…è®¸æ‰€æœ‰æ¥æº:', origin || 'æ—  originï¼ˆå¦‚ Postman/curlï¼‰');
      return callback(null, true);
    }
    
    // å…è®¸æ²¡æœ‰ origin çš„è¯·æ±‚ï¼ˆå¦‚ Postmanã€curlï¼‰
    if (!origin) {
      console.log('[CORS] å…è®¸æ—  origin çš„è¯·æ±‚ï¼ˆå¦‚ Postman/curlï¼‰');
      return callback(null, true);
    }
    
    // âœ… ä¿®å¤ï¼šæ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ *.vercel.appï¼‰
    const isAllowed = allowedOrigins.some(allowed => {
      if (allowed.includes('*')) {
        // é€šé…ç¬¦åŒ¹é…ï¼šå°† * æ›¿æ¢ä¸ºæ­£åˆ™è¡¨è¾¾å¼
        const pattern = allowed.replace(/\*/g, '.*');
        const regex = new RegExp(`^${pattern}$`);
        return regex.test(origin);
      }
      return origin.startsWith(allowed);
    });
    
    if (isAllowed) {
      console.log('[CORS] âœ… å…è®¸æ¥æº:', origin);
      callback(null, true);
    } else {
      console.warn('[CORS] âŒ æ‹’ç»æ¥æº:', origin, 'ï¼ˆä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼‰');
      console.warn('[CORS] å½“å‰å…è®¸çš„åŸŸå:', allowedOrigins);
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-User-Id'],
});
```

**ç¯å¢ƒå˜é‡é…ç½®ï¼ˆECS æœåŠ¡å™¨ï¼‰ï¼š**

```env
# åç«¯ .env æ–‡ä»¶
FRONTEND_URL=https://your-app.vercel.app
# âœ… æ–°å¢ï¼šå…è®¸å¤šä¸ªå‰ç«¯åŸŸåï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
ALLOWED_ORIGINS=https://your-app.vercel.app,https://your-app-git-main.vercel.app,https://your-app-xxx.vercel.app
```

---

### ä¿®å¤ #2ï¼šå¼ºåˆ¶ä½¿ç”¨ HTTPSï¼ˆåç«¯ + Nginxï¼‰

**æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Nginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰**

**æ–‡ä»¶ï¼š** `nginx.conf`ï¼ˆéœ€è¦åˆ›å»ºï¼‰

```nginx
server {
    listen 80;
    server_name api.your-domain.com;
    
    # é‡å®šå‘æ‰€æœ‰ HTTP è¯·æ±‚åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;
    
    # SSL è¯ä¹¦é…ç½®ï¼ˆä½¿ç”¨ Let's Encryptï¼‰
    ssl_certificate /etc/letsencrypt/live/api.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.your-domain.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # CORS é…ç½®
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-User-Id' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    
    # å¤„ç†é¢„æ£€è¯·æ±‚
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    # åå‘ä»£ç†åˆ°åç«¯æœåŠ¡
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**æ–¹æ¡ˆ Bï¼šåœ¨åç«¯ä»£ç ä¸­å¼ºåˆ¶ HTTPSï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**

**æ–‡ä»¶ï¼š** `backend-api/src/main.ts`

```typescript
// âœ… æ–°å¢ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ HTTPS
if (process.env.NODE_ENV === 'production' && !process.env.FORCE_HTTPS_DISABLED) {
  app.use((req, res, next) => {
    if (req.headers['x-forwarded-proto'] !== 'https' && req.headers.host?.includes('api.')) {
      return res.redirect(301, `https://${req.headers.host}${req.url}`);
    }
    next();
  });
}
```

**å‰ç«¯ç¯å¢ƒå˜é‡ï¼ˆVercelï¼‰ï¼š**

```env
# âœ… å¿…é¡»ä½¿ç”¨ HTTPS
NEXT_PUBLIC_BACKEND_API_URL=https://api.your-domain.com
# æˆ–
NEXT_PUBLIC_BACKEND_API_URL=https://your-ecs-ip:3001  # å¦‚æœé…ç½®äº† SSL
```

---

### ä¿®å¤ #3ï¼šç¯å¢ƒå˜é‡é…ç½®æ¸…å•

**Vercel ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¿…é¡»ï¼‰ï¼š**

```env
# ============================================
# NextAuth è®¤è¯é…ç½®
# ============================================
NEXTAUTH_SECRET=your-secret-key-change-in-production  # âœ… å¿…é¡»é…ç½®
NEXTAUTH_URL=https://your-app.vercel.app  # âœ… å¿…é¡»é…ç½®ï¼ˆä¸ Vercel åŸŸåä¸€è‡´ï¼‰

# ============================================
# åç«¯ API é…ç½®ï¼ˆå…³é”®ï¼ï¼‰
# ============================================
NEXT_PUBLIC_BACKEND_API_URL=https://api.your-domain.com  # âœ… å¿…é¡»é…ç½®ï¼ˆä½¿ç”¨ HTTPSï¼‰
# æ³¨æ„ï¼šå¦‚æœåç«¯æ˜¯ HTTPï¼Œå¿…é¡»é…ç½® Nginx åå‘ä»£ç† + SSL

# ============================================
# ç”¨æˆ·ç™½åå•ï¼ˆç”¨äºç™»å½•æµ‹è¯•ï¼‰
# ============================================
ADMIN_USERS=admin:admin123,user1:password1  # âœ… æ ¼å¼ï¼šç”¨æˆ·å:å¯†ç ,ç”¨æˆ·å:å¯†ç 

# ============================================
# JWT å¯†é’¥ï¼ˆå¿…é¡»ä¸åç«¯ä¸€è‡´ï¼‰
# ============================================
JWT_SECRET=your-jwt-secret-key  # âœ… å¿…é¡»ä¸åç«¯ JWT_SECRET ä¸€è‡´
```

**ECS åç«¯ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¿…é¡»ï¼‰ï¼š**

```env
# ============================================
# æœåŠ¡å™¨é…ç½®
# ============================================
PORT=3001
NODE_ENV=production

# ============================================
# å‰ç«¯åœ°å€ï¼ˆCORSï¼‰
# ============================================
FRONTEND_URL=https://your-app.vercel.app  # âœ… å¿…é¡»é…ç½®
ALLOWED_ORIGINS=https://your-app.vercel.app,https://your-app-git-main.vercel.app  # âœ… æ–°å¢

# ============================================
# JWT å¯†é’¥ï¼ˆå¿…é¡»ä¸å‰ç«¯ä¸€è‡´ï¼‰
# ============================================
JWT_SECRET=your-jwt-secret-key  # âœ… å¿…é¡»ä¸å‰ç«¯ NEXTAUTH_SECRET ä¸€è‡´
NEXTAUTH_SECRET=your-secret-key-change-in-production  # âœ… å¯é€‰ï¼Œä¸ JWT_SECRET ç›¸åŒå³å¯

# ============================================
# ç”¨æˆ·ç™½åå•ï¼ˆå¿…é¡»ä¸å‰ç«¯ä¸€è‡´ï¼‰
# ============================================
USER_WHITELIST=admin@admin.local:admin123,user1@admin.local:password1  # âœ… æ ¼å¼ï¼šé‚®ç®±:å¯†ç 
ADMIN_USERS=admin:admin123,user1:password1  # âœ… å…¼å®¹é…ç½®

# ============================================
# æ•°æ®åº“é…ç½®
# ============================================
DB_HOST=postgres  # âœ… Docker å®¹å™¨åï¼Œä¸æ˜¯ localhost
DB_PORT=5432
DB_NAME=ue_assets
DB_USERNAME=postgres
DB_PASSWORD=your-db-password
```

---

### ä¿®å¤ #4ï¼šDocker å®¹å™¨é—´ç½‘ç»œè¿æ¥

**é—®é¢˜ï¼š** Docker å®¹å™¨å†…ä½¿ç”¨ `localhost` è¿æ¥æ•°æ®åº“ä¼šå¤±è´¥

**æ–‡ä»¶ï¼š** `docker-compose.yml`ï¼ˆéœ€è¦åˆ›å»ºæˆ–æ›´æ–°ï¼‰

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ue-assets-postgres
    environment:
      POSTGRES_DB: ue_assets
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - ue-assets-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend-api
      dockerfile: Dockerfile
    container_name: ue-assets-backend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=postgres  # âœ… ä½¿ç”¨æœåŠ¡åï¼Œä¸æ˜¯ localhost
      - DB_PORT=5432
      - DB_NAME=ue_assets
      - DB_USERNAME=postgres
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=${FRONTEND_URL}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - USER_WHITELIST=${USER_WHITELIST}
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ue-assets-network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  ue-assets-network:
    driver: bridge
```

**å…³é”®ä¿®å¤ç‚¹ï¼š**
- âœ… `DB_HOST=postgres`ï¼ˆä½¿ç”¨ Docker æœåŠ¡åï¼‰
- âœ… ä½¿ç”¨ `depends_on` ç¡®ä¿æ•°æ®åº“å…ˆå¯åŠ¨
- âœ… ä½¿ç”¨ `networks` ç¡®ä¿å®¹å™¨é—´å¯ä»¥é€šä¿¡

---

### ä¿®å¤ #5ï¼šå‰ç«¯ API è°ƒç”¨ä¼˜åŒ–

**æ–‡ä»¶ï¼š** `lib/auth-config.ts`

**ä¿®å¤ä»£ç ï¼š**

```typescript
// âœ… ä¿®å¤ï¼šç¡®ä¿åç«¯ URL ä½¿ç”¨ HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
const getBackendUrl = () => {
  const url = process.env.BACKEND_API_URL || 
              process.env.NEXT_PUBLIC_BACKEND_API_URL || 
              'http://localhost:3001';
  
  // âœ… ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ HTTPS
  if (process.env.NODE_ENV === 'production' && url.startsWith('http://')) {
    console.warn('[Auth] âš ï¸ ç”Ÿäº§ç¯å¢ƒæ£€æµ‹åˆ° HTTP åç«¯ URLï¼Œå»ºè®®ä½¿ç”¨ HTTPS:', url);
    // å¦‚æœåç«¯æ˜¯ HTTPï¼Œå°è¯•è½¬æ¢ä¸º HTTPSï¼ˆéœ€è¦é…ç½® SSLï¼‰
    // æ³¨æ„ï¼šè¿™éœ€è¦åç«¯æ”¯æŒ HTTPSï¼Œå¦åˆ™ä¼šå¤±è´¥
    const httpsUrl = url.replace('http://', 'https://');
    console.warn('[Auth] å°è¯•ä½¿ç”¨ HTTPS URL:', httpsUrl);
    return httpsUrl;
  }
  
  return url;
};

const backendUrl = getBackendUrl();
```

---

## ğŸ“ åç»­éšæ‚£æ¸…å•

### ğŸ”´ é«˜é£é™©éšæ‚£

1. **Token è¿‡æœŸå¤„ç†**
   - å½“å‰ä»£ç ä¸­ token ç¼“å­˜ TTL ä¸º 30 åˆ†é’Ÿï¼Œä½† JWT token æœ‰æ•ˆæœŸæ˜¯ 30 å¤©
   - **é£é™©ï¼š** Token è¿‡æœŸåéœ€è¦é‡æ–°ç™»å½•ï¼Œä½†å‰ç«¯å¯èƒ½ä¸ä¼šè‡ªåŠ¨åˆ·æ–°
   - **å»ºè®®ï¼š** å®ç° token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

2. **æ•°æ®åº“è¿æ¥æ± è€—å°½**
   - TypeORM é»˜è®¤è¿æ¥æ± å¤§å°ä¸º 10
   - **é£é™©ï¼š** é«˜å¹¶å‘æ—¶å¯èƒ½å¯¼è‡´è¿æ¥æ± è€—å°½
   - **å»ºè®®ï¼š** ç›‘æ§æ•°æ®åº“è¿æ¥æ•°ï¼Œè°ƒæ•´è¿æ¥æ± å¤§å°

3. **CORS é¢„æ£€è¯·æ±‚æ€§èƒ½**
   - æ¯æ¬¡è·¨åŸŸè¯·æ±‚éƒ½ä¼šå‘é€ OPTIONS é¢„æ£€è¯·æ±‚
   - **é£é™©ï¼š** å¢åŠ å»¶è¿Ÿï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
   - **å»ºè®®ï¼š** ä½¿ç”¨ `Access-Control-Max-Age` å¤´ç¼“å­˜é¢„æ£€è¯·æ±‚ç»“æœ

### ğŸŸ¡ ä¸­é£é™©éšæ‚£

4. **ç¯å¢ƒå˜é‡æ³„éœ²**
   - `NEXT_PUBLIC_*` å˜é‡ä¼šæš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­
   - **é£é™©ï¼š** æ•æ„Ÿä¿¡æ¯æ³„éœ²
   - **å»ºè®®ï¼š** ä¸è¦åœ¨ `NEXT_PUBLIC_*` å˜é‡ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯

5. **é”™è¯¯ä¿¡æ¯æ³„éœ²**
   - åç«¯é”™è¯¯ä¿¡æ¯å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼‰
   - **é£é™©ï¼š** å®‰å…¨æ¼æ´
   - **å»ºè®®ï¼š** ç”Ÿäº§ç¯å¢ƒç»Ÿä¸€é”™è¯¯ä¿¡æ¯æ ¼å¼ï¼Œä¸è¿”å›è¯¦ç»†é”™è¯¯

6. **OSS ç›´ä¼ å®‰å…¨æ€§**
   - å¦‚æœä½¿ç”¨ OSS ç›´ä¼ ï¼Œéœ€è¦æ­£ç¡®é…ç½® STS Token
   - **é£é™©ï¼š** æœªæˆæƒè®¿é—® OSS èµ„æº
   - **å»ºè®®ï¼š** å®ç° STS Token ä¸´æ—¶æˆæƒæœºåˆ¶

### ğŸŸ¢ ä½é£é™©éšæ‚£

7. **æ—¥å¿—è®°å½•ä¸è¶³**
   - ç™»å½•å¤±è´¥æ—¶ç¼ºå°‘è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - **é£é™©ï¼š** éš¾ä»¥æ’æŸ¥é—®é¢˜
   - **å»ºè®®ï¼š** æ·»åŠ ç»“æ„åŒ–æ—¥å¿—ï¼ˆå¦‚ä½¿ç”¨ Winston æˆ– Pinoï¼‰

8. **Rate Limiting ç¼ºå¤±**
   - ç™»å½•æ¥å£æ²¡æœ‰é€Ÿç‡é™åˆ¶
   - **é£é™©ï¼š** æš´åŠ›ç ´è§£æ”»å‡»
   - **å»ºè®®ï¼š** å®ç°ç™»å½•æ¥å£é€Ÿç‡é™åˆ¶ï¼ˆå¦‚ 5 æ¬¡/åˆ†é’Ÿï¼‰

9. **Session å›ºå®šæ”»å‡»**
   - NextAuth é»˜è®¤ä¼šç”Ÿæˆæ–°çš„ session IDï¼Œä½†éœ€è¦ç¡®è®¤é…ç½®
   - **é£é™©ï¼š** Session å›ºå®šæ”»å‡»
   - **å»ºè®®ï¼š** ç¡®è®¤ NextAuth é…ç½®æ­£ç¡®ï¼Œç™»å½•æ—¶ç”Ÿæˆæ–°çš„ session ID

---

## âœ… å¿«é€Ÿä¿®å¤æ£€æŸ¥æ¸…å•

### Vercel é…ç½®æ£€æŸ¥

- [ ] `NEXTAUTH_SECRET` å·²é…ç½®ï¼ˆå¼ºéšæœºå¯†é’¥ï¼Œ32+ å­—ç¬¦ï¼‰
- [ ] `NEXTAUTH_URL` å·²é…ç½®ï¼ˆä¸ Vercel åŸŸåä¸€è‡´ï¼‰
- [ ] `NEXT_PUBLIC_BACKEND_API_URL` å·²é…ç½®ï¼ˆä½¿ç”¨ HTTPSï¼‰
- [ ] `ADMIN_USERS` å·²é…ç½®ï¼ˆè‡³å°‘ä¸€ä¸ªæµ‹è¯•è´¦å·ï¼‰
- [ ] `JWT_SECRET` å·²é…ç½®ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰

### ECS åç«¯é…ç½®æ£€æŸ¥

- [ ] `FRONTEND_URL` å·²é…ç½®ï¼ˆVercel åŸŸåï¼‰
- [ ] `ALLOWED_ORIGINS` å·²é…ç½®ï¼ˆåŒ…å«æ‰€æœ‰ Vercel åŸŸåï¼‰
- [ ] `JWT_SECRET` å·²é…ç½®ï¼ˆä¸å‰ç«¯ä¸€è‡´ï¼‰
- [ ] `USER_WHITELIST` å·²é…ç½®ï¼ˆä¸å‰ç«¯ ADMIN_USERS ä¸€è‡´ï¼‰
- [ ] `DB_HOST` å·²é…ç½®ï¼ˆDocker æœåŠ¡åï¼Œä¸æ˜¯ localhostï¼‰
- [ ] `NODE_ENV=production` å·²è®¾ç½®

### Docker é…ç½®æ£€æŸ¥

- [ ] `docker-compose.yml` ä¸­ `DB_HOST=postgres`ï¼ˆæœåŠ¡åï¼‰
- [ ] å®¹å™¨ä½¿ç”¨ç›¸åŒçš„ `networks`
- [ ] `depends_on` é…ç½®æ­£ç¡®ï¼ˆåç«¯ä¾èµ–æ•°æ®åº“ï¼‰

### Nginx é…ç½®æ£€æŸ¥ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

- [ ] SSL è¯ä¹¦å·²é…ç½®
- [ ] HTTP â†’ HTTPS é‡å®šå‘å·²é…ç½®
- [ ] CORS å¤´å·²é…ç½®
- [ ] åå‘ä»£ç†åˆ° `localhost:3001` å·²é…ç½®

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯• CORS é…ç½®

```bash
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
fetch('https://api.your-domain.com/auth/debug/config', {
  method: 'GET',
  credentials: 'include',
})
  .then(r => r.json())
  .then(console.log)
  .catch(console.error);
```

**é¢„æœŸç»“æœï¼š** æˆåŠŸè¿”å›é…ç½®ä¿¡æ¯ï¼Œæ—  CORS é”™è¯¯

### 2. æµ‹è¯•ç™»å½•æ¥å£

```bash
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
fetch('https://api.your-domain.com/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include',
  body: JSON.stringify({
    email: 'admin@admin.local',
    password: 'admin123',
  }),
})
  .then(r => r.json())
  .then(console.log)
  .catch(console.error);
```

**é¢„æœŸç»“æœï¼š** è¿”å› `{ success: true, token: '...', userId: '...' }`

### 3. æµ‹è¯•å‰ç«¯ç™»å½•æµç¨‹

1. è®¿é—® `https://your-app.vercel.app/auth/login`
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
3. ç‚¹å‡»ç™»å½•
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
5. æ£€æŸ¥ Network æ ‡ç­¾é¡µï¼Œç¡®è®¤è¯·æ±‚æˆåŠŸï¼ˆ200ï¼‰

---

## ğŸ“ é—®é¢˜æ’æŸ¥æµç¨‹

å¦‚æœä¿®å¤åä»ç„¶æ— æ³•ç™»å½•ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š

1. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**
   - æ˜¯å¦æœ‰ CORS é”™è¯¯ï¼Ÿ
   - æ˜¯å¦æœ‰ Mixed Content é”™è¯¯ï¼Ÿ
   - æ˜¯å¦æœ‰ç½‘ç»œé”™è¯¯ï¼ˆ404/500ï¼‰ï¼Ÿ

2. **æ£€æŸ¥åç«¯æ—¥å¿—**
   ```bash
   # SSH åˆ° ECS æœåŠ¡å™¨
   docker logs ue-assets-backend
   ```
   - æŸ¥çœ‹æ˜¯å¦æœ‰ CORS æ‹’ç»æ—¥å¿—
   - æŸ¥çœ‹æ˜¯å¦æœ‰æ•°æ®åº“è¿æ¥é”™è¯¯
   - æŸ¥çœ‹æ˜¯å¦æœ‰ JWT éªŒè¯é”™è¯¯

3. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   # å‰ç«¯ï¼ˆVercelï¼‰
   # åœ¨ Vercel Dashboard â†’ Settings â†’ Environment Variables æ£€æŸ¥
   
   # åç«¯ï¼ˆECSï¼‰
   docker exec ue-assets-backend env | grep -E 'FRONTEND_URL|JWT_SECRET|DB_HOST'
   ```

4. **æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥**
   ```bash
   curl https://api.your-domain.com/health
   ```

5. **æµ‹è¯•æ•°æ®åº“è¿æ¥**
   ```bash
   docker exec ue-assets-backend node -e "
     const { Client } = require('pg');
     const client = new Client({
       host: process.env.DB_HOST,
       port: process.env.DB_PORT,
       database: process.env.DB_NAME,
       user: process.env.DB_USERNAME,
       password: process.env.DB_PASSWORD,
     });
     client.connect().then(() => console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')).catch(console.error);
   "
   ```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [NextAuth.js æ–‡æ¡£](https://next-auth.js.org/)
- [NestJS CORS é…ç½®](https://docs.nestjs.com/security/cors)
- [Docker Compose ç½‘ç»œé…ç½®](https://docs.docker.com/compose/networking/)
- [Nginx SSL é…ç½®](https://nginx.org/en/docs/http/configuring_https_servers.html)

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2024-12-19
**è¯Šæ–­èŒƒå›´ï¼š** å‰ç«¯ï¼ˆVercelï¼‰+ åç«¯ï¼ˆECS Dockerï¼‰+ æ•°æ®åº“ï¼ˆPostgreSQLï¼‰






