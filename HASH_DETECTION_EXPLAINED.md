# Hash 检测说明

## 文件下载位置

**重要：文件不会保存到磁盘！**

当使用 `--hash` 模式时：
- 文件会**临时下载到内存（RAM）**
- 计算完 hash 后**立即释放内存**
- **不会保存到磁盘的任何位置**
- 不会占用你的硬盘空间

### 工作原理

```
OSS 文件 → 下载到内存（Buffer）→ 计算 SHA256 hash → 释放内存 → 继续下一个文件
```

## 进度查看

### 优化后的进度显示

脚本现在会显示详细的进度信息：

```
📊 进度: 100/6365 (1%)
⏱️  已用时间: 2分30秒
📥 已下载: 1250.50 MB
⚡ 速度: 0.67 文件/秒
⏳ 预计剩余: 155分30秒
```

### 进度更新频率

- **每处理 10 个文件**显示一次
- **或每 5 秒**显示一次（取先满足的条件）

### 如何查看当前进度

如果脚本正在运行，你可以：

1. **查看终端输出**：脚本会实时显示进度
2. **按 Ctrl+C 停止**：可以随时中断（不会删除任何文件）

## 时间估算

### 影响因素

1. **文件数量**：6365 个文件
2. **文件总大小**：需要下载所有文件
3. **网络速度**：从 OSS 下载的速度
4. **文件大小分布**：大文件需要更长时间

### 粗略估算

假设：
- 平均每个文件 1 MB
- 总大小约 6 GB
- 下载速度 10 MB/s

**预计时间：**
- 下载时间：约 10 分钟
- 计算 hash：约 5 分钟
- **总计：约 15-20 分钟**

实际时间取决于：
- 你的网络速度
- OSS 的响应速度
- 文件大小分布

## 如何运行

### 方式 1：前台运行（可以看到进度）

```bash
npm run cleanup-duplicates -- --hash
```

或

```bash
npx tsx scripts/cleanup-duplicate-files.ts --hash
```

### 方式 2：后台运行（不占用终端）

```bash
nohup npx tsx scripts/cleanup-duplicate-files.ts --hash > cleanup.log 2>&1 &
```

然后查看日志：
```bash
tail -f cleanup.log
```

### 方式 3：使用 screen 或 tmux（推荐）

```bash
# 创建新会话
screen -S cleanup

# 运行脚本
npx tsx scripts/cleanup-duplicate-files.ts --hash

# 按 Ctrl+A 然后 D 分离会话

# 重新连接查看进度
screen -r cleanup
```

## 内存使用

### 内存占用

- **每个文件**：文件大小 + 少量开销
- **峰值内存**：最大文件的大小
- **不会累积**：处理完一个文件就释放

### 示例

如果最大文件是 100 MB：
- 峰值内存占用：约 100-150 MB
- 处理完立即释放

## 停止和恢复

### 停止脚本

按 `Ctrl+C` 可以安全停止，不会：
- 删除任何文件
- 损坏数据
- 影响 OSS

### 恢复检测

停止后可以重新运行，脚本会：
- 重新扫描所有文件
- 重新计算 hash
- 从头开始（不会保存中间结果）

## 优化建议

### 如果文件太多或太大

1. **分批处理**：修改脚本，只处理部分文件
2. **使用 manifest.json**：如果已有 hash，使用默认模式（最快）
3. **手动检查**：使用 `find-same-size` 脚本先查看相同大小的文件

### 使用 manifest.json 模式（推荐）

如果新上传的文件都有 hash，可以：

1. **先等待新文件积累 hash**
2. **使用默认模式**（从 manifest.json 读取）
3. **只对没有 hash 的文件使用 --hash 模式**

## 常见问题

### Q: 文件会占用我的硬盘吗？

A: 不会。文件只下载到内存，计算完 hash 就释放。

### Q: 可以暂停后继续吗？

A: 不可以。停止后需要重新运行，但不会影响 OSS 中的文件。

### Q: 如果网络中断怎么办？

A: 脚本会报错并停止，可以重新运行。已处理的文件不会丢失（因为没保存）。

### Q: 需要多长时间？

A: 取决于文件数量和大小。脚本会实时显示预计剩余时间。

### Q: 可以加速吗？

A: 
- 使用更好的网络连接
- 或者等待新文件积累 hash，使用 manifest.json 模式

