# M5 测试问题修复 - 后端登录失败

## ✅ 已修复

### 问题
后端登录失败，返回 401 "邮箱或密码错误"

### 原因
后端 `AuthService.login` 只有在 `isAdmin=true` 时才会检查白名单，但前端没有传递 `isAdmin`，所以后端会尝试从数据库验证。数据库中的用户密码是空的（`CreditsService` 初始化时创建），所以验证失败。

### 修复
**修改了 `backend-api/src/auth/auth.service.ts`：**
- 无论 `isAdmin` 是否为 true，都先检查白名单
- 如果白名单匹配，直接返回 token（不验证数据库密码）
- 如果不在白名单，再尝试从数据库验证

---

## 🔧 需要检查的配置

### 1. 后端 `.env` 文件

确保 `USER_WHITELIST` 包含 `test@factory-buy.com` 和正确的密码：

```bash
USER_WHITELIST=test@factory-buy.com:YOUR_PASSWORD
```

**注意：** 密码必须与 `BACKEND_TEST_PASSWORD` 完全匹配（包括大小写、空格等）

### 2. 前端 `.env.local` 文件

确保配置正确：

```bash
BACKEND_TEST_EMAIL=test@factory-buy.com
BACKEND_TEST_PASSWORD=YOUR_PASSWORD
```

**注意：** `BACKEND_TEST_PASSWORD` 必须与后端 `USER_WHITELIST` 中的密码完全匹配

---

## 🚀 测试步骤

### 1. 重启后端服务

```bash
# 在服务器上
cd /opt/ue-assets-backend/backend-api
pm2 restart ue-assets-backend --update-env
```

或者本地开发：
```bash
cd backend-api
npm run start:dev
```

### 2. 测试登录

**方法 1：使用 curl**
```bash
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@factory-buy.com",
    "password": "YOUR_PASSWORD"
  }'
```

**预期结果：**
- 返回 200，包含 `token`
- 或者返回 401（如果密码不匹配）

**方法 2：刷新前端页面**
- 访问 `/dashboard` 或 `/settings`
- 检查浏览器控制台，应该不再有登录失败的错误

---

## ✅ 验证清单

- [ ] 后端 `.env` 文件中的 `USER_WHITELIST` 包含 `test@factory-buy.com:密码`
- [ ] 前端 `.env.local` 文件中的 `BACKEND_TEST_PASSWORD` 与后端密码匹配
- [ ] 后端服务已重启
- [ ] 测试登录成功（返回 token）
- [ ] 前端页面不再显示登录失败错误

---

## 🐛 如果还有问题

### 问题 1：仍然返回 401

**检查：**
1. 后端 `USER_WHITELIST` 格式是否正确（`email:password`，多个用户用逗号分隔）
2. 密码是否完全匹配（包括大小写、空格、特殊字符）
3. 后端服务是否已重启
4. 后端日志是否有错误

### 问题 2：前端仍然显示错误

**检查：**
1. 前端 `.env.local` 文件是否正确配置
2. 前端服务是否已重启（如果修改了 `.env.local`）
3. 浏览器控制台是否有其他错误

### 问题 3：数据库中没有用户

**解决方法：**
- `CreditsService` 会在启动时自动创建白名单用户
- 如果用户不存在，检查后端日志，看是否有初始化错误
- 可以手动调用注册接口创建用户

---

## 📝 相关文件

- `backend-api/src/auth/auth.service.ts` - 已修复登录逻辑
- `backend-api/src/credits/credits.service.ts` - 自动创建白名单用户
- `lib/backend-api-client.ts` - 前端登录逻辑

---

**修复完成！** ✅

现在可以重新测试 M5 功能了。







