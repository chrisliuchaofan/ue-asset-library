# 服务器充值操作指南

## 根据 PM2 配置，后端代码位置

根据 `ecosystem.config.js` 配置，后端代码在服务器上的路径是：
```
/opt/ue-assets-backend/backend-api
```

## 方法 1：重启后端服务（推荐）

```bash
# 1. 查看 PM2 进程
pm2 list

# 2. 重启后端服务（进程名称应该是 ue-assets-backend）
pm2 restart ue-assets-backend

# 3. 查看日志确认重启成功
pm2 logs ue-assets-backend --lines 50
```

## 方法 2：上传修改后的代码并重启

如果代码还没有上传到服务器：

```bash
# 1. 进入后端代码目录
cd /opt/ue-assets-backend/backend-api

# 2. 拉取最新代码（如果使用 git）
# git pull

# 3. 或者手动上传修改后的 credits.controller.ts 文件

# 4. 重新编译（如果需要）
npm run build

# 5. 重启服务
pm2 restart ue-assets-backend
```

## 方法 3：直接操作数据库（临时方案，无需重启）

如果无法重启后端，可以直接在数据库中插入充值记录：

```sql
-- 连接到 PostgreSQL 数据库
-- 替换 'test@factory-buy.com' 为实际用户邮箱

-- 1. 查询当前余额
SELECT COALESCE(SUM(amount), 0) as balance 
FROM credit_transactions 
WHERE user_id = 'test@factory-buy.com';

-- 2. 插入充值记录（增加 100 积分）
INSERT INTO credit_transactions (
  user_id, 
  amount, 
  action, 
  description, 
  balance_after, 
  created_at
)
SELECT 
  'test@factory-buy.com',  -- 替换为实际用户邮箱
  100,                      -- 充值金额
  'admin_recharge',
  '管理员充值',
  COALESCE(SUM(amount), 0) + 100,  -- 新余额
  NOW()
FROM credit_transactions 
WHERE user_id = 'test@factory-buy.com';

-- 3. 更新用户表的缓存余额（可选，系统会自动同步）
UPDATE users 
SET credits = (
  SELECT COALESCE(SUM(amount), 0) 
  FROM credit_transactions 
  WHERE user_id = users.id
)
WHERE id = 'test@factory-buy.com';

-- 4. 验证余额
SELECT COALESCE(SUM(amount), 0) as balance 
FROM credit_transactions 
WHERE user_id = 'test@factory-buy.com';
```

## 方法 4：使用 psql 命令行

```bash
# 连接到数据库（需要替换为实际的数据库连接信息）
psql -h localhost -U <数据库用户名> -d <数据库名>

# 然后执行上面的 SQL 语句
```

## 注意事项

1. **用户邮箱**：需要确认实际登录的用户邮箱，可能是：
   - `test@factory-buy.com`（根据 BACKEND_TEST_EMAIL）
   - `admin@admin.local`（前端登录的邮箱）

2. **数据库连接信息**：需要从环境变量或配置文件中获取：
   - `DB_HOST`
   - `DB_PORT`
   - `DB_NAME`
   - `DB_USERNAME`
   - `DB_PASSWORD`

3. **充值接口**：如果使用充值接口，需要确保：
   - 后端代码已更新（添加了 `/credits/recharge` 接口）
   - 后端服务已重启
   - 生产环境需要设置 `ALLOW_RECHARGE=true`（如果使用接口）

## 快速检查

```bash
# 检查后端服务状态
pm2 status

# 检查后端日志
pm2 logs ue-assets-backend --lines 20

# 检查后端代码是否存在
ls -la /opt/ue-assets-backend/backend-api/src/credits/credits.controller.ts
```

