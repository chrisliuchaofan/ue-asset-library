# M5.1 æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### 1. æ£€æŸ¥ç¯å¢ƒå˜é‡

**åç«¯ `.env` æ–‡ä»¶éœ€è¦åŒ…å«ï¼š**
```bash
# OSS é…ç½®ï¼ˆå¿…éœ€ï¼‰
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY=your-access-key-id
OSS_SECRET=your-access-key-secret

# OSS è®¿é—® URLï¼ˆå¯é€‰ï¼Œç”¨äº CDNï¼‰
OSS_BASE_URL=https://your-cdn-domain.com

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=your-username
DB_PASSWORD=your-password
DB_NAME=ue_assets
```

**æ£€æŸ¥æ–¹æ³•ï¼š**
```bash
cd backend-api
cat .env | grep OSS
```

---

### 2. æ£€æŸ¥æ•°æ®åº“è¡¨

**ç¡®è®¤ `job_outputs` è¡¨å·²åˆ›å»ºï¼š**

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
psql -h localhost -U your-username -d ue_assets

-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
\dt job_outputs

-- æŸ¥çœ‹è¡¨ç»“æ„
\d job_outputs
```

**å¦‚æœè¡¨ä¸å­˜åœ¨ï¼ŒTypeORM ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼ˆå¦‚æœ `synchronize: true`ï¼‰ã€‚**

---

### 3. æ£€æŸ¥ä¸´æ—¶ç›®å½•

**ç¡®è®¤ `/tmp/dream-factory` ç›®å½•å­˜åœ¨ï¼š**

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
ls -la /tmp/dream-factory
```

**å¦‚æœä¸å­˜åœ¨ï¼ŒStorageService ä¼šè‡ªåŠ¨åˆ›å»ºã€‚**

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1ï¼šæ£€æŸ¥åç«¯æœåŠ¡å¯åŠ¨

**æ­¥éª¤ï¼š**
1. å¯åŠ¨åç«¯æœåŠ¡
2. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰é”™è¯¯

```bash
cd backend-api
npm run start:dev
```

**é¢„æœŸç»“æœï¼š**
- âœ… æœåŠ¡æ­£å¸¸å¯åŠ¨
- âœ… æ²¡æœ‰ OSS é…ç½®é”™è¯¯
- âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
- âœ… `job_outputs` è¡¨å·²åˆ›å»º

---

### æµ‹è¯• 2ï¼šæµ‹è¯• OSS é…ç½®

**åˆ›å»ºæµ‹è¯•è„šæœ¬ï¼š** `backend-api/test-oss-config.ts`

```typescript
import { StorageService } from './src/storage/storage.service';
import { Test } from '@nestjs/testing';
import { getRepositoryToken } from '@nestjs/typeorm';
import { JobOutput } from './src/database/entities/job-output.entity';

async function testOSSConfig() {
  const mockRepository = {
    create: jest.fn(),
    save: jest.fn(),
    find: jest.fn(),
  };

  const module = await Test.createTestingModule({
    providers: [
      StorageService,
      {
        provide: getRepositoryToken(JobOutput),
        useValue: mockRepository,
      },
    ],
  }).compile();

  const storageService = module.get<StorageService>(StorageService);
  
  // æµ‹è¯• OSS å®¢æˆ·ç«¯åˆ›å»º
  try {
    const client = (storageService as any).getOSSClient();
    console.log('âœ… OSS å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
  } catch (error) {
    console.error('âŒ OSS é…ç½®é”™è¯¯:', error);
  }
}

testOSSConfig();
```

**æˆ–è€…ç›´æ¥æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼š**
```bash
cd backend-api
node -e "console.log('OSS_BUCKET:', process.env.OSS_BUCKET); console.log('OSS_REGION:', process.env.OSS_REGION);"
```

---

### æµ‹è¯• 3ï¼šæµ‹è¯•å›¾ç‰‡ç”Ÿæˆå’Œä¸Šä¼ 

**ä½¿ç”¨ Postman æˆ– curlï¼š**

```bash
# 1. å…ˆç™»å½•è·å– token
TOKEN=$(curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"your-password"}' \
  | jq -r '.token')

# 2. è°ƒç”¨ç”Ÿæˆå›¾ç‰‡æ¥å£ï¼ˆæä¾›å·²ç”Ÿæˆçš„å›¾ç‰‡ URLï¼‰
curl -X POST http://localhost:3001/ai/generate-image \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "æµ‹è¯•å›¾ç‰‡",
    "imageUrl": "https://via.placeholder.com/1024x1024.jpg"
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… è¿”å› `imageUrl`ï¼ˆOSS URLï¼‰
- âœ… OSS ä¸­æœ‰æ–‡ä»¶ï¼ˆè·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/image-{timestamp}.jpg`ï¼‰
- âœ… æ•°æ®åº“ `job_outputs` è¡¨æœ‰è®°å½•
- âœ… `/tmp/dream-factory/` ç›®å½•æ²¡æœ‰æ®‹ç•™æ–‡ä»¶

---

### æµ‹è¯• 4ï¼šæµ‹è¯•è§†é¢‘ç”Ÿæˆå’Œä¸Šä¼ 

```bash
# è°ƒç”¨ç”Ÿæˆè§†é¢‘æ¥å£ï¼ˆæä¾›å·²ç”Ÿæˆçš„è§†é¢‘ URLï¼‰
curl -X POST http://localhost:3001/ai/generate-video \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "video",
    "imageUrl": "https://via.placeholder.com/1920x1080.jpg",
    "prompt": "æµ‹è¯•è§†é¢‘",
    "videoUrl": "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4"
  }'
```

**é¢„æœŸç»“æœï¼š**
- âœ… è¿”å› `videoUrl`ï¼ˆOSS URLï¼‰
- âœ… OSS ä¸­æœ‰æ–‡ä»¶ï¼ˆè·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/video-{timestamp}.mp4`ï¼‰
- âœ… æ•°æ®åº“ `job_outputs` è¡¨æœ‰è®°å½•
- âœ… `/tmp/dream-factory/` ç›®å½•æ²¡æœ‰æ®‹ç•™æ–‡ä»¶

---

### æµ‹è¯• 5ï¼šæ£€æŸ¥ OSS æ–‡ä»¶

**æ–¹æ³• 1ï¼šä½¿ç”¨ OSS æ§åˆ¶å°**
1. ç™»å½•é˜¿é‡Œäº‘ OSS æ§åˆ¶å°
2. è¿›å…¥å¯¹åº”çš„ Bucket
3. æŸ¥çœ‹è·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/`
4. ç¡®è®¤æœ‰æ–‡ä»¶å­˜åœ¨

**æ–¹æ³• 2ï¼šä½¿ç”¨ OSS CLI**
```bash
# åˆ—å‡ºæ–‡ä»¶
ossutil ls oss://your-bucket/users/test@factory-buy.com/jobs/
```

---

### æµ‹è¯• 6ï¼šæ£€æŸ¥æ•°æ®åº“è®°å½•

```sql
-- æŸ¥è¯¢ job_outputs è¡¨
SELECT 
  id,
  "jobId",
  "userId",
  type,
  "ossUrl",
  "ossPath",
  size,
  meta,
  "createdAt"
FROM job_outputs
ORDER BY "createdAt" DESC
LIMIT 10;
```

**é¢„æœŸç»“æœï¼š**
- âœ… æœ‰è®°å½•
- âœ… `ossUrl` æ˜¯å®Œæ•´çš„ OSS URL
- âœ… `ossPath` ç¬¦åˆè§„èŒƒï¼š`users/{userId}/jobs/{jobId}/{type}-{timestamp}.{ext}`
- âœ… `size` å¤§äº 0

---

### æµ‹è¯• 7ï¼šæ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ¸…ç†

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š**
```bash
# æ£€æŸ¥ä¸´æ—¶ç›®å½•
ls -la /tmp/dream-factory/

# åº”è¯¥åªæœ‰æ­£åœ¨å¤„ç†çš„æ–‡ä»¶ï¼Œæ²¡æœ‰å·²å®Œæˆçš„æ–‡ä»¶
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ²¡æœ‰å·²å®Œæˆçš„ Job çš„ä¸´æ—¶æ–‡ä»¶
- âœ… åªæœ‰æ­£åœ¨å¤„ç†çš„æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰

---

### æµ‹è¯• 8ï¼šæµ‹è¯•æ¸…ç†æœºåˆ¶

**æ‰‹åŠ¨è§¦å‘æ¸…ç†ï¼š**
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆéœ€è¦ Node.js ç¯å¢ƒï¼‰
cd backend-api
node -e "
const { StorageService } = require('./dist/storage/storage.service');
const service = new StorageService();
service.cleanupOldTempFiles().then(count => {
  console.log('æ¸…ç†äº†', count, 'ä¸ªè¿‡æœŸæ–‡ä»¶');
});
"
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ¸…ç† 24 å°æ—¶å‰çš„ä¸´æ—¶æ–‡ä»¶
- âœ… è¿”å›æ¸…ç†çš„æ–‡ä»¶æ•°é‡

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šOSS é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
OSS é…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼šOSS_BUCKET, OSS_REGION, OSS_ACCESS_KEY, OSS_SECRET
```

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ OSS é…ç½®
2. ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®
3. é‡å¯åç«¯æœåŠ¡

---

### é—®é¢˜ 2ï¼šOSS ä¸Šä¼ å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
ä¸Šä¼ å›¾ç‰‡åˆ° OSS å¤±è´¥: AccessDenied
```

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ OSS AccessKey å’Œ Secret æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ OSS Bucket æƒé™è®¾ç½®
3. ç¡®ä¿æœ‰å†™å…¥æƒé™

---

### é—®é¢˜ 3ï¼šä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†

**æ£€æŸ¥ï¼š**
```bash
ls -la /tmp/dream-factory/
```

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ Job æ˜¯å¦æ­£å¸¸å®Œæˆï¼ˆ`status = 'completed'`ï¼‰
2. æ£€æŸ¥ `JobsService.complete()` æ˜¯å¦è¢«è°ƒç”¨
3. æ‰‹åŠ¨æ¸…ç†ï¼š`rm -rf /tmp/dream-factory/*`

---

### é—®é¢˜ 4ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š**
```
relation "job_outputs" does not exist
```

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ `synchronize: true`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
2. æˆ–è¿è¡Œæ•°æ®åº“è¿ç§»
3. æ‰‹åŠ¨åˆ›å»ºè¡¨ï¼ˆå‚è€ƒ `job-output.entity.ts`ï¼‰

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] OSS é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“ `job_outputs` è¡¨å­˜åœ¨
- [ ] å›¾ç‰‡ç”Ÿæˆå’Œä¸Šä¼ æˆåŠŸ
- [ ] è§†é¢‘ç”Ÿæˆå’Œä¸Šä¼ æˆåŠŸ
- [ ] OSS ä¸­æœ‰æ–‡ä»¶
- [ ] æ•°æ®åº“æœ‰è®°å½•
- [ ] ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†
- [ ] è¿”å›çš„ URL æ˜¯ OSS URLï¼ˆä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š
1. ä¿®æ”¹å‰ç«¯ API è·¯ç”±ï¼Œç”Ÿæˆåè°ƒç”¨åç«¯ä¸Šä¼ 
2. å®ç° Cron æ¸…ç†ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
3. æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£


