# ğŸ—„ï¸ PostgreSQL æ•°æ®åº“è®¾ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ åœ¨ ECS æœåŠ¡å™¨ä¸Šå®‰è£…å’Œé…ç½® PostgreSQL æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·ã€ç§¯åˆ†å’Œæ—¥å¿—æ•°æ®ã€‚

## ğŸš€ å¿«é€Ÿè®¾ç½®ï¼ˆè‡ªåŠ¨åŒ–è„šæœ¬ï¼‰

### åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# 1. è¿›å…¥åç«¯ç›®å½•
cd /opt/ue-assets-backend/backend-api

# 2. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆåŒ…å«æ•°æ®åº“è®¾ç½®è„šæœ¬ï¼‰
git pull origin main

# 3. æ‰§è¡Œæ•°æ®åº“è®¾ç½®è„šæœ¬
sudo bash scripts/setup-database.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- å®‰è£… PostgreSQL
- åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
- è®¾ç½®æƒé™
- ç”Ÿæˆéšæœºå¯†ç 

---

## ğŸ“ æ‰‹åŠ¨è®¾ç½®æ­¥éª¤

å¦‚æœè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

### ç¬¬ä¸€æ­¥ï¼šå®‰è£… PostgreSQL

```bash
# æ›´æ–°åŒ…åˆ—è¡¨
sudo apt update

# å®‰è£… PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```bash
# åˆ‡æ¢åˆ° postgres ç”¨æˆ·
sudo -u postgres psql
```

åœ¨ PostgreSQL å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE ue_assets;

-- åˆ›å»ºç”¨æˆ·ï¼ˆæ›¿æ¢å¯†ç ï¼‰
CREATE USER ue_assets_user WITH PASSWORD 'ä½ çš„å¼ºå¯†ç ';

-- æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE ue_assets TO ue_assets_user;

-- è¿æ¥åˆ°æ•°æ®åº“
\c ue_assets

-- æˆäºˆ schema æƒé™
GRANT ALL ON SCHEMA public TO ue_assets_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO ue_assets_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO ue_assets_user;

-- é€€å‡º
\q
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®åç«¯ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
cd /opt/ue-assets-backend/backend-api
nano .env
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ue_assets
DB_USERNAME=ue_assets_user
DB_PASSWORD=ä½ åˆšæ‰è®¾ç½®çš„å¯†ç 
```

ä¿å­˜æ–‡ä»¶ï¼š`Ctrl + X` â†’ `Y` â†’ `Enter`

### ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡

```bash
# å®‰è£…æ–°çš„ä¾èµ–ï¼ˆTypeORM å’Œ PostgreSQL é©±åŠ¨ï¼‰
npm install

# é‡æ–°æ„å»º
npm run build

# é‡å¯æœåŠ¡
pm2 restart ue-assets-backend --update-env

# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤æ•°æ®åº“è¿æ¥æˆåŠŸ
pm2 logs ue-assets-backend --lines 20
```

---

## âœ… éªŒè¯æ•°æ®åº“è¿æ¥

### æ–¹æ³• 1ï¼šæŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
pm2 logs ue-assets-backend --lines 30
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```
[Nest] Connected to PostgreSQL database
```

### æ–¹æ³• 2ï¼šç›´æ¥è¿æ¥æ•°æ®åº“

```bash
# ä½¿ç”¨ postgres ç”¨æˆ·è¿æ¥
sudo -u postgres psql -d ue_assets

# æŸ¥çœ‹è¡¨
\dt

# åº”è¯¥çœ‹åˆ°ï¼šusers, credit_transactions, log_entries
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šPostgreSQL æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo journalctl -u postgresql -n 50
```

### é—®é¢˜ 2ï¼šè¿æ¥è¢«æ‹’ç»

æ£€æŸ¥ PostgreSQL é…ç½®ï¼š

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/postgresql/*/main/postgresql.conf

# ç¡®ä¿ listen_addresses = 'localhost' æˆ– '*'

# ç¼–è¾‘è®¿é—®æ§åˆ¶
sudo nano /etc/postgresql/*/main/pg_hba.conf

# ç¡®ä¿æœ‰è¿™è¡Œï¼š
# local   all             all                                     peer
# host    all             all             127.0.0.1/32            md5

# é‡å¯ PostgreSQL
sudo systemctl restart postgresql
```

### é—®é¢˜ 3ï¼šæƒé™é”™è¯¯

```bash
# é‡æ–°æˆäºˆæƒé™
sudo -u postgres psql -d ue_assets -c "GRANT ALL ON SCHEMA public TO ue_assets_user;"
sudo -u postgres psql -d ue_assets -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO ue_assets_user;"
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨
- `id` (string, PK): ç”¨æˆ·IDï¼ˆé‚®ç®±ï¼‰
- `email` (string): é‚®ç®±
- `name` (string): ç”¨æˆ·å
- `passwordHash` (string): åŠ å¯†åçš„å¯†ç 
- `credits` (number): ç§¯åˆ†ä½™é¢
- `createdAt` (Date): åˆ›å»ºæ—¶é—´
- `updatedAt` (Date): æ›´æ–°æ—¶é—´

### credit_transactions è¡¨
- `id` (uuid, PK): äº¤æ˜“ID
- `userId` (string): ç”¨æˆ·ID
- `amount` (number): é‡‘é¢ï¼ˆæ­£æ•°=å……å€¼ï¼Œè´Ÿæ•°=æ¶ˆè´¹ï¼‰
- `action` (string): æ“ä½œç±»å‹
- `transactionId` (string): å¤–éƒ¨äº¤æ˜“ID
- `description` (string): äº¤æ˜“æè¿°
- `balanceAfter` (number): äº¤æ˜“åä½™é¢
- `createdAt` (Date): åˆ›å»ºæ—¶é—´

### log_entries è¡¨
- `id` (uuid, PK): æ—¥å¿—ID
- `userId` (string): ç”¨æˆ·ID
- `action` (string): æ“ä½œç±»å‹
- `details` (jsonb): è¯¦ç»†ä¿¡æ¯
- `success` (boolean): æ˜¯å¦æˆåŠŸ
- `timestamp` (Date): æ“ä½œæ—¶é—´
- `createdAt` (Date): åˆ›å»ºæ—¶é—´

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨å¼ºå¯†ç **ï¼šæ•°æ®åº“å¯†ç åº”è¯¥è¶³å¤Ÿå¤æ‚
2. **é™åˆ¶è®¿é—®**ï¼šåªå…è®¸ localhost è¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
3. **å®šæœŸå¤‡ä»½**ï¼šè®¾ç½®æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
4. **æ›´æ–°å¯†ç **ï¼šå®šæœŸæ›´æ¢æ•°æ®åº“å¯†ç 

---

## ğŸ“ ä¸‹ä¸€æ­¥

æ•°æ®åº“è®¾ç½®å®Œæˆåï¼Œéœ€è¦ï¼š
1. ä¿®æ”¹æœåŠ¡å±‚ä»£ç ä½¿ç”¨æ•°æ®åº“ï¼ˆè€Œä¸æ˜¯å†…å­˜å­˜å‚¨ï¼‰
2. è¿è¡Œæ•°æ®åº“è¿ç§»åˆ›å»ºè¡¨
3. åˆå§‹åŒ–ç”¨æˆ·æ•°æ®

**æœ€åæ›´æ–°**ï¼š2025-12-14

