# 数据库设置指南

## 📋 数据库类型

**后端使用：PostgreSQL**

---

## 🎯 两种方案

### 方案 1：本地开发（推荐先测试）

**适用于：** 本地开发和测试

#### 选项 A：使用 Docker（最简单）

```bash
# 1. 安装 Docker Desktop（如果还没有）
# 下载：https://www.docker.com/products/docker-desktop

# 2. 启动 PostgreSQL 容器
docker run --name ue-assets-db \
  -e POSTGRES_USER=ue_user \
  -e POSTGRES_PASSWORD=ue_password \
  -e POSTGRES_DB=ue_assets \
  -p 5432:5432 \
  -d postgres:15

# 3. 验证数据库运行
docker ps | grep ue-assets-db
```

**配置 `backend-api/.env`：**
```bash
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=ue_user
DB_PASSWORD=ue_password
DB_NAME=ue_assets
```

#### 选项 B：本地安装 PostgreSQL

**macOS：**
```bash
# 使用 Homebrew 安装
brew install postgresql@15

# 启动服务
brew services start postgresql@15

# 创建数据库和用户
createdb ue_assets
psql ue_assets
```

**在 psql 中执行：**
```sql
CREATE USER ue_user WITH PASSWORD 'ue_password';
GRANT ALL PRIVILEGES ON DATABASE ue_assets TO ue_user;
\q
```

**配置 `backend-api/.env`：**
```bash
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=ue_user
DB_PASSWORD=ue_password
DB_NAME=ue_assets
```

---

### 方案 2：云数据库（生产环境推荐）

**适用于：** 生产环境部署

#### 选项 A：阿里云 RDS PostgreSQL

1. **登录阿里云控制台**
   - 访问：https://rds.console.aliyun.com/

2. **创建 RDS 实例**
   - 点击"创建实例"
   - 选择 PostgreSQL 版本（推荐 15.x）
   - 选择地域和可用区
   - 选择实例规格（根据需求选择）
   - 设置密码

3. **配置白名单**
   - 添加 ECS 服务器的 IP 到白名单
   - 或添加 `0.0.0.0/0`（允许所有 IP，仅用于测试）

4. **获取连接信息**
   - 实例连接地址（如：`rm-xxxxx.postgres.rds.aliyuncs.com`）
   - 端口：`5432`
   - 数据库名：`ue_assets`（需要手动创建）
   - 用户名：创建实例时设置的用户名
   - 密码：创建实例时设置的密码

5. **创建数据库**
   ```sql
   -- 连接到 RDS 实例后执行
   CREATE DATABASE ue_assets;
   ```

6. **配置 `backend-api/.env`（在服务器上）**
   ```bash
   DB_HOST=rm-xxxxx.postgres.rds.aliyuncs.com
   DB_PORT=5432
   DB_USERNAME=你的RDS用户名
   DB_PASSWORD=你的RDS密码
   DB_NAME=ue_assets
   ```

#### 选项 B：使用 ECS 服务器上的 PostgreSQL

**如果 ECS 服务器上已经有 PostgreSQL：**

1. **SSH 到服务器**
   ```bash
   ssh your-server
   ```

2. **检查 PostgreSQL 是否运行**
   ```bash
   sudo systemctl status postgresql
   # 或
   ps aux | grep postgres
   ```

3. **创建数据库和用户**
   ```bash
   sudo -u postgres psql
   ```

   ```sql
   CREATE DATABASE ue_assets;
   CREATE USER ue_user WITH PASSWORD 'your_password';
   GRANT ALL PRIVILEGES ON DATABASE ue_assets TO ue_user;
   \q
   ```

4. **配置 `backend-api/.env`（在服务器上）**
   ```bash
   DB_HOST=localhost  # 如果数据库在本地
   # 或
   DB_HOST=服务器内网IP  # 如果从其他服务器连接
   DB_PORT=5432
   DB_USERNAME=ue_user
   DB_PASSWORD=your_password
   DB_NAME=ue_assets
   ```

---

## 🧪 测试数据库连接

### 方法 1：使用 psql 命令行

```bash
# 本地测试
psql -h localhost -U ue_user -d ue_assets

# 输入密码后，如果连接成功，会看到：
# ue_assets=>
```

### 方法 2：启动后端服务测试

```bash
cd backend-api
npm run start:dev
```

**查看日志：**
- ✅ 如果看到数据库连接成功，说明配置正确
- ❌ 如果看到连接错误，检查配置和网络

---

## 📝 快速检查清单

- [ ] 已选择方案（本地 Docker / 本地安装 / 云数据库）
- [ ] 已创建数据库 `ue_assets`
- [ ] 已创建用户并设置密码
- [ ] 已配置 `backend-api/.env` 文件
- [ ] 已测试数据库连接
- [ ] 后端服务可以正常启动

---

## 💡 推荐方案

**开发阶段：**
- ✅ 使用 Docker（最简单，不污染系统）

**生产环境：**
- ✅ 使用阿里云 RDS（稳定、可靠、有备份）

---

## ⚠️ 注意事项

1. **密码安全**
   - 生产环境使用强密码
   - 不要将密码提交到 Git

2. **网络访问**
   - 本地开发：`DB_HOST=localhost`
   - 云数据库：使用 RDS 连接地址
   - 确保防火墙允许 5432 端口

3. **数据库初始化**
   - TypeORM 会在启动时自动创建表（如果 `synchronize: true`）
   - 生产环境建议使用迁移（`synchronize: false`）
