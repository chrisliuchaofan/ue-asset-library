name: Deploy Backend to ECS

on:
  push:
    branches:
      - main
    # ç§»é™¤è·¯å¾„è¿‡æ»¤ï¼Œç¡®ä¿æ‰€æœ‰æäº¤éƒ½è§¦å‘éƒ¨ç½²
    # å¦‚æœéœ€è¦ä¼˜åŒ–ï¼Œå¯ä»¥æ·»åŠ è·¯å¾„è¿‡æ»¤
    # paths:
    #   - 'backend-api/**'
    #   - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend-api/package-lock.json

      - name: Install dependencies
        run: |
          cd backend-api
          npm ci

      - name: Build backend
        run: |
          cd backend-api
          npm run build

      - name: Deploy to ECS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åç«¯..."
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "/opt/ue-assets-backend/backend-api" ]; then
              echo "âŒ é”™è¯¯ï¼šç›®å½• /opt/ue-assets-backend/backend-api ä¸å­˜åœ¨"
              exit 1
            fi
            
            cd /opt/ue-assets-backend/backend-api
            
            # å¦‚æœä½¿ç”¨ Gitï¼Œæ‹‰å–æœ€æ–°ä»£ç 
            if [ -d .git ]; then
              echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
              git pull origin main || {
                echo "âš ï¸ Git pull å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨ç°æœ‰ä»£ç "
              }
            fi
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --production || {
              echo "âŒ npm install å¤±è´¥"
              exit 1
            }
            
            # å¦‚æœæœåŠ¡å™¨ä¸Šæœ‰æºç ï¼Œéœ€è¦æ„å»º
            if [ -d src ]; then
              echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
              npm run build || {
                echo "âŒ npm run build å¤±è´¥"
                exit 1
              }
            fi
            
            # é‡å¯ PM2 è¿›ç¨‹
            echo "ğŸ”„ é‡å¯ PM2 è¿›ç¨‹..."
            pm2 restart ue-assets-backend --update-env || {
              echo "âŒ PM2 restart å¤±è´¥ï¼Œå°è¯•å¯åŠ¨..."
              pm2 start ecosystem.config.js || {
                echo "âŒ PM2 start å¤±è´¥"
                exit 1
              }
            }
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 3
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            pm2 status
            
            # æ˜¾ç¤ºæ—¥å¿—
            echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—ï¼š"
            pm2 logs ue-assets-backend --lines 20 --nostream || true
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

