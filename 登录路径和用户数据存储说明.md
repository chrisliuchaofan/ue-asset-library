# ğŸ” ç™»å½•è·¯å¾„å’Œç”¨æˆ·æ•°æ®å­˜å‚¨è¯´æ˜

## ğŸ“‹ å½“å‰ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ ˆ
- **å‰ç«¯è®¤è¯**ï¼šNextAuth.js v5ï¼ˆJWT ç­–ç•¥ï¼‰
- **åç«¯è®¤è¯**ï¼šNestJS + JWT
- **ç”¨æˆ·æ•°æ®å­˜å‚¨**ï¼šPostgreSQL æ•°æ®åº“ï¼ˆåç«¯ï¼‰
- **å‰ç«¯æ¡†æ¶**ï¼šNext.js 16

---

## ğŸ”„ å®Œæ•´ç™»å½•è·¯å¾„

### 1. ç”¨æˆ·è®¿é—®ç®¡ç†é¡µé¢

```
ç”¨æˆ·è®¿é—® /admin
  â†“
middleware.ts æ£€æŸ¥è®¤è¯çŠ¶æ€
  â†“
æœªç™»å½• â†’ é‡å®šå‘åˆ° /auth/login?callbackUrl=/admin
```

### 2. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 

```
ç”¨æˆ·åœ¨ç™»å½•é¡µé¢è¾“å…¥ï¼š
- ç”¨æˆ·åï¼šadmin
- å¯†ç ï¼šadmin123
  â†“
ç‚¹å‡»ç™»å½•æŒ‰é’®
  â†“
è°ƒç”¨ NextAuth signIn('credentials', { username, password })
```

### 3. NextAuth è®¤è¯æµç¨‹

```
lib/auth-config.ts: authorize() å‡½æ•°
  â†“
æ­¥éª¤ 1ï¼šå°è¯•è°ƒç”¨åç«¯ç™»å½•æ¥å£
  - URL: ${BACKEND_API_URL}/auth/login
  - æ–¹æ³•: POST
  - æ•°æ®: { email: "admin@admin.local", password: "admin123" }
  - è¶…æ—¶: 10ç§’
  â†“
æ­¥éª¤ 2-Aï¼šåç«¯ç™»å½•æˆåŠŸ
  - åç«¯è¿”å›: { success: true, userId, email, name, token, isAdmin }
  - å‰ç«¯æå–: { id: userId, email, name }
  - è¿”å›ç»™ NextAuth
  â†“
æ­¥éª¤ 2-Bï¼šåç«¯ç™»å½•å¤±è´¥ï¼ˆè¶…æ—¶/è¿æ¥å¤±è´¥ï¼‰
  - æ•è·é”™è¯¯
  - å›é€€åˆ°æœ¬åœ°è®¤è¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  - ä» ADMIN_USERS ç¯å¢ƒå˜é‡åŒ¹é…ç”¨æˆ·
  - å¦‚æœåŒ¹é…æˆåŠŸï¼Œè¿”å›: { id: email, name: username, email }
  â†“
æ­¥éª¤ 3ï¼šNextAuth åˆ›å»º Session
  - JWT Callback: å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥ JWT token
  - Session Callback: å°† JWT token ä¿¡æ¯å†™å…¥ session
  - è¿”å› session ç»™å‰ç«¯
```

### 4. ç™»å½•æˆåŠŸåçš„è·³è½¬

```
signIn è¿”å› { ok: true, url: "/admin" }
  â†“
å‰ç«¯è·³è½¬åˆ° /admin
  â†“
middleware.ts å†æ¬¡æ£€æŸ¥
  - req.auth å­˜åœ¨ â†’ å…è®¸è®¿é—®
  - æ˜¾ç¤ºç®¡ç†é¡µé¢
```

---

## ğŸ’¾ ç”¨æˆ·æ•°æ®å­˜å‚¨ä½ç½®

### æ•°æ®å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ï¼ˆNext.jsï¼‰                                â”‚
â”‚  - NextAuth Sessionï¼ˆJWTï¼Œå­˜å‚¨åœ¨ cookieï¼‰      â”‚
â”‚  - ä¸å­˜å‚¨ç”¨æˆ·å¯†ç                                â”‚
â”‚  - åªå­˜å‚¨ï¼šid, email, name                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            HTTP API è°ƒç”¨
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯æœåŠ¡ï¼ˆNestJSï¼‰                             â”‚
â”‚  - è¿è¡Œåœ¨æœåŠ¡å™¨æˆ–æœ¬åœ°                            â”‚
â”‚  - ç«¯å£ï¼š3002ï¼ˆæˆ– 3001ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            TypeORM æ•°æ®åº“è¿æ¥
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ³ Docker å®¹å™¨ï¼ˆæœ¬åœ°æ•°æ®å±‚ï¼‰                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL æ•°æ®åº“ï¼ˆè¿è¡Œåœ¨ Docker ä¸­ï¼‰    â”‚  â”‚
â”‚  â”‚  - å®¹å™¨åï¼šue-assets-db                   â”‚  â”‚
â”‚  â”‚  - ç«¯å£æ˜ å°„ï¼š5432:5432                    â”‚  â”‚
â”‚  â”‚  - æ•°æ®å­˜å‚¨ï¼šDocker æ•°æ®å·ï¼ˆæœ¬åœ°ç£ç›˜ï¼‰     â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  ğŸ“Š æ•°æ®åº“è¡¨ï¼š                              â”‚  â”‚
â”‚  â”‚  - users è¡¨ï¼ˆç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼‰               â”‚  â”‚
â”‚  â”‚    * id (email)                           â”‚  â”‚
â”‚  â”‚    * email                                â”‚  â”‚
â”‚  â”‚    * name                                 â”‚  â”‚
â”‚  â”‚    * passwordHash (bcrypt)                â”‚  â”‚
â”‚  â”‚    * credits (ç¼“å­˜ï¼ŒéçœŸå®æ¥æº)           â”‚  â”‚
â”‚  â”‚    * billingMode (DRY_RUN/REAL)           â”‚  â”‚
â”‚  â”‚    * modelMode (DRY_RUN/REAL)             â”‚  â”‚
â”‚  â”‚    * createdAt, updatedAt                 â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  - credit_transactions è¡¨ï¼ˆç§¯åˆ†è´¦æœ¬ï¼‰     â”‚  â”‚
â”‚  â”‚    * id                                   â”‚  â”‚
â”‚  â”‚    * userId                               â”‚  â”‚
â”‚  â”‚    * amount (æ­£æ•°=å……å€¼ï¼Œè´Ÿæ•°=æ¶ˆè´¹)        â”‚  â”‚
â”‚  â”‚    * type (RECHARGE/CONSUME)              â”‚  â”‚
â”‚  â”‚    * refId (å¹‚ç­‰æ€§æ ‡è¯†)                   â”‚  â”‚
â”‚  â”‚    * createdAt                             â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  âš ï¸ çœŸå®ä½™é¢æ¥æºï¼šä» credit_transactions â”‚  â”‚
â”‚  â”‚     è¡¨ SUM(amount) è®¡ç®—ï¼Œä¸æ˜¯ users.creditsâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  ğŸ’¾ æ•°æ®æŒä¹…åŒ–ï¼š                                 â”‚
â”‚  - Docker æ•°æ®å·ï¼šue-assets-db-data            â”‚
â”‚  - å­˜å‚¨ä½ç½®ï¼š/var/lib/docker/volumes/          â”‚
â”‚  - æˆ–å®¹å™¨å†…ï¼š/var/lib/postgresql/data          â”‚
â”‚  - âœ… è¿™æ˜¯"æœ¬åœ°æ•°æ®å±‚"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”¨æˆ·æ•°æ®åˆå§‹åŒ–æµç¨‹

```
åç«¯æœåŠ¡å¯åŠ¨
  â†“
è¿æ¥ Docker PostgreSQL æ•°æ®åº“
  - DB_HOST=localhostï¼ˆè¿æ¥æœ¬åœ° Docker å®¹å™¨ï¼‰
  - DB_PORT=5432ï¼ˆDocker ç«¯å£æ˜ å°„ï¼‰
  â†“
CreditsService æ„é€ å‡½æ•°æ‰§è¡Œ
  â†“
initializeUsers() æ–¹æ³•
  â†“
è¯»å–ç¯å¢ƒå˜é‡ USER_WHITELIST
  æ ¼å¼: email1:password1,email2:password2
  â†“
éå†æ¯ä¸ªç”¨æˆ·
  â†“
æ£€æŸ¥ Docker æ•°æ®åº“ users è¡¨ï¼ˆæœ¬åœ°æ•°æ®å±‚ï¼‰
  â†“
å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼š
  - åœ¨ Docker æ•°æ®åº“ä¸­åˆ›å»ºç”¨æˆ·è®°å½•
  - è®¾ç½®åˆå§‹ç§¯åˆ†ï¼ˆINITIAL_CREDITSï¼‰
  - passwordHash æš‚æ—¶ä¸ºç©ºï¼ˆç”±ç™»å½•æ—¶è®¾ç½®ï¼‰
  - âœ… æ•°æ®ä¿å­˜åœ¨æœ¬åœ° Docker æ•°æ®å·ä¸­
  â†“
å¦‚æœç”¨æˆ·å­˜åœ¨ä½†ç§¯åˆ†ä¸º0ï¼š
  - é‡ç½®ä¸ºåˆå§‹ç§¯åˆ†
  - âœ… æ•°æ®æ›´æ–°åˆ°æœ¬åœ° Docker æ•°æ®åº“
```

### ç”¨æˆ·è®¤è¯æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå‰ç«¯ï¼‰                            â”‚
â”‚  ADMIN_USERS=admin:admin123                     â”‚
â”‚  - ç”¨äºæœ¬åœ°è®¤è¯å›é€€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰                 â”‚
â”‚  - ä¸å­˜å‚¨åˆ°æ•°æ®åº“                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¯å¢ƒå˜é‡é…ç½®ï¼ˆåç«¯ï¼‰                            â”‚
â”‚  USER_WHITELIST=admin@admin.local:admin123     â”‚
â”‚  - ç”¨äºå¼€å‘ç¯å¢ƒç™½åå•éªŒè¯                        â”‚
â”‚  - ç”¨äºåˆå§‹åŒ– Docker æ•°æ®åº“ç”¨æˆ·                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ³ Docker PostgreSQL æ•°æ®åº“ï¼ˆæœ¬åœ°æ•°æ®å±‚ï¼‰      â”‚
â”‚  - è¿è¡Œåœ¨ Docker å®¹å™¨ä¸­ï¼ˆue-assets-dbï¼‰        â”‚
â”‚  - æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° Docker æ•°æ®å·                 â”‚
â”‚  - åç«¯é€šè¿‡ localhost:5432 è¿æ¥                 â”‚
â”‚  - users è¡¨ï¼šå­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œå¯†ç å“ˆå¸Œ         â”‚
â”‚  - credit_transactions è¡¨ï¼šå­˜å‚¨ç§¯åˆ†äº¤æ˜“è®°å½•     â”‚
â”‚  - âœ… è¿™æ˜¯"æœ¬åœ°æ•°æ®å±‚"ï¼Œä¸æ˜¯è¿œç¨‹æ•°æ®åº“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å½“å‰å®ç°çš„åŸºç¡€

### 1. å‰ç«¯è®¤è¯åŸºç¡€

**æ–‡ä»¶ï¼š** `lib/auth-config.ts`

- âœ… NextAuth.js v5 é…ç½®
- âœ… Credentials Providerï¼ˆç”¨æˆ·åå¯†ç ç™»å½•ï¼‰
- âœ… JWT ç­–ç•¥ï¼ˆæ— çŠ¶æ€ï¼Œä¸éœ€è¦æ•°æ®åº“ï¼‰
- âœ… Session é…ç½®ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
- âœ… åç«¯ç™»å½•æ¥å£é›†æˆ
- âœ… æœ¬åœ°è®¤è¯å›é€€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**Session å­˜å‚¨ï¼š**
- å­˜å‚¨åœ¨ HTTP-only cookie ä¸­
- ä½¿ç”¨ JWT token ç¼–ç 
- åŒ…å«ï¼š`id`, `email`, `name`

### 2. åç«¯è®¤è¯åŸºç¡€

**æ–‡ä»¶ï¼š** `backend-api/src/auth/auth.service.ts`

- âœ… æ•°æ®åº“ç”¨æˆ·éªŒè¯ï¼ˆä¼˜å…ˆï¼‰
- âœ… ç™½åå•ç”¨æˆ·éªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒå›é€€ï¼‰
- âœ… JWT token ç”Ÿæˆ
- âœ… ç®¡ç†å‘˜æƒé™æ£€æŸ¥

**æ–‡ä»¶ï¼š** `backend-api/src/users/users.service.ts`

- âœ… ç”¨æˆ·æ³¨å†Œ
- âœ… ç”¨æˆ·ç™»å½•ï¼ˆbcrypt å¯†ç éªŒè¯ï¼‰
- âœ… ç”¨æˆ·æŸ¥è¯¢
- âœ… ç”¨æˆ·æ¨¡å¼ç®¡ç†

### 3. ç”¨æˆ·æ•°æ®å­˜å‚¨åŸºç¡€

**æ•°æ®åº“å®ä½“ï¼š** `backend-api/src/database/entities/user.entity.ts`

```typescript
- id: string (email)
- email: string
- name: string
- passwordHash: string (bcrypt)
- credits: number (ç¼“å­˜ï¼ŒéçœŸå®æ¥æº)
- billingMode: 'DRY_RUN' | 'REAL'
- modelMode: 'DRY_RUN' | 'REAL'
- createdAt, updatedAt
```

**ç§¯åˆ†è´¦æœ¬ï¼š** `backend-api/src/database/entities/credit-transaction.entity.ts`

```typescript
- id: string
- userId: string
- amount: number (æ­£æ•°=å……å€¼ï¼Œè´Ÿæ•°=æ¶ˆè´¹)
- type: 'RECHARGE' | 'CONSUME'
- refId: string (å¹‚ç­‰æ€§æ ‡è¯†)
- createdAt: Date
```

**çœŸå®ä½™é¢è®¡ç®—ï¼š** `backend-api/src/credits/credits.service.ts`

```typescript
// ä» credit_transactions è¡¨ SUM(amount) è®¡ç®—
// è¿™æ˜¯å”¯ä¸€çœŸå®æ¥æºï¼ˆSingle Source of Truthï¼‰
// users.credits ä»…ä½œä¸ºç¼“å­˜
```

### 4. è·¯ç”±ä¿æŠ¤åŸºç¡€

**æ–‡ä»¶ï¼š** `middleware.ts`

- âœ… ä¿æŠ¤ `/admin` è·¯ç”±
- âœ… ä¿æŠ¤ `/dream-factory` è·¯ç”±
- âœ… æœªç™»å½•è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
- âœ… ç™»å½•åè‡ªåŠ¨è·³è½¬å›åŸé¡µé¢

---

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·ç™»å½•ç®¡ç†é¡µé¢

```
1. ç”¨æˆ·è®¿é—® http://localhost:3000/admin
   â†“
2. middleware.ts æ£€æŸ¥ req.auth
   - æœªç™»å½• â†’ é‡å®šå‘åˆ° /auth/login?callbackUrl=/admin
   â†“
3. ç”¨æˆ·åœ¨ç™»å½•é¡µé¢è¾“å…¥ï¼š
   - ç”¨æˆ·å: admin
   - å¯†ç : admin123
   â†“
4. å‰ç«¯è°ƒç”¨ signIn('credentials', { username: 'admin', password: 'admin123' })
   â†“
5. NextAuth è°ƒç”¨ authorize() å‡½æ•°
   â†“
6. authorize() å°è¯•è°ƒç”¨åç«¯ç™»å½•æ¥å£
   POST http://8.148.196.57:3002/auth/login
   Body: { email: "admin@admin.local", password: "admin123" }
   â†“
7-A. åç«¯ç™»å½•æˆåŠŸï¼ˆå¦‚æœåç«¯å¯ç”¨ï¼‰
   - åç«¯æŸ¥è¯¢æ•°æ®åº“ users è¡¨
   - éªŒè¯å¯†ç ï¼ˆbcrypt.compareï¼‰
   - è¿”å›: { success: true, userId, email, name, token }
   - å‰ç«¯è¿”å›ç”¨æˆ·ä¿¡æ¯ç»™ NextAuth
   â†“
7-B. åç«¯ç™»å½•å¤±è´¥ï¼ˆè¶…æ—¶/è¿æ¥å¤±è´¥ï¼‰
   - æ•è·é”™è¯¯
   - ä» ADMIN_USERS ç¯å¢ƒå˜é‡åŒ¹é…ç”¨æˆ·
   - å¦‚æœåŒ¹é…æˆåŠŸï¼Œè¿”å›: { id: "admin@admin.local", email: "admin@admin.local", name: "admin" }
   â†“
8. NextAuth JWT Callback
   - å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥ JWT token
   - token.id = user.id
   - token.email = user.email
   - token.name = user.name
   â†“
9. NextAuth Session Callback
   - ä» JWT token è¯»å–ç”¨æˆ·ä¿¡æ¯
   - session.user.id = token.id
   - session.user.email = token.email
   - session.user.name = token.name
   â†“
10. ç™»å½•æˆåŠŸï¼Œå‰ç«¯è·³è½¬åˆ° /admin
   â†“
11. middleware.ts å†æ¬¡æ£€æŸ¥
   - req.auth å­˜åœ¨ â†’ å…è®¸è®¿é—®
   - æ˜¾ç¤ºç®¡ç†é¡µé¢
```

---

## ğŸ“Š ç”¨æˆ·æ•°æ®å­˜å‚¨æ€»ç»“

### å­˜å‚¨ä½ç½®

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | è¯´æ˜ |
|---------|---------|------|
| **ç”¨æˆ·åŸºæœ¬ä¿¡æ¯** | ğŸ³ Docker PostgreSQL `users` è¡¨ | å”¯ä¸€çœŸå®æ¥æºï¼Œå­˜å‚¨åœ¨æœ¬åœ° Docker æ•°æ®å· |
| **ç”¨æˆ·å¯†ç ** | ğŸ³ Docker PostgreSQL `users.passwordHash` | bcrypt åŠ å¯†å­˜å‚¨ï¼Œæœ¬åœ°æ•°æ®å±‚ |
| **ç”¨æˆ·ç§¯åˆ†ä½™é¢** | ğŸ³ Docker PostgreSQL `credit_transactions` è¡¨ | ä»äº¤æ˜“è®°å½• SUM è®¡ç®—ï¼ˆçœŸå®æ¥æºï¼‰ï¼Œæœ¬åœ°æ•°æ®å±‚ |
| **ç”¨æˆ·ç§¯åˆ†ç¼“å­˜** | ğŸ³ Docker PostgreSQL `users.credits` | ä»…ä½œä¸ºç¼“å­˜ï¼ŒéçœŸå®æ¥æºï¼Œæœ¬åœ°æ•°æ®å±‚ |
| **Session ä¿¡æ¯** | HTTP-only Cookieï¼ˆå‰ç«¯ï¼‰ | JWT tokenï¼ŒåŒ…å« id, email, name |
| **ç®¡ç†å‘˜é…ç½®** | ç¯å¢ƒå˜é‡ `ADMIN_USERS` | ä»…ç”¨äºæœ¬åœ°è®¤è¯å›é€€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ |
| **åç«¯ç”¨æˆ·ç™½åå•** | ç¯å¢ƒå˜é‡ `USER_WHITELIST` | ç”¨äºåˆå§‹åŒ– Docker æ•°æ®åº“ç”¨æˆ·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ |

### ğŸ³ Docker æ•°æ®å±‚è¯´æ˜

**Docker PostgreSQL å°±æ˜¯ä½ çš„"æœ¬åœ°æ•°æ®å±‚"ï¼**

```
Docker å®¹å™¨ï¼ˆue-assets-dbï¼‰
  â†“
PostgreSQL æ•°æ®åº“
  â†“
æ•°æ®å­˜å‚¨åœ¨ Docker æ•°æ®å·ä¸­
  â†“
æ•°æ®å·ä½ç½®ï¼š/var/lib/docker/volumes/ue-assets-db-data
  â†“
âœ… è¿™æ˜¯æœ¬åœ°ç£ç›˜ï¼Œä¸æ˜¯è¿œç¨‹æœåŠ¡å™¨
```

**å…³é”®ç‚¹ï¼š**
- âœ… Docker å®¹å™¨è¿è¡Œåœ¨**æœ¬åœ°æœºå™¨**ä¸Š
- âœ… æ•°æ®å­˜å‚¨åœ¨**æœ¬åœ° Docker æ•°æ®å·**ä¸­
- âœ… åç«¯æœåŠ¡é€šè¿‡ `localhost:5432` è¿æ¥ï¼ˆæœ¬åœ°è¿æ¥ï¼‰
- âœ… è¿™ä¸æ˜¯"è¿œç¨‹æ•°æ®åº“"ï¼Œè€Œæ˜¯"æœ¬åœ° Docker æ•°æ®å±‚"

### æ•°æ®æµå‘

```
ç¯å¢ƒå˜é‡ï¼ˆé…ç½®ï¼‰
  â†“
PostgreSQL æ•°æ®åº“ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰
  â†“
åç«¯ APIï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
  â†“
JWT Tokenï¼ˆè®¤è¯ï¼‰
  â†“
NextAuth Sessionï¼ˆå‰ç«¯çŠ¶æ€ï¼‰
```

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. ç”¨æˆ·æ•°æ®çš„å•ä¸€çœŸå®æ¥æº

- âœ… **ç”¨æˆ·åŸºæœ¬ä¿¡æ¯**ï¼šPostgreSQL `users` è¡¨
- âœ… **ç”¨æˆ·ç§¯åˆ†ä½™é¢**ï¼šPostgreSQL `credit_transactions` è¡¨ï¼ˆä» SUM è®¡ç®—ï¼‰
- âš ï¸ **users.credits**ï¼šä»…ä½œä¸ºç¼“å­˜ï¼Œä¸æ˜¯çœŸå®æ¥æº

### 2. è®¤è¯çš„åŒé‡æœºåˆ¶

- âœ… **ç”Ÿäº§ç¯å¢ƒ**ï¼šä¼˜å…ˆä½¿ç”¨æ•°æ®åº“éªŒè¯ï¼Œå¤±è´¥åˆ™æ‹’ç»ç™»å½•
- âš ï¸ **å¼€å‘ç¯å¢ƒ**ï¼šæ•°æ®åº“éªŒè¯å¤±è´¥åï¼Œå›é€€åˆ°ç™½åå•éªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰

### 3. å¯†ç å­˜å‚¨

- âœ… **æ•°æ®åº“**ï¼šbcrypt åŠ å¯†å­˜å‚¨ï¼ˆ`users.passwordHash`ï¼‰
- âš ï¸ **ç¯å¢ƒå˜é‡**ï¼šæ˜æ–‡å­˜å‚¨ï¼ˆä»…ç”¨äºå¼€å‘ç¯å¢ƒï¼Œä¸åº”åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰

### 4. Session å­˜å‚¨

- âœ… **å‰ç«¯**ï¼šHTTP-only cookieï¼ˆJWT tokenï¼‰
- âœ… **æ— çŠ¶æ€**ï¼šä¸ä¾èµ–æ•°æ®åº“ï¼Œä½¿ç”¨ JWT ç­–ç•¥
- âœ… **æœ‰æ•ˆæœŸ**ï¼š30å¤©

---

## ğŸ”§ é…ç½®è¦æ±‚

### å‰ç«¯ç¯å¢ƒå˜é‡ï¼ˆ`.env.local`ï¼‰

```env
# NextAuth é…ç½®ï¼ˆå¿…éœ€ï¼‰
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=http://localhost:3000

# ç®¡ç†å‘˜è´¦å·ï¼ˆç”¨äºæœ¬åœ°è®¤è¯å›é€€ï¼‰
ADMIN_USERS=admin:admin123

# åç«¯ API é…ç½®
BACKEND_API_URL=http://8.148.196.57:3002
# æˆ–
NEXT_PUBLIC_BACKEND_API_URL=http://8.148.196.57:3002
```

### åç«¯ç¯å¢ƒå˜é‡ï¼ˆæœåŠ¡å™¨ `.env`ï¼‰

```env
# ğŸ³ Docker æ•°æ®åº“é…ç½®ï¼ˆå¿…éœ€ï¼‰
# æ³¨æ„ï¼šDB_HOST=localhost è¡¨ç¤ºè¿æ¥æœ¬åœ° Docker å®¹å™¨
# è¿™æ˜¯"æœ¬åœ°æ•°æ®å±‚"ï¼Œä¸æ˜¯è¿œç¨‹æ•°æ®åº“
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ue_assets
DB_USERNAME=ue_user
DB_PASSWORD=ue_password

# JWT é…ç½®ï¼ˆå¿…éœ€ï¼Œå¿…é¡»ä¸å‰ç«¯ NEXTAUTH_SECRET ç›¸åŒï¼‰
JWT_SECRET=your-secret-key
NEXTAUTH_SECRET=your-secret-key

# ç”¨æˆ·ç™½åå•ï¼ˆç”¨äºåˆå§‹åŒ– Docker æ•°æ®åº“ç”¨æˆ·ï¼‰
USER_WHITELIST=admin@admin.local:admin123

# åˆå§‹ç§¯åˆ†
INITIAL_CREDITS=100

# Dry Run æ¨¡å¼ï¼ˆé»˜è®¤å®‰å…¨ï¼‰
MODEL_ENABLED=false
BILLING_ENABLED=false
```

### ğŸ³ Docker æ•°æ®å±‚é…ç½®

**Docker å®¹å™¨é…ç½®ï¼š**
```bash
# å¯åŠ¨ Docker PostgreSQL å®¹å™¨ï¼ˆæœ¬åœ°æ•°æ®å±‚ï¼‰
docker run --name ue-assets-db \
  -e POSTGRES_USER=ue_user \
  -e POSTGRES_PASSWORD=ue_password \
  -e POSTGRES_DB=ue_assets \
  -p 5432:5432 \
  -v ue-assets-db-data:/var/lib/postgresql/data \
  -d postgres:15
```

**æ•°æ®æŒä¹…åŒ–ï¼š**
- âœ… ä½¿ç”¨ Docker æ•°æ®å· `ue-assets-db-data`
- âœ… æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ï¼š`/var/lib/docker/volumes/ue-assets-db-data`
- âœ… åˆ é™¤å®¹å™¨ä¸ä¼šä¸¢å¤±æ•°æ®ï¼ˆæ•°æ®å·ä¿ç•™ï¼‰
- âœ… è¿™æ˜¯**æœ¬åœ°æ•°æ®å±‚**ï¼Œä¸æ˜¯è¿œç¨‹æ•°æ®åº“

---

## ğŸ“ æ€»ç»“

### å½“å‰ç™»å½•è·¯å¾„

1. **å‰ç«¯è®¤è¯**ï¼šNextAuth.jsï¼ˆJWT ç­–ç•¥ï¼‰
2. **åç«¯è®¤è¯**ï¼šNestJS + JWT + PostgreSQL
3. **è®¤è¯æµç¨‹**ï¼šå‰ç«¯è°ƒç”¨åç«¯ç™»å½•æ¥å£ â†’ å¦‚æœå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°è®¤è¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
4. **Session å­˜å‚¨**ï¼šHTTP-only cookieï¼ˆJWT tokenï¼‰

### ç”¨æˆ·æ•°æ®å­˜å‚¨

1. **æŒä¹…åŒ–å­˜å‚¨**ï¼šğŸ³ Docker PostgreSQL æ•°æ®åº“ï¼ˆæœ¬åœ°æ•°æ®å±‚ï¼‰
   - è¿è¡Œåœ¨ Docker å®¹å™¨ä¸­ï¼ˆ`ue-assets-db`ï¼‰
   - æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° Docker æ•°æ®å·ä¸­
   - åç«¯é€šè¿‡ `localhost:5432` è¿æ¥ï¼ˆæœ¬åœ°è¿æ¥ï¼‰
   - âœ… **è¿™å°±æ˜¯ä½ çš„"æœ¬åœ°æ•°æ®å±‚"**
2. **ç”¨æˆ·è¡¨**ï¼š`users` è¡¨ï¼ˆåŸºæœ¬ä¿¡æ¯ã€å¯†ç å“ˆå¸Œã€ç§¯åˆ†ç¼“å­˜ï¼‰
3. **ç§¯åˆ†è´¦æœ¬**ï¼š`credit_transactions` è¡¨ï¼ˆçœŸå®ä½™é¢æ¥æºï¼‰
4. **Session**ï¼šHTTP-only cookieï¼ˆå‰ç«¯ï¼ŒJWT tokenï¼‰

### å½“å‰åŸºç¡€

- âœ… å®Œæ•´çš„è®¤è¯ç³»ç»Ÿï¼ˆå‰åç«¯ï¼‰
- âœ… ç”¨æˆ·æ•°æ®æŒä¹…åŒ–ï¼ˆğŸ³ Docker PostgreSQL - æœ¬åœ°æ•°æ®å±‚ï¼‰
- âœ… ç§¯åˆ†ç³»ç»Ÿï¼ˆè´¦æœ¬åŒ–è®¾è®¡ï¼‰
- âœ… è·¯ç”±ä¿æŠ¤ï¼ˆmiddlewareï¼‰
- âœ… å¼€å‘ç¯å¢ƒå›é€€æœºåˆ¶ï¼ˆæœ¬åœ°è®¤è¯ï¼‰

### ğŸ³ Docker æ•°æ®å±‚æ¶æ„è¯´æ˜

**é‡è¦æ¾„æ¸…ï¼šDocker PostgreSQL å°±æ˜¯ä½ çš„"æœ¬åœ°æ•°æ®å±‚"ï¼**

```
ä½ çš„æœ¬åœ°æœºå™¨
  â†“
Docker å®¹å™¨ï¼ˆue-assets-dbï¼‰
  â”œâ”€ PostgreSQL æ•°æ®åº“
  â””â”€ æ•°æ®å·ï¼ˆæœ¬åœ°ç£ç›˜ï¼‰
      â””â”€ /var/lib/docker/volumes/ue-assets-db-data
          â””â”€ âœ… æ‰€æœ‰ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œï¼ˆæœ¬åœ°ï¼‰
  â†“
åç«¯æœåŠ¡ï¼ˆNestJSï¼‰
  â””â”€ é€šè¿‡ localhost:5432 è¿æ¥ Docker æ•°æ®åº“
      â””â”€ âœ… è¿™æ˜¯æœ¬åœ°è¿æ¥ï¼Œä¸æ˜¯è¿œç¨‹è¿æ¥
```

**å…³é”®ç†è§£ï¼š**
- ğŸ³ Docker å®¹å™¨è¿è¡Œåœ¨**ä½ çš„æœ¬åœ°æœºå™¨**ä¸Š
- ğŸ’¾ æ•°æ®å­˜å‚¨åœ¨**æœ¬åœ° Docker æ•°æ®å·**ä¸­
- ğŸ”Œ åç«¯é€šè¿‡ `localhost:5432` è¿æ¥ï¼ˆæœ¬åœ°è¿æ¥ï¼‰
- âœ… **è¿™å°±æ˜¯"æœ¬åœ°æ•°æ®å±‚"ï¼Œä¸æ˜¯è¿œç¨‹æ•°æ®åº“**
- ğŸ“ æ•°æ®ä½ç½®ï¼š`/var/lib/docker/volumes/ue-assets-db-data`ï¼ˆæœ¬åœ°ç£ç›˜ï¼‰

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2025-01-16
**åŸºäºä»£ç ç‰ˆæœ¬ï¼š** å½“å‰ä»£ç åº“çŠ¶æ€

