# ğŸ“‹ èº«ä»½è®¤è¯é“¾è·¯ - æ–‡ä»¶å˜æ›´æ¸…å•

## âœ… æ–°å¢æ–‡ä»¶

### 1. `lib/backend-api-client.ts`
**åŠŸèƒ½ï¼š** åç«¯ API å®¢æˆ·ç«¯ï¼Œè‡ªåŠ¨å¤„ç†è®¤è¯ token è·å–å’Œæºå¸¦

**å…³é”®æ–¹æ³•ï¼š**
- `getBackendToken()` - è·å–åç«¯ JWT tokenï¼ˆä½¿ç”¨ session email + é…ç½®çš„å¯†ç ï¼‰
- `callBackendAPI()` - è°ƒç”¨åç«¯ APIï¼ˆè‡ªåŠ¨æºå¸¦è®¤è¯ï¼‰
- `getCurrentUserInfo()` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆè°ƒç”¨ `/me` æ¥å£ï¼‰

### 2. `èº«ä»½è®¤è¯é“¾è·¯å®ç°æ€»ç»“.md`
**åŠŸèƒ½ï¼š** è¯¦ç»†çš„å®ç°æ–‡æ¡£å’ŒéªŒè¯æ­¥éª¤

### 3. `ç¯å¢ƒå˜é‡é…ç½®æ¸…å•.md`
**åŠŸèƒ½ï¼š** å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—

### 4. `èº«ä»½è®¤è¯é“¾è·¯-æ–‡ä»¶å˜æ›´æ¸…å•.md`ï¼ˆæœ¬æ–‡ä»¶ï¼‰
**åŠŸèƒ½ï¼š** æ–‡ä»¶å˜æ›´æ¸…å•

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### å‰ç«¯æ–‡ä»¶

#### 1. `middleware.ts`
**å˜æ›´ï¼š**
- âœ… å¢åŠ  `/dream-factory` è·¯ç”±ä¿æŠ¤
- âœ… æœªç™»å½•è‡ªåŠ¨è·³è½¬åˆ° `/auth/login`

**å…³é”®ä»£ç ï¼š**
```typescript
// ä¿æŠ¤ /admin å’Œ /dream-factory è·¯ç”±
if (pathname.startsWith('/admin') || pathname.startsWith('/dream-factory')) {
  const isAuthenticated = !!req.auth;
  if (!isAuthenticated) {
    const loginUrl = new URL('/auth/login', req.url);
    loginUrl.searchParams.set('callbackUrl', pathname);
    return NextResponse.redirect(loginUrl);
  }
}
```

#### 2. `app/api/ai/generate-text/route.ts`
**å˜æ›´ï¼š**
- âœ… å¢åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ˆæœªç™»å½•è¿”å› 401ï¼‰
- âœ… ä½¿ç”¨ `callBackendAPI` è°ƒç”¨åç«¯ï¼ˆè‡ªåŠ¨æºå¸¦è®¤è¯ï¼‰
- âœ… ç§»é™¤æ—§çš„ `getBackendToken` å‡½æ•°

**å…³é”®ä»£ç ï¼š**
```typescript
// âœ… æ£€æŸ¥ç™»å½•çŠ¶æ€
const session = await getSession();
if (!session?.user?.email) {
  return NextResponse.json(
    { message: 'æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•' },
    { status: 401 }
  );
}

// è°ƒç”¨åç«¯APIï¼ˆè‡ªåŠ¨æºå¸¦è®¤è¯ï¼‰
const backendResult = await callBackendAPI('/ai/generate-text', {
  method: 'POST',
  body: JSON.stringify(backendRequestBody),
});
```

#### 3. `app/api/ai/generate-image/route.ts`
**å˜æ›´ï¼š**
- âœ… å¢åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ˆæœªç™»å½•è¿”å› 401ï¼‰

**å…³é”®ä»£ç ï¼š**
```typescript
const session = await getSession();
if (!session?.user?.email) {
  return NextResponse.json(
    { message: 'æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•' },
    { status: 401 }
  );
}
```

#### 4. `app/api/ai/generate-job/route.ts`
**å˜æ›´ï¼š**
- âœ… å¢åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ˆæœªç™»å½•è¿”å› 401ï¼‰

#### 5. `app/dream-factory/page.tsx`
**å˜æ›´ï¼š**
- âœ… å¢åŠ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼ˆå³ä¸Šè§’ï¼‰
- âœ… è°ƒç”¨ `/me` æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… æ˜¾ç¤ºä½™é¢å’Œæ¨¡å¼ï¼ˆDRY_RUN/REALï¼‰
- âœ… é€€å‡ºç™»å½•æŒ‰é’®

**å…³é”®ä»£ç ï¼š**
```typescript
// ç”¨æˆ·ä¿¡æ¯çŠ¶æ€
const [userInfo, setUserInfo] = useState<{
  userId: string;
  email: string;
  balance: number;
  billingMode: 'DRY_RUN' | 'REAL';
  modelMode: 'DRY_RUN' | 'REAL';
} | null>(null);

// åŠ è½½ç”¨æˆ·ä¿¡æ¯
useEffect(() => {
  if (session?.user?.email) {
    getCurrentUserInfo()
      .then(setUserInfo)
      .catch((err) => {
        console.error('[Dream Factory] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
      });
  }
}, [session]);
```

#### 6. `lib/auth-config.ts`
**å˜æ›´ï¼š**
- âœ… æ”¯æŒ email æ ¼å¼çš„ç”¨æˆ·å
- âœ… è‡ªåŠ¨ç”Ÿæˆ emailï¼ˆå¦‚æœ username ä¸åŒ…å« @ï¼‰

**å…³é”®ä»£ç ï¼š**
```typescript
function getAdminUsers(): Array<{ username: string; password: string; email?: string }> {
  // ...
  return usersEnv.split(',').map((user) => {
    const [username, password] = user.split(':');
    const usernameTrimmed = username.trim();
    const email = usernameTrimmed.includes('@') 
      ? usernameTrimmed 
      : `${usernameTrimmed}@admin.local`;
    return { 
      username: usernameTrimmed, 
      password: password.trim(),
      email,
    };
  });
}
```

### åç«¯æ–‡ä»¶

#### 7. `backend-api/src/auth/auth.controller.ts`
**å˜æ›´ï¼š**
- âœ… æ–°å¢ `MeController` ç±»
- âœ… æ–°å¢ `/me` æ¥å£
- âœ… è¿”å›ç”¨æˆ·ä¿¡æ¯ã€ä½™é¢ã€æ¨¡å¼ä¿¡æ¯

**å…³é”®ä»£ç ï¼š**
```typescript
@Controller()
@UseGuards(AuthGuard)
export class MeController {
  @Get('me')
  async getMe(@CurrentUser() user: { userId: string; email: string }) {
    const balanceResult = await this.creditsService.getBalance(user.userId);
    
    // åˆ¤æ–­æ¨¡å¼ï¼ˆæ ¹æ®ç¯å¢ƒå˜é‡ï¼‰
    const modelEnabled = process.env.MODEL_ENABLED !== 'false';
    const billingEnabled = process.env.BILLING_ENABLED !== 'false';
    
    // å¯ä»¥æ ¹æ®ç”¨æˆ·ç™½åå•è¦†ç›–æ¨¡å¼
    const realModeUsers = process.env.REAL_MODE_USERS || '';
    let finalModelMode: 'DRY_RUN' | 'REAL' = modelEnabled ? 'REAL' : 'DRY_RUN';
    let finalBillingMode: 'DRY_RUN' | 'REAL' = billingEnabled ? 'REAL' : 'DRY_RUN';
    
    if (realModeUsers && realModeUsers.split(',').includes(user.email)) {
      finalModelMode = 'REAL';
      finalBillingMode = 'REAL';
    }
    
    return {
      userId: user.userId,
      email: user.email,
      balance: balanceResult.balance,
      billingMode: finalBillingMode,
      modelMode: finalModelMode,
    };
  }
}
```

#### 8. `backend-api/src/auth/auth.module.ts`
**å˜æ›´ï¼š**
- âœ… å¯¼å…¥ `CreditsModule`
- âœ… æ³¨å†Œ `MeController`

**å…³é”®ä»£ç ï¼š**
```typescript
@Module({
  imports: [CreditsModule],
  controllers: [AuthController, MeController],
  providers: [AuthService],
  exports: [AuthService],
})
export class AuthModule {}
```

---

## ğŸ”§ ç¯å¢ƒå˜é‡å˜æ›´

### å‰ç«¯æ–°å¢ç¯å¢ƒå˜é‡

```env
# åç«¯ç™»å½•å¯†ç ï¼ˆç”¨äºè·å–åç«¯ tokenï¼‰
BACKEND_TEST_PASSWORD=test123
```

### åç«¯æ–°å¢ç¯å¢ƒå˜é‡

```env
# çœŸå®æ¨¡å¼ç”¨æˆ·ç™½åå•ï¼ˆå¯é€‰ï¼‰
REAL_MODE_USERS=admin@factory-buy.com
```

---

## ğŸ“Š å˜æ›´ç»Ÿè®¡

- **æ–°å¢æ–‡ä»¶ï¼š** 4 ä¸ª
- **ä¿®æ”¹æ–‡ä»¶ï¼š** 8 ä¸ª
- **æ–°å¢æ¥å£ï¼š** 1 ä¸ªï¼ˆ`/me`ï¼‰
- **ä¿æŠ¤è·¯ç”±ï¼š** 1 ä¸ªï¼ˆ`/dream-factory`ï¼‰
- **ä¿æŠ¤ APIï¼š** 3 ä¸ªï¼ˆ`/api/ai/generate-text`, `/api/ai/generate-image`, `/api/ai/generate-job`ï¼‰

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯

- [x] `/dream-factory` è·¯ç”±ä¿æŠ¤ï¼ˆæœªç™»å½•è·³è½¬ç™»å½•é¡µï¼‰
- [x] ç™»å½•åè‡ªåŠ¨è·³è½¬å›åŸé¡µé¢
- [x] å‰ç«¯ç”Ÿæˆæ¥å£éœ€è¦ç™»å½•ï¼ˆ401 ä¿æŠ¤ï¼‰
- [x] åç«¯ `/me` æ¥å£è¿”å›ç”¨æˆ·ä¿¡æ¯
- [x] å‰ç«¯æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå³ä¸Šè§’ï¼‰
- [x] å‰ç«¯æ˜¾ç¤ºä½™é¢å’Œæ¨¡å¼
- [x] åç«¯è‡ªåŠ¨è¯†åˆ« userIdï¼ˆä» token è§£æï¼‰
- [x] Dry Run æ¨¡å¼æ­£å¸¸å·¥ä½œ

### é…ç½®éªŒè¯

- [x] å‰ç«¯ `NEXTAUTH_SECRET` ä¸åç«¯ `JWT_SECRET` ç›¸åŒ
- [x] å‰ç«¯ `ADMIN_USERS` å¯†ç ä¸åç«¯ `USER_WHITELIST` åŒ¹é…
- [x] åç«¯ `MODEL_ENABLED=false` å’Œ `BILLING_ENABLED=false` é…ç½®æ­£ç¡®

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å‰ç«¯éƒ¨ç½²ï¼ˆVercelï¼‰

1. åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­æ·»åŠ ï¼š
   - `NEXTAUTH_SECRET`
   - `ADMIN_USERS`
   - `BACKEND_TEST_PASSWORD`
   - `NEXT_PUBLIC_BACKEND_API_URL`

2. é‡æ–°éƒ¨ç½²

### 2. åç«¯éƒ¨ç½²ï¼ˆæœåŠ¡å™¨ï¼‰

1. åœ¨æœåŠ¡å™¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
   - `JWT_SECRET`ï¼ˆä¸å‰ç«¯ç›¸åŒï¼‰
   - `USER_WHITELIST`ï¼ˆå¯†ç ä¸å‰ç«¯åŒ¹é…ï¼‰
   - `MODEL_ENABLED=false`
   - `BILLING_ENABLED=false`

2. é‡å¯æœåŠ¡ï¼š
   ```bash
   pm2 restart ue-assets-backend --update-env
   ```

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•è·¯ç”±ä¿æŠ¤

```bash
# è®¿é—® /dream-factoryï¼ˆæœªç™»å½•ï¼‰
curl -I http://localhost:3000/dream-factory
# åº”è¯¥è¿”å› 302 é‡å®šå‘åˆ° /auth/login
```

### 2. æµ‹è¯• API è®¤è¯

```bash
# æœªç™»å½•è°ƒç”¨ç”Ÿæˆæ¥å£
curl -X POST http://localhost:3000/api/ai/generate-text \
  -H "Content-Type: application/json" \
  -d '{"prompt":"æµ‹è¯•"}'
# åº”è¯¥è¿”å› 401
```

### 3. æµ‹è¯• /me æ¥å£

```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"test123"}' \
  | jq -r '.token')

# 2. è°ƒç”¨ /me æ¥å£
curl https://api.factory-buy.com/me \
  -H "Authorization: Bearer $TOKEN" | jq .
```

---

## âœ… å®ŒæˆçŠ¶æ€

æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼ğŸ‰


