# M5 部署和测试指南

## ✅ 代码已推送

**提交信息：** `feat: M5完成 - 用户管理UI、设置页面、后端登录修复`

**包含的变更：**
- 前端：M5 用户管理 UI、设置页面、dashboard 增强
- 后端：登录逻辑修复、用户列表、交易记录、管理员充值接口
- 修复：构建错误、类型错误

---

## 🚀 部署步骤

### 1. 前端部署（Vercel）

**自动部署：**
- ✅ 如果配置了 GitHub webhook，Vercel 会自动部署
- ⏱️ 预计 2-5 分钟完成

**手动部署（如果需要）：**
1. 访问 Vercel Dashboard
2. 选择项目
3. 点击 "Redeploy"

**验证部署：**
- 访问你的 Vercel 域名
- 检查 `/dashboard`、`/settings`、`/admin/users` 页面

---

### 2. 后端部署（服务器）

**自动部署：**
- ✅ GitHub Actions 会自动检测 `backend-api/` 目录的变更
- ✅ 如果检测到变更，会自动部署到 ECS 服务器
- ⏱️ 预计 3-5 分钟完成

**手动部署（如果需要）：**

```bash
# SSH 连接到服务器
ssh root@YOUR_SERVER_IP

# 进入后端目录
cd /opt/ue-assets-backend/backend-api

# 拉取最新代码
git pull origin main

# 安装依赖（如果需要）
npm install --production

# 构建
npm run build

# 重启服务
pm2 restart ue-assets-backend --update-env

# 查看日志
pm2 logs ue-assets-backend --lines 20
```

**验证部署：**
```bash
# 检查服务状态
pm2 status

# 检查健康检查接口
curl http://localhost:3001/health

# 检查登录接口（需要正确的 USER_WHITELIST）
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"YOUR_PASSWORD"}'
```

---

## 🧪 测试步骤

### 1. 测试后端登录修复

**问题：** 之前后端登录失败（401 错误）

**修复：** 修改了 `backend-api/src/auth/auth.service.ts`，现在无论 `isAdmin` 是否为 true，都会先检查白名单

**测试：**
1. 访问前端页面（`/dashboard` 或 `/settings`）
2. 检查浏览器控制台，应该不再有登录失败的错误
3. 检查用户信息是否正确显示

---

### 2. 测试 `/dashboard` 页面

**访问：** `https://YOUR_VERCEL_DOMAIN/dashboard`

**检查项：**
- [ ] 页面正常加载
- [ ] 积分余额正确显示
- [ ] 计费模式显示正确（DRY_RUN/REAL）
- [ ] 模型模式显示正确（DRY_RUN/REAL）
- [ ] 用户 ID 正确显示
- [ ] "设置" 按钮可以点击
- [ ] "登出" 按钮可以点击

---

### 3. 测试 `/settings` 页面

**访问：** `https://YOUR_VERCEL_DOMAIN/settings`

**检查项：**
- [ ] 页面正常加载
- [ ] 个人信息卡片显示正确（邮箱、用户 ID）
- [ ] 积分信息卡片显示正确（余额、计费模式、模型模式）
- [ ] 交易记录表格显示（如果有交易记录）
- [ ] "刷新" 按钮可以点击
- [ ] "返回" 按钮可以点击

---

### 4. 测试 `/admin/users` 页面

**访问：** `https://YOUR_VERCEL_DOMAIN/admin/users`

**检查项：**
- [ ] 页面正常加载
- [ ] 用户列表正确显示（至少显示当前登录用户）
- [ ] 搜索功能正常（输入邮箱或姓名，列表过滤）
- [ ] 点击用户，右侧显示用户详情
- [ ] 用户详情显示正确（邮箱、姓名、用户 ID、积分余额、创建时间）
- [ ] 交易记录显示（如果有）
- [ ] 充值功能测试：
  - [ ] 输入充值金额（如 100）
  - [ ] 点击"充值"按钮
  - [ ] 显示成功提示
  - [ ] 用户余额更新
  - [ ] 交易记录更新

---

## 🔧 如果遇到问题

### 问题 1：后端登录仍然失败

**检查：**
1. 后端服务是否已重启（`pm2 restart ue-assets-backend`）
2. 后端 `.env` 文件中的 `USER_WHITELIST` 是否包含 `test@factory-buy.com:密码`
3. 前端 `.env.local` 文件中的 `BACKEND_TEST_PASSWORD` 是否与后端密码匹配
4. 后端日志是否有错误（`pm2 logs ue-assets-backend`）

---

### 问题 2：用户列表为空

**检查：**
1. 后端服务是否运行（`pm2 status`）
2. 数据库连接是否正常
3. 后端 `/users/list` 接口是否可用
4. 后端日志是否有错误

---

### 问题 3：交易记录为空

**检查：**
1. 用户是否有交易记录（可以先进行一次充值或消费操作）
2. 后端 `/credits/transactions` 接口是否可用
3. 数据库 `credit_transactions` 表是否有数据

---

### 问题 4：充值功能失败

**检查：**
1. 后端服务是否运行
2. 后端 `/credits/admin/recharge` 接口是否可用
3. 后端日志是否有错误
4. 网络请求是否成功（浏览器 Network 标签）

---

## 📝 相关文档

- [M5 完成总结](./docs/ops/M5_COMPLETION_SUMMARY.md)
- [M5 快速测试清单](./docs/ops/M5_快速测试清单.md)
- [M5 测试问题修复](./M5测试问题修复.md)

---

**部署完成后，可以开始测试！** ✅

