# æ¶æ„å®ç°æ€»ç»“

## ğŸ“ æ–‡ä»¶ç»“æ„

### Next.js å‰ç«¯ï¼ˆVercelï¼‰

```
web/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ ai/
â”‚   â”‚       â””â”€â”€ generate-job/
â”‚   â”‚           â””â”€â”€ route.ts          # âœ… ä¿®æ”¹ï¼šè°ƒç”¨å‰æ‰£ç§¯åˆ†
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ login/
â”‚   â”‚       â””â”€â”€ page.tsx              # âœ… ä¿®æ”¹ï¼šæ”¯æŒé‚®ç®±+å¯†ç 
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ page.tsx                  # âœ… æ–°å¢ï¼šç”¨æˆ·ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ dream-factory/
â”‚   â”‚   â””â”€â”€ page.tsx                  # å·²å­˜åœ¨
â”‚   â””â”€â”€ middleware.ts                 # âœ… ä¿®æ”¹ï¼šä¿æŠ¤è·¯ç”±
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth-config.ts                # âœ… ä¿®æ”¹ï¼šæ”¯æŒé‚®ç®±+å¯†ç ï¼Œåç«¯éªŒè¯
â”‚   â”œâ”€â”€ backend-client.ts             # âœ… æ–°å¢ï¼šåç«¯ API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ oss-client.ts                 # âœ… ä¿®æ”¹ï¼šæ”¯æŒ userId è·¯å¾„éš”ç¦»
â”œâ”€â”€ types/
â”‚   â””â”€â”€ backend.d.ts                  # âœ… æ–°å¢ï¼šåç«¯ API ç±»å‹å®šä¹‰
â””â”€â”€ lib/ai/
    â”œâ”€â”€ types.ts                      # âœ… ä¿®æ”¹ï¼šæ·»åŠ  userId å­—æ®µ
    â””â”€â”€ providers/
        â””â”€â”€ jimeng-provider.ts        # âœ… ä¿®æ”¹ï¼šä½¿ç”¨ç”¨æˆ·éš”ç¦»è·¯å¾„
```

### ECS åç«¯ API

```
backend-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                       # âœ… å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ app.module.ts                 # âœ… æ ¹æ¨¡å—
â”‚   â”œâ”€â”€ auth/                         # âœ… è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â””â”€â”€ auth.module.ts
â”‚   â”œâ”€â”€ credits/                      # âœ… ç§¯åˆ†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ credits.controller.ts
â”‚   â”‚   â”œâ”€â”€ credits.service.ts
â”‚   â”‚   â”œâ”€â”€ auth.guard.ts
â”‚   â”‚   â””â”€â”€ credits.module.ts
â”‚   â”œâ”€â”€ logs/                         # âœ… æ—¥å¿—æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ logs.controller.ts
â”‚   â”‚   â”œâ”€â”€ logs.service.ts
â”‚   â”‚   â””â”€â”€ logs.module.ts
â”‚   â””â”€â”€ health/                       # âœ… å¥åº·æ£€æŸ¥
â”‚       â”œâ”€â”€ health.controller.ts
â”‚       â””â”€â”€ health.module.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### 1. è®¤è¯ç³»ç»Ÿ

- **NextAuth é…ç½®**: `lib/auth-config.ts`
  - æ”¯æŒé‚®ç®±+å¯†ç ç™»å½•
  - æ”¯æŒç¯å¢ƒå˜é‡ç™½åå•
  - æ”¯æŒåç«¯ API éªŒè¯

- **ç™»å½•é¡µé¢**: `app/auth/login/page.tsx`
  - é‚®ç®±+å¯†ç è¾“å…¥
  - è‡ªåŠ¨è¯†åˆ«ç®¡ç†å‘˜/æ™®é€šç”¨æˆ·è·¯ç”±

- **è·¯ç”±ä¿æŠ¤**: `middleware.ts`
  - ä¿æŠ¤ `/dream-factory` å’Œ `/dashboard`
  - æœªç™»å½•è‡ªåŠ¨è·³è½¬ `/auth/login`

### 2. ç§¯åˆ†ç³»ç»Ÿ

- **ç§¯åˆ†æ‰£é™¤**: `app/api/ai/generate-job/route.ts`
  - è°ƒç”¨å³æ¢¦ API å‰å…ˆæ‰£ç§¯åˆ†
  - ç§¯åˆ†ä¸è¶³è¿”å› 402 é”™è¯¯
  - è®°å½•æ—¥å¿—

- **åç«¯å®¢æˆ·ç«¯**: `lib/backend-client.ts`
  - ç»Ÿä¸€çš„ API è°ƒç”¨æ¥å£
  - é”™è¯¯å¤„ç†

### 3. OSS è·¯å¾„éš”ç¦»

- **ç”¨æˆ·è·¯å¾„**: `lib/oss-client.ts`
  - `getUserOSSPath()`: ç”Ÿæˆç”¨æˆ·éš”ç¦»è·¯å¾„
  - `uploadToUserPath()`: ä¸Šä¼ åˆ°ç”¨æˆ·è·¯å¾„
  - æ ¼å¼: `users/{userId}/...`

- **å³æ¢¦ Provider**: `lib/ai/providers/jimeng-provider.ts`
  - ä½¿ç”¨ç”¨æˆ·éš”ç¦»è·¯å¾„ä¸Šä¼ å›¾ç‰‡

## ğŸ“ API æ¥å£

### åç«¯ APIï¼ˆECSï¼‰

| æ¥å£ | æ–¹æ³• | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ | å¦ |
| `/auth/login` | POST | ç”¨æˆ·ç™»å½• | å¦ |
| `/auth/verify` | POST | éªŒè¯ Token | å¦ |
| `/credits/balance` | GET | è·å–ç§¯åˆ†ä½™é¢ | æ˜¯ |
| `/credits/consume` | POST | æ¶ˆè´¹ç§¯åˆ† | æ˜¯ |
| `/logs/create` | POST | åˆ›å»ºæ—¥å¿— | æ˜¯ |

### Next.js APIï¼ˆVercelï¼‰

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/ai/generate-job` | POST | AI ç”Ÿæˆä»»åŠ¡ï¼ˆå·²é›†æˆç§¯åˆ†æ‰£é™¤ï¼‰ |
| `/api/auth/[...nextauth]` | GET/POST | NextAuth è®¤è¯ |

## ğŸ” è®¤è¯æµç¨‹

```
1. ç”¨æˆ·è®¿é—® /dream-factory
   â†“
2. middleware.ts æ£€æŸ¥ç™»å½•çŠ¶æ€
   â†“
3. æœªç™»å½• â†’ è·³è½¬ /auth/login
   â†“
4. ç”¨æˆ·è¾“å…¥é‚®ç®±+å¯†ç 
   â†“
5. NextAuth éªŒè¯ï¼ˆç¯å¢ƒå˜é‡æˆ–åç«¯ APIï¼‰
   â†“
6. ç™»å½•æˆåŠŸ â†’ è·³è½¬å› /dream-factory
   â†“
7. Session å­˜å‚¨åœ¨ JWT Token ä¸­
```

## ğŸ’° ç§¯åˆ†æ‰£é™¤æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç”Ÿæˆè§†é¢‘
   â†“
2. å‰ç«¯è°ƒç”¨ /api/ai/generate-job
   â†“
3. åç«¯éªŒè¯ç”¨æˆ·ç™»å½•
   â†“
4. è°ƒç”¨åç«¯ /credits/balance æ£€æŸ¥ä½™é¢
   â†“
5. è°ƒç”¨åç«¯ /credits/consume æ‰£ç§¯åˆ†
   â†“
6. ç§¯åˆ†ä¸è¶³ â†’ è¿”å› 402 é”™è¯¯
   â†“
7. ç§¯åˆ†è¶³å¤Ÿ â†’ ç»§ç»­è°ƒç”¨å³æ¢¦ API
   â†“
8. è®°å½•æ—¥å¿—åˆ°åç«¯ /logs/create
```

## ğŸ“¦ OSS è·¯å¾„ç»“æ„

```
OSS Bucket/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ user1@example.com/
â”‚   â”‚   â”œâ”€â”€ jimeng-video-ref-xxx.jpg
â”‚   â”‚   â””â”€â”€ project-xxx/
â”‚   â””â”€â”€ user2@example.com/
â”‚       â””â”€â”€ ...
â””â”€â”€ temp/  (æ—§è·¯å¾„ï¼Œå…¼å®¹)
```

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### Vercel éƒ¨ç½²

- [ ] ä»£ç å·²æ¨é€åˆ° Git ä»“åº“
- [ ] Vercel é¡¹ç›®å·²åˆ›å»ºå¹¶è¿æ¥ä»“åº“
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆå‚è€ƒ `ENV_VARIABLES.md`ï¼‰
- [ ] éƒ¨ç½²æˆåŠŸï¼ŒåŸŸåå¯è®¿é—®
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸

### ECS éƒ¨ç½²

- [ ] Node.js å·²å®‰è£…ï¼ˆv20+ï¼‰
- [ ] ä»£ç å·²ä¸Šä¼ åˆ° ECS
- [ ] ä¾èµ–å·²å®‰è£…ï¼ˆ`npm install --production`ï¼‰
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆ`.env` æ–‡ä»¶ï¼‰
- [ ] PM2 å·²å®‰è£…å¹¶è¿è¡ŒæœåŠ¡
- [ ] Nginx å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] å¥åº·æ£€æŸ¥æ¥å£å¯è®¿é—®

### æµ‹è¯•

- [ ] åç«¯ `/health` æ¥å£æ­£å¸¸
- [ ] å‰ç«¯å¯ä»¥è¿æ¥åç«¯
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ç§¯åˆ†æ‰£é™¤åŠŸèƒ½æ­£å¸¸
- [ ] å³æ¢¦ API è°ƒç”¨æ­£å¸¸
- [ ] OSS æ–‡ä»¶ä¸Šä¼ åˆ°ç”¨æˆ·è·¯å¾„

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `ENV_VARIABLES.md` - ç¯å¢ƒå˜é‡æ¸…å•
- `BACKEND_API_SETUP.md` - åç«¯ API é…ç½®æŒ‡å—
- `DEPLOYMENT_GUIDE.md` - å®Œæ•´éƒ¨ç½²æŒ‡å—
- `AUTH_SETUP.md` - è®¤è¯é…ç½®æŒ‡å—ï¼ˆå·²æœ‰ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **JWT å¯†é’¥ä¸€è‡´æ€§**ï¼šVercel å’Œ ECS çš„ `JWT_SECRET` æˆ– `NEXTAUTH_SECRET` å¿…é¡»ä¸€è‡´
2. **CORS é…ç½®**ï¼šåç«¯å¿…é¡»å…è®¸å‰ç«¯åŸŸåè®¿é—®
3. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
4. **Token ä¼ é€’**ï¼šç›®å‰ NextAuth session ä¸åŒ…å«åç«¯ tokenï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
5. **æ•°æ®æŒä¹…åŒ–**ï¼šå½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ•°æ®åº“

