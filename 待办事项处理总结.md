# 待办事项处理总结

**处理时间：** 2025-12-15  
**状态：** 部分完成

---

## ✅ 已完成

### 1. 数据库迁移脚本 ✅

**文件：**
- `backend-api/src/database/migrations/add-user-mode-fields.sql` - SQL 迁移脚本
- `backend-api/scripts/run-migration.sh` - 执行脚本

**功能：**
- 为 User 实体添加 `billingMode` 和 `modelMode` 字段
- 设置默认值（DRY_RUN）
- 添加约束检查
- 支持开发和生产环境

**使用方法：**
```bash
cd backend-api
./scripts/run-migration.sh
```

---

### 2. M5.1: 生成产物存储策略完善 🔄

**已完成：**
- ✅ 修改前端 `generate-image` 路由，确保生成的图片都通过后端上传到 OSS
- ✅ 如果前端生成图片，会自动调用后端接口上传到 OSS
- ✅ 返回 OSS URL 而不是原始 URL

**待完成：**
- ⏳ 视频生成流程也需要类似处理
- ⏳ 验证所有 API 响应只返回 OSS URL

---

## 📋 待处理事项

### 3. 管理员权限检查系统 ⏳

**需要添加权限检查的接口：**
- `GET /users/list` - 用户列表
- `POST /users/update-mode` - 更新用户模式
- `POST /credits/admin/recharge` - 管理员充值

**实现方案：**
1. 创建 `AdminGuard` 装饰器
2. 检查用户是否在管理员白名单中（`ADMIN_USERS` 环境变量）
3. 或添加 `isAdmin` 字段到 User 实体

**预计时间：** 1-2 天

---

### 4. M5.1: Cron 任务清理临时文件（可选）⏳

**实现方案：**
1. 使用 `@nestjs/schedule` 模块
2. 每天凌晨执行清理任务
3. 清理 24 小时前的临时文件

**预计时间：** 0.5 天

---

### 5. M5.1: 服务器端数据层迁移 ⏳

**目标：** 将 Dream Factory 项目数据从 localStorage 迁移到服务器端

**实施步骤：**
1. 创建 Project 实体
2. 创建 Projects Service 和 Controller
3. 创建前端 API 路由
4. 修改 project-storage.ts，支持后端存储
5. 实现数据迁移功能

**预计时间：** 3-4 天

---

## 🎯 优先级建议

1. **高优先级：**
   - ✅ 数据库迁移脚本（已完成）
   - 🔄 M5.1 生成产物存储策略完善（进行中）
   - ⏳ 管理员权限检查系统

2. **中优先级：**
   - ⏳ Cron 任务清理临时文件
   - ⏳ 服务器端数据层迁移

---

## 📝 下一步行动

1. **立即执行：**
   - 在生产环境运行数据库迁移脚本
   - 测试图片生成流程，确保都上传到 OSS

2. **短期（1-2 周）：**
   - 完成管理员权限检查系统
   - 完善视频生成流程的 OSS 上传
   - 添加 Cron 任务清理临时文件

3. **中期（2-4 周）：**
   - 完成服务器端数据层迁移
   - 实现跨设备同步功能

---

**处理完成度：** 2/6 (33.3%)

