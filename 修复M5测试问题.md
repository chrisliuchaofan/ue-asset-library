# ä¿®å¤ M5 æµ‹è¯•é—®é¢˜

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1ï¼š/admin/users é¡µé¢ 500 é”™è¯¯

**ç°è±¡ï¼š**
- `/api/users/list` è¿”å› 500 é”™è¯¯
- ç”¨æˆ·åˆ—è¡¨ä¸ºç©º

**å¯èƒ½åŸå› ï¼š**
1. åç«¯ `/users/list` æ¥å£æœ‰é—®é¢˜
2. æ•°æ®åº“è¿æ¥é—®é¢˜
3. UsersService.findAll() æ–¹æ³•æœ‰é—®é¢˜

---

### é—®é¢˜ 2ï¼šç™»å½•ç³»ç»Ÿæ··ä¹±

**ç°è±¡ï¼š**
- ä½¿ç”¨ `admin` å’Œ `admin123` å¯ä»¥ç™»å½•
- è¿™æ˜¯ä¹‹å‰æ²¡æœ‰æœåŠ¡å™¨æ—¶çš„æœ¬åœ°è®¤è¯è´¦å·
- ç°åœ¨åº”è¯¥ä½¿ç”¨åç«¯æ•°æ®åº“ç”¨æˆ·ç³»ç»Ÿ

**é—®é¢˜åˆ†æï¼š**
å½“å‰æœ‰ä¸¤ä¸ªè®¤è¯ç³»ç»Ÿï¼š
1. **å‰ç«¯ NextAuth**ï¼šä½¿ç”¨ `ADMIN_USERS` ç¯å¢ƒå˜é‡ï¼ˆæ—§çš„æœ¬åœ°è®¤è¯ï¼‰
2. **åç«¯ç”¨æˆ·ç³»ç»Ÿ**ï¼šä½¿ç”¨æ•°æ®åº“ + `USER_WHITELIST`ï¼ˆæ–°çš„æœåŠ¡å™¨ç«¯è®¤è¯ï¼‰

**è¿™å¯¼è‡´çš„é—®é¢˜ï¼š**
- å‰ç«¯å¯ä»¥ç™»å½•ï¼Œä½†åç«¯å¯èƒ½æ²¡æœ‰å¯¹åº”çš„ç”¨æˆ·
- ç”¨æˆ·èº«ä»½ä¸ä¸€è‡´
- æ•°æ®æ··ä¹±

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç»Ÿä¸€è®¤è¯ç³»ç»Ÿï¼ˆæ¨èï¼‰

**ç›®æ ‡ï¼š** å‰ç«¯ NextAuth è°ƒç”¨åç«¯ç™»å½•æ¥å£

**æ­¥éª¤ï¼š**
1. ä¿®æ”¹ `lib/auth-config.ts`ï¼Œè®© NextAuth çš„ `authorize` å‡½æ•°è°ƒç”¨åç«¯ `/auth/login` æ¥å£
2. ç§»é™¤ `ADMIN_USERS` çš„æœ¬åœ°è®¤è¯é€»è¾‘
3. ç¡®ä¿åç«¯ `USER_WHITELIST` åŒ…å«æ‰€æœ‰éœ€è¦ç™»å½•çš„ç”¨æˆ·

**ä¼˜ç‚¹ï¼š**
- å•ä¸€è®¤è¯æ¥æºï¼ˆåç«¯æ•°æ®åº“ï¼‰
- ç”¨æˆ·èº«ä»½ä¸€è‡´
- æ•°æ®æ¸…æ™°

---

### æ–¹æ¡ˆ 2ï¼šå…ˆä¿®å¤ 500 é”™è¯¯ï¼Œå†ç»Ÿä¸€è®¤è¯

**æ­¥éª¤ï¼š**
1. å…ˆä¿®å¤ `/users/list` çš„ 500 é”™è¯¯
2. ç„¶åç»Ÿä¸€è®¤è¯ç³»ç»Ÿ

---

## ğŸš€ ç«‹å³ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥åç«¯æ—¥å¿—

**åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š**
```bash
pm2 logs ue-assets-backend --lines 50
```

**æŸ¥æ‰¾ï¼š**
- `/users/list` ç›¸å…³çš„é”™è¯¯
- æ•°æ®åº“è¿æ¥é”™è¯¯
- UsersService çš„é”™è¯¯

---

### æ­¥éª¤ 2ï¼šæµ‹è¯•åç«¯æ¥å£

**ç›´æ¥æµ‹è¯•åç«¯ï¼š**
```bash
# 1. å…ˆç™»å½•è·å– token
curl -X POST http://YOUR_BACKEND_URL/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"YOUR_PASSWORD"}'

# 2. ä½¿ç”¨ token è·å–ç”¨æˆ·åˆ—è¡¨
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://YOUR_BACKEND_URL/users/list
```

---

### æ­¥éª¤ 3ï¼šä¿®å¤è®¤è¯ç³»ç»Ÿ

**ä¿®æ”¹ `lib/auth-config.ts`ï¼š**

```typescript
async authorize(credentials) {
  if (!credentials?.username || !credentials?.password) {
    return null;
  }

  // è°ƒç”¨åç«¯ç™»å½•æ¥å£
  try {
    const backendUrl = process.env.BACKEND_API_URL || process.env.NEXT_PUBLIC_BACKEND_API_URL;
    const response = await fetch(`${backendUrl}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: credentials.username,
        password: credentials.password,
      }),
    });

    if (!response.ok) {
      return null;
    }

    const data = await response.json();
    
    return {
      id: data.userId || data.user?.id || credentials.username,
      name: data.name || data.user?.name || credentials.username,
      email: data.email || data.user?.email || `${credentials.username}@admin.local`,
    };
  } catch (error) {
    console.error('[Auth] åç«¯ç™»å½•å¤±è´¥:', error);
    return null;
  }
}
```

---

## ğŸ“ å¾…åŠäº‹é¡¹

1. [ ] æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œå®šä½ 500 é”™è¯¯
2. [ ] ä¿®å¤ `/users/list` æ¥å£
3. [ ] ç»Ÿä¸€è®¤è¯ç³»ç»Ÿï¼ˆå‰ç«¯è°ƒç”¨åç«¯ç™»å½•ï¼‰
4. [ ] ç¡®ä¿åç«¯ `USER_WHITELIST` é…ç½®æ­£ç¡®
5. [ ] æµ‹è¯•ç™»å½•å’Œç”¨æˆ·ç®¡ç†åŠŸèƒ½

---

## âš ï¸ é‡è¦æç¤º

**åœ¨ç»Ÿä¸€è®¤è¯ç³»ç»Ÿä¹‹å‰ï¼š**
- ç¡®ä¿åç«¯ `USER_WHITELIST` åŒ…å«æ‰€æœ‰éœ€è¦ç™»å½•çš„ç”¨æˆ·
- ç¡®ä¿åç«¯æ•°æ®åº“ä¸­æœ‰å¯¹åº”çš„ç”¨æˆ·è®°å½•
- ç¡®ä¿ `BACKEND_TEST_EMAIL` å’Œ `BACKEND_TEST_PASSWORD` ä¸ `USER_WHITELIST` åŒ¹é…







