# 🔧 登录功能失效 - 小白修复指南（超详细版）

> **说明**：这是专门为小白用户准备的详细修复指南，每一步都有详细说明和截图指引。

---

## 📋 目录

1. [问题是什么？](#问题是什么)
2. [修复步骤总览](#修复步骤总览)
3. [第一步：修复后端代码（已完成✅）](#第一步修复后端代码已完成)
4. [第二步：配置 Vercel 环境变量](#第二步配置-vercel-环境变量)
5. [第三步：配置服务器环境变量](#第三步配置服务器环境变量)
6. [第四步：测试登录功能](#第四步测试登录功能)
7. [常见问题排查](#常见问题排查)

---

## 问题是什么？

**简单来说**：你的网站部署在 Vercel（前端），后端运行在 ECS 服务器上。当用户点击登录时，前端无法连接到后端，导致登录失败。

**为什么会这样？**
1. **跨域问题**：Vercel 的域名不在后端允许的域名列表中
2. **HTTPS/HTTP 混用**：Vercel 强制 HTTPS，但后端可能是 HTTP
3. **环境变量缺失**：前端不知道后端地址在哪里

---

## 修复步骤总览

整个修复过程分为 4 个步骤：

```
✅ 步骤 1：修复后端代码（我已经帮你修复好了）
⬜ 步骤 2：在 Vercel 配置环境变量（你需要操作）
⬜ 步骤 3：在服务器配置环境变量（你需要操作）
⬜ 步骤 4：测试登录功能（验证是否修复成功）
```

---

## 第一步：修复后端代码（已完成✅）

**我已经帮你修复好了！** 文件 `backend-api/src/main.ts` 已经更新，现在支持：
- ✅ 从环境变量读取多个允许的域名
- ✅ 支持通配符匹配（如 `*.vercel.app`）
- ✅ 强制 HTTPS（生产环境）

**你不需要做任何操作**，代码已经修复完成。

---

## 第二步：配置 Vercel 环境变量

### 🎯 目标
告诉 Vercel（前端）你的后端地址在哪里，以及登录需要的密钥。

### 📝 详细步骤

#### 步骤 2.1：打开 Vercel Dashboard

1. 打开浏览器，访问：https://vercel.com/dashboard
2. 登录你的账号
3. 找到你的项目（项目名称通常是 `web` 或你的仓库名）
4. **点击项目名称**进入项目页面

#### 步骤 2.2：进入环境变量设置

1. 在项目页面，点击顶部菜单的 **Settings**（设置）
2. 在左侧菜单中找到 **Environment Variables**（环境变量）
3. 点击进入

#### 步骤 2.3：添加必需的环境变量

你需要添加以下环境变量。**注意**：每个变量都要选择环境（Production、Preview、Development），建议全部选择。

##### 变量 1：`NEXTAUTH_SECRET`（必须）

**作用**：用于加密登录会话的密钥

**如何生成密钥？**

**方法 A：使用在线工具（最简单）**
1. 访问：https://generate-secret.vercel.app/32
2. 复制生成的密钥（一串随机字符）

**方法 B：使用命令行（如果你有终端）**
```bash
# Mac/Linux
openssl rand -base64 32

# Windows（PowerShell）
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))
```

**添加步骤**：
1. 点击 **Add New**（添加新变量）
2. **Key（键）**：输入 `NEXTAUTH_SECRET`
3. **Value（值）**：粘贴刚才生成的密钥
4. **Environment（环境）**：选择 `Production`、`Preview`、`Development`（全部勾选）
5. 点击 **Save**（保存）

---

##### 变量 2：`NEXTAUTH_URL`（必须）

**作用**：告诉 NextAuth 你的网站地址

**如何填写？**
- 如果你的 Vercel 域名是 `https://your-app.vercel.app`，就填这个
- 如果有自定义域名 `https://your-domain.com`，就填这个

**添加步骤**：
1. 点击 **Add New**
2. **Key**：`NEXTAUTH_URL`
3. **Value**：`https://your-app.vercel.app`（替换为你的实际域名）
4. **Environment**：全部勾选
5. 点击 **Save**

---

##### 变量 3：`NEXT_PUBLIC_BACKEND_API_URL`（必须）

**作用**：告诉前端你的后端地址在哪里

**如何填写？**
- 如果你的后端有域名（如 `https://api.your-domain.com`），填这个
- 如果只有 IP 地址，填 `http://你的IP:3001`（但建议配置 HTTPS）

**⚠️ 重要**：
- 如果后端是 HTTP，Vercel（HTTPS）无法连接，会报 Mixed Content 错误
- **强烈建议**：配置 Nginx + SSL 证书，使用 HTTPS

**添加步骤**：
1. 点击 **Add New**
2. **Key**：`NEXT_PUBLIC_BACKEND_API_URL`
3. **Value**：`https://api.your-domain.com` 或 `http://你的IP:3001`（临时测试用）
4. **Environment**：全部勾选
5. 点击 **Save**

---

##### 变量 4：`JWT_SECRET`（必须）

**作用**：用于签名 JWT Token，必须与后端一致

**如何填写？**
- **与 `NEXTAUTH_SECRET` 使用相同的值**（最简单）
- 或者生成一个新的密钥（但要确保后端也用这个）

**添加步骤**：
1. 点击 **Add New**
2. **Key**：`JWT_SECRET`
3. **Value**：与 `NEXTAUTH_SECRET` 相同的值
4. **Environment**：全部勾选
5. 点击 **Save**

---

##### 变量 5：`ADMIN_USERS`（必须）

**作用**：配置可以登录的管理员账号

**格式**：`用户名:密码,用户名:密码`

**示例**：
```
admin:admin123,user1:password1,user2:password2
```

**添加步骤**：
1. 点击 **Add New**
2. **Key**：`ADMIN_USERS`
3. **Value**：`admin:admin123`（至少配置一个账号）
4. **Environment**：全部勾选
5. 点击 **Save**

---

#### 步骤 2.4：重新部署

**重要**：修改环境变量后，必须重新部署才能生效！

1. 点击顶部菜单的 **Deployments**（部署）
2. 找到最新的部署记录
3. 点击右侧的 **...**（三个点）
4. 选择 **Redeploy**（重新部署）
5. 等待部署完成（通常 1-3 分钟）

---

## 第三步：配置服务器环境变量

### 🎯 目标
告诉后端服务器允许哪些前端域名访问，以及数据库连接信息。

### 📝 详细步骤

#### 步骤 3.1：连接到服务器

**方法 A：使用 SSH（推荐）**

1. 打开终端（Mac）或 PowerShell（Windows）
2. 使用 SSH 连接：
```bash
ssh root@你的服务器IP
# 或
ssh 用户名@你的服务器IP
```

**方法 B：使用服务器控制台**

1. 登录你的云服务商控制台（阿里云/腾讯云等）
2. 找到你的 ECS 服务器
3. 点击 **远程连接** 或 **VNC**

---

#### 步骤 3.2：找到后端项目目录

通常后端项目在以下位置之一：
- `/opt/ue-assets-backend`
- `/root/ue-assets-backend`
- `/home/用户名/ue-assets-backend`

**查找命令**：
```bash
# 查找 backend-api 目录
find / -name "backend-api" -type d 2>/dev/null

# 或查找 main.ts 文件
find / -name "main.ts" -path "*/backend-api/*" 2>/dev/null
```

找到后，进入目录：
```bash
cd /opt/ue-assets-backend/backend-api
# 或你的实际路径
```

---

#### 步骤 3.3：创建或编辑 `.env` 文件

**检查文件是否存在**：
```bash
ls -la .env
```

**如果文件不存在，创建它**：
```bash
nano .env
# 或使用 vim
vim .env
```

**如果文件存在，编辑它**：
```bash
nano .env
```

---

#### 步骤 3.4：添加环境变量

在 `.env` 文件中添加以下内容（**替换为你的实际值**）：

```env
# ============================================
# 服务器配置
# ============================================
PORT=3001
NODE_ENV=production

# ============================================
# 前端地址（CORS）- 非常重要！
# ============================================
# 替换为你的 Vercel 域名
FRONTEND_URL=https://your-app.vercel.app

# ✅ 新增：允许多个前端域名（用逗号分隔）
# 包括：生产域名、预览域名、所有 Vercel 分配的域名
ALLOWED_ORIGINS=https://your-app.vercel.app,https://your-app-git-main.vercel.app,https://your-app-*.vercel.app

# ============================================
# JWT 密钥（必须与前端一致！）
# ============================================
# 与 Vercel 中的 NEXTAUTH_SECRET 和 JWT_SECRET 使用相同的值
JWT_SECRET=你的密钥（与前端一致）
NEXTAUTH_SECRET=你的密钥（与前端一致）

# ============================================
# 用户白名单（必须与前端一致！）
# ============================================
# 格式：邮箱:密码,邮箱:密码
# 注意：邮箱格式，如 admin@admin.local
USER_WHITELIST=admin@admin.local:admin123,user1@admin.local:password1

# 兼容配置（可选）
ADMIN_USERS=admin:admin123,user1:password1

# ============================================
# 数据库配置（Docker 容器间连接）
# ============================================
# ⚠️ 重要：DB_HOST 必须是 Docker 服务名，不是 localhost！
DB_HOST=postgres
DB_PORT=5432
DB_NAME=ue_assets
DB_USERNAME=postgres
DB_PASSWORD=你的数据库密码

# ============================================
# 积分系统配置（可选）
# ============================================
INITIAL_CREDITS=100
```

**保存文件**：
- **nano**：按 `Ctrl + X`，然后按 `Y`，然后按 `Enter`
- **vim**：按 `Esc`，输入 `:wq`，按 `Enter`

---

#### 步骤 3.5：重启后端服务

**如果使用 Docker Compose**：
```bash
# 进入项目根目录（有 docker-compose.yml 的目录）
cd /opt/ue-assets-backend

# 重启服务
docker-compose restart backend

# 或重新构建并启动
docker-compose down
docker-compose up -d
```

**如果使用 PM2**：
```bash
pm2 restart backend-api
# 或
pm2 restart all
```

**如果直接运行 Node.js**：
```bash
# 停止当前进程（Ctrl + C）
# 然后重新启动
npm run start:prod
# 或
node dist/main.js
```

---

#### 步骤 3.6：检查服务是否正常运行

**检查后端日志**：
```bash
# Docker
docker logs ue-assets-backend
# 或
docker logs -f ue-assets-backend  # 实时查看日志

# PM2
pm2 logs backend-api

# 直接运行
# 查看终端输出
```

**应该看到类似这样的输出**：
```
🚀 Backend API running on port 3001
📡 Listening on: 0.0.0.0:3001
🌍 CORS: 仅允许配置的来源
[CORS] ✅ 允许来源: https://your-app.vercel.app
```

**测试后端健康检查**：
```bash
curl http://localhost:3001/health
# 应该返回 JSON 数据
```

---

## 第四步：测试登录功能

### 🎯 目标
验证登录功能是否修复成功。

### 📝 详细步骤

#### 步骤 4.1：检查浏览器控制台

1. 打开你的网站（Vercel 域名）
2. 按 `F12` 打开开发者工具
3. 点击 **Console**（控制台）标签
4. 查看是否有错误信息

**常见的错误类型**：
- ❌ `CORS policy`：跨域问题，检查 `ALLOWED_ORIGINS`
- ❌ `Mixed Content`：HTTPS/HTTP 混用，后端需要使用 HTTPS
- ❌ `Failed to fetch`：网络连接失败，检查后端地址
- ❌ `401 Unauthorized`：认证失败，检查 `JWT_SECRET` 是否一致

---

#### 步骤 4.2：测试登录接口

**方法 A：在浏览器控制台测试**

1. 打开网站，按 `F12` 打开控制台
2. 在 Console 中输入以下代码（**替换为你的实际值**）：

```javascript
// 替换为你的后端地址
const backendUrl = 'https://api.your-domain.com';  // 或 http://你的IP:3001

// 测试登录接口
fetch(`${backendUrl}/auth/login`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    email: 'admin@admin.local',  // 替换为你的用户名
    password: 'admin123',        // 替换为你的密码
  }),
})
  .then(response => {
    console.log('状态码:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('登录结果:', data);
    if (data.success) {
      console.log('✅ 登录成功！Token:', data.token);
    } else {
      console.error('❌ 登录失败:', data);
    }
  })
  .catch(error => {
    console.error('❌ 请求失败:', error);
  });
```

3. 按 `Enter` 执行
4. 查看输出结果

**预期结果**：
- ✅ 如果看到 `登录成功！Token: ...`，说明后端连接正常
- ❌ 如果看到错误，根据错误信息排查

---

#### 步骤 4.3：在前端页面测试登录

1. 访问登录页面：`https://your-app.vercel.app/auth/login`
2. 输入用户名和密码
3. 点击登录按钮
4. 观察页面反应

**预期结果**：
- ✅ 登录成功，跳转到 `/admin` 页面
- ❌ 如果失败，查看浏览器控制台的错误信息

---

#### 步骤 4.4：检查网络请求

1. 打开开发者工具（F12）
2. 点击 **Network**（网络）标签
3. 点击登录按钮
4. 查找 `/auth/login` 请求
5. 点击该请求，查看详情

**检查要点**：
- **Status（状态码）**：应该是 `200`（成功）
- **Request URL（请求地址）**：应该是正确的后端地址
- **Response（响应）**：应该包含 `success: true` 和 `token`

---

## 常见问题排查

### ❌ 问题 1：CORS 错误

**错误信息**：
```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```

**解决方法**：
1. 检查服务器 `.env` 文件中的 `ALLOWED_ORIGINS`
2. 确保包含你的 Vercel 域名
3. 重启后端服务
4. 检查后端日志，查看 CORS 拒绝的域名

---

### ❌ 问题 2：Mixed Content 错误

**错误信息**：
```
Mixed Content: The page at 'https://...' was loaded over HTTPS, but requested an insecure resource 'http://...'
```

**解决方法**：
1. **方案 A（推荐）**：配置 Nginx + SSL 证书，让后端使用 HTTPS
2. **方案 B（临时）**：在浏览器中允许不安全内容（不推荐）

**配置 Nginx + SSL**：
```bash
# 1. 安装 certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# 2. 申请 SSL 证书
sudo certbot --nginx -d api.your-domain.com

# 3. 配置 Nginx（参考 nginx.conf.example）
```

---

### ❌ 问题 3：401 Unauthorized

**错误信息**：
```
401 Unauthorized
```

**解决方法**：
1. 检查 `JWT_SECRET` 是否在前端和后端一致
2. 检查 `USER_WHITELIST` 格式是否正确（邮箱:密码）
3. 检查用户名和密码是否正确
4. 查看后端日志，查看具体错误信息

---

### ❌ 问题 4：无法连接到后端

**错误信息**：
```
Failed to fetch
Network error
```

**解决方法**：
1. 检查 `NEXT_PUBLIC_BACKEND_API_URL` 是否正确
2. 检查后端服务是否运行：`curl http://你的IP:3001/health`
3. 检查服务器防火墙是否开放 3001 端口
4. 检查服务器安全组规则

---

### ❌ 问题 5：数据库连接失败

**错误信息**：
```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**解决方法**：
1. 检查 `DB_HOST` 是否为 `postgres`（Docker 服务名），不是 `localhost`
2. 检查数据库容器是否运行：`docker ps`
3. 检查数据库密码是否正确
4. 检查 Docker 网络配置

---

## ✅ 修复完成检查清单

完成所有步骤后，请确认：

### Vercel 配置
- [ ] `NEXTAUTH_SECRET` 已配置
- [ ] `NEXTAUTH_URL` 已配置（与域名一致）
- [ ] `NEXT_PUBLIC_BACKEND_API_URL` 已配置（使用 HTTPS）
- [ ] `JWT_SECRET` 已配置（与后端一致）
- [ ] `ADMIN_USERS` 已配置
- [ ] 已重新部署

### 服务器配置
- [ ] `FRONTEND_URL` 已配置（Vercel 域名）
- [ ] `ALLOWED_ORIGINS` 已配置（包含所有 Vercel 域名）
- [ ] `JWT_SECRET` 已配置（与前端一致）
- [ ] `USER_WHITELIST` 已配置（格式正确）
- [ ] `DB_HOST=postgres`（Docker 服务名）
- [ ] 后端服务已重启

### 功能测试
- [ ] 浏览器控制台无 CORS 错误
- [ ] 浏览器控制台无 Mixed Content 错误
- [ ] 登录接口返回 `200` 状态码
- [ ] 前端登录页面可以正常登录
- [ ] 登录后可以访问 `/admin` 页面

---

## 🆘 需要帮助？

如果按照以上步骤操作后仍然无法登录，请提供以下信息：

1. **浏览器控制台的错误信息**（截图）
2. **后端日志**（最后 50 行）
3. **环境变量配置**（隐藏敏感信息）
4. **网络请求详情**（Network 标签页截图）

---

## 📚 相关文件

- `登录功能失效-深度诊断报告.md` - 详细的技术分析报告
- `backend-api/src/main.ts` - 后端代码（已修复）
- `环境变量配置模板.env.example` - 环境变量模板
- `docker-compose.yml.example` - Docker 配置示例
- `nginx.conf.example` - Nginx 配置示例

---

**最后更新**：2024-12-19
**适用版本**：Next.js + NestJS 全栈项目






