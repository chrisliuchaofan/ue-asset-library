# ğŸ” æ£€æŸ¥åç«¯æœåŠ¡å™¨é…ç½®çš„æ–¹æ³•

## æ–¹æ³• 1: SSH ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹ .env æ–‡ä»¶ï¼ˆæœ€ç›´æ¥ï¼‰

```bash
# SSH ç™»å½•åˆ°æœåŠ¡å™¨
ssh your-username@your-server-ip

# è¿›å…¥åç«¯é¡¹ç›®ç›®å½•
cd /opt/ue-assets-backend/backend-api

# æŸ¥çœ‹ .env æ–‡ä»¶ä¸­çš„ USER_WHITELIST
cat .env | grep USER_WHITELIST

# æˆ–è€…æŸ¥çœ‹æ‰€æœ‰ç›¸å…³é…ç½®
cat .env | grep -E "USER_WHITELIST|JWT_SECRET|MODEL_ENABLED|BILLING_ENABLED"
```

## æ–¹æ³• 2: é€šè¿‡ PM2 æŸ¥çœ‹ç¯å¢ƒå˜é‡

```bash
# SSH ç™»å½•æœåŠ¡å™¨å
pm2 env <process-id>

# æˆ–è€…æŸ¥çœ‹æ‰€æœ‰ PM2 è¿›ç¨‹çš„ç¯å¢ƒå˜é‡
pm2 show ue-assets-backend | grep -A 20 "env:"
```

## æ–¹æ³• 3: é€šè¿‡åç«¯æ—¥å¿—æŸ¥çœ‹ï¼ˆå¦‚æœé…ç½®äº†æ—¥å¿—è¾“å‡ºï¼‰

```bash
# SSH ç™»å½•æœåŠ¡å™¨å
pm2 logs ue-assets-backend --lines 100 | grep -i "whitelist\|user"

# æˆ–è€…æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f /opt/ue-assets-backend/backend-api/logs/*.log | grep -i whitelist
```

## æ–¹æ³• 4: é€šè¿‡åç«¯å¥åº·æ£€æŸ¥æ¥å£ï¼ˆå¦‚æœæœ‰ï¼‰

```bash
# å¦‚æœåç«¯æœ‰å¥åº·æ£€æŸ¥æ¥å£ï¼Œå¯ä»¥æŸ¥çœ‹é…ç½®ä¿¡æ¯
curl https://api.factory-buy.com/health | jq .

# æˆ–è€…ç›´æ¥æµ‹è¯•ç™»å½•æ¥å£ï¼Œçœ‹é”™è¯¯ä¿¡æ¯
curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' \
  -v
```

## æ–¹æ³• 5: åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„é…ç½®æŸ¥çœ‹æ¥å£ï¼ˆæ¨èï¼‰

å¦‚æœåç«¯æ²¡æœ‰é…ç½®æŸ¥çœ‹æ¥å£ï¼Œå¯ä»¥ä¸´æ—¶æ·»åŠ ä¸€ä¸ªï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰ï¼š

```typescript
// backend-api/src/auth/auth.controller.ts
@Get('debug/config')
async getConfig() {
  // åªè¿”å›é…ç½®çš„ keyï¼Œä¸è¿”å›æ•æ„Ÿä¿¡æ¯
  return {
    hasUserWhitelist: !!process.env.USER_WHITELIST,
    userWhitelistCount: process.env.USER_WHITELIST?.split(',').length || 0,
    userWhitelistEmails: process.env.USER_WHITELIST?.split(',').map(u => u.split(':')[0]) || [],
    hasJwtSecret: !!process.env.JWT_SECRET,
    modelEnabled: process.env.MODEL_ENABLED !== 'false',
    billingEnabled: process.env.BILLING_ENABLED !== 'false',
  };
}
```

ç„¶åè®¿é—®ï¼š
```bash
curl https://api.factory-buy.com/auth/debug/config
```

## æ–¹æ³• 6: ç›´æ¥æµ‹è¯•ç™»å½•ï¼ˆæœ€ç®€å•ï¼‰

```bash
# æµ‹è¯•ä¸åŒçš„å¯†ç ç»„åˆ
curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}'

# å¦‚æœå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
curl -X POST https://api.factory-buy.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin","password":"admin123"}'
```

---

## ğŸ”§ å¿«é€Ÿæ£€æŸ¥è„šæœ¬

åˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶ `check-backend-config.sh`ï¼š

```bash
#!/bin/bash

echo "=== æ£€æŸ¥åç«¯é…ç½® ==="
echo ""

# 1. æ£€æŸ¥ .env æ–‡ä»¶
echo "1. .env æ–‡ä»¶ä¸­çš„é…ç½®ï¼š"
if [ -f "/opt/ue-assets-backend/backend-api/.env" ]; then
  echo "USER_WHITELIST:"
  grep USER_WHITELIST /opt/ue-assets-backend/backend-api/.env || echo "  æœªæ‰¾åˆ°"
  echo ""
  echo "JWT_SECRET:"
  grep JWT_SECRET /opt/ue-assets-backend/backend-api/.env | sed 's/=.*/=***/' || echo "  æœªæ‰¾åˆ°"
  echo ""
  echo "MODEL_ENABLED:"
  grep MODEL_ENABLED /opt/ue-assets-backend/backend-api/.env || echo "  æœªæ‰¾åˆ°"
  echo ""
  echo "BILLING_ENABLED:"
  grep BILLING_ENABLED /opt/ue-assets-backend/backend-api/.env || echo "  æœªæ‰¾åˆ°"
else
  echo "  .env æ–‡ä»¶ä¸å­˜åœ¨"
fi

echo ""
echo "2. PM2 è¿›ç¨‹ç¯å¢ƒå˜é‡ï¼š"
pm2 show ue-assets-backend 2>/dev/null | grep -E "USER_WHITELIST|JWT_SECRET|MODEL_ENABLED|BILLING_ENABLED" || echo "  æ— æ³•è·å– PM2 ç¯å¢ƒå˜é‡"

echo ""
echo "3. æµ‹è¯•ç™»å½•æ¥å£ï¼š"
echo "   æµ‹è¯• admin@admin.local + admin123"
curl -s -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' | jq -r '.success // .message // "è¯·æ±‚å¤±è´¥"'

echo ""
echo "=== æ£€æŸ¥å®Œæˆ ==="
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
chmod +x check-backend-config.sh
./check-backend-config.sh
```

---

## ğŸ“ æ¨èçš„æ£€æŸ¥æ­¥éª¤

1. **SSH ç™»å½•æœåŠ¡å™¨**
   ```bash
   ssh your-username@your-server-ip
   ```

2. **æŸ¥çœ‹ .env æ–‡ä»¶**
   ```bash
   cd /opt/ue-assets-backend/backend-api
   cat .env | grep USER_WHITELIST
   ```

3. **ç¡®è®¤é…ç½®æ ¼å¼**
   - åº”è¯¥æ˜¯ï¼š`USER_WHITELIST=admin:admin123` æˆ– `USER_WHITELIST=admin@admin.local:admin123`
   - å¯†ç åº”è¯¥æ˜¯ `admin123`ï¼ˆä¸å‰ç«¯ `ADMIN_USERS=admin:admin123` åŒ¹é…ï¼‰

4. **å¦‚æœé…ç½®ä¸å¯¹ï¼Œä¿®æ”¹å¹¶é‡å¯**
   ```bash
   # ç¼–è¾‘ .env æ–‡ä»¶
   nano .env
   # æˆ–
   vi .env
   
   # ä¿®æ”¹åé‡å¯æœåŠ¡
   pm2 restart ue-assets-backend --update-env
   ```

5. **éªŒè¯é…ç½®**
   ```bash
   # æµ‹è¯•ç™»å½•
   curl -X POST http://localhost:3001/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@admin.local","password":"admin123"}'
   ```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1: .env æ–‡ä»¶ä¸å­˜åœ¨

**è§£å†³ï¼š** åˆ›å»º .env æ–‡ä»¶
```bash
cd /opt/ue-assets-backend/backend-api
cp .env.example .env  # å¦‚æœæœ‰ç¤ºä¾‹æ–‡ä»¶
# æˆ–æ‰‹åŠ¨åˆ›å»º
nano .env
```

### é—®é¢˜ 2: PM2 æ²¡æœ‰åŠ è½½ .env æ–‡ä»¶

**è§£å†³ï¼š** ç¡®ä¿ PM2 é…ç½®æ­£ç¡®åŠ è½½ç¯å¢ƒå˜é‡
```bash
# æ£€æŸ¥ ecosystem.config.js æˆ– PM2 é…ç½®
cat ecosystem.config.js | grep env

# é‡å¯æ—¶ä½¿ç”¨ --update-env
pm2 restart ue-assets-backend --update-env
```

### é—®é¢˜ 3: é…ç½®æ ¼å¼é”™è¯¯

**æ­£ç¡®æ ¼å¼ï¼š**
```env
USER_WHITELIST=email1:password1,email2:password2
```

**é”™è¯¯æ ¼å¼ï¼š**
```env
USER_WHITELIST="email1:password1,email2:password2"  # ä¸è¦ç”¨å¼•å·
USER_WHITELIST=email1:password1 email2:password2   # ä¸è¦ç”¨ç©ºæ ¼åˆ†éš”
```

---

## ğŸ¯ å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# ä¸€é”®æ£€æŸ¥ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
echo "=== åç«¯é…ç½®æ£€æŸ¥ ===" && \
echo "USER_WHITELIST:" && \
grep USER_WHITELIST /opt/ue-assets-backend/backend-api/.env 2>/dev/null || echo "æœªæ‰¾åˆ°" && \
echo "" && \
echo "æµ‹è¯•ç™»å½•:" && \
curl -s -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.local","password":"admin123"}' | jq -r '.success // .message // "è¯·æ±‚å¤±è´¥"'
```


