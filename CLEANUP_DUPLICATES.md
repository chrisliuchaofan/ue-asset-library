# OSS 重复文件清理指南

## 问题说明

如果 OSS 中存在重复文件，会导致：
- 浪费存储空间（产生额外费用）
- 数据冗余，难以管理
- 可能影响系统性能

## 清理工具

项目提供了专门的清理脚本：`scripts/cleanup-duplicate-files.ts`

## 使用方法

### 1. 扫描重复文件（推荐，默认使用 manifest.json 的 hash）

默认会从 `manifest.json` 读取 hash 信息进行匹配，这是**最快且最准确**的方法：

```bash
npm run cleanup-duplicates
```

或者：

```bash
tsx scripts/cleanup-duplicate-files.ts
```

**工作原理**：
- 从 OSS 的 `manifest.json` 读取所有资产的 hash
- 按 hash 分组 OSS 文件
- 找出相同 hash 的重复文件（即使文件名不同）

### 2. 下载文件计算 Hash（最准确但最慢）

如果 `manifest.json` 中没有 hash 信息，或者想验证，可以下载文件计算 hash：

```bash
tsx scripts/cleanup-duplicate-files.ts --hash
```

**注意**：hash 匹配需要下载每个文件来计算 hash，对于大量文件会非常慢。

### 3. 禁用 manifest.json（使用文件名+大小匹配）

如果不想使用 manifest.json，可以禁用：

```bash
tsx scripts/cleanup-duplicate-files.ts --no-manifest
```

**注意**：这种方法只能检测文件名相同且大小相同的文件，无法检测文件名不同但内容相同的文件。

### 3. 实际删除重复文件

⚠️ **警告**：这会永久删除文件，请确保已备份重要数据！

```bash
npm run cleanup-duplicates:delete
```

或者：

```bash
tsx scripts/cleanup-duplicate-files.ts --delete
```

执行删除操作前，脚本会要求你输入 "yes" 确认。

## 工作原理

### 默认模式（从 manifest.json 读取 hash，推荐）

1. 从 OSS 的 `manifest.json` 读取所有资产的 hash 信息
2. 扫描 OSS 中 `assets/` 目录下的所有文件
3. 将文件路径与 manifest 中的 hash 匹配
4. 按 hash 值分组
5. 找出相同 hash 的文件组（即使文件名不同）
6. 保留最早上传的文件，标记其他为重复

**优点**：
- ✅ 速度快（不需要下载文件）
- ✅ 准确（基于文件内容 hash）
- ✅ 能检测文件名不同但内容相同的文件

**缺点**：
- 如果 manifest.json 中没有 hash 信息，会回退到文件名+大小匹配

### Hash 模式（下载文件计算）

1. 扫描 OSS 中所有文件
2. 下载每个文件并计算 SHA256 hash
3. 按 hash 值分组
4. 找出相同 hash 的文件组
5. 保留最早上传的文件，标记其他为重复

**优点**：
- ✅ 最准确，能检测所有重复文件

**缺点**：
- ❌ 速度慢（需要下载所有文件）
- ❌ 消耗流量

### 文件名+大小模式（快速但不准确）

1. 扫描 OSS 中 `assets/` 目录下的所有文件
2. 提取文件名（去除时间戳前缀）
3. 按 `文件名_大小` 分组
4. 找出同一组中超过 1 个文件的组
5. 保留最早上传的文件，标记其他为重复

**优点**：
- ✅ 速度快

**缺点**：
- ❌ 如果文件名不同但内容相同，无法检测

## 报告示例

```
================================================================================
📊 重复文件清理报告
================================================================================

📈 统计信息：
   - 重复文件组数: 5
   - 可删除文件数: 8
   - 可节省空间: 125.50 MB

📋 详细列表：

1. 重复组: image.jpg_1024000
   保留文件: assets/1234567890_image.jpg (1.00 MB)
   删除文件:
     - assets/1234567891_image.jpg (1.00 MB)
     - assets/1234567892_image.jpg (1.00 MB)
   可节省: 2.00 MB

...
```

## 注意事项

1. **备份重要数据**：删除操作不可逆，请确保重要文件已备份
2. **先扫描再删除**：建议先运行扫描模式查看报告，确认无误后再删除
3. **检查资产记录**：删除文件后，需要检查 `manifest.json` 中是否有引用这些文件
4. **网络连接**：确保能正常访问阿里云 OSS
5. **权限配置**：确保 OSS AccessKey 有删除权限

## 配置要求

脚本会自动从以下位置读取 OSS 配置：

1. `.env.local` 文件（优先）
2. 环境变量

需要的配置项：
- `OSS_BUCKET`
- `OSS_REGION`
- `OSS_ACCESS_KEY_ID`
- `OSS_ACCESS_KEY_SECRET`

## 预防重复文件

为了避免将来出现重复文件：

1. **使用批量上传功能**：系统会自动检查重复文件
2. **启用重复检测**：上传前会检查文件 hash
3. **统一上传渠道**：建议统一使用 Vercel 线上版本上传

## 常见问题

### Q: 删除文件后，资产记录中的 URL 会失效吗？

A: 是的。删除文件后，如果资产记录中引用了该文件，需要手动更新资产记录或删除该资产。

### Q: 如何检查哪些资产引用了被删除的文件？

A: 可以手动检查 `manifest.json`（OSS 模式）或 `data/manifest.json`（本地模式），搜索被删除文件的 URL。

### Q: 脚本执行很慢怎么办？

A: 
- 默认模式（文件名+大小）通常很快
- 如果使用 `--hash` 模式，对于大量文件会很慢，这是正常的
- 可以考虑分批处理

### Q: 删除失败怎么办？

A: 检查：
1. OSS AccessKey 是否有删除权限
2. 网络连接是否正常
3. 文件是否被其他进程占用

## 建议工作流程

1. **首次清理**：
   ```bash
   # 1. 先扫描查看情况
   npm run cleanup-duplicates
   
   # 2. 查看报告，确认要删除的文件
   
   # 3. 确认无误后执行删除
   npm run cleanup-duplicates:delete
   ```

2. **定期维护**：
   - 每月运行一次扫描
   - 发现重复文件及时清理

3. **预防措施**：
   - 统一使用线上版本上传
   - 启用重复文件检测功能

