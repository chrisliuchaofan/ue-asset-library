# 分阶段清理计划

**生成时间**: 2024-12-19  
**基于**: 《项目体检报告.md》  
**原则**: 保守型重构，确保功能不被破坏

---

## 清理策略

1. **分批执行**: 每个阶段独立提交，便于回滚
2. **先验证后删除**: 每步都有验证命令
3. **保留备份**: 重要文件删除前先确认
4. **渐进式清理**: 从低风险到高风险

---

## 第一阶段：清理构建产物和缓存文件（高优先级）

### 📋 变更内容

**文件删除清单**:
1. `build.log` (5.0KB)
2. `tsconfig.tsbuildinfo` (143KB)
3. `backend-api/dist/` 目录及其所有内容 (740KB)
4. `backend-api/dist/tsconfig.tsbuildinfo` (如果存在)

**配置更新**:
- 更新 `.gitignore` 确保完整覆盖

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 这些都是构建产物和缓存文件，不影响源代码
- 删除后可通过 `npm run build` 重新生成
- `.gitignore` 已配置，只是文件未清理

**潜在影响**:
- 无功能影响
- 首次构建可能稍慢（需重新生成缓存）

### 🔄 回滚方式

```bash
# 如果删除后发现问题，可通过以下方式恢复：
git checkout HEAD -- build.log tsconfig.tsbuildinfo backend-api/dist/
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 确认这些文件确实存在
ls -lh build.log tsconfig.tsbuildinfo
ls -ld backend-api/dist/

# 2. 确认 .gitignore 已配置
grep -E "(build\.log|tsbuildinfo|backend-api/dist)" .gitignore
```

**删除后验证**:
```bash
# 1. 确认文件已删除
ls build.log tsconfig.tsbuildinfo 2>&1 | grep "No such file"
ls backend-api/dist/ 2>&1 | grep "No such file"

# 2. 验证项目仍可正常构建
npm run build

# 3. 验证后端仍可正常构建
cd backend-api && npm run build

# 4. 确认 .gitignore 生效（文件不应出现在 git status 中）
git status | grep -E "(build\.log|tsbuildinfo|backend-api/dist)" && echo "❌ 文件仍在跟踪中" || echo "✅ 文件已正确忽略"
```

**冒烟测试**:
```bash
# 1. 前端构建测试
npm run build
npm run start &
sleep 5
curl http://localhost:3000 | head -20
pkill -f "next start"

# 2. 后端构建测试（如果使用）
cd backend-api
npm run build
cd ..
```

### 📝 执行步骤

```bash
# Step 1: 备份当前状态（可选，但推荐）
git add -A
git commit -m "chore: 备份清理前的状态"

# Step 2: 删除构建产物和缓存文件
rm -f build.log tsconfig.tsbuildinfo
rm -rf backend-api/dist/

# Step 3: 更新 .gitignore（如果需要）
# 检查 .gitignore 是否包含以下内容：
# *.tsbuildinfo
# build.log*
# backend-api/dist/

# Step 4: 验证删除
npm run build
cd backend-api && npm run build && cd ..

# Step 5: 提交更改
git add -A
git commit -m "chore: 清理构建产物和缓存文件

- 删除 build.log
- 删除 tsconfig.tsbuildinfo
- 删除 backend-api/dist/ 目录
- 这些文件可通过构建重新生成"
```

---

## 第二阶段：删除未使用的依赖（中优先级）

### 📋 变更内容

**package.json 依赖删除清单**:
1. `graceful-fs` (^4.2.11)
2. `ogl` (^1.0.11)
3. `gsap` (^3.13.0)
4. `@google/genai` (^1.33.0)
5. `proxy-agent` (^5.0.0)

**预期节省**: 约 15-20MB node_modules 体积

### ⚠️ 风险评估

**风险等级**: 🟡 **中**

**理由**:
- 这些依赖在代码中未找到直接引用
- 但可能是间接依赖或动态导入
- 删除前需要充分测试

**潜在影响**:
- 如果误删，可能导致运行时错误
- 动态导入的依赖可能被遗漏

### 🔄 回滚方式

```bash
# 恢复 package.json
git checkout HEAD -- package.json

# 重新安装依赖
npm install
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 再次确认这些依赖未被使用
grep -r "graceful-fs\|ogl\|gsap\|@google/genai\|proxy-agent" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . --exclude-dir=node_modules --exclude-dir=.next

# 2. 检查是否有动态导入
grep -r "import.*\(graceful-fs\|ogl\|gsap\|genai\|proxy-agent\)" --include="*.ts" --include="*.tsx" .

# 3. 检查 package-lock.json 中的依赖关系
npm ls graceful-fs ogl gsap @google/genai proxy-agent
```

**删除后验证**:
```bash
# 1. 确认 package.json 已更新
grep -E "(graceful-fs|ogl|gsap|@google/genai|proxy-agent)" package.json && echo "❌ 依赖仍在" || echo "✅ 依赖已删除"

# 2. 重新安装依赖
rm -rf node_modules package-lock.json
npm install

# 3. 验证项目仍可正常构建
npm run build

# 4. 运行所有测试脚本
npm run lint
npm run test
```

**冒烟测试**:
```bash
# 1. 启动开发服务器
npm run dev &
DEV_PID=$!
sleep 10

# 2. 测试主要页面
curl http://localhost:3000 | head -20
curl http://localhost:3000/assets | head -20
curl http://localhost:3000/materials | head -20

# 3. 停止开发服务器
kill $DEV_PID

# 4. 构建生产版本
npm run build
npm run start &
sleep 5
curl http://localhost:3000 | head -20
pkill -f "next start"
```

### 📝 执行步骤

```bash
# Step 1: 备份当前 package.json
cp package.json package.json.backup

# Step 2: 删除未使用的依赖
npm uninstall graceful-fs ogl gsap @google/genai proxy-agent

# Step 3: 验证删除
npm run build
npm run lint

# Step 4: 运行冒烟测试（见上方）

# Step 5: 如果一切正常，提交更改
git add package.json package-lock.json
git commit -m "chore: 删除未使用的依赖

删除以下未使用的依赖包：
- graceful-fs (未在代码中直接使用)
- ogl (未在代码中找到引用)
- gsap (未在代码中找到引用)
- @google/genai (未在代码中找到引用)
- proxy-agent (未在代码中直接使用)

预期节省: 15-20MB node_modules 体积"

# Step 6: 如果发现问题，回滚
# git checkout HEAD -- package.json package-lock.json
# npm install
```

---

## 第三阶段：整理文档文件（中优先级）

### 📋 变更内容

**文档归档**:
- 创建 `docs/archive/` 目录
- 移动历史文档到归档目录

**文档删除**（需人工确认）:
- 重复的配置说明文档
- 临时的问题排查文档（已解决的问题）

**保留的核心文档**:
- `README.md`
- `PROJECT_STRUCTURE.md`
- `ARCHITECTURE_SUMMARY.md`
- `docs/` 目录下的文档

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 文档文件不影响功能
- 归档而非删除，可随时恢复
- 只整理根目录文档，不影响 `docs/` 目录

**潜在影响**:
- 无功能影响
- 可能影响文档查找（但归档后更有序）

### 🔄 回滚方式

```bash
# 恢复文档文件
git checkout HEAD -- docs/archive/
git mv docs/archive/*.md .
rmdir docs/archive
```

### ✅ 验证方式

**归档前验证**:
```bash
# 1. 列出根目录所有 .md 文件
find . -maxdepth 1 -name "*.md" -type f | sort

# 2. 确认 docs/archive/ 目录不存在或为空
ls -la docs/archive/ 2>&1 | head -5
```

**归档后验证**:
```bash
# 1. 确认文档已移动到归档目录
ls docs/archive/ | wc -l

# 2. 确认根目录文档数量减少
find . -maxdepth 1 -name "*.md" -type f | wc -l

# 3. 验证项目仍可正常构建（文档不影响构建）
npm run build
```

### 📝 执行步骤

```bash
# Step 1: 创建归档目录
mkdir -p docs/archive

# Step 2: 移动历史文档到归档目录（示例，需根据实际情况调整）
# 完成总结类文档
mv *完成总结*.md docs/archive/ 2>/dev/null || true
mv *完成总结-*.md docs/archive/ 2>/dev/null || true

# 修复类文档
mv *修复*.md docs/archive/ 2>/dev/null || true

# 测试类文档
mv *测试*.md docs/archive/ 2>/dev/null || true

# 部署类文档
mv *部署*.md docs/archive/ 2>/dev/null || true
mv *部署*.md docs/archive/ 2>/dev/null || true

# 问题排查类文档
mv *问题排查*.md docs/archive/ 2>/dev/null || true
mv *排查*.md docs/archive/ 2>/dev/null || true

# 指南类文档（保留核心指南，归档历史指南）
# mv *指南*.md docs/archive/ 2>/dev/null || true  # 需人工确认

# Step 3: 创建归档索引
cat > docs/archive/README.md << 'EOF'
# 文档归档目录

本目录包含历史文档，按类型分类：

- 完成总结类: `*完成总结*.md`
- 修复类: `*修复*.md`
- 测试类: `*测试*.md`
- 部署类: `*部署*.md`
- 问题排查类: `*问题排查*.md`, `*排查*.md`

如需查找历史文档，请在此目录中搜索。
EOF

# Step 4: 验证归档
ls docs/archive/ | head -20

# Step 5: 提交更改
git add docs/archive/
git add -u  # 跟踪已移动的文件
git commit -m "chore: 整理文档文件，归档历史文档到 docs/archive/

- 创建 docs/archive/ 目录
- 移动历史文档（完成总结、修复、测试、部署、问题排查类）到归档目录
- 保留核心文档在根目录"
```

---

## 第四阶段：清理后端废弃文件（中优先级）

### 📋 变更内容

**文件删除清单**:
1. `backend-api/src/auth/auth.service.old.ts` (如果存在且已废弃)
2. `backend-api/src/auth/auth.service.new.ts` (如果已合并到主文件)

**前提条件**:
- 需人工确认这些文件确实已废弃
- 确认 `auth.service.ts` 是当前使用的文件

### ⚠️ 风险评估

**风险等级**: 🟡 **中**

**理由**:
- 需要确认文件确实已废弃
- 删除前需检查是否有其他地方引用
- 可能包含重要的历史代码

**潜在影响**:
- 如果误删，可能丢失重要代码
- 如果文件仍在使用，会导致编译错误

### 🔄 回滚方式

```bash
# 恢复文件
git checkout HEAD -- backend-api/src/auth/auth.service.old.ts backend-api/src/auth/auth.service.new.ts
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 确认文件存在
ls -lh backend-api/src/auth/auth.service*.ts

# 2. 检查是否有其他地方引用这些文件
grep -r "auth.service.old\|auth.service.new" backend-api/src/

# 3. 对比文件内容，确认已合并
diff backend-api/src/auth/auth.service.ts backend-api/src/auth/auth.service.new.ts
# 如果差异很小，说明已合并

# 4. 检查 Git 历史，确认文件状态
git log --oneline --all -- backend-api/src/auth/auth.service*.ts
```

**删除后验证**:
```bash
# 1. 确认文件已删除
ls backend-api/src/auth/auth.service.old.ts 2>&1 | grep "No such file"
ls backend-api/src/auth/auth.service.new.ts 2>&1 | grep "No such file"

# 2. 验证后端仍可正常构建
cd backend-api
npm run build
cd ..

# 3. 验证后端仍可正常启动（如果可能）
cd backend-api
npm run start:dev &
sleep 5
curl http://localhost:3001/health 2>&1 || echo "健康检查端点可能不存在"
pkill -f "ts-node-dev"
cd ..
```

### 📝 执行步骤

```bash
# Step 1: 备份文件（重要！）
cp backend-api/src/auth/auth.service.old.ts backend-api/src/auth/auth.service.old.ts.backup 2>/dev/null || true
cp backend-api/src/auth/auth.service.new.ts backend-api/src/auth/auth.service.new.ts.backup 2>/dev/null || true

# Step 2: 确认文件状态（需人工确认）
# 检查 auth.service.ts 是否是当前使用的文件
# 检查 .old.ts 和 .new.ts 是否已废弃

# Step 3: 删除废弃文件（仅在确认后执行）
# rm backend-api/src/auth/auth.service.old.ts
# rm backend-api/src/auth/auth.service.new.ts

# Step 4: 验证删除
cd backend-api
npm run build
cd ..

# Step 5: 提交更改
git add backend-api/src/auth/
git commit -m "chore: 清理后端废弃文件

- 删除 auth.service.old.ts (已废弃)
- 删除 auth.service.new.ts (已合并到 auth.service.ts)"
```

---

## 第五阶段：优化配置文件（低优先级，可选）

### 📋 变更内容

**tailwind.config.ts**:
- 移除 `./src/**/*.{ts,tsx}` 路径（项目中没有 `src` 目录）

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 只是移除冗余配置，不影响功能
- Tailwind 会忽略不存在的路径

**潜在影响**:
- 无功能影响
- 可能略微提升构建性能（忽略不存在的路径）

### 🔄 回滚方式

```bash
git checkout HEAD -- tailwind.config.ts
```

### ✅ 验证方式

**修改后验证**:
```bash
# 1. 确认配置已更新
grep -E "src.*tsx" tailwind.config.ts && echo "❌ 配置仍在" || echo "✅ 配置已移除"

# 2. 验证 Tailwind 仍正常工作
npm run build

# 3. 检查构建输出中是否有 Tailwind 相关错误
npm run build 2>&1 | grep -i "tailwind\|postcss" || echo "✅ 无错误"
```

### 📝 执行步骤

```bash
# Step 1: 修改 tailwind.config.ts
# 移除 content 数组中的 "./src/**/*.{ts,tsx}"

# Step 2: 验证修改
npm run build

# Step 3: 提交更改
git add tailwind.config.ts
git commit -m "chore: 优化 Tailwind 配置，移除不存在的 src 目录路径"
```

---

## 自动化体检脚本方案

### 📋 脚本功能

创建一个自动化体检脚本，每周运行一次，检查：
1. 未使用的依赖
2. 构建产物是否误入仓库
3. 大文件检查
4. 重复文件检查
5. 未使用的环境变量

### 📝 实现方案

在 `package.json` 中添加以下脚本：

```json
{
  "scripts": {
    "health-check": "tsx scripts/health-check.ts",
    "health-check:deps": "tsx scripts/health-check.ts --deps",
    "health-check:build": "tsx scripts/health-check.ts --build",
    "health-check:files": "tsx scripts/health-check.ts --files",
    "health-check:env": "tsx scripts/health-check.ts --env",
    "health-check:all": "tsx scripts/health-check.ts --all"
  }
}
```

### 🔧 脚本实现

脚本将检查：
1. **依赖检查**: 使用 `depcheck` 或自定义逻辑检查未使用的依赖
2. **构建产物检查**: 检查 `.gitignore` 中的文件是否误入仓库
3. **大文件检查**: 查找大于 1MB 的文件
4. **重复文件检查**: 使用现有脚本 `find-same-size`
5. **环境变量检查**: 检查 `.env.example` 中的变量是否在代码中使用

---

## 执行时间表

### 第一周
- ✅ **Day 1**: 第一阶段 - 清理构建产物和缓存文件
- ✅ **Day 2**: 验证第一阶段，开始第二阶段准备

### 第二周
- ✅ **Day 1**: 第二阶段 - 删除未使用的依赖
- ✅ **Day 2-3**: 充分测试第二阶段
- ✅ **Day 4**: 第三阶段 - 整理文档文件

### 第三周
- ✅ **Day 1**: 第四阶段 - 清理后端废弃文件
- ✅ **Day 2**: 第五阶段 - 优化配置文件（可选）
- ✅ **Day 3**: 创建自动化体检脚本

---

## 注意事项

1. **每次清理后都要充分测试**
2. **重要文件删除前先备份**
3. **每个阶段独立提交，便于回滚**
4. **遇到问题立即停止，分析后再继续**
5. **保留清理记录，便于后续参考**

---

**计划生成完成时间**: 2024-12-19  
**下一步**: 确认计划后开始执行第一阶段

