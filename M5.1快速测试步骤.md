# M5.1 å¿«é€Ÿæµ‹è¯•æ­¥éª¤

## âœ… ç¼–è¯‘çŠ¶æ€

- âœ… åç«¯ä»£ç ç¼–è¯‘æˆåŠŸ
- âœ… å·²å®‰è£… `ali-oss` ä¾èµ–
- âœ… å·²ä¿®å¤ TypeScript ç±»å‹é”™è¯¯

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### æ­¥éª¤ 1ï¼šé…ç½®ç¯å¢ƒå˜é‡

**åœ¨ `backend-api/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š**

```bash
# OSS é…ç½®ï¼ˆå¿…éœ€ï¼‰
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY=your-access-key-id
OSS_SECRET=your-access-key-secret

# OSS è®¿é—® URLï¼ˆå¯é€‰ï¼Œç”¨äº CDNï¼‰
OSS_BASE_URL=https://your-cdn-domain.com
```

---

### æ­¥éª¤ 2ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend-api
npm run start:dev
```

**æ£€æŸ¥æ—¥å¿—ï¼š**
- âœ… æ²¡æœ‰ OSS é…ç½®é”™è¯¯
- âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
- âœ… `job_outputs` è¡¨å·²åˆ›å»ºï¼ˆå¦‚æœ `synchronize: true`ï¼‰

---

### æ­¥éª¤ 3ï¼šæµ‹è¯•å›¾ç‰‡ä¸Šä¼ 

**ä½¿ç”¨ curl æˆ– Postmanï¼š**

```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@factory-buy.com","password":"your-password"}' \
  | jq -r '.token')

# 2. è°ƒç”¨ç”Ÿæˆå›¾ç‰‡æ¥å£ï¼ˆæä¾›å·²ç”Ÿæˆçš„å›¾ç‰‡ URLï¼‰
curl -X POST http://localhost:3001/ai/generate-image \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "æµ‹è¯•å›¾ç‰‡",
    "imageUrl": "https://via.placeholder.com/1024x1024.jpg"
  }'
```

**é¢„æœŸç»“æœï¼š**
```json
{
  "imageUrl": "https://your-bucket.oss-cn-hangzhou.aliyuncs.com/users/test@factory-buy.com/jobs/abc123/image-1703123456789.jpg"
}
```

---

### æ­¥éª¤ 4ï¼šéªŒè¯ç»“æœ

**1. æ£€æŸ¥ OSSï¼š**
- ç™»å½•é˜¿é‡Œäº‘ OSS æ§åˆ¶å°
- æŸ¥çœ‹è·¯å¾„ï¼š`users/{userId}/jobs/{jobId}/`
- ç¡®è®¤æœ‰æ–‡ä»¶å­˜åœ¨

**2. æ£€æŸ¥æ•°æ®åº“ï¼š**
```sql
SELECT * FROM job_outputs ORDER BY "createdAt" DESC LIMIT 1;
```

**3. æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶ï¼š**
```bash
ls -la /tmp/dream-factory/
# åº”è¯¥æ²¡æœ‰æ®‹ç•™æ–‡ä»¶ï¼ˆé™¤äº†æ­£åœ¨å¤„ç†çš„ï¼‰
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šOSS é…ç½®é”™è¯¯

**é”™è¯¯ï¼š** `OSS é…ç½®ä¸å®Œæ•´`

**è§£å†³ï¼š** æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ OSS é…ç½®

---

### é—®é¢˜ 2ï¼šä¸Šä¼ å¤±è´¥

**é”™è¯¯ï¼š** `AccessDenied`

**è§£å†³ï¼š**
1. æ£€æŸ¥ OSS AccessKey å’Œ Secret æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ OSS Bucket æƒé™è®¾ç½®

---

### é—®é¢˜ 3ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é”™è¯¯ï¼š** `relation "job_outputs" does not exist`

**è§£å†³ï¼š**
1. ç¡®ä¿ `synchronize: true`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
2. æˆ–æ‰‹åŠ¨åˆ›å»ºè¡¨

---

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] OSS é…ç½®æ­£ç¡®
- [ ] å›¾ç‰‡ä¸Šä¼ æˆåŠŸ
- [ ] è¿”å› OSS URLï¼ˆä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼‰
- [ ] OSS ä¸­æœ‰æ–‡ä»¶
- [ ] æ•°æ®åº“æœ‰è®°å½•
- [ ] ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š
1. ä¿®æ”¹å‰ç«¯ API è·¯ç”±ï¼Œç”Ÿæˆåè°ƒç”¨åç«¯ä¸Šä¼ 
2. å®ç° Cron æ¸…ç†ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
3. æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£


