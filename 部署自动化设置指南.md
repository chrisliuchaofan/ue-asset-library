# ğŸš€ è‡ªåŠ¨éƒ¨ç½²è®¾ç½®æŒ‡å—

ä½¿ç”¨ GitHub Actions å®ç°ä»£ç æ¨é€åè‡ªåŠ¨éƒ¨ç½²åˆ° ECS æœåŠ¡å™¨ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

- âœ… GitHub ä»“åº“å·²è®¾ç½®
- âœ… ECS æœåŠ¡å™¨å¯ä»¥ SSH è®¿é—®
- âœ… æœåŠ¡å™¨ä¸Šå·²å®‰è£… Node.jsã€PM2ã€Git

## ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ SSH å¯†é’¥å¯¹

### åœ¨æœ¬åœ°æ‰§è¡Œï¼š

```bash
# ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/github_actions_deploy

# è¿™ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š
# ~/.ssh/github_actions_deploy (ç§é’¥)
# ~/.ssh/github_actions_deploy.pub (å…¬é’¥)
```

### å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨ï¼š

```bash
# å¤åˆ¶å…¬é’¥å†…å®¹
cat ~/.ssh/github_actions_deploy.pub

# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆå°†ä¸Šé¢çš„å…¬é’¥å†…å®¹ç²˜è´´è¿›å»ï¼‰
mkdir -p ~/.ssh
echo "ç²˜è´´å…¬é’¥å†…å®¹" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

### æˆ–è€…ä½¿ç”¨ ssh-copy-idï¼š

```bash
ssh-copy-id -i ~/.ssh/github_actions_deploy.pub root@8.148.196.57
```

---

## ğŸ” ç¬¬äºŒæ­¥ï¼šåœ¨ GitHub æ·»åŠ  Secrets

1. ç™»å½• [GitHub](https://github.com)
2. è¿›å…¥ä½ çš„ä»“åº“ï¼š`chrisliuchaofan/ue-asset-library`
3. ç‚¹å‡» **Settings** â†’ **Secrets and variables** â†’ **Actions**
4. ç‚¹å‡» **New repository secret**ï¼Œæ·»åŠ ä»¥ä¸‹ä¸‰ä¸ªå¯†é’¥ï¼š

### Secret 1: `ECS_HOST`
- **Name**: `ECS_HOST`
- **Value**: `8.148.196.57`ï¼ˆä½ çš„æœåŠ¡å™¨ IPï¼‰

### Secret 2: `ECS_USERNAME`
- **Name**: `ECS_USERNAME`
- **Value**: `root`ï¼ˆä½ çš„æœåŠ¡å™¨ç”¨æˆ·åï¼‰

### Secret 3: `ECS_SSH_KEY`
- **Name**: `ECS_SSH_KEY`
- **Value**: ç§é’¥å†…å®¹ï¼ˆæ‰§è¡Œ `cat ~/.ssh/github_actions_deploy` è·å–ï¼‰

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•è‡ªåŠ¨éƒ¨ç½²

1. ä¿®æ”¹ `backend-api` ç›®å½•ä¸‹çš„ä»»æ„æ–‡ä»¶ï¼ˆæ¯”å¦‚æ·»åŠ ä¸€ä¸ªæ³¨é‡Šï¼‰
2. æäº¤å¹¶æ¨é€ï¼š

```bash
git add backend-api/
git commit -m "test: æµ‹è¯•è‡ªåŠ¨éƒ¨ç½²"
git push origin main
```

3. åœ¨ GitHub ä¸ŠæŸ¥çœ‹ Actionsï¼š
   - è¿›å…¥ä»“åº“ â†’ **Actions** æ ‡ç­¾é¡µ
   - åº”è¯¥èƒ½çœ‹åˆ° "Deploy Backend to ECS" workflow æ­£åœ¨è¿è¡Œ
   - ç­‰å¾…å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—ç¡®è®¤éƒ¨ç½²æˆåŠŸ

---

## ğŸ” éªŒè¯éƒ¨ç½²

åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥ï¼š

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ue-assets-backend --lines 20

# æ£€æŸ¥ä»£ç æ˜¯å¦æ›´æ–°
cd /opt/ue-assets-backend/backend-api
git log -1
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### è§¦å‘æ¡ä»¶

è‡ªåŠ¨éƒ¨ç½²ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š
- æ¨é€åˆ° `main` åˆ†æ”¯
- ä¸”ä¿®æ”¹äº† `backend-api/**` ç›®å½•ä¸‹çš„æ–‡ä»¶
- æˆ–ä¿®æ”¹äº†éƒ¨ç½²é…ç½®æ–‡ä»¶

### éƒ¨ç½²æµç¨‹

1. GitHub Actions æ£€å‡ºä»£ç 
2. é€šè¿‡ SSH è¿æ¥åˆ° ECS æœåŠ¡å™¨
3. æ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼š
   - `git pull` - æ‹‰å–æœ€æ–°ä»£ç 
   - `npm install --production` - å®‰è£…ä¾èµ–
   - `npm run build` - æ„å»ºé¡¹ç›®
   - `pm2 restart` - é‡å¯æœåŠ¡

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šSSH è¿æ¥å¤±è´¥

**æ£€æŸ¥ï¼š**
- SSH å¯†é’¥æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ°æœåŠ¡å™¨
- GitHub Secrets ä¸­çš„ `ECS_HOST` å’Œ `ECS_USERNAME` æ˜¯å¦æ­£ç¡®
- æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å…è®¸ SSH è¿æ¥

### é—®é¢˜ 2ï¼šéƒ¨ç½²å¤±è´¥

**æ£€æŸ¥ï¼š**
- GitHub Actions æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- æœåŠ¡å™¨ä¸Šçš„ PM2 æ—¥å¿—ï¼š`pm2 logs ue-assets-backend`
- æœåŠ¡å™¨ç£ç›˜ç©ºé—´ï¼š`df -h`

### é—®é¢˜ 3ï¼šä»£ç æ²¡æœ‰æ›´æ–°

**æ£€æŸ¥ï¼š**
- GitHub Actions æ˜¯å¦æˆåŠŸæ‰§è¡Œ
- æœåŠ¡å™¨ä¸Šçš„ Git çŠ¶æ€ï¼š`git status`
- PM2 æ˜¯å¦æˆåŠŸé‡å¯ï¼š`pm2 status`

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **SSH å¯†é’¥å®‰å…¨**ï¼š
   - ä¸è¦å°†ç§é’¥æäº¤åˆ° Git
   - å®šæœŸæ›´æ¢ SSH å¯†é’¥
   - ä½¿ç”¨ä¸“ç”¨çš„éƒ¨ç½²å¯†é’¥ï¼Œä¸è¦ç”¨ä¸ªäºº SSH å¯†é’¥

2. **éƒ¨ç½²é¢‘ç‡**ï¼š
   - æ¯æ¬¡æ¨é€éƒ½ä¼šè§¦å‘éƒ¨ç½²
   - å¦‚æœé¢‘ç¹æ¨é€ï¼Œè€ƒè™‘æ·»åŠ éƒ¨ç½²é”æˆ–åˆå¹¶å¤šä¸ªæäº¤

3. **å›æ»šæ–¹æ¡ˆ**ï¼š
   - å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨å›æ»šï¼š
   ```bash
   cd /opt/ue-assets-backend/backend-api
   git reset --hard HEAD~1
   npm run build
   pm2 restart ue-assets-backend
   ```

---

## ğŸ‰ å®Œæˆ

è®¾ç½®å®Œæˆåï¼Œä»¥ååªéœ€è¦ï¼š

```bash
# æœ¬åœ°ä¿®æ”¹ä»£ç 
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push origin main
```

æœåŠ¡å™¨ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œï¼

---

**æœ€åæ›´æ–°**ï¼š2025-12-14

