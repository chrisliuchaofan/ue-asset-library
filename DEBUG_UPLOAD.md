# 批量上传网络错误排查指南

## 问题现象

批量上传时出现"上传失败：网络错误"，但API调用返回200。

## 错误流程

1. ✅ `/api/oss/direct-upload` 返回200 - 获取上传凭证成功
2. ✅ `/api/assets/check-duplicate` 返回200 - 去重复检查成功
3. ❌ 实际向OSS上传文件时失败 - 触发 `xhr.onerror`

## 可能的原因

### 1. OSS上传URL问题
- **CORS配置**：OSS的CORS策略可能不允许当前域名
- **URL格式**：上传URL可能不正确
- **HTTPS/HTTP混合**：页面是HTTPS但OSS URL是HTTP（或反之）

### 2. 网络问题
- **超时**：文件太大，上传时间超过30秒
- **网络不稳定**：连接中断
- **防火墙/代理**：阻止了到OSS的连接

### 3. 文件问题
- **文件大小**：超过OSS限制
- **文件损坏**：文件本身有问题

## 排查步骤

### 1. 检查浏览器控制台
打开浏览器开发者工具（F12），查看：
- **Network标签**：查看实际的上传请求
- **Console标签**：查看详细的错误日志

### 2. 检查OSS配置
```bash
# 检查环境变量
echo $OSS_BUCKET
echo $OSS_REGION
echo $OSS_ENDPOINT
```

### 3. 检查网络连接
```bash
# 测试OSS连接
curl -I https://your-bucket.oss-region.aliyuncs.com/
```

### 4. 查看详细日志
代码中已添加详细日志，查看：
- `[直接上传] 开始上传到OSS:` - 上传开始
- `[直接上传] 网络错误详情:` - 错误详情
- `[批量上传] 上传失败 (尝试 X/3):` - 重试信息

## 解决方案

### 1. 增加超时时间
如果文件较大，可以增加超时时间（当前30秒）

### 2. 检查OSS CORS配置
确保OSS的CORS配置允许：
- 允许的来源：你的域名
- 允许的方法：POST, PUT
- 允许的头部：*

### 3. 使用分片上传
对于大文件，考虑使用OSS的分片上传功能

### 4. 检查网络代理
如果有代理，确保代理配置正确

## 调试命令

```bash
# 查看上传日志
npm run dev
# 然后在浏览器控制台查看详细日志
```

## 常见错误码

- **0**: 网络错误（最常见）
- **400**: 请求格式错误
- **403**: 权限不足或CORS问题
- **404**: URL不存在
- **500**: 服务器错误










