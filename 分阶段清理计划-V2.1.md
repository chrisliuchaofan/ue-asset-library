# 分阶段清理计划 V2.1（修正版）

**生成时间**: 2024-12-19  
**基于**: 《项目体检报告.md》  
**原则**: 保守型重构，确保功能不被破坏

---

## ⚠️ 前置检查：Git 状态（关键修正）

### 步骤1：检查当前 Git 状态

```bash
# 检查工作区状态
git status --short
```

**判断标准**:
- **如果输出为空**：工作区干净，可以继续
- **如果有输出**：工作区不干净，必须执行步骤2

### 步骤2：清理工作区（二选一）

**⚠️ 重要**: 在 dirty 状态下切换分支，脏改动会跟随到新分支，**不能当作解决方案**。

**选项A：暂存当前更改（推荐）**
```bash
git stash push -u -m "暂存清理前的状态"
```

**选项B：提交当前更改**
```bash
git add -A
git commit -m "chore: 提交当前工作状态"
```

### 步骤3：创建清理分支（可选，但推荐）

**⚠️ 必须在工作区干净后执行**：
```bash
# 确认工作区干净
git status --short
# 应该输出为空

# 创建清理分支
git checkout -b chore/project-cleanup
```

### 恢复方式

**如果使用 stash**:
```bash
# 查看 stash 列表
git stash list

# 恢复 stash
git stash pop

# 或应用但不删除
git stash apply stash@{0}
```

**如果使用 commit**:
```bash
# 查看提交历史
git log --oneline -5

# 如果需要修改提交
git reset --soft HEAD~1
```

**如果使用 tag**:
```bash
# 查看 tag
git tag | grep pre-cleanup

# 恢复到 tag 状态
git checkout pre-cleanup-YYYYMMDD
```

---

## 清理策略

1. **分批执行**: 每个阶段独立提交，便于回滚
2. **先验证后删除**: 每步都有验证命令
3. **保留备份**: 重要文件删除前先确认
4. **渐进式清理**: 从低风险到高风险
5. **严格证据**: 所有删除必须有可验证的依据

---

## 第一阶段：清理构建产物和缓存文件（高优先级）

### 📋 变更内容

**文件删除清单**:
1. `build.log` (5.0KB) - **未被git跟踪**，可直接删除
2. `tsconfig.tsbuildinfo` (143KB) - **未被git跟踪**，可直接删除
3. `backend-api/dist/` 目录及其所有内容 (740KB) - **已被git跟踪**，需使用 `git rm`

**配置更新**:
- `.gitignore` 已更新，确保这些文件被忽略

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 这些都是构建产物和缓存文件，不影响源代码
- 删除后可通过 `npm run build` 重新生成
- `.gitignore` 已配置，只是文件未清理

**潜在影响**:
- 无功能影响
- 首次构建可能稍慢（需重新生成缓存）

### 🔄 回滚方式

```bash
# 如果删除后发现问题，可通过以下方式恢复：
# 对于未跟踪的文件（build.log, tsconfig.tsbuildinfo），无法直接恢复，但可重新生成
# 对于已跟踪的文件（backend-api/dist/），可通过git恢复：
git checkout HEAD -- backend-api/dist/
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 确认 Git 状态干净
git status --short
# 必须输出为空或只有预期的修改

# 2. 确认这些文件存在
ls -lh build.log tsconfig.tsbuildinfo 2>/dev/null || echo "文件不存在"
ls -ld backend-api/dist/ 2>/dev/null || echo "目录不存在"

# 3. 确认 backend-api/dist/ 被git跟踪
git ls-files backend-api/dist/ | head -5
# 应该输出文件列表

# 4. 确认 .gitignore 已配置
grep -E "(build\.log|tsbuildinfo|backend-api/dist)" .gitignore
# 应该输出匹配的行
```

**删除后验证**:
```bash
# 1. 确认文件已删除
ls build.log tsconfig.tsbuildinfo 2>&1 | grep "No such file" || echo "文件仍存在"
ls backend-api/dist/ 2>&1 | grep "No such file" || echo "目录仍存在"

# 2. 验证项目仍可正常构建（使用package.json中的真实scripts）
npm run build

# 3. 验证后端仍可正常构建
cd backend-api && npm run build && cd ..

# 4. 确认 .gitignore 生效（文件不应出现在 git status 中）
git status --short | grep -E "(build\.log|tsbuildinfo|backend-api/dist)" && echo "❌ 文件仍在跟踪中" || echo "✅ 文件已正确忽略"

# 5. 验证lint（使用package.json中的真实scripts）
npm run lint
```

**冒烟测试**:
```bash
# 1. 前端构建测试
npm run build
npm run start &
sleep 5
curl http://localhost:3000 | head -20
pkill -f "next start"

# 2. 后端构建测试（如果使用）
cd backend-api
npm run build
cd ..
```

### 📝 执行步骤

```bash
# Step 1: 确认 Git 状态干净
git status --short
# 如果不干净，先执行前置检查中的操作

# Step 2: 备份当前状态（默认方案：tag，不推荐commit）
# 方案A（推荐）：创建 tag
git tag pre-cleanup-$(date +%Y%m%d)

# 方案B：使用 stash
# git stash push -u -m "pre-cleanup"

# ⚠️ 注意：只有在明确要求把当前状态入历史时，才使用 commit
# git add -A
# git commit -m "chore: 备份清理前的状态"

# Step 3: 删除未跟踪的构建产物和缓存文件
rm -f build.log tsconfig.tsbuildinfo

# Step 4: 删除已跟踪的构建产物（使用git rm）
git rm -r backend-api/dist/

# Step 5: 验证删除
npm run build
cd backend-api && npm run build && cd ..
npm run lint

# Step 6: 提交更改
git add -A
git commit -m "chore: 清理构建产物和缓存文件

- 删除 build.log（未跟踪）
- 删除 tsconfig.tsbuildinfo（未跟踪）
- 删除 backend-api/dist/ 目录（已跟踪，使用git rm）
- 这些文件可通过构建重新生成
- .gitignore 已配置，确保不再跟踪这些文件"

# Step 7: 输出变更统计
git diff --stat HEAD~1 HEAD
```

---

## 第二阶段：删除未使用的依赖（中优先级）

### 📋 当前 package.json scripts 列表

```json
{
  "scripts": {
    "dev": "NODE_OPTIONS='--no-deprecation' next dev",
    "build": "next build",
    "start": "NODE_OPTIONS='--no-deprecation' next start",
    "lint": "next lint",
    "build:manifest": "tsx scripts/build_manifest.ts",
    "test": "npm run build",
    "pre-push": "./scripts/pre-push.sh",
    "cleanup-duplicates": "tsx scripts/cleanup-duplicate-files.ts",
    "cleanup-duplicates:delete": "tsx scripts/cleanup-duplicate-files.ts --delete",
    "find-same-size": "tsx scripts/find-same-size-files.ts",
    "test:user-identity": "tsx scripts/test-user-identity-chain.ts",
    "verify:m3": "tsx scripts/verify-m3-system-status.ts",
    "check:supabase": "tsx scripts/check-supabase.ts",
    "check:env": "tsx scripts/check-env.ts",
    "health-check": "tsx scripts/health-check.ts",
    "health-check:deps": "tsx scripts/health-check.ts --deps",
    "health-check:build": "tsx scripts/health-check.ts --build",
    "health-check:files": "tsx scripts/health-check.ts --files",
    "health-check:env": "tsx scripts/health-check.ts --env",
    "health-check:all": "tsx scripts/health-check.ts --all"
  }
}
```

**注意**: `test` 脚本实际执行的是 `npm run build`，不是真正的测试。

### 📋 变更内容

**package.json 依赖删除清单**（基于证据）:

#### ✅ 确认可删除的依赖（需 depcheck/knip 证据）：

1. **`graceful-fs`** (^4.2.11)
   - **初步证据**: 
     - `npm ls graceful-fs` 显示它是直接依赖，但项目代码中无直接引用
     - 仅在 `backend-api/node_modules` 中被间接依赖（通过其他包的依赖）
     - 项目代码中搜索无任何 `import`/`require` 语句
   - **⚠️ 需要 depcheck/knip 证据确认**

2. **`gsap`** (^3.13.0)
   - **初步证据**:
     - 项目代码中搜索无任何 `import`/`require` 语句
     - 无动态导入
     - 无字符串拼接导入
   - **⚠️ 需要 depcheck/knip 证据确认**

3. **`@google/genai`** (^1.33.0)
   - **初步证据**:
     - 项目代码中搜索无任何 `import`/`require` 语句
     - 无动态导入
     - 无字符串拼接导入
   - **⚠️ 需要 depcheck/knip 证据确认**

#### ⚠️ 需要保留的依赖：

1. **`ogl`** (^1.0.11) - **保留**
   - **证据**: 在 `components/galaxy-background.tsx` 中有动态导入：`import('ogl')`
   - **结论**: 必须保留

2. **`proxy-agent`** (^5.0.0) - **暂不删除，待确认**
   - **证据**: 
     - `npm ls` 显示它被 `ali-oss` 间接依赖
     - 虽然项目代码中不直接使用，但删除可能导致 `ali-oss` 功能异常
   - **结论**: 暂时保留，待 depcheck/knip 确认 `ali-oss` 是否真的需要它

**预期节省**: 约 10-15MB node_modules 体积（删除3个依赖）

### ⚠️ 风险评估

**风险等级**: 🟡 **中**

**理由**:
- 这些依赖在代码中未找到直接引用
- 但可能是间接依赖或动态导入
- 删除前需要充分测试和 depcheck/knip 证据

**潜在影响**:
- 如果误删，可能导致运行时错误
- 动态导入的依赖可能被遗漏（已检查，无遗漏）

### 🔄 回滚方式

```bash
# 恢复 package.json
git checkout HEAD -- package.json

# 重新安装依赖
npm install
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 安装 depcheck（如果未安装）
npm install -g depcheck
# 或使用 npx（推荐，不污染全局）
# npx depcheck

# 2. 运行 depcheck 生成证据报告
mkdir -p docs/cleanup
npx depcheck > docs/cleanup/dep-audit-$(date +%Y%m%d).txt 2>&1

# 3. 查看报告，确认待删除依赖在 "Unused dependencies" 列表中
cat docs/cleanup/dep-audit-$(date +%Y%m%d).txt

# 4. 再次确认这些依赖未被使用
# graceful-fs
grep -r "graceful-fs\|gracefulFs" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist . 2>/dev/null | grep -v "node_modules" | head -5
# 应该只输出node_modules中的结果

# gsap
grep -r "gsap\|GSAP" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist . 2>/dev/null | grep -v "node_modules" | head -5
# 应该无输出

# @google/genai
grep -r "@google/genai\|genai" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist . 2>/dev/null | grep -v "node_modules" | head -5
# 应该无输出

# 5. 检查是否有动态导入
grep -r "import.*\(graceful-fs\|gsap\|genai\)" --include="*.ts" --include="*.tsx" . --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist 2>/dev/null
# 应该无输出

# 6. 检查 npm ls 输出
npm ls graceful-fs gsap @google/genai
# 记录输出，作为删除前的证据
```

**删除后验证**:
```bash
# 1. 确认 package.json 已更新
grep -E "(graceful-fs|gsap|@google/genai)" package.json && echo "❌ 依赖仍在" || echo "✅ 依赖已删除"

# 2. 重新安装依赖
rm -rf node_modules package-lock.json
npm install

# 3. 验证项目仍可正常构建（使用package.json中的真实scripts）
npm run build

# 4. 运行lint（使用package.json中的真实scripts）
npm run lint

# 5. 运行"test"脚本（实际是build，已在build中验证）
npm run test
```

**冒烟测试**:
```bash
# 1. 启动开发服务器
npm run dev &
DEV_PID=$!
sleep 10

# 2. 测试主要页面
curl http://localhost:3000 | head -20
curl http://localhost:3000/assets | head -20
curl http://localhost:3000/materials | head -20

# 3. 停止开发服务器
kill $DEV_PID

# 4. 构建生产版本
npm run build
npm run start &
sleep 5
curl http://localhost:3000 | head -20
pkill -f "next start"
```

### 📝 执行步骤

```bash
# Step 1: 备份当前 package.json
cp package.json package.json.backup

# Step 2: 生成依赖审计证据（depcheck）
mkdir -p docs/cleanup
npx depcheck > docs/cleanup/dep-audit-$(date +%Y%m%d).txt 2>&1

# Step 3: 查看 depcheck 报告
cat docs/cleanup/dep-audit-$(date +%Y%m%d).txt

# Step 4: 确认待删除依赖在 "Unused dependencies" 列表中
# 如果不在列表中，或报告显示有风险，停止执行

# Step 5: 记录删除前的证据
npm ls graceful-fs gsap @google/genai > docs/cleanup/deps-before-removal-$(date +%Y%m%d).txt 2>&1
cat docs/cleanup/deps-before-removal-$(date +%Y%m%d).txt

# Step 6: 删除未使用的依赖（只删除确认的3个）
npm uninstall graceful-fs gsap @google/genai

# Step 7: 验证删除
npm run build
npm run lint
npm run test  # 实际是 build，已在上面验证

# Step 8: 运行冒烟测试（见上方）

# Step 9: 如果一切正常，提交更改
git add package.json package-lock.json docs/cleanup/
git commit -m "chore: 删除未使用的依赖

删除以下未使用的依赖包（基于 depcheck 证据）：
- graceful-fs (未在代码中直接使用，仅在node_modules中被间接依赖)
- gsap (未在代码中找到任何引用)
- @google/genai (未在代码中找到任何引用)

保留以下依赖（有使用证据）：
- ogl (在 components/galaxy-background.tsx 中有动态导入)
- proxy-agent (被 ali-oss 间接依赖，暂时保留)

证据文件：
- docs/cleanup/dep-audit-YYYYMMDD.txt (depcheck 报告)
- docs/cleanup/deps-before-removal-YYYYMMDD.txt (npm ls 输出)

预期节省: 10-15MB node_modules 体积"

# Step 10: 输出变更统计
git diff --stat HEAD~1 HEAD

# Step 11: 如果发现问题，回滚
# git checkout HEAD -- package.json package-lock.json
# npm install
```

---

## 第三阶段：整理文档文件（中优先级）

### 📋 变更内容

**文档归档**:
- 创建 `docs/archive/` 目录
- 移动历史文档到归档目录

**文档删除**（需人工确认）:
- 重复的配置说明文档
- 临时的问题排查文档（已解决的问题）

**保留的核心文档**:
- `README.md`
- `PROJECT_STRUCTURE.md`
- `ARCHITECTURE_SUMMARY.md`
- `docs/` 目录下的文档

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 文档文件不影响功能
- 归档而非删除，可随时恢复
- 只整理根目录文档，不影响 `docs/` 目录

**潜在影响**:
- 无功能影响
- 可能影响文档查找（但归档后更有序）

### 🔄 回滚方式

```bash
# 恢复文档文件
git checkout HEAD -- docs/archive/
git mv docs/archive/*.md .
rmdir docs/archive
```

### ✅ 验证方式

**归档前验证**:
```bash
# 1. 列出根目录所有 .md 文件
find . -maxdepth 1 -name "*.md" -type f | sort

# 2. 确认 docs/archive/ 目录不存在或为空
ls -la docs/archive/ 2>&1 | head -5
```

**归档后验证**:
```bash
# 1. 确认文档已移动到归档目录
ls docs/archive/ | wc -l

# 2. 确认根目录文档数量减少
find . -maxdepth 1 -name "*.md" -type f | wc -l

# 3. 验证项目仍可正常构建（文档不影响构建）
npm run build
```

### 📝 执行步骤

```bash
# Step 1: 创建归档目录
mkdir -p docs/archive

# Step 2: 移动历史文档到归档目录（示例，需根据实际情况调整）
# 完成总结类文档
mv *完成总结*.md docs/archive/ 2>/dev/null || true
mv *完成总结-*.md docs/archive/ 2>/dev/null || true

# 修复类文档
mv *修复*.md docs/archive/ 2>/dev/null || true

# 测试类文档
mv *测试*.md docs/archive/ 2>/dev/null || true

# 部署类文档
mv *部署*.md docs/archive/ 2>/dev/null || true

# 问题排查类文档
mv *问题排查*.md docs/archive/ 2>/dev/null || true
mv *排查*.md docs/archive/ 2>/dev/null || true

# Step 3: 创建归档索引
cat > docs/archive/README.md << 'EOF'
# 文档归档目录

本目录包含历史文档，按类型分类：

- 完成总结类: `*完成总结*.md`
- 修复类: `*修复*.md`
- 测试类: `*测试*.md`
- 部署类: `*部署*.md`
- 问题排查类: `*问题排查*.md`, `*排查*.md`

如需查找历史文档，请在此目录中搜索。
EOF

# Step 4: 验证归档
ls docs/archive/ | head -20

# Step 5: 提交更改
git add docs/archive/
git add -u  # 跟踪已移动的文件
git commit -m "chore: 整理文档文件，归档历史文档到 docs/archive/

- 创建 docs/archive/ 目录
- 移动历史文档（完成总结、修复、测试、部署、问题排查类）到归档目录
- 保留核心文档在根目录"

# Step 6: 输出变更统计
git diff --stat HEAD~1 HEAD
```

---

## 第四阶段：清理后端废弃文件（中优先级）

### 📋 变更内容

**文件删除清单**（需人工确认）:
1. `backend-api/src/auth/auth.service.old.ts` - **需确认是否已废弃**
2. `backend-api/src/auth/auth.service.new.ts` - **需确认是否已合并到主文件**

**前提条件**:
- 需人工确认这些文件确实已废弃
- 确认 `auth.service.ts` 是当前使用的文件

### ⚠️ 风险评估

**风险等级**: 🟡 **中**

**理由**:
- 需要确认文件确实已废弃
- 删除前需检查是否有其他地方引用
- 可能包含重要的历史代码

**潜在影响**:
- 如果误删，可能丢失重要代码
- 如果文件仍在使用，会导致编译错误

### 🔄 回滚方式

```bash
# 恢复文件
git checkout HEAD -- backend-api/src/auth/auth.service.old.ts backend-api/src/auth/auth.service.new.ts
```

### ✅ 验证方式

**删除前验证**:
```bash
# 1. 确认文件存在
ls -lh backend-api/src/auth/auth.service*.ts

# 2. 检查是否有其他地方引用这些文件
grep -r "auth\.service\.old\|auth\.service\.new" backend-api/src/

# 3. 检查 auth.module.ts 中的引用
cat backend-api/src/auth/auth.module.ts
# 应该只引用 auth.service.ts

# 4. 对比文件内容，确认已合并
diff backend-api/src/auth/auth.service.ts backend-api/src/auth/auth.service.new.ts
# 如果差异很小，说明已合并

# 5. 检查 Git 历史，确认文件状态
git log --oneline --all -- backend-api/src/auth/auth.service*.ts
```

**删除后验证**:
```bash
# 1. 确认文件已删除
ls backend-api/src/auth/auth.service.old.ts 2>&1 | grep "No such file"
ls backend-api/src/auth/auth.service.new.ts 2>&1 | grep "No such file"

# 2. 验证后端仍可正常构建
cd backend-api
npm run build
cd ..

# 3. 验证后端仍可正常启动（如果可能）
cd backend-api
npm run start:dev &
sleep 5
curl http://localhost:3001/health 2>&1 || echo "健康检查端点可能不存在"
pkill -f "ts-node-dev"
cd ..
```

### 📝 执行步骤

```bash
# Step 1: 备份文件（重要！）
cp backend-api/src/auth/auth.service.old.ts backend-api/src/auth/auth.service.old.ts.backup 2>/dev/null || true
cp backend-api/src/auth/auth.service.new.ts backend-api/src/auth/auth.service.new.ts.backup 2>/dev/null || true

# Step 2: 确认文件状态（需人工确认）
# 检查 auth.service.ts 是否是当前使用的文件
# 检查 .old.ts 和 .new.ts 是否已废弃

# Step 3: 执行删除前验证（见上方）

# Step 4: 删除废弃文件（仅在确认后执行）
# ⚠️ 注意：这一步需要人工确认后才能执行
# git rm backend-api/src/auth/auth.service.old.ts
# git rm backend-api/src/auth/auth.service.new.ts

# Step 5: 验证删除
cd backend-api
npm run build
cd ..

# Step 6: 提交更改
git add backend-api/src/auth/
git commit -m "chore: 清理后端废弃文件

- 删除 auth.service.old.ts (已废弃)
- 删除 auth.service.new.ts (已合并到 auth.service.ts)"

# Step 7: 输出变更统计
git diff --stat HEAD~1 HEAD
```

**⚠️ 重要**: 如果无法确认完整引用链，禁止删除，仅允许标注 TODO。

---

## 第五阶段：优化配置文件（低优先级，可选）

### 📋 变更内容

**tailwind.config.ts**:
- 移除 `./src/**/*.{ts,tsx}` 路径（项目中没有 `src` 目录）

### ⚠️ 风险评估

**风险等级**: 🟢 **低**

**理由**:
- 只是移除冗余配置，不影响功能
- Tailwind 会忽略不存在的路径

**潜在影响**:
- 无功能影响
- 可能略微提升构建性能（忽略不存在的路径）

### 🔄 回滚方式

```bash
git checkout HEAD -- tailwind.config.ts
```

### ✅ 验证方式

**修改后验证**:
```bash
# 1. 确认配置已更新
grep -E "src.*tsx" tailwind.config.ts && echo "❌ 配置仍在" || echo "✅ 配置已移除"

# 2. 验证 Tailwind 仍正常工作
npm run build

# 3. 检查构建输出中是否有 Tailwind 相关错误
npm run build 2>&1 | grep -i "tailwind\|postcss" || echo "✅ 无错误"
```

### 📝 执行步骤

```bash
# Step 1: 修改 tailwind.config.ts
# 移除 content 数组中的 "./src/**/*.{ts,tsx}"

# Step 2: 验证修改
npm run build

# Step 3: 提交更改
git add tailwind.config.ts
git commit -m "chore: 优化 Tailwind 配置，移除不存在的 src 目录路径"

# Step 4: 输出变更统计
git diff --stat HEAD~1 HEAD
```

---

## 执行规范

### 每个阶段必须执行：

1. **执行前**:
   - 确认 Git 状态干净
   - 执行删除前验证

2. **执行中**:
   - 按步骤执行，不跳过任何验证

3. **执行后**:
   - 执行删除后验证
   - 运行冒烟测试
   - 输出 `git diff --stat`
   - 单独 commit，清晰的 commit message

4. **验证失败**:
   - 立即停止
   - 回滚当前阶段
   - 输出失败原因分析
   - 修正计划后再继续

---

## 执行顺序

1. ✅ **先输出修正后的清理计划 V2.1**（本文档）
2. ⏸️ **等待确认"可以开始执行"**
3. ▶️ **按阶段逐步实施**

---

## 重要提醒

1. **Git 状态必须干净**才能开始
2. **每个阶段独立提交**，便于回滚
3. **充分测试**后再进行下一阶段
4. **遇到问题立即停止**，分析后再继续
5. **保留清理记录**，便于后续参考
6. **依赖删除必须有 depcheck/knip 证据**

---

**计划修正完成时间**: 2024-12-19  
**版本**: V2.1  
**下一步**: 等待确认"可以开始执行"

