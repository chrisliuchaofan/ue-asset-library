# 服务器端口占用检查指南

## 查看端口占用

### 方法 1：使用 lsof（推荐）

```bash
# 查看 3002 端口占用
lsof -i :3002

# 查看 3001 端口占用
lsof -i :3001

# 查看所有端口占用（包含进程信息）
lsof -i -P -n | grep LISTEN
```

**输出示例：**
```
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
node    12345 root   20u  IPv4  12345      0t0  TCP *:3002 (LISTEN)
```

### 方法 2：使用 netstat

```bash
# 查看 3002 端口占用
netstat -tuln | grep 3002

# 查看 3001 端口占用
netstat -tuln | grep 3001

# 查看所有监听端口（包含进程信息）
netstat -tulnp | grep LISTEN
```

### 方法 3：使用 ss（现代 Linux 推荐）

```bash
# 查看 3002 端口占用
ss -tuln | grep 3002

# 查看 3001 端口占用
ss -tuln | grep 3001

# 查看所有监听端口（包含进程信息）
ss -tulnp | grep LISTEN
```

### 方法 4：使用 fuser

```bash
# 查看 3002 端口占用
fuser 3002/tcp

# 查看 3001 端口占用
fuser 3001/tcp
```

## 停止占用端口的进程

### 方法 1：使用 kill（需要先获取 PID）

```bash
# 1. 先查看端口占用，获取 PID
lsof -i :3002

# 2. 使用 PID 停止进程（替换 12345 为实际的 PID）
kill 12345

# 3. 如果普通 kill 无效，使用强制停止
kill -9 12345
```

### 方法 2：一行命令停止（推荐）

```bash
# 停止占用 3002 端口的进程
lsof -ti :3002 | xargs kill -9

# 停止占用 3001 端口的进程
lsof -ti :3001 | xargs kill -9
```

### 方法 3：使用 fuser 停止

```bash
# 停止占用 3002 端口的进程
fuser -k 3002/tcp

# 停止占用 3001 端口的进程
fuser -k 3001/tcp
```

## 完整操作流程

### 场景 1：检查并停止 3002 端口占用

```bash
# 1. 查看端口占用
lsof -i :3002

# 2. 如果有输出，停止进程
lsof -ti :3002 | xargs kill -9

# 3. 再次检查，确认端口已释放
lsof -i :3002
# 应该没有输出
```

### 场景 2：检查并停止 3001 端口占用

```bash
# 1. 查看端口占用
lsof -i :3001

# 2. 如果有输出，停止进程
lsof -ti :3001 | xargs kill -9

# 3. 再次检查，确认端口已释放
lsof -i :3001
# 应该没有输出
```

## 查找所有 Node.js 进程

```bash
# 查看所有 node 进程
ps aux | grep node

# 查看所有 node 进程（包含端口信息）
lsof -i -P -n | grep node

# 停止所有 node 进程（谨慎使用！）
pkill -9 node
```

## 常见问题

### Q: 为什么总是有端口占用？

**可能原因：**
1. 之前的服务没有正确停止
2. 服务崩溃后进程残留
3. 有多个服务实例在运行

**解决方案：**
1. 使用 `screen` 或 `tmux` 管理服务，方便查看和停止
2. 使用 `systemd` 或 `pm2` 管理服务
3. 启动前先检查并清理端口占用

### Q: 如何避免端口占用问题？

**推荐方案：使用 screen 管理服务**

```bash
# 1. 创建 screen 会话
screen -S backend

# 2. 在 screen 中启动服务
cd /opt/ue-assets-backend/backend-api
npm run start:dev

# 3. 按 Ctrl+A 然后按 D 分离会话（服务继续运行）

# 4. 重新连接会话
screen -r backend

# 5. 停止服务：在 screen 中按 Ctrl+C，然后退出
exit
```

**或者使用 pm2 管理服务**

```bash
# 1. 安装 pm2
npm install -g pm2

# 2. 启动服务
cd /opt/ue-assets-backend/backend-api
pm2 start npm --name "backend-api" -- run start:dev

# 3. 查看服务状态
pm2 list

# 4. 停止服务
pm2 stop backend-api

# 5. 删除服务
pm2 delete backend-api
```

## 快速脚本

### 停止端口占用的脚本

创建文件 `stop-port.sh`：

```bash
#!/bin/bash

PORT=$1

if [ -z "$PORT" ]; then
    echo "用法: ./stop-port.sh <端口号>"
    echo "示例: ./stop-port.sh 3002"
    exit 1
fi

echo "检查端口 $PORT 占用情况..."
PID=$(lsof -ti :$PORT)

if [ -z "$PID" ]; then
    echo "端口 $PORT 未被占用"
    exit 0
fi

echo "找到占用端口 $PORT 的进程: PID=$PID"
echo "进程信息:"
ps -p $PID -o pid,user,cmd

read -p "是否停止该进程? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    kill -9 $PID
    echo "已停止进程 $PID"
    
    # 再次检查
    sleep 1
    if lsof -i :$PORT > /dev/null 2>&1; then
        echo "警告: 端口 $PORT 仍然被占用"
    else
        echo "端口 $PORT 已释放"
    fi
else
    echo "取消操作"
fi
```

使用：
```bash
chmod +x stop-port.sh
./stop-port.sh 3002
```


