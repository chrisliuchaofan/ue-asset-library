# 待办事项处理计划

**创建时间：** 2025-12-15  
**状态：** 进行中

---

## ✅ 已完成

### 1. 数据库迁移脚本 ✅
- ✅ 创建 SQL 迁移脚本：`backend-api/src/database/migrations/add-user-mode-fields.sql`
- ✅ 创建执行脚本：`backend-api/scripts/run-migration.sh`
- ✅ 支持开发和生产环境

**下一步：** 在生产环境执行迁移

---

## 🚧 进行中

### 2. M5.1: 完善生成产物存储策略

**当前状态：**
- ✅ StorageService 已实现
- ✅ JobOutput 实体已创建
- ✅ 后端接口已支持从 URL 上传到 OSS
- ⚠️ 前端生成流程需要确保所有产物都通过后端上传

**需要处理：**
1. **前端 generate-image 路由**
   - 当前：前端调用 AI 服务生成图片，然后可能需要上传到 OSS
   - 目标：确保生成的图片通过后端上传到 OSS，返回 OSS URL

2. **前端 generate-video 路由**
   - 当前：类似图片生成
   - 目标：确保生成的视频通过后端上传到 OSS，返回 OSS URL

3. **验证 API 响应**
   - 确保所有响应只返回 OSS URL
   - 不返回本地路径或临时 URL

---

## 📋 待处理

### 3. 管理员权限检查系统

**需要添加权限检查的接口：**
- `GET /users/list` - 用户列表
- `POST /users/update-mode` - 更新用户模式
- `POST /credits/admin/recharge` - 管理员充值
- 其他管理员功能

**实现方案：**
1. 创建 `AdminGuard` 装饰器
2. 检查用户是否在管理员白名单中
3. 或添加 `isAdmin` 字段到 User 实体

---

### 4. M5.1: Cron 任务清理临时文件（可选）

**实现方案：**
1. 使用 `@nestjs/schedule` 模块
2. 每天凌晨执行清理任务
3. 清理 24 小时前的临时文件

---

### 5. M5.1: 服务器端数据层迁移

**目标：** 将 Dream Factory 项目数据从 localStorage 迁移到服务器端

**实施步骤：**
1. 创建 Project 实体
2. 创建 Projects Service 和 Controller
3. 创建前端 API 路由
4. 修改 project-storage.ts，支持后端存储
5. 实现数据迁移功能

**预计时间：** 3-4 天

---

## 🎯 优先级

1. **高优先级：**
   - ✅ 数据库迁移脚本（已完成）
   - 🔄 M5.1 生成产物存储策略完善（进行中）
   - ⏳ 管理员权限检查系统

2. **中优先级：**
   - ⏳ Cron 任务清理临时文件
   - ⏳ 服务器端数据层迁移

3. **低优先级：**
   - 其他优化项

---

## 📝 处理记录

### 2025-12-15
- ✅ 创建数据库迁移脚本
- 🔄 开始处理 M5.1 生成产物存储策略

---

**下一步：** 继续完善 M5.1 生成产物存储策略，确保所有生成产物都通过后端上传到 OSS。

