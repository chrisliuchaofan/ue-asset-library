# 压力测试指南

## 概述

本文档说明如何对批量上传功能进行压力测试，以确保系统能够处理大量资产和素材的上传。

## 快速开始

### 1. 安装依赖（如果还没有）

```bash
npm install
```

### 2. 启动开发服务器

```bash
npm run dev
```

### 3. 运行压力测试

```bash
npx tsx scripts/stress-test-upload.ts
```

## 测试场景

压力测试脚本会自动测试以下场景：

1. **小批量测试** (10个文件)
   - 测试基本功能是否正常
   - 每个文件约 100KB

2. **中批量测试** (50个文件)
   - 测试中等规模上传
   - 每个文件约 1MB

3. **大批量测试** (100个文件)
   - 测试大规模上传
   - 每个文件约 1MB

4. **并发测试** (3个用户同时上传)
   - 测试并发场景
   - 每个用户 10 个文件

## 优化措施

系统已经实施了以下优化措施来防止崩溃：

### 1. 并发控制
- **最大并发数**: 5个文件同时上传
- **批量大小限制**: 单次最多 100 个文件
- 防止内存溢出和连接数过多

### 2. 错误处理和重试
- **自动重试**: 失败后自动重试最多 3 次
- **渐进延迟**: 重试间隔递增（1s, 2s, 3s）
- **部分失败处理**: 部分文件失败不影响其他文件

### 3. 资源监控
- 测试脚本会监控内存使用情况
- 记录每个测试的耗时和成功率

## 手动测试建议

### 测试不同文件大小

1. **小文件** (< 1MB)
   - 测试快速上传场景
   - 验证并发处理能力

2. **中等文件** (1-10MB)
   - 测试正常使用场景
   - 验证内存使用

3. **大文件** (10-50MB)
   - 测试大文件处理
   - 验证超时处理

### 测试不同文件数量

1. **少量文件** (1-10个)
   - 验证基本功能

2. **中等数量** (10-50个)
   - 验证批量处理

3. **大量文件** (50-100个)
   - 验证系统稳定性

4. **超大量** (> 100个)
   - 需要分批上传
   - 系统会自动限制

## 监控指标

测试过程中关注以下指标：

1. **成功率**: 应该 > 95%
2. **平均速度**: 每个文件上传时间
3. **内存使用**: 不应该持续增长
4. **错误信息**: 查看服务器日志

## 性能基准

基于测试，预期性能：

- **小批量 (10个)**: < 5秒
- **中批量 (50个)**: < 30秒
- **大批量 (100个)**: < 60秒
- **并发 (3用户)**: < 90秒

## 故障排查

如果测试失败：

1. **检查服务器日志**
   ```bash
   # 查看 Next.js 开发服务器输出
   ```

2. **检查内存使用**
   - 如果内存持续增长，可能存在内存泄漏
   - 考虑减少并发数

3. **检查网络连接**
   - OSS 上传需要稳定的网络连接
   - 检查 OSS 配置是否正确

4. **检查文件大小限制**
   - 默认最大 200MB/文件
   - 可在 `lib/constants.ts` 中调整

## 生产环境建议

在生产环境部署前：

1. **调整并发数**: 根据服务器配置调整 `MAX_CONCURRENT_UPLOADS`
2. **设置超时**: 为 API 路由设置合理的超时时间
3. **监控告警**: 设置内存和 CPU 使用率告警
4. **日志记录**: 记录所有上传操作，便于排查问题

## 配置调整

可以在 `lib/constants.ts` 中调整以下配置：

```typescript
export const BATCH_UPLOAD_CONFIG = {
  MAX_CONCURRENT_UPLOADS: 5,  // 并发数
  MAX_BATCH_SIZE: 100,         // 批量大小
  MAX_RETRIES: 3,              // 重试次数
  RETRY_DELAY: 1000,           // 重试延迟(ms)
} as const;
```

## 注意事项

1. **测试环境**: 建议在开发环境先测试
2. **数据清理**: 测试后清理测试数据
3. **资源限制**: 注意 OSS 存储空间和流量限制
4. **网络环境**: 确保网络连接稳定

















